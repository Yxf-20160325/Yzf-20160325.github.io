<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëø∑ÂÆ´ÂÜíÈô© - 1.13.7</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            overflow: auto;
            min-height: 100vh;
        }
        
        /* ‰∏ªËèúÂçïÊ†∑Âºè */
        .main-menu {
            text-align: center;
            margin-top: 50px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-title {
            font-size: 48px;
            margin-bottom: 30px;
            color: #4CAF50;
            text-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
            letter-spacing: 3px;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .menu-button, .menu-btn {
            display: block;
            width: 250px;
            margin: 15px auto;
            padding: 14px;
            font-size: 18px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .menu-btn.highlight {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .badge {
            background-color: #FF5252;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 5px;
        }
        
        .menu-button:hover, .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #66BB6A, #388E3C);
        }
        
        .menu-btn.highlight:hover {
            background: linear-gradient(135deg, #FFA726, #FF8F00);
        }
        
        /* ÂÖ≥Âç°ÈÄâÊã©Ê†∑Âºè */
        .level-select {
            text-align: center;
            margin-top: 20px;
            animation: slideIn 0.8s ease-out;
            position: relative;
            padding-top: 80px;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
.level-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 700px;
    margin: 30px auto;
    margin-top: 60px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
    -webkit-overflow-scrolling: touch; /* iOSÊªëÂä®ÊµÅÁïÖ */
    touch-action: pan-y; /* ‰ºòÂåñËß¶ÊéßË°å‰∏∫ */
    overscroll-behavior: contain; /* Èò≤Ê≠¢ÊªöÂä®‰º†Êí≠Âà∞Â§ñÂ±Ç */
}
        
        .level-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .level-container::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 4px;
        }
        
        .level-container::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .level-button {
            width: 60px;
            height: 60px;
            margin: 12px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .level-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        
        .level-button.locked {
            background: linear-gradient(135deg, #555, #333);
            cursor: not-allowed;
        }
        
        .level-button.completed {
            background: linear-gradient(135deg, #FFC107, #FF9800);
        }

        .level-button.unsolvable {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            position: relative;
            overflow: hidden;
        }
        
        .level-button.unsolvable::after {
            content: "?";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255,255,255,0.7);
        }
        
        /* Ê∏∏ÊàèÁîªÂ∏ÉÊ†∑Âºè */
        #gameCanvas {
            display: block;
            margin: 20px auto;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
        }
        
        /* Ê∏∏Êàè‰ø°ÊÅØÊ†∑Âºè */
        .game-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 10;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 300px;
            transition: all 0.3s ease;
        }
        
        .game-info-item {
            display: flex;
            align-items: center;
            padding: 5px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 4px;
            min-width: 80px;
        }
        
        /* ÈÄöÂÖ≥ÊèêÁ§∫Ê†∑Âºè */
        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            width: 400px;
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.5);
            border: 2px solid #4CAF50;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .level-complete h2 {
            font-size: 36px;
            margin-bottom: 25px;
            color: #4CAF50;
        }
        
        .level-complete p {
            font-size: 22px;
            margin-bottom: 30px;
            font-family: monospace;
        }
        
        .level-complete button {
            margin: 0 10px;
            padding: 12px 25px;
            font-size: 18px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-complete button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* ËøîÂõûÊåâÈíÆÊ†∑Âºè */
        .back-button {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 8px 16px;
            font-size: 16px;
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            z-index: 20;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.4);
        }
        
        /* Â§ö‰∫∫Ê∏∏ÊàèËÆæÁΩÆÊ†∑Âºè */
        .multiplayer-setup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            width: 400px;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
            border: 2px solid #4CAF50;
        }
        
        .multiplayer-setup h2 {
            font-size: 32px;
            margin-bottom: 30px;
            color: #4CAF50;
        }
        
        .setup-label {
            display: block;
            color: white;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .setup-color-input {
            width: 100%;
            height: 40px;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .setup-input {
            margin: 15px 0;
            padding: 12px 15px;
            width: 100%;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            outline: none;
        }
        
        .setup-input:focus {
            border-color: #8BC34A;
            box-shadow: 0 0 10px rgba(139, 195, 74, 0.5);
        }
        
        .room-settings {
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #4CAF50;
        }
        
        .room-settings h4 {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .room-settings .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .room-settings label {
            color: white;
            font-weight: bold;
        }
        
        /* Â§ö‰∫∫Ê∏∏ÊàèÁïåÈù¢Ê†∑Âºè */
        .player-list {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            min-width: 180px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            font-family: monospace;
            z-index: 10;
            border: 1px solid #4CAF50;
        }
        
        .player-list h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4CAF50;
            text-align: center;
            border-bottom: 1px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .player-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
        }
        
        .player-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .connection-status {
            position: absolute;
            bottom: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-family: monospace;
            z-index: 10;
        }
        
        .connected {
            background: rgba(76, 175, 80, 0.8);
            color: white;
        }
        
        .disconnected {
            background: rgba(244, 67, 54, 0.8);
            color: white;
        }
        
        /* ÈöêËóèÁ±ª */
        .hidden {
            display: none !important;
        }
        
        /* Ê∏∏ÊàèËØ¥ÊòéÂºπÁ™ó */
        .instructions-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            z-index: 1000;
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.7);
            border: 2px solid #4CAF50;
        }
        
        .instructions-modal h2 {
            color: #4CAF50;
            text-align: center;
            margin-top: 0;
        }
        
        .instructions-modal p {
            line-height: 1.6;
            margin-bottom: 20px;
            font-family: monospace;
        }
        
        .instructions-modal ul {
            text-align: left;
            padding-left: 20px;
        }
        
        .instructions-modal li {
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .instructions-modal button {
            display: block;
            margin: 20px auto 0;
            padding: 10px 25px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* ÊñπÂêëÈîÆÊéßÂà∂Èù¢Êùø */
        .controls-panel {
            position: fixed;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            z-index: 10;
            transition: all 0.3s ease;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            width: 150px;
            height: 150px;
            box-sizing: border-box;
        }

        .control-button {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 5px;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: scale(1.05);
        }

        .control-button:active {
            background: rgba(76, 175, 80, 0.5);
            transform: scale(0.95);
        }

        .control-up {
            grid-column: 2;
            grid-row: 1;
        }

        .control-left {
            grid-column: 1;
            grid-row: 2;
        }

        .control-right {
            grid-column: 3;
            grid-row: 2;
        }

        .control-down {
            grid-column: 2;
            grid-row: 3;
        }
        
        /* ÂÖ≥Âç°ÂÜÖÊéßÂà∂ÊåâÈíÆ */
        .level-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 10;
        }
        
        .level-control-button {
            padding: 10px 20px;
            font-size: 16px;
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        .level-control-button.reset {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        .level-control-button.exit {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .level-control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        
        /* ÂÖ≥Âç°ÈÄâÊã©Ê†áÈ¢òÊ†∑Âºè */
        .level-select-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            z-index: 10;
            width: 100%;
            text-align: center;
        }
        
        /* ËøΩÈÄêËÄÖÊ†∑Âºè */
        .enemy-info {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            font-family: monospace;
            z-index: 10;
            white-space: nowrap;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.5); }
            50% { box-shadow: 0 0 20px rgba(244, 67, 54, 0.8); }
            100% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.5); }
        }
        
        /* Èí•ÂåôÂíåÈó®Ê†∑Âºè */
        .key-info {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            font-family: monospace;
            z-index: 10;
            white-space: nowrap;
            animation: glow 1.5s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
        }
        
        .unlock-timer {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            font-family: monospace;
            z-index: 10;
            white-space: nowrap;
            animation: glow 1.5s infinite alternate;
        }
        
        /* ÊéßÂà∂Âè∞Ê†∑Âºè */
        .console-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            width: 500px;
            max-width: 90%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            font-family: 'Courier New', monospace;
        }
        
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #4CAF50;
            margin-bottom: 10px;
        }
        
        .console-title {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .console-close {
            background: none;
            border: none;
            color: #f44336;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .console-close:hover {
            background: rgba(244, 67, 54, 0.2);
        }
        
        .console-output {
            background: rgba(20, 20, 30, 0.9);
            height: 200px;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
            font-size: 14px;
            color: #ccc;
            white-space: pre-wrap;
        }
        
        .console-input-group {
            display: flex;
        }
        
        .console-prompt {
            color: #4CAF50;
            padding: 8px 10px 8px 0;
            font-weight: bold;
        }
        
        .console-input {
            flex: 1;
            background: rgba(30, 30, 40, 0.9);
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 8px 12px;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }
        
        .console-input:focus {
            border-color: #8BC34A;
            box-shadow: 0 0 8px rgba(139, 195, 74, 0.5);
        }
        
        .console-status {
            margin-top: 10px;
            padding: 5px 10px;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 5px;
            font-size: 12px;
            color: #aaa;
        }
        
        .console-hidden {
            display: none;
        }
        
        /* ÊéßÂà∂Âè∞ÊèêÁ§∫ */
        .console-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-family: monospace;
            border: 1px solid #4CAF50;
            z-index: 100;
            animation: fadeInHint 0.5s;
        }
        
        @keyframes fadeInHint {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .console-hint.hidden {
            display: none;
        }
        
        /* UIËÆæÁΩÆÈù¢ÊùøÊ†∑Âºè */
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 3000;
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.7);
            border: 2px solid #4CAF50;
        }
        
        /* ÁßªÂä®ËÆæÂ§áÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .settings-modal {
                padding: 15px;
                width: 95%;
                max-height: 90vh;
            }
            
            .settings-modal h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            /* Á°Æ‰øùËæìÂÖ•Ê°ÜÂú®ÊâãÊú∫‰∏äÂèØÁÇπÂáª */
            .settings-modal input,
            .settings-modal button {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* ÊéßÂà∂Âè∞ÁâπÂÆöÊ†∑ÂºèË∞ÉÊï¥ */
            #consolePasswordInput,
            #consoleCommandInput {
                font-size: 16px !important;
            }
        }

        .settings-modal h2 {
            color: #4CAF50;
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .setting-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4CAF50;
        }

        .setting-group h3 {
            color: #8BC34A;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .setting-row label {
            width: 80px;
            margin-right: 15px;
            color: white;
        }

        .setting-row select, 
        .setting-row input[type="range"] {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4CAF50;
            color: white;
            padding: 8px;
            border-radius: 5px;
        }

        .setting-row input[type="range"] {
            padding: 0;
        }
        
        .setting-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-checkbox input {
            margin-right: 10px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .buttons button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* Èü≥‰πêÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        .music-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .music-controls button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ËÆæÁΩÆÊåâÈíÆÊ†∑Âºè */
        .settings-button {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            transition: all 0.3s;
        }

        .settings-button:hover {
            background: rgba(76, 175, 80, 0.8);
            transform: scale(1.1);
        }
        
        /* Ê∏∏Êàè‰ø°ÊÅØËÆæÁΩÆ */
        .info-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .drag-handle {
            width: 100%;
            height: 20px;
            background: rgba(76, 175, 80, 0.2);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            cursor: move;
            position: absolute;
            top: -20px;
            left: 0;
            z-index: 1;
        }
        
        .controls-panel.draggable {
            cursor: grabbing;
        }
        
        /* ÁßªÂä®Á´ØÊéßÂà∂Èù¢ÊùøÊãñÊãΩÊ†∑Âºè */
        .controls-panel {
            position: fixed;
            touch-action: none;
            transition: left 0.2s, top 0.2s;
        }
#controlsPanel {
    position: fixed;
    /* ÂàùÂßã‰ΩçÁΩÆÔºà‰ºöË¢´JSË¶ÜÁõñÔºâ */
    left: 20px;
    bottom: 20px;
    /* Âπ≥ÊªëÁßªÂä®ÊïàÊûú */
    transition: left 0.2s, top 0.2s;
    /* Èò≤Ê≠¢Ëß¶Êë∏È´ò‰∫Æ */
    -webkit-tap-highlight-color: transparent;
}

#dragHandle {
    width: 100%;
    height: 30px;
    /* Ëß¶Êë∏‰ºòÂåñ */
    touch-action: none;
    cursor: grab;
}
.level-control-button.next {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
}

.level-control-button.skip {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(255, 152, 0, 0.7); }
    50% { box-shadow: 0 0 15px rgba(255, 152, 0, 0.9); }
    100% { box-shadow: 0 0 5px rgba(255, 152, 0, 0.7); }
}

        /* Êñ∞Â¢ûÊ†∑ÂºèÔºöË∏¢Âá∫ÊåâÈíÆ */
        .kick-button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .kick-button:hover {
            background: linear-gradient(135deg, #ff5252, #ff1744);
        }
        
        /* ÊàøÈó¥ËÆæÁΩÆÊ†∑Âºè */
        .room-settings {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #4CAF50;
        }
        
        .room-settings h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #8BC34A;
        }
/* Êõ¥Â§öÊåëÊàòÊ†∑Âºè */
.challenges-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
}

.challenge-card {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 25px;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.challenge-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
    background: rgba(0, 0, 0, 0.8);
}

.challenge-card h3 {
    color: #4CAF50;
    margin-top: 0;
    font-size: 24px;
}

.challenge-card p {
    color: #ccc;
    margin-bottom: 15px;
}

.challenge-stats {
    color: #8BC34A;
    font-size: 14px;
}

/* ÊàêÂ∞±Á≥ªÁªüÊ†∑Âºè */
.achievements-container {
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
}

.achievement-item {
    display: flex;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #333;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.achievement-item.completed {
    border-color: #FFD700;
    background: rgba(255, 215, 0, 0.1);
}

.achievement-icon {
    font-size: 32px;
    margin-right: 15px;
}

.achievement-info {
    flex: 1;
}

.achievement-info h3 {
    color: #fff;
    margin: 0 0 5px 0;
    font-size: 18px;
}

.achievement-info p {
    color: #ccc;
    margin: 0 0 10px 0;
    font-size: 14px;
}

.achievement-progress {
    display: flex;
    align-items: center;
    gap: 10px;
}
.special-challenges {
    margin-top: 30px;
    border-top: 1px solid #4CAF50;
    padding-top: 20px;
}

.challenge-button {
    background: rgba(76, 175, 80, 0.2);
    border: 1px dashed #4CAF50;
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
}

.challenge-button:hover {
    background: rgba(76, 175, 80, 0.4);
}

.challenge-icon {
    font-size: 30px;
    margin-right: 15px;
}
.progress-bar {
    flex: 1;
    height: 8px;
    background: #333;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #4CAF50, #8BC34A);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.achievement-status {
    padding: 5px 10px;
    background: #333;
    border-radius: 15px;
    font-size: 12px;
    color: #ccc;
}

.achievement-item.completed .achievement-status {
    background: #FFD700;
    color: #000;
    font-weight: bold;
}

/* Êó∂Èó¥ÊåëÊàòÊèêÁ§∫ */
.time-challenge-info {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(244, 67, 54, 0.9);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-family: monospace;
    z-index: 10;
    animation: pulse 1.5s infinite;
}
.replay-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 15px 0;
    border: 1px solid #333;
    border-radius: 5px;
}

.replay-item {
    padding: 12px;
    border-bottom: 1px solid #444;
    cursor: pointer;
    transition: background 0.2s;
}

.replay-item:hover {
    background: rgba(76, 175, 80, 0.1);
}

.replay-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.player-container {
    margin-top: 20px;
    background: #111;
    padding: 15px;
    border-radius: 5px;
}

.player-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

.speed-control {
    margin-left: auto;
}
/* ‰∫ã‰ª∂ÈÄöÁü•Ê†∑Âºè */
#event-notifications {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}

.event-notification {
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 15px;
  border-radius: 5px;
  border-left: 4px solid #FF9800;
  margin-bottom: 5px;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ÂïÜÂ∫óÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
.shop-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.shop-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 25px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 40px rgba(76, 175, 80, 0.5);
}

.shop-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #4CAF50;
}

.shop-header h2 {
    color: #4CAF50;
    margin: 0;
}

.shop-close-btn {
    background: none;
    border: none;
    color: #f44336;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.shop-close-btn:hover {
    background: rgba(244, 67, 54, 0.2);
}

.shop-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: calc(90vh - 150px);
    overflow-y: auto;
}

/* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
.shop-items::-webkit-scrollbar {
    width: 8px;
}

.shop-items::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.shop-items::-webkit-scrollbar-thumb {
    background: rgba(76, 175, 80, 0.6);
    border-radius: 4px;
}

.shop-items::-webkit-scrollbar-thumb:hover {
    background: rgba(76, 175, 80, 0.8);
}

.shop-item {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #4CAF50;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.shop-item:hover {
    background: rgba(76, 175, 80, 0.1);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.item-icon {
    font-size: 40px;
    margin-right: 20px;
}

.item-info {
    flex: 1;
}

.item-info h3 {
    color: #8BC34A;
    margin: 0 0 5px 0;
    font-size: 20px;
}

.item-info p {
    color: #ccc;
    margin: 0;
    font-size: 14px;
}

.item-price {
    display: flex;
    align-items: center;
    margin: 0 20px;
}

.coin-icon {
    color: gold;
    font-size: 20px;
    margin-right: 5px;
}

.price-amount {
    color: gold;
    font-weight: bold;
    font-size: 18px;
}

.buy-btn {
    padding: 8px 20px;
    background: linear-gradient(135deg, #FFC107, #FF9800);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.buy-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 10px rgba(255, 152, 0, 0.5);
}

/* ÂΩìÈáëÂ∏Å‰∏çË∂≥Êó∂ÔºåÊåâÈíÆÂèòÁÅ∞‰∏î‰∏çÂèØÁÇπÂáª */
.buy-btn:disabled {
    background: #555;
    cursor: not-allowed;
    transform: scale(1);
}

        /* ÁªüËÆ°Êï∞ÊçÆÈ°µÈù¢Ê†∑Âºè */
        .statistics-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-top: 60px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .statistic-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .statistic-icon {
            font-size: 36px;
            margin-right: 20px;
            min-width: 50px;
        }
        
        .statistic-info {
            text-align: center;
            flex: 1;
        }
        
        .statistic-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #4CAF50;
        }
        
        .statistic-info p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
    
    /* ÂéÜÂè≤Êõ¥Êñ∞Ê†∑Âºè */
    #historyUpdates {
        padding: 20px;
        box-sizing: border-box;
        height: 100vh;
        overflow: hidden;
    }
    
    .updates-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 120px);
        overflow-y: auto;
        padding: 20px 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scrollbar-width: thin;
        scrollbar-color: #4CAF50 rgba(255, 255, 255, 0.1);
    }
    
    /* WebkitÊµèËßàÂô®ÊªöÂä®Êù°Ê†∑Âºè */
    .updates-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .updates-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .updates-container::-webkit-scrollbar-thumb {
        background: #4CAF50;
        border-radius: 4px;
    }
    
    .updates-container::-webkit-scrollbar-thumb:hover {
        background: #45a049;
    }
    
    .update-item {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .update-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(76, 175, 80, 0.5);
    }
    
    .update-date {
        color: #4CAF50;
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .update-title {
        color: #fff;
        font-size: 20px;
        margin: 0 0 15px 0;
    }
    
    .update-content {
        color: #ccc;
    }
    
    .update-content ul {
        list-style-type: disc;
        margin-left: 20px;
        padding: 0;
    }
    
    .update-content li {
        margin: 5px 0;
        line-height: 1.5;
    }
    
    /* ÊØèÊó•ÊåëÊàòÊ†∑Âºè */
    #dailyChallengeScreen {
        padding: 20px;
        box-sizing: border-box;
        height: 100vh;
        overflow: hidden;
    }
    
    .daily-challenge-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 120px);
        overflow-y: auto;
        padding: 20px 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scrollbar-width: thin;
        scrollbar-color: #4CAF50 rgba(255, 255, 255, 0.1);
    }
    
    .daily-challenge-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .daily-challenge-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .daily-challenge-container::-webkit-scrollbar-thumb {
        background: #4CAF50;
        border-radius: 4px;
    }
    
    .daily-challenge-container::-webkit-scrollbar-thumb:hover {
        background: #45a049;
    }
    
    .challenge-header {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .challenge-date {
        color: #4CAF50;
        font-size: 18px;
        font-weight: bold;
    }
    
    .challenge-countdown {
        color: #FFD700;
        font-size: 16px;
    }
    
    .challenge-card {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
        border: 2px solid #4CAF50;
        border-radius: 15px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .challenge-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    
    .challenge-icon {
        font-size: 64px;
        flex-shrink: 0;
    }
    
    .challenge-info {
        flex: 1;
    }
    
    .challenge-title {
        color: #fff;
        font-size: 24px;
        margin: 0 0 10px 0;
        font-weight: bold;
    }
    
    .challenge-description {
        color: #ccc;
        font-size: 16px;
        margin: 0 0 15px 0;
    }
    
    .challenge-rewards {
        display: flex;
        gap: 20px;
    }
    
    .reward-item {
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid #FFD700;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        color: #FFD700;
        font-weight: bold;
    }
    
    .challenge-status {
        flex-shrink: 0;
    }
    
    .challenge-status span {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
    
    .status-pending {
        background: rgba(255, 152, 0, 0.2);
        color: #FF9800;
        border: 1px solid #FF9800;
    }
    
    .status-completed {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid #4CAF50;
    }
    
    .challenge-details {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
    }
    
    .challenge-details h4 {
        color: #4CAF50;
        margin: 0 0 15px 0;
        font-size: 18px;
    }
    
    .challenge-details ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    
    .challenge-details li {
        color: #ccc;
        padding: 8px 0;
        border-bottom: 1px solid rgba(76, 175, 80, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .challenge-details li:last-child {
        border-bottom: none;
    }
    
    .challenge-details li::before {
        content: "‚úì";
        color: #4CAF50;
        font-weight: bold;
    }
    
    .challenge-progress {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
    }
    
    .challenge-progress h4 {
        color: #4CAF50;
        margin: 0 0 15px 0;
        font-size: 18px;
    }
    
    .progress-bar {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 10px;
    }
    
    .progress-text {
        color: #ccc;
        text-align: center;
        margin: 0;
        font-size: 14px;
    }
    
    .challenge-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .challenge-button {
        padding: 15px 40px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .challenge-button.primary {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }
    
    .challenge-button.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    
    .challenge-button.secondary {
        background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }
    
    .challenge-button.secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
    }
    
    .challenge-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .challenge-history {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
    }
    
    .challenge-history h4 {
        color: #4CAF50;
        margin: 0 0 15px 0;
        font-size: 18px;
    }
    
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .history-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .history-item.completed {
        border-color: #4CAF50;
    }
    
    .history-item.failed {
        border-color: #f44336;
    }
    
    .history-date {
        color: #ccc;
        font-size: 14px;
    }
    
    .history-result {
        font-weight: bold;
        font-size: 14px;
    }
    
    .history-result.completed {
        color: #4CAF50;
    }
    
    .history-result.failed {
        color: #f44336;
    }
    
    /* ÊàøÈó¥ÊµèËßàÂô®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .room-browser-list .room-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 5px 0;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(76, 175, 80, 0.3);
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .room-browser-list .room-item:hover {
        background: rgba(76, 175, 80, 0.2);
        transform: translateX(5px);
    }
    
    .room-browser-list .room-info {
        flex: 1;
    }
    
    .room-browser-list .room-name {
        font-weight: bold;
        color: #4CAF50;
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .room-browser-list .room-host {
        font-size: 14px;
        color: #999;
        margin-bottom: 5px;
    }
    
    .room-browser-list .room-players {
        font-size: 12px;
        color: #ccc;
    }
    
    .room-browser-list .room-status {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 8px;
        display: inline-block;
    }
    
    .room-browser-list .room-status.waiting {
        background: rgba(76, 175, 80, 0.3);
        color: #4CAF50;
    }
    
    .room-browser-list .room-status.playing {
        background: rgba(255, 152, 0, 0.3);
        color: #FF9800;
    }
    
    .room-browser-list .join-button {
        padding: 8px 16px;
        background: linear-gradient(135deg, #2196F3, #1976D2);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .room-browser-list .join-button:hover {
        background: linear-gradient(135deg, #42A5F5, #1E88E5);
    }
    
    .room-browser-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .room-browser-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .room-browser-list::-webkit-scrollbar-thumb {
        background: rgba(76, 175, 80, 0.5);
        border-radius: 4px;
    }
    
    .room-browser-list::-webkit-scrollbar-thumb:hover {
        background: rgba(76, 175, 80, 0.8);
    }
    </style>
</head>

<body>
    <div id="shopModal" class="shop-modal hidden">
        <div class="shop-content">
            <div class="shop-header">
                <h2>Ê∏∏ÊàèÂïÜÂ∫ó</h2>
                <button class="shop-close-btn" onclick="closeShop()">√ó</button>
            </div>
    
    <!-- Áé©ÂÆ∂Â∑•Âùä -->
    <div id="workshopMain" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">Áé©ÂÆ∂Â∑•Âùä</h2>
        
        <div class="workshop-container">
            <button class="workshop-button" onclick="showScreen('mazeEditor')">
                <div class="workshop-button-icon">üñåÔ∏è</div>
                <div class="workshop-button-text">ÂàõÂª∫Ëø∑ÂÆ´</div>
            </button>
            
            <button class="workshop-button" onclick="showScreen('myMazes')">
                <div class="workshop-button-icon">üìÅ</div>
                <div class="workshop-button-text">ÊàëÁöÑËø∑ÂÆ´</div>
            </button>
            
            <button class="workshop-button" onclick="showScreen('browseMazes')">
                <div class="workshop-button-icon">üîç</div>
                <div class="workshop-button-text">ÊµèËßàËø∑ÂÆ´</div>
            </button>
            
            <button class="workshop-button" onclick="showScreen('popularMazes')">
                <div class="workshop-button-icon">‚≠ê</div>
                <div class="workshop-button-text">ÁÉ≠Èó®Ëø∑ÂÆ´</div>
            </button>
        </div>
    </div>
    
    <!-- Ëø∑ÂÆ´ÁºñËæëÂô® -->
    <div id="mazeEditor" class="hidden">
        <button class="back-button" onclick="showScreen('workshopMain')">ËøîÂõû</button>
        <h2 class="level-select-title">Ëø∑ÂÆ´ÁºñËæëÂô®</h2>
        
        <div class="editor-container">
            <!-- Â∑•ÂÖ∑Ê†è -->
            <div class="editor-toolbar">
                <h3>Â∑•ÂÖ∑Ê†è</h3>
                <div class="tool-group">
                    <button class="tool-button active" data-tool="wall">Â¢ôÂ£Å</button>
                    <button class="tool-button" data-tool="path">ÈÄöÈÅì</button>
                    <button class="tool-button" data-tool="exit">Âá∫Âè£</button>
                    <button class="tool-button" data-tool="key">Èí•Âåô</button>
                    <button class="tool-button" data-tool="door">Èó®</button>
                    <button class="tool-button" data-tool="teleporter">‰º†ÈÄÅÈó®</button>
                </div>
                
                <div class="maze-properties">
                    <h3>Ëø∑ÂÆ´Â±ûÊÄß</h3>
                    <div class="property-group">
                        <label for="mazeName">ÂêçÁß∞:</label>
                        <input type="text" id="mazeName" placeholder="ËæìÂÖ•Ëø∑ÂÆ´ÂêçÁß∞">
                    </div>
                    <div class="property-group">
                        <label for="mazeDescription">ÊèèËø∞:</label>
                        <textarea id="mazeDescription" placeholder="ËæìÂÖ•Ëø∑ÂÆ´ÊèèËø∞" rows="3"></textarea>
                    </div>
                    <div class="property-group">
                        <label for="mazeDifficulty">ÈöæÂ∫¶:</label>
                        <select id="mazeDifficulty">
                            <option value="ÁÆÄÂçï">ÁÆÄÂçï</option>
                            <option value="‰∏≠Á≠â" selected>‰∏≠Á≠â</option>
                            <option value="Âõ∞Èöæ">Âõ∞Èöæ</option>
                        </select>
                    </div>
                </div>
                
                <div class="editor-actions">
                    <button class="menu-button" onclick="newMaze()">Êñ∞Âª∫</button>
                    <button class="menu-button" onclick="saveMaze()">‰øùÂ≠òÂà∞Êú¨Âú∞</button>
                    <button class="menu-button" onclick="publishMaze()">ÂèëÂ∏É</button>
                    <button class="menu-button" onclick="previewMaze()">È¢ÑËßà</button>
                </div>
            </div>
            
            <!-- Ëø∑ÂÆ´ÁºñËæëÁîªÂ∏É -->
            <div class="editor-canvas-container">
                <div class="canvas-header">
                    <h3>Ëø∑ÂÆ´ÁºñËæëÂå∫Âüü</h3>
                    <div class="canvas-info">15x15 ÁΩëÊ†º</div>
                </div>
                <div id="mazeCanvas" class="maze-canvas"></div>
            </div>
        </div>
    </div>
    
    <!-- ÊàëÁöÑËø∑ÂÆ´ -->
    <div id="myMazes" class="hidden">
        <button class="back-button" onclick="showScreen('workshopMain')">ËøîÂõû</button>
        <h2 class="level-select-title">ÊàëÁöÑËø∑ÂÆ´</h2>
        
        <div class="mazes-container">
            <div id="myMazesList" class="maze-list"></div>
        </div>
    </div>
    
    <!-- ÊµèËßàËø∑ÂÆ´ -->
    <div id="browseMazes" class="hidden">
        <button class="back-button" onclick="showScreen('workshopMain')">ËøîÂõû</button>
        <h2 class="level-select-title">ÊµèËßàËø∑ÂÆ´</h2>
        
        <div class="browse-container">
            <div class="search-bar">
                <input type="text" id="searchMazes" placeholder="ÊêúÁ¥¢Ëø∑ÂÆ´ÂêçÁß∞Êàñ‰ΩúËÄÖ">
                <select id="filterDifficulty">
                    <option value="">ÊâÄÊúâÈöæÂ∫¶</option>
                    <option value="ÁÆÄÂçï">ÁÆÄÂçï</option>
                    <option value="‰∏≠Á≠â">‰∏≠Á≠â</option>
                    <option value="Âõ∞Èöæ">Âõ∞Èöæ</option>
                </select>
                <button class="menu-button" onclick="searchMazes()">ÊêúÁ¥¢</button>
            </div>
            
            <div id="browseMazesList" class="maze-list"></div>
        </div>
    </div>
    
    <!-- ÁÉ≠Èó®Ëø∑ÂÆ´ -->
    <div id="popularMazes" class="hidden">
        <button class="back-button" onclick="showScreen('workshopMain')">ËøîÂõû</button>
        <h2 class="level-select-title">ÁÉ≠Èó®Ëø∑ÂÆ´</h2>
        
        <div class="mazes-container">
            <div id="popularMazesList" class="maze-list"></div>
        </div>
    </div>
            <div class="shop-items">
                <!-- ÈÅìÂÖ∑1ÔºöÊïàÊûúÊ∏ÖÈô§ -->
                <div class="shop-item" data-item="clear-events">
                    <div class="item-icon">‚ú®</div>
                    <div class="item-info">
                        <h3>ÊïàÊûúÊ∏ÖÈô§</h3>
                        <p>Ê∏ÖÈô§ÂΩìÂâçËß¶ÂèëÁöÑÊâÄÊúâÈöèÊú∫‰∫ã‰ª∂ÔºàÂ¶ÇÊéßÂà∂ÂèçËΩ¨Ôºâ„ÄÇ</p>
                    </div>
                    <div class="item-price">
                        <span class="coin-icon">ü™ô</span>
                        <span class="price-amount">20</span>
                    </div>
                    <button class="buy-btn" onclick="buyItem('clear-events')">Ë¥≠‰π∞</button>
                </div>
                
                <!-- ÈÅìÂÖ∑3Ôºö‰º†ÈÄÅ -->
                <div class="shop-item" data-item="teleport">
                    <div class="item-icon">üåÄ</div>
                    <div class="item-info">
                        <h3>‰º†ÈÄÅ</h3>
                        <p>Âú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÔºåËÆ©‰Ω†‰º†ÈÄÅÂà∞Âú∞Âõæ‰∏äÁöÑ‰ªªÊÑè‰ΩçÁΩÆ„ÄÇ</p>
                        <p class="item-note" style="color: #888; font-size: 12px;">*‰ªÖÈôêÂçï‰∫∫Ê∏∏Êàè</p>
                    </div>
                    <div class="item-price">
                        <span class="coin-icon">ü™ô</span>
                        <span class="price-amount">25</span>
                    </div>
                    <button class="buy-btn" onclick="buyItem('teleport')">Ë¥≠‰π∞</button>
                </div>

                <!-- ÈÅìÂÖ∑5ÔºöÊó†ÊïåÊä§Áõæ -->
                <div class="shop-item" data-item="invincibility">
                    <div class="item-icon">üõ°Ô∏è</div>
                    <div class="item-info">
                        <h3>Êó†ÊïåÊä§Áõæ</h3>
                        <p>ÂÖçÁñ´Èô∑Èò±‰º§ÂÆ≥ÔºåÊåÅÁª≠20Áßí„ÄÇ</p>
                    </div>
                    <div class="item-price">
                        <span class="coin-icon">ü™ô</span>
                        <span class="price-amount">50</span>
                    </div>
                    <button class="buy-btn" onclick="buyItem('invincibility')">Ë¥≠‰π∞</button>
                </div>

                <!-- ÈÅìÂÖ∑6ÔºöËø∑ÂÆ´ÊèêÁ§∫ -->
                <div class="shop-item" data-item="hint">
                    <div class="item-icon">üß≠</div>
                    <div class="item-info">
                        <h3>Ëø∑ÂÆ´ÊèêÁ§∫</h3>
                        <p>ÊòæÁ§∫‰∏ÄÊù°ÈÄöÂæÄÂá∫Âè£ÁöÑË∑ØÂæÑ„ÄÇ</p>
                    </div>
                    <div class="item-price">
                        <span class="coin-icon">ü™ô</span>
                        <span class="price-amount">10</span>
                    </div>
                    <button class="buy-btn" onclick="buyItem('hint')">Ë¥≠‰π∞</button>
                </div>
            </div>
        </div>
    </div>    <div id="statisticsScreen" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">Ê∏∏ÊàèÁªüËÆ°</h2>
        
        <div class="statistics-container">
            <div class="statistic-item">
                <div class="statistic-icon">‚è±Ô∏è</div>
                <div class="statistic-info">
                    <h3>ÊÄªÊ∏∏ÊàèÊó∂Èó¥</h3>
                    <p id="totalPlayTime">0 ÂàÜÈíü</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">üéÆ</div>
                <div class="statistic-info">
                    <h3>ÊÄªÁßªÂä®Ê¨°Êï∞</h3>
                    <p id="totalMoves">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">üèÜ</div>
                <div class="statistic-info">
                    <h3>ÈÄöÂÖ≥ÊÄªÂÖ≥Âç°Êï∞</h3>
                    <p id="totalLevelsCompleted">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">‚ö°</div>
                <div class="statistic-info">
                    <h3>Ëß¶ÂèëÈô∑Èò±Ê¨°Êï∞</h3>
                    <p id="totalTrapsTriggered">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">üí∞</div>
                <div class="statistic-info">
                    <h3>Êî∂ÈõÜÈáëÂ∏ÅÊÄªÊï∞</h3>
                    <p id="totalCoinsCollected">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">üß©</div>
                <div class="statistic-info">
                    <h3>Ëß£Ë∞úÂÖ≥Âç°ÂÆåÊàêÊï∞</h3>
                    <p id="puzzleLevelsCompleted">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">‚è∞</div>
                <div class="statistic-info">
                    <h3>ÊúÄÂø´ÈÄöÂÖ≥Êó∂Èó¥</h3>
                    <p id="timeChallengeBest">0 Áßí</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">üìä</div>
                <div class="statistic-info">
                    <h3>Âπ≥ÂùáÊØèÂÖ≥ÁßªÂä®Ê¨°Êï∞</h3>
                    <p id="averageMovesPerLevel">0</p>
                </div>
            </div>
            
            <div class="statistic-item">
                <div class="statistic-icon">‚úÖ</div>
                <div class="statistic-info">
                    <h3>ÈÄöÂÖ≥Áéá</h3>
                    <p id="completionRate">0%</p>
                </div>
            </div>
        </div>
        
        <button class="menu-button" onclick="resetStatistics()" style="margin-top: 20px;">ÈáçÁΩÆÁªüËÆ°Êï∞ÊçÆ</button>
    </div>    <!-- ‰∏ªËèúÂçï -->
    <div id="mainMenu" class="main-menu">
        <h1 class="menu-title">Ëø∑ÂÆ´ÂÜíÈô©</h1>
        <button class="menu-button" onclick="showScreen('singlePlayerLevelSelect')">Âçï‰∫∫Ê∏∏Êàè</button>
        <button class="menu-button" onclick="showScreen('multiplayerSetup')">Â±ÄÂüüÁΩëÂ§ö‰∫∫Ê∏∏Êàè iOSËØ∑Á°Æ‰øùÊúçÂä°Âô®ÂºÄÂêØ</button>
        <button class="menu-button" onclick="showInstructions()">Ê∏∏ÊàèËØ¥Êòé</button>
        <div id="playTimeDisplay" class="game-info" style="margin: 15px auto; display: inline-block;"></div>
        <button class="menu-button" onclick="showScreen('achievementsScreen')">ÊàêÂ∞±Á≥ªÁªü</button>
        <button class="menu-button" onclick="showScreen('statisticsScreen')">ÁªüËÆ°Êï∞ÊçÆ</button>
        <!-- <button class="menu-button" onclick="showScreen('moreChallengesScreen')">Êõ¥Â§öÊåëÊàò</button> -->
        <!-- <button class="menu-button" onclick="showSaveLoadMenu()">Â≠òÊ°£/ËØªÊ°£</button> -->
        <button class="menu-button" onclick="showUISettings()">UIËÆæÁΩÆ</button>
        <button class="menu-button" onclick="openShop()">Ê∏∏ÊàèÂïÜÂ∫ó</button>
        <button class="menu-button" onclick="openConsolePasswordModal()" ontouchstart="openConsolePasswordModal()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">ÊéßÂà∂Âè∞</button>
        <button class="menu-button" onclick="showScreen('dailyChallengeScreen')">ÊØèÊó•ÊåëÊàò</button>
        <button class="menu-button" onclick="showScreen('historyUpdates')">ÂéÜÂè≤Êõ¥Êñ∞</button>
        
        <!-- Êñ∞Â¢ûÁé©ÂÆ∂Â∑•ÂùäÊåâÈíÆ
        <button id="workshopBtn" class="menu-btn highlight">
            Áé©ÂÆ∂Â∑•Âùä
            <span class="badge" id="newLevelsBadge">12</span>
        </button>
        
        <button id="playBtn" class="menu-btn">
            <i class="icon-play"></i> ÂºÄÂßãÊ∏∏Êàè
        </button> -->
        </div>
    
    <!-- Â≠òÊ°£/ËØªÊ°£ÁÆ°ÁêÜÁïåÈù¢ - Â∑≤ÈöêËóè -->
    <!-- <div id="saveLoadModal" class="instructions-modal hidden">
        <h2>Â≠òÊ°£ÁÆ°ÁêÜ</h2>
        <div style="display: flex; flex-direction: column; gap: 20px; max-height: 80vh; overflow-y: auto;">
            <div class="save-slot">
                <h3>Â≠òÊ°£‰ΩçÁΩÆ 1</h3>
                <div class="slot-info">Á©∫Â≠òÊ°£</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="menu-button" onclick="saveGame(0)">‰øùÂ≠ò</button>
                    <button class="menu-button" onclick="confirmLoadGame(0)" disabled>Âä†ËΩΩ</button>
                    <button class="menu-button" onclick="deleteSave(0)" disabled>Âà†Èô§</button>
                </div>
            </div>
            <div class="save-slot">
                <h3>Â≠òÊ°£‰ΩçÁΩÆ 2</h3>
                <div class="slot-info">Á©∫Â≠òÊ°£</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="menu-button" onclick="saveGame(1)">‰øùÂ≠ò</button>
                    <button class="menu-button" onclick="confirmLoadGame(1)" disabled>Âä†ËΩΩ</button>
                    <button class="menu-button" onclick="deleteSave(1)" disabled>Âà†Èô§</button>
                </div>
            </div>
            <div class="save-slot">
                <h3>Â≠òÊ°£‰ΩçÁΩÆ 3</h3>
                <div class="slot-info">Á©∫Â≠òÊ°£</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="menu-button" onclick="saveGame(2)">‰øùÂ≠ò</button>
                    <button class="menu-button" onclick="confirmLoadGame(2)" disabled>Âä†ËΩΩ</button>
                    <button class="menu-button" onclick="deleteSave(2)" disabled>Âà†Èô§</button>
                </div>
            </div>
        </div>
        <button style="margin-top: 20px;" onclick="closeSaveLoadMenu()">ÂÖ≥Èó≠</button>
    </div> -->
    
    <div id="moreChallengesScreen" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">Êõ¥Â§öÊåëÊàò</h2>
        <div class="challenges-container">
            <div class="challenge-card" onclick="startTimeChallenge()">
                <h3>Êó∂Èó¥ÊåëÊàò</h3>
                <p>Âú®60ÁßíÂÜÖÂ∞ΩÂèØËÉΩÈÄöËøáÊõ¥Â§öÂÖ≥Âç°ÔºÅ</p>
                <div class="challenge-stats">ÊúÄ‰Ω≥ËÆ∞ÂΩï: <span id="timeChallengeBest">0</span>Áßí</div>
            </div>
            <div class="challenge-card" onclick="startPuzzleMode()">
                <h3>Ëß£Ë∞úÊ®°Âºè</h3>
                <p>Ëß£ÂºÄÁ≤æÂøÉËÆæËÆ°ÁöÑË∞úÈ¢òÂÖ≥Âç°„ÄÇ</p>
                <div class="challenge-stats">Â∑≤ÂÆåÊàê: <span id="puzzleCompleted">0</span>/10</div>
            </div>
        </div>
    </div>
    <!-- ÊàêÂ∞±Á≥ªÁªüÁïåÈù¢ -->
    <div id="achievementsScreen" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">ÊàêÂ∞±Á≥ªÁªü</h2>
        
        <div class="achievements-container">
            <div class="achievement-item" id="achievement1">
                <div class="achievement-icon">üèÜ</div>
                <div class="achievement-info">
                    <h3>Ëø∑ÂÆ´Â§ßÂ∏à</h3>
                    <p>ÈÄöÂÖ≥ÊâÄÊúâÂÖ≥Âç°</p>
                    <div class="achievement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress1"></div>
                        </div>
                        <span id="progressText1">0/80</span>
                    </div>
                </div>
                <div class="achievement-status" id="status1">Êú™ÂÆåÊàê</div>
            </div>
            
            <div class="achievement-item" id="achievement2">
                <div class="achievement-icon">üë•</div>
                <div class="achievement-info">
                    <h3>Á§æ‰∫§Ëææ‰∫∫</h3>
                    <p>ÈÄöÂÖ≥10Ê¨°Â§ö‰∫∫ËÅîÊú∫ÊåëÊàò</p>
                    <div class="achievement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress2"></div>
                        </div>
                        <span id="progressText2">0/10</span>
                    </div>
                </div>
                <div class="achievement-status" id="status2">Êú™ÂÆåÊàê</div>
            </div>
            
            <div class="achievement-item" id="achievement3">
                <div class="achievement-icon">üí•</div>
                <div class="achievement-info">
                    <h3>Èô∑Èò±‰∏ìÂÆ∂</h3>
                    <p>Ëµ∞Âà∞Èô∑Èò±30Ê¨°</p>
                    <div class="achievement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress3"></div>
                        </div>
                        <span id="progressText3">0/30</span>
                    </div>
                </div>
                <div class="achievement-status" id="status3">Êú™ÂÆåÊàê</div>
            </div>
            
            <!-- ÈöêËóèÊàêÂ∞±Ôºö‰ºüÂ§ßÁöÑÂõΩÂÆ∂ÔºåÂãøÂøòÂõΩËÄª -->
            <div class="achievement-item hidden" id="achievement4">
                <div class="achievement-icon">üá®üá≥</div>
                <div class="achievement-info">
                    <h3>‰ºüÂ§ßÁöÑÂõΩÂÆ∂ÔºåÂãøÂøòÂõΩËÄª</h3>
                    <p>‰ΩøÁî®‰∏≠ÂõΩÂõΩÊóóË°®ÊÉÖÂåÖ</p>
                    <div class="achievement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress4"></div>
                        </div>
                        <span id="progressText4">0/1</span>
                    </div>
                </div>
                <div class="achievement-status" id="status4">Êú™ÂÆåÊàê</div>
            </div>
        </div>
    </div>
    
    <!-- ÊØèÊó•ÊåëÊàòÁïåÈù¢ -->
    <div id="dailyChallengeScreen" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">ÊØèÊó•ÊåëÊàò</h2>
        
        <div class="daily-challenge-container">
            <div class="challenge-header">
                <div class="challenge-date" id="challengeDate"></div>
                <div class="challenge-countdown" id="challengeCountdown"></div>
            </div>
            
            <div class="challenge-card" id="currentChallengeCard">
                <div class="challenge-icon" id="challengeIcon">‚ö°</div>
                <div class="challenge-info">
                    <h3 class="challenge-title" id="challengeTitle">Âä†ËΩΩ‰∏≠...</h3>
                    <p class="challenge-description" id="challengeDescription">Ê≠£Âú®Ëé∑Âèñ‰ªäÊó•ÊåëÊàò</p>
                    <div class="challenge-rewards">
                        <span class="reward-item">ü™ô <span id="rewardCoins">0</span> ÈáëÂ∏Å</span>
                        <span class="reward-item">‚≠ê <span id="rewardStars">0</span> ÊòüÊòü</span>
                    </div>
                </div>
                <div class="challenge-status" id="challengeStatus">
                    <span class="status-pending">Êú™ÂÆåÊàê</span>
                </div>
            </div>
            
            <div class="challenge-details" id="challengeDetails">
                <h4>ÊåëÊàòÁõÆÊ†á</h4>
                <ul id="challengeGoals"></ul>
            </div>
            
            <div class="challenge-progress" id="challengeProgressSection" style="display: none;">
                <h4>ÂΩìÂâçËøõÂ∫¶</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <p class="progress-text" id="progressText">0 / 0</p>
            </div>
            
            <div class="challenge-actions">
                <button class="challenge-button primary" id="startChallengeBtn" onclick="startDailyChallenge()">ÂºÄÂßãÊåëÊàò</button>
                <button class="challenge-button secondary" id="claimRewardBtn" onclick="claimDailyReward()" style="display: none;">È¢ÜÂèñÂ•ñÂä±</button>
            </div>
            
            <div class="challenge-history">
                <h4>ÂéÜÂè≤ËÆ∞ÂΩï</h4>
                <div class="history-list" id="challengeHistory"></div>
            </div>
        </div>
    </div>
    
    <!-- ÂéÜÂè≤Êõ¥Êñ∞ -->
    <div id="historyUpdates" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">ÂéÜÂè≤Êõ¥Êñ∞</h2>
        
        <div class="updates-container">
            <!-- Êõ¥Êñ∞ÂÜÖÂÆπÂ∞ÜÁî±Áî®Êà∑Â°´ÂÜô -->
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.13.7</div>
                <div class="update-content">
                    <ul>
                        <li>Êñ∞Â¢ûÊØèÊó•ÊåëÊàòÁ≥ªÁªüÔºåÊèê‰æõ3Áßç‰∏çÂêåÁ±ªÂûãÁöÑÊåëÊàò‰ªªÂä°</li>
                        <li>‰ºòÂåñÂ§ö‰∫∫ËÅäÂ§©Á≥ªÁªüÔºåÁ°Æ‰øùÊ∂àÊÅØÊí§ÂõûÂäüËÉΩ‰ªÖÂèëÈÄÅËÄÖÂèØÁî®</li>
                        <li>ÊîπËøõÈü≥È¢ëÂΩïÂà∂Á®≥ÂÆöÊÄßÔºå‰øÆÂ§çÂΩïÈü≥ÂêéÈ∫¶ÂÖãÈ£éÊåÅÁª≠Âç†Áî®ÈóÆÈ¢ò</li>
                        <li>Â¢ûÂº∫Ê∂àÊÅØÂÆâÂÖ®ÊÄßÔºåÈôêÂà∂‰ªÖÊú¨‰∫∫ÂèØÊìç‰ΩúËá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØ</li>
                        <li>‰ºòÂåñBlobËµÑÊ∫êÂ§ÑÁêÜÔºåËß£ÂÜ≥Ë∑®‰ºöËØùÈü≥È¢ëÂä†ËΩΩÂ§±Ë¥•ÈóÆÈ¢ò</li>
                        <li>‰øÆÂ§çÂ§öÂ§ÑUIÊòæÁ§∫ÂºÇÂ∏∏ÔºåÊèêÂçáÊï¥‰Ωì‰∫§‰∫í‰ΩìÈ™å</li>
                    </ul>
                </div>
            </div>
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.11.5</div>
                <div class="update-content">
                    <ul>
                        <li>Êñ∞Â¢ûËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩÔºåÊîØÊåÅËØ≠Èü≥Ê∂àÊÅØËΩ¨Êç¢‰∏∫ÊñáÂ≠óÊòæÁ§∫</li>
                        <li>Ê∑ªÂä†‰∫ÜÂÆåÊï¥ÁöÑÊ∏∏ÊàèÂïÜÂ∫óÁ≥ªÁªüÔºåÂåÖÂê´ÂêÑÁßçÈÅìÂÖ∑ÂíåË£ÖÈ•∞ÂìÅ</li>
                        <li>‰ºòÂåñ‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑËØ≠Èü≥Ê∂àÊÅØÁ≥ªÁªüÁ®≥ÂÆöÊÄß</li>
                        <li>‰øÆÂ§ç‰∫ÜÂΩïÈü≥ÂäüËÉΩÁöÑÂ§ö‰∏™bugÔºåÊèêÂçáÁî®Êà∑‰ΩìÈ™å</li>
                        <li>ÊîπËøõ‰∫ÜÊàêÂ∞±Á≥ªÁªüÊòæÁ§∫ÁïåÈù¢</li>
                        <li>‰ºòÂåñ‰∫ÜÊ∏∏ÊàèÊï¥‰ΩìÊÄßËÉΩÂíåÂä†ËΩΩÈÄüÂ∫¶</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.10.4</div>
                <div class="update-content">
                    <ul>
                        <li>ÂÆåÂñÑ‰∫ÜËØ≠Èü≥Ê∂àÊÅØÁ≥ªÁªüÔºåÊîØÊåÅÊúÄÈïø60ÁßíÂΩïÈü≥</li>
                        <li>Ê∑ªÂä†‰∫ÜÂΩïÈü≥Áä∂ÊÄÅÂÆûÊó∂ÊòæÁ§∫ÂäüËÉΩ</li>
                        <li>‰ºòÂåñ‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑËøûÊé•Á®≥ÂÆöÊÄß</li>
                        <li>‰øÆÂ§ç‰∫ÜÊàøÈó¥Âä†ÂÖ•Êó∂ÁöÑÂç°Ê≠ªÈóÆÈ¢ò</li>
                        <li>ÊîπËøõ‰∫ÜÊ∏∏ÊàèÁïåÈù¢ÁöÑÂìçÂ∫îÈÄüÂ∫¶</li>
                        <li>Ê∑ªÂä†‰∫ÜÊõ¥Â§öÊ∏∏ÊàèÈÅìÂÖ∑ÂíåÂäüËÉΩ</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.9.1</div>
                <div class="update-content">
                    <ul>
                        <li>‰ºòÂåñ‰∫ÜËø∑ÂÆ´ÁîüÊàêÁÆóÊ≥ïÔºåÊèê‰æõÊõ¥Â§öÊ†∑ÂåñÁöÑÂú∞ÂõæÂ∏ÉÂ±Ä</li>
                        <li>ÊîπËøõ‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑÂêåÊ≠•Êú∫Âà∂</li>
                        <li>Ê∑ªÂä†‰∫ÜÊõ¥Â§öÁöÑÊ∏∏ÊàèËÆæÁΩÆÈÄâÈ°π</li>
                        <li>‰øÆÂ§ç‰∫ÜÂ§ö‰∏™Â∑≤Áü•ÁöÑÊ∏∏Êàèbug</li>
                        <li>ÊèêÂçá‰∫ÜÊ∏∏ÊàèÊï¥‰ΩìÁ®≥ÂÆöÊÄß</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.8.3 - ÊàøÈó¥ÊêúÁ¥¢ÔºàÁâπÊÆäÁâàÊú¨ÔºåÊú™ÂèëÂ∏ÉÔºâ</div>
                <div class="update-content">
                    <ul>
                        <li>Êñ∞Â¢ûÊàøÈó¥ÊêúÁ¥¢ÂäüËÉΩÔºåÊñπ‰æøÁé©ÂÆ∂Âø´ÈÄüÊâæÂà∞ÂèØÂä†ÂÖ•ÁöÑÊàøÈó¥</li>
                        <li>‰ºòÂåñ‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑÊàøÈó¥ÁÆ°ÁêÜÁ≥ªÁªü</li>
                        <li>ÊîπËøõ‰∫ÜÁé©ÂÆ∂ÂåπÈÖçÁÆóÊ≥ï</li>
                        <li>Ê∑ªÂä†‰∫ÜÊàøÈó¥‰ø°ÊÅØÊòæÁ§∫ÔºàÁé©ÂÆ∂Êï∞Èáè„ÄÅÊ∏∏ÊàèÁä∂ÊÄÅÁ≠âÔºâ</li>
                        <li>ÊèêÂçá‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑËøûÊé•ÈÄüÂ∫¶</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.7.4</div>
                <div class="update-content">
                    <ul>
                        <li>‰ºòÂåñ‰∫ÜÊ∏∏ÊàèÁïåÈù¢ÁöÑËßÜËßâÊïàÊûú</li>
                        <li>ÊîπËøõ‰∫ÜÁßªÂä®Á´ØËß¶Êéß‰ΩìÈ™å</li>
                        <li>‰øÆÂ§ç‰∫ÜÂ§ö‰∏™UIÊòæÁ§∫ÈóÆÈ¢ò</li>
                        <li>ÊèêÂçá‰∫ÜÊ∏∏ÊàèÊï¥‰ΩìÊÄßËÉΩ</li>
                        <li>‰ºòÂåñ‰∫Ü‰ª£Á†ÅÁªìÊûÑÂíåÂä†ËΩΩÊïàÁéá</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.7.1</div>
                <div class="update-content">
                    <ul>
                        <li>‰ºòÂåñ‰∫ÜÂ§ö‰∫∫Ê∏∏ÊàèÁöÑÁΩëÁªúÈÄö‰ø°</li>
                        <li>ÊîπËøõ‰∫ÜÊ∏∏ÊàèÁä∂ÊÄÅÁöÑÂêåÊ≠•Êú∫Âà∂</li>
                        <li>‰øÆÂ§ç‰∫ÜÈÉ®ÂàÜËÆæÂ§á‰∏äÁöÑÂÖºÂÆπÊÄßÈóÆÈ¢ò</li>
                        <li>ÊèêÂçá‰∫ÜÊ∏∏ÊàèËøêË°åÁ®≥ÂÆöÊÄß</li>
                        <li>‰ºòÂåñ‰∫ÜÂÜÖÂ≠ò‰ΩøÁî®ÊïàÁéá</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.6.5</div>
                <div class="update-content">
                    <ul>
                        <li>‰ºòÂåñ‰∫ÜÂçï‰∫∫Ê∏∏ÊàèÁöÑÂÖ≥Âç°ËÆæËÆ°</li>
                        <li>ÊîπËøõ‰∫ÜÊ∏∏ÊàèÁöÑÈöæÂ∫¶Âπ≥Ë°°</li>
                        <li>Ê∑ªÂä†‰∫ÜÊõ¥Â§öÁöÑÊ∏∏ÊàèÈü≥Êïà</li>
                        <li>‰ºòÂåñ‰∫ÜËø∑ÂÆ´ÁîüÊàêÁÆóÊ≥ï</li>
                        <li>ÊèêÂçá‰∫ÜÊ∏∏ÊàèÊï¥‰Ωì‰ΩìÈ™å</li>
                    </ul>
                </div>
            </div>
            
            <div class="update-item">
                <div class="update-title">ÁâàÊú¨ 1.4.2 - ÈöèÊú∫‰∫ã‰ª∂Á≥ªÁªü</div>
                <div class="update-content">
                    <ul>
                        <li>ÂºïÂÖ•‰∫ÜÈöèÊú∫‰∫ã‰ª∂Á≥ªÁªüÔºåÂ¢ûÂä†Ê∏∏ÊàèË∂£Âë≥ÊÄß</li>
                        <li>Ê∑ªÂä†‰∫ÜÊéßÂà∂ÂèçËΩ¨Á≠âÁâπÊÆä‰∫ã‰ª∂</li>
                        <li>‰ºòÂåñ‰∫ÜÊ∏∏ÊàèÂïÜÂ∫óÁ≥ªÁªü</li>
                        <li>ÊîπËøõ‰∫ÜÊàêÂ∞±Á≥ªÁªüÁöÑÊòæÁ§∫ÊïàÊûú</li>
                        <li>ÊèêÂçá‰∫ÜÊ∏∏ÊàèÁïåÈù¢ÁöÑÁæéËßÇÂ∫¶</li>
                        <li>‰øÆÂ§ç‰∫ÜÂ§ö‰∏™Ê∏∏ÊàèÊú∫Âà∂ÈóÆÈ¢ò</li>
                    </ul>
                </div>
            </div>
        
        </div>
    </div>
    
    <!-- Âçï‰∫∫Ê∏∏ÊàèÁïåÈù¢ -->
    <div id="singlePlayerLevelSelect" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">ÈÄâÊã©ÂÖ≥Âç°</h2>
        <div class="level-container" id="levelContainer"></div>
    </div>

    <div id="singlePlayerGame" class="hidden">
        <button class="settings-button" onclick="showUISettings()">‚öôÔ∏è</button>
        <div class="game-info" id="gameInfo">
            <div class="game-info-item" id="levelDisplay">ÂÖ≥Âç°: 1</div>
            <div class="game-info-item" id="timeDisplay">Êó∂Èó¥: 0:00</div>
            <div class="game-info-item" id="moveCount">ÁßªÂä®: 0</div>
            <div class="game-info-item" id="trapHit">Èô∑Èò±Ëß¶Âèë: 0</div>
            <div class="game-info-item" id="keyStatus">Èí•Âåô: Êú™Ëé∑Âæó</div>
            <div class="game-info-item" id="coinDisplay" style="display: none;">ÈáëÂ∏Å: 0</div>
        </div>
        <div id="enemyInfo" class="enemy-info hidden">ÁßªÂä®Êïå‰∫∫Ê≠£Âú®ËøΩÈÄê‰Ω†ÔºÅ</div>
        <div id="pathEnemyInfo" class="enemy-info hidden">ÂΩìÂâçÊúâÁßªÂä®Êïå‰∫∫ÔºåËØ∑ÂÅúÊ≠¢ÂâçËøõ„ÄÇ</div>
        <div id="keyInfo" class="key-info hidden">ÊâæÂà∞Èí•ÂåôÊâçËÉΩÂºÄÈó®ÔºÅ</div>
        <div id="unlockTimer" class="unlock-timer hidden">ÂºÄÈó®ÂÄíËÆ°Êó∂: 10Áßí</div>


        <canvas id="singlePlayerCanvas"></canvas>
        <div class="level-controls">
            <button class="level-control-button reset" onclick="resetSinglePlayerLevel()">ÈáçÁΩÆÂÖ≥Âç°</button>
            <button id="regularNextButton" class="level-control-button next" style="display:none;" onclick="loadNextLevel()">‰∏ã‰∏ÄÂÖ≥</button>
            <button id="unsolvableNextButton" class="level-control-button skip" style="display:none;" onclick="loadNextLevel()">Ë∑≥ËøáÊó†Ëß£ÂÖ≥Âç°</button>
            <button class="level-control-button save" onclick="saveGame()">üíæ ‰øùÂ≠òÊ∏∏Êàè</button>
            <!-- <button class="level-control-button exit" onclick="showExitConfirmation()">ÈÄÄÂá∫ÂÖ≥Âç°</button> -->
            <button class="level-control-button exit" onclick="showScreen('mainMenu')">ÈÄÄÂá∫ÂÖ≥Âç°</button>
            <button class="level-control-button shop-trigger" onclick="openShop()">üõí ÂïÜÂ∫ó</button>
        </div>
        <!-- ÊñπÂêëÈîÆÊéßÂà∂Èù¢Êùø -->
        <div class="controls-panel hidden" id="singlePlayerControls">
            <div class="drag-handle" id="mobileDragHandle"></div>
            <div class="control-button control-up" onclick="handleControlButtonClick('ArrowUp')">‚Üë</div>
            <div class="control-button control-left" onclick="handleControlButtonClick('ArrowLeft')">‚Üê</div>
            <div class="control-button control-right" onclick="handleControlButtonClick('ArrowRight')">‚Üí</div>
            <div class="control-button control-down" onclick="handleControlButtonClick('ArrowDown')">‚Üì</div>
        </div>
    </div>

    <div id="singlePlayerComplete" class="level-complete hidden">
        <h2>ÂÖ≥Âç°ÂÆåÊàê!</h2>
        <p id="singlePlayerCompleteTime">Áî®Êó∂: 0:00</p>
        <p id="singlePlayerCompleteMoves">ÁßªÂä®Ê¨°Êï∞: 0</p>
        <button onclick="loadNextLevel()">‰∏ã‰∏ÄÂÖ≥</button>
        <button onclick="showScreen('singlePlayerLevelSelect')">ÈÄâÊã©ÂÖ≥Âç°</button>
    </div>

    <!-- Â§ö‰∫∫Ê∏∏ÊàèÁïåÈù¢ -->
    <div id="multiplayerSetup" class="hidden">
        <div class="multiplayer-setup">
            <h2>Â§ö‰∫∫Ê∏∏ÊàèËÆæÁΩÆ</h2>
            <div>
                <input type="text" id="playerName" class="setup-input" placeholder="‰Ω†ÁöÑÂêçÂ≠ó" maxlength="10" value="Áé©ÂÆ∂">
            </div>
            <div>
                <label for="playerColor" class="setup-label">ÈÄâÊã©Â§¥ÂÉèÈ¢úËâ≤:</label>
                <input type="color" id="playerColor" class="setup-color-input" value="#FF6B6B">
            </div>
            <div>
                <input type="text" id="roomCode" class="setup-input" placeholder="ÊàøÈó¥‰ª£Á†Å (ÁïôÁ©∫ÂàõÂª∫Êñ∞ÊàøÈó¥)">
            </div>
            <div>
                <input type="password" id="roomPassword" class="setup-input" placeholder="ÊàøÈó¥ÂØÜÁ†Å (ÂèØÈÄâ)">
            </div>
            <div class="room-settings">
                <h4>ÊàøÈó¥ËÆæÁΩÆ (‰ªÖÂàõÂª∫ÊàøÈó¥Êó∂ÊúâÊïà)</h4>
                <div class="setting-row">
                    <label for="maxPlayers">ÊúÄÂ§ß‰∫∫Êï∞:</label>
                    <select id="maxPlayers" class="setup-input">
                        <option value="2">2‰∫∫</option>
                        <option value="3">3‰∫∫</option>
                        <option value="4">4‰∫∫</option>
                        <option value="5">5‰∫∫</option>
                        <option value="6">6‰∫∫</option>
                        <option value="7">7‰∫∫</option>
                        <option value="8">8‰∫∫</option>
                    </select>
                </div>
            </div>
            <div id="roomStatus" style="margin: 10px 0; color: #4CAF50;"></div>
            <button class="menu-button" onclick="connectToMultiplayerGame()" id="multiplayerStartBtn">ÂºÄÂßãÊ∏∏Êàè</button>
            <button class="menu-button" onclick="openRoomBrowserModal()">ÊµèËßàÊàøÈó¥</button>
            <button class="menu-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        </div>
    </div>
    
    <!-- ÊàøÈó¥ÊµèËßàÂô®Ê®°ÊÄÅÊ°Ü -->
    <div id="roomBrowserModal" class="room-browser-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 99999; display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto;">
        <div class="room-browser-content" style="background: rgba(30, 30, 30, 0.95); border: 2px solid #4CAF50; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 20001;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 60px; margin-right: 15px;">üè†</div>
                <div>
                    <h2 style="color: #4CAF50; margin: 0 0 5px 0; font-size: 24px;">ÊµèËßàÊàøÈó¥</h2>
                    <p style="color: #ccc; margin: 0; font-size: 14px;">Êü•ÊâæÂπ∂Âä†ÂÖ•ÂÖ¨ÂºÄÊàøÈó¥</p>
                </div>
                <button onclick="closeRoomBrowserModal()" style="background: none; border: none; color: #aaa; font-size: 28px; cursor: pointer; padding: 5px; border-radius: 5px;">√ó</button>
            </div>
            
            <div class="search-container" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="roomBrowserSearch" style="flex: 1; min-width: 200px; padding: 12px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(76, 175, 80, 0.5); border-radius: 5px; color: white; font-size: 16px;" placeholder="ÊêúÁ¥¢ÊàøÈó¥ÊàñÊàø‰∏ª">
                <button onclick="searchRoomsInModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; white-space: nowrap;">ÊêúÁ¥¢</button>
                <button onclick="loadRoomsInModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; white-space: nowrap;">Âà∑Êñ∞</button>
            </div>
            
            <div id="roomBrowserStatus" style="margin-bottom: 15px; color: #4CAF50; font-size: 14px;"></div>
            
            <div id="roomBrowserList" class="room-browser-list" style="flex: 1; max-height: 400px; overflow-y: auto; background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                <!-- ÊàøÈó¥ÂàóË°®Â∞ÜÁî±JavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="closeRoomBrowserModal()" style="padding: 15px 40px; background: linear-gradient(135deg, #757575, #616161); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div id="multiplayerGame" class="hidden">
        <button class="settings-button" onclick="showUISettings()">‚öôÔ∏è</button>
        <div class="player-list" id="playerList">
            <h3>Áé©ÂÆ∂ÂàóË°®</h3>
            <div id="playersContainer"></div>
        </div>
        <div class="game-info" id="multiplayerGameInfo">
            <div class="game-info-item" id="multiplayerRoomCode">ÊàøÈó¥: </div>
            <div class="game-info-item" id="multiplayerTimeDisplay">Êó∂Èó¥: 0:00</div>
            <div class="game-info-item" id="multiplayerMoveCount">ÁßªÂä®: 0</div>
            <div class="game-info-item" id="multiplayerPlayerCount">Áé©ÂÆ∂: 0/0</div>
        </div>
        <div id="connectionStatus" class="connection-status connected">Â∑≤ËøûÊé•</div>
        <!-- ËÅäÂ§©ÊåâÈíÆ -->
        <button id="chatButton" class="chat-button" onclick="openChatModal()" style="position: absolute; bottom: 20px; left: 20px; padding: 10px 15px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; z-index: 10;">üí¨ ËÅäÂ§©</button>
        <!-- ËÅäÂ§©Á≥ªÁªü -->
        <div id="chatContainer" class="chat-container" style="display: none;">
            <div id="chatMessages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; font-family: monospace;"></div>
            <div style="display: flex; padding: 5px;">
                <textarea id="chatInput" class="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." style="flex: 1.5; padding: 8px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; outline: none; resize: none; min-height: 36px; max-height: 100px;"></textarea>
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                <button id="imageButton" class="image-button" onclick="document.getElementById('imageInput').click()" style="margin-left: 5px; padding: 8px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">üñºÔ∏è</button>
                <button id="emojiButton" class="emoji-button" onclick="toggleEmojiPicker()" style="margin-left: 5px; padding: 8px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">üòä</button>
                <button id="voiceButton" class="voice-button" onclick="toggleVoiceRecording()" style="margin-left: 5px; padding: 8px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">üé§</button>


                <button id="sendButton" class="send-button" onclick="sendChatMessage()" style="margin-left: 5px; padding: 8px 12px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer;">ÂèëÈÄÅ</button>
            </div>
        </div>
        <!-- Ë°®ÊÉÖÂåÖÈÄâÊã©Èù¢Êùø -->
        <div id="emojiPicker" class="emoji-picker" style="display: none; position: fixed; bottom: 100px; left: 20px; width: 300px; max-height: 200px; background: rgba(0, 0, 0, 0.9); border: 1px solid #4CAF50; border-radius: 10px; padding: 10px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; z-index: 6000;"></div>
        
        <!-- Èü≥È¢ëÂÖÉÁ¥†ÔºåÁî®‰∫éÊí≠ÊîæËÉåÊôØÈü≥‰πê -->
        <audio id="gameAudio" loop preload="auto">
            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
        </audio>
        
        <!-- Èü≥È¢ëÊñá‰ª∂ÈÄâÊã©ËæìÂÖ•Ê°Ü -->
        <input type="file" id="musicFileInput" accept="audio/*" style="display: none;" onchange="handleMusicFileSelect(event)">
        
        <!-- ÂÖ®Â±èËÅäÂ§©Ê®°ÊÄÅÊ°Ü -->
        <div id="chatModal" class="chat-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: none; flex-direction: column;">
            <!-- ËÅäÂ§©Â§¥ÈÉ® -->
            <div class="chat-header" style="padding: 15px; background: rgba(76, 175, 80, 0.2); border-bottom: 1px solid #4CAF50; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">ËÅäÂ§©Á™óÂè£</h2>
                <button id="closeChatModal" onclick="closeChatModal()" style="background: rgba(244, 67, 54, 0.8); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            
            <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
            <div id="chatMessagesModal" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; font-size: 16px; font-family: monospace;"></div>
            
            <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
            <div class="chat-input-area" style="padding: 20px; border-top: 1px solid #4CAF50; display: flex; gap: 10px; background: rgba(0, 0, 0, 0.8);">
                <textarea id="chatInputModal" class="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." style="flex: 1.5; padding: 12px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; outline: none; font-size: 16px; resize: none; min-height: 40px; max-height: 150px;"></textarea>
                <input type="file" id="imageInputModal" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                <button id="imageButtonModal" class="image-button" onclick="document.getElementById('imageInputModal').click()" style="padding: 12px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px;">üñºÔ∏è</button>
                <button id="emojiButtonModal" class="emoji-button" onclick="toggleEmojiPicker()" style="padding: 12px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px;">üòä</button>
                <button id="voiceButtonModal" class="voice-button" onclick="toggleVoiceRecording()" style="padding: 12px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px;">üé§</button>


                <button id="sendButtonModal" class="send-button" onclick="sendChatMessage()" style="padding: 12px 20px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">ÂèëÈÄÅ</button>
            </div>
        </div>

        <!-- ÂΩïÈü≥Áä∂ÊÄÅÊ®°ÊÄÅÊ°Ü -->
        <div id="recordingModal" class="recording-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center;">
            <div class="recording-content" style="text-align: center;">
                <div class="recording-icon" style="font-size: 80px; margin-bottom: 20px; animation: pulse 1s infinite;">üé§</div>
                <div class="recording-status" style="color: #4CAF50; font-size: 28px; margin-bottom: 10px;">Ê≠£Âú®ÂΩïÈü≥</div>
                <div id="recordingTimer" class="recording-timer" style="color: #fff; font-size: 48px; font-family: monospace; margin-bottom: 30px;">00:00</div>
                <div class="recording-progress" style="width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-bottom: 30px; overflow: hidden;">
                    <div id="recordingProgress" class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #2E7D32); transition: width 0.3s;"></div>
                </div>
                <div class="recording-buttons" style="display: flex; gap: 20px; justify-content: center;">
                    <button id="pauseRecordingBtn" class="recording-btn" onclick="togglePauseRecording()" style="padding: 15px 40px; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 18px;">‚è∏Ô∏è ÊöÇÂÅú</button>
                    <button id="stopRecordingBtn" class="recording-btn" onclick="stopVoiceRecording()" style="padding: 15px 40px; background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 18px;">‚èπÔ∏è ÂÅúÊ≠¢</button>
                </div>
                <div class="recording-hint" style="color: #888; font-size: 14px; margin-top: 20px;">ÁÇπÂáªÂÅúÊ≠¢ÂèëÈÄÅËØ≠Èü≥ÔºåÁÇπÂáªÊöÇÂÅúÊöÇÊó∂ÂÅúÊ≠¢ÂΩïÈü≥</div>
            </div>
        </div>
        
        <!-- Èü≥‰πêÊí≠ÊîæÁ°ÆËÆ§ÂºπÁ™ó -->
        <div id="musicPlayConfirmModal" class="music-confirm-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 15000; display: none; flex-direction: column; justify-content: center; align-items: center;">
            <div class="music-confirm-content" style="background: rgba(30, 30, 30, 0.95); border: 2px solid #4CAF50; border-radius: 15px; padding: 30px; max-width: 400px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 20px;">üéµ</div>
                <h2 style="color: #4CAF50; margin: 0 0 15px 0; font-size: 24px;">Èü≥‰πêÊí≠ÊîæËØ∑Ê±Ç</h2>
                <p style="color: #ccc; margin: 0 0 25px 0; font-size: 16px; line-height: 1.5;">ÊúâÁé©ÂÆ∂ÊÉ≥Ë¶ÅÊí≠ÊîæËÉåÊôØÈü≥‰πêÔºåÊòØÂê¶ÂêåÊÑèÊí≠ÊîæÔºü</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="acceptMusicBtn" onclick="acceptMusicPlay()" style="padding: 15px 40px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">ÂêåÊÑèÊí≠Êîæ</button>
                    <button id="rejectMusicBtn" onclick="rejectMusicPlay()" disabled style="padding: 15px 40px; background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 25px; cursor: not-allowed; font-size: 16px; font-weight: bold; opacity: 0.5;">ÊãíÁªù (<span id="rejectCountdown">10</span>Áßí)</button>
                </div>
            </div>
        </div>
        
        <!-- Ë∏¢Âá∫Áé©ÂÆ∂ÁïåÈù¢ -->
        <div id="kickPlayerModal" class="kick-player-modal hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 16000; display: none; flex-direction: column; justify-content: center; align-items: center;">
            <div class="kick-player-content" style="background: rgba(30, 30, 30, 0.95); border: 2px solid #FF5252; border-radius: 15px; padding: 30px; max-width: 500px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 20px;">üë•</div>
                <h2 style="color: #FF5252; margin: 0 0 15px 0; font-size: 24px;">Ë∏¢Âá∫Áé©ÂÆ∂</h2>
                <p style="color: #ccc; margin: 0 0 25px 0; font-size: 16px;">ÈÄâÊã©Ë¶ÅË∏¢Âá∫ÁöÑÁé©ÂÆ∂Ôºö</p>
                <div id="kickPlayerList" class="kick-player-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 15px;">
                    <!-- Áé©ÂÆ∂ÂàóË°®Â∞ÜÁî±JavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="closeKickPlayerModal()" style="padding: 15px 40px; background: linear-gradient(135deg, #757575, #616161); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <canvas id="multiplayerCanvas"></canvas>
        <div class="level-controls" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; z-index: 10; background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 25px; border: 1px solid #4CAF50;">
            <button class="level-control-button reset" onclick="resetMultiplayerPlayer()">ÈáçÁΩÆ‰ΩçÁΩÆ</button>
            <button class="level-control-button shop-trigger" onclick="openShop()">üõí ÂïÜÂ∫ó</button>
            <button class="level-control-button exit" onclick="disconnectMultiplayer()">ÈÄÄÂá∫Ê∏∏Êàè</button>
        </div>
        <!-- ÊñπÂêëÈîÆÊéßÂà∂Èù¢Êùø -->
        <div class="controls-panel hidden" id="multiplayerControls">
            <div class="drag-handle" id="mobileMultiplayerDragHandle"></div>
            <div class="control-button control-up" onclick="handleControlButtonClick('ArrowUp')">‚Üë</div>
            <div class="control-button control-left" onclick="handleControlButtonClick('ArrowLeft')">‚Üê</div>
            <div class="control-button control-right" onclick="handleControlButtonClick('ArrowRight')">‚Üí</div>
            <div class="control-button control-down" onclick="handleControlButtonClick('ArrowDown')">‚Üì</div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèËØ¥ÊòéÂºπÁ™ó -->
    <div id="instructionsModal" class="instructions-modal hidden">
        <h2>Ê∏∏ÊàèËØ¥Êòé</h2>
        <p><strong>Âçï‰∫∫Ê®°ÂºèÔºö</strong>80‰∏™Áã¨ÁâπÂÖ≥Âç°ÔºåÈöæÂ∫¶ÈÄíÂ¢û„ÄÇ‰ΩøÁî®ÊñπÂêëÈîÆÁßªÂä®ËßíËâ≤ÔºåÈÅøÂºÄÈô∑Èò±ÔºåÊâæÂà∞Âá∫Âè£„ÄÇ</p>
        <p><strong style="color: #4CAF50">Â§ö‰∫∫Ê®°ÂºèÔºö</strong>‰∏éÊúãÂèãÂêà‰ΩúÊàñÁ´û‰∫â„ÄÇÂàõÂª∫ÊàøÈó¥ÊàñÂä†ÂÖ•Â∑≤ÊúâÊàøÈó¥ÔºåÂÖ±ÂêåÂÆåÊàêËø∑ÂÆ´ÊåëÊàò„ÄÇ</p>
        <p><strong>Ëø∑ÂÆ´ÂÖÉÁ¥†Ôºö</strong></p>
        <ul>
            <li>ÁªøËâ≤ÔºöÁé©ÂÆ∂</li>
            <li>Á∫¢Ëâ≤ÔºöÂá∫Âè£</li>
            <li>ÈªÑËâ≤ÔºöÈô∑Èò±ÔºàËß¶Á¢∞ÂêéÂõûÂà∞Ëµ∑ÁÇπÔºâ</li>
            <li>ÈùíËâ≤Ôºö‰º†ÈÄÅÈó®ÔºàÈöèÊú∫‰º†ÈÄÅÂà∞Âè¶‰∏Ä‰∏™‰º†ÈÄÅÈó®Ôºâ</li>
            <li>Á¥´Ëâ≤ÔºöÁßªÂä®Èô∑Èò±Ôºà‰ºöÁßªÂä®ÁöÑÂç±Èô©Âå∫ÂüüÔºâ</li>
            <li><span style="color: #f44336">Á∫¢Ëâ≤Èó™ÁÉÅË≠¶Âëä</span>ÔºöÁßªÂä®Êïå‰∫∫Ê≠£Âú®ËøΩÈÄê‰Ω†ÔºÅ</li>
            <li><span style="color: gold">ÈáëËâ≤</span>ÔºöÈí•ÂåôÔºàÁâπÊÆäÂÖ≥Âç°ÈúÄË¶ÅÈí•ÂåôÊâçËÉΩÂºÄÈó®Ôºâ</li>
            <li><span style="color: #8B4513">Ê£ïËâ≤</span>ÔºöÈó®ÔºàÈúÄË¶ÅÈí•ÂåôÊâçËÉΩÊâìÂºÄÔºâ</li>
        </ul>
        <p><strong>ÁâπÊÆäÂÖ≥Âç°Ôºö</strong></p>
        <ul>
            <li>Á¨¨30ÂÖ≥Âíå60ÂÖ≥‰∏∫Ëû∫ÊóãËø∑ÂÆ´Ôºå‰∏≠ÂøÉÊòØÂá∫Âè£ÔºåÂπ∂ÊúâÁßªÂä®Êïå‰∫∫ËøΩÈÄêÁé©ÂÆ∂ÔºÅ</li>
            <li>ÁâπÊÆäÂÖ≥Âç°ÈúÄË¶ÅÊâæÂà∞Èí•ÂåôÊâçËÉΩÂºÄÈó®ÔºåÊãøÂà∞Èí•ÂåôÂêéÈúÄË¶Å10ÁßíÂÄíËÆ°Êó∂ÊâçËÉΩÂºÄÈó®</li>
        </ul>
        <button onclick="document.getElementById('instructionsModal').classList.add('hidden')">ÂÖ≥Èó≠</button>
    </div>
    
    <!-- UIËÆæÁΩÆÈù¢Êùø -->
    <div id="uiSettingsModal" class="settings-modal hidden">
        <h2>UIËÆæÁΩÆ</h2>

    <!-- Èü≥‰πêËß£ÈîÅÊ®°ÊÄÅÊ°Ü -->
    <div id="musicUnlockModal" class="settings-modal hidden">
        <h2>Èü≥‰πêËß£ÈîÅ</h2>
        <p>ËØ∑ËæìÂÖ•ÂØÜÁ†ÅËß£ÈîÅÈü≥‰πêÊí≠ÊîæÂô®</p>
        <input type="password" id="musicPasswordInput" placeholder="ËæìÂÖ•ÂØÜÁ†Å" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
        <div class="error-message" id="passwordError" style="color: red; display: none; margin-bottom: 15px;">ÂØÜÁ†ÅÈîôËØØ</div>
        <button onclick="validateMusicPassword()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Ëß£ÈîÅ</button>
    </div>
        
        <div class="setting-group">
            <h3>ÊéßÂà∂Èù¢Êùø</h3>
            <label for="showControlsCheckbox">
                <input type="checkbox" id="showControlsCheckbox"> ÊòæÁ§∫ÊéßÂà∂Èù¢Êùø
            </label>
            
            <div class="setting-row">
                <label for="controlsPosition">‰ΩçÁΩÆ:</label>
                <select id="controlsPosition">
                    <option value="bottom-left">Â∑¶‰∏ãËßí</option>
                    <option value="bottom-right">Âè≥‰∏ãËßí</option>
                    <option value="top-left">Â∑¶‰∏äËßí</option>
                    <option value="top-right">Âè≥‰∏äËßí</option>
                    <option value="custom">Ëá™ÂÆö‰πâÔºàÂÆûÈ™åÊÄßÂäüËÉΩÔºâ</option>
                </select>
            </div>
            
            <div class="setting-row">
                <label for="controlsSize">Â§ßÂ∞è:</label>
                <input type="range" id="controlsSize" min="80" max="150" value="100">
            </div>
            
            <div class="setting-row">
                <label for="controlsOpacity">ÈÄèÊòéÂ∫¶:</label>
                <input type="range" id="controlsOpacity" min="30" max="100" value="60">
            </div>
        </div>
        
        <div class="setting-group">
            <h3>Ê∏∏Êàè‰ø°ÊÅØ</h3>
            <label for="showGameInfoCheckbox">
                <input type="checkbox" id="showGameInfoCheckbox" checked> ÊòæÁ§∫Ê∏∏Êàè‰ø°ÊÅØ
            </label>
            
            <div class="info-settings">
                <div class="setting-checkbox">
                    <input type="checkbox" id="showLevelInfo" checked>
                    <label for="showLevelInfo">ÂÖ≥Âç°‰ø°ÊÅØ</label>
                </div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showTimeInfo" checked>
                    <label for="showTimeInfo">Êó∂Èó¥‰ø°ÊÅØ</label>
                </div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showMoveInfo" checked>
                    <label for="showMoveInfo">ÁßªÂä®Ê¨°Êï∞</label>
                </div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showKeyInfo" checked>
                    <label for="showKeyInfo">Èí•ÂåôÁä∂ÊÄÅ</label>
                </div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showRoomInfo" checked>
                    <label for="showRoomInfo">ÊàøÈó¥‰ª£Á†Å</label>
                </div>
            </div>
        </div>
        <div class="setting-group">
            <h3>Â§ö‰∫∫Ê∏∏ÊàèËÆæÁΩÆ</h3>
            <label for="showPlayerListCheckbox">
                <input type="checkbox" id="showPlayerListCheckbox" checked>
                ÊòæÁ§∫Áé©ÂÆ∂ÂàóË°®
            </label>
        </div>

        <div class="setting-group">
            <h3>Èü≥‰πêÊí≠ÊîæÂô®</h3>
            <label for="musicEnabledCheckbox">
                <input type="checkbox" id="musicEnabledCheckbox"> ÂêØÁî®Èü≥‰πê
            </label>
            <div class="setting-row">
                <label for="musicVolume">Èü≥Èáè:</label>
                <input type="range" id="musicVolume" min="0" max="100" value="50">
            </div>
            <div class="setting-row">
                <label>Èü≥‰πêÈÄâÊã©:</label>
                <div id="musicSelectionList" style="display: flex; flex-direction: column; gap: 6px; max-height: 150px; overflow-y: auto; padding: 6px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(0, 0, 0, 0.3); font-size: 14px;">
                    <!-- ÈªòËÆ§Èü≥‰πêÈÄâÈ°π -->
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-1" checked> Ê∏∏ÊàèÈü≥‰πê 1
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-2"> Ê∏∏ÊàèÈü≥‰πê 2
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-3"> Ê∏∏ÊàèÈü≥‰πê 3
                        </label>
                    </div>
                    <!-- Ëá™ÂÆö‰πâÈü≥‰πêÂ∞ÜÂä®ÊÄÅÊ∑ªÂä†Âú®ËøôÈáå -->
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button id="deleteCustomMusicBtn" onclick="deleteSelectedCustomMusic()" disabled>Âà†Èô§ÈÄâ‰∏≠È°π</button>
                    <button onclick="deleteAllCustomMusic()" disabled id="deleteAllMusicBtn">Âà†Èô§ÊâÄÊúâËá™ÂÆö‰πâÈü≥‰πê</button>
                </div>
            </div>
            <div class="setting-row">
                <label for="customMusicFile">ÂØºÂÖ•Ëá™ÂÆö‰πâÈü≥‰πê:</label>
                <div>
                    <input type="text" id="customMusicName" placeholder="Èü≥‰πêÂêçÁß∞" style="width: 150px; margin-right: 10px;">
                    <input type="file" id="customMusicFile" accept=".mp3" style="margin-right: 10px;">
                    <button onclick="importCustomMusic()">ÂØºÂÖ•</button>
                </div>
            </div>
            <div class="music-controls">
                <button id="musicPlay">‚ñ∂Ô∏è Êí≠Êîæ</button>
                <button id="musicPause">‚è∏Ô∏è ÊöÇÂÅú</button>
                <button id="musicStop">‚èπÔ∏è ÂÅúÊ≠¢</button>
            </div>
        </div>

        <div class="buttons">
            <button onclick="saveUISettings()">‰øùÂ≠ò</button>
            <button onclick="document.getElementById('uiSettingsModal').classList.add('hidden')">ÂèñÊ∂à</button>
            <button onclick="checkServerVersion()">Ê£ÄÊü•ÁâàÊú¨</button>
        </div>
    </div>
    
    <!-- Èü≥‰πêËß£ÈîÅÊ®°ÊÄÅÊ°Ü -->
    <div id="musicUnlockModal" class="settings-modal hidden">
        <h2>Èü≥‰πêËß£ÈîÅ</h2>
        <p>ËØ∑ËæìÂÖ•ÂØÜÁ†ÅËß£ÈîÅÈü≥‰πêÊí≠ÊîæÂô®</p>
        <input type="password" id="musicPasswordInput" placeholder="ËæìÂÖ•ÂØÜÁ†Å" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
        <div class="error-message" id="passwordError" style="color: red; display: none; margin-bottom: 15px;">ÂØÜÁ†ÅÈîôËØØ</div>
        <button onclick="validateMusicPassword()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Ëß£ÈîÅ</button>
    </div>
    
    <!-- ÂºÄÂèëËÄÖÊéßÂà∂Âè∞ -->
    <div id="console" class="console-container console-hidden">
        <div class="console-header">
            <div class="console-title">ÂºÄÂèëËÄÖÊéßÂà∂Âè∞</div>
            <button class="console-close" onclick="toggleConsole()">√ó</button>
        </div>
        <div class="console-output" id="consoleOutput">> Ê¨¢Ëøé‰ΩøÁî®ÂºÄÂèëËÄÖÊéßÂà∂Âè∞
> ËæìÂÖ• 'help' Êü•ÁúãÂèØÁî®ÂëΩ‰ª§</div>
        <div class="console-input-group">
            <div class="console-prompt">></div>
            <input type="text"class="console-input"id="consoleInput"placeholder="ËæìÂÖ•ÂëΩ‰ª§...">
        </div>
    </div>

    <!-- ÊéßÂà∂Âè∞ÂØÜÁ†ÅËæìÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="consolePasswordModal" class="settings-modal hidden">
        <h2>ÊéßÂà∂Âè∞ÂØÜÁ†Å</h2>
        <p>ËØ∑ËæìÂÖ•ÊéßÂà∂Âè∞ÂØÜÁ†ÅÔºö</p>
        <input type="password" id="consolePasswordInput" placeholder="ËæìÂÖ•ÂØÜÁ†Å" style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px;" />
        <div style="display: flex; justify-content: center; gap: 20px;">
            <button class="menu-button" onclick="checkConsolePassword()" ontouchstart="checkConsolePassword()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">Á°ÆËÆ§</button>
            <button class="menu-button" onclick="closeConsolePasswordModal()" ontouchstart="closeConsolePasswordModal()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">ÂèñÊ∂à</button>
        </div>
    </div>


    <div id="consoleModal" class="settings-modal hidden">
        <h2>JavaScriptÊéßÂà∂Âè∞</h2>
        <div id="consoleContent" style="background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; margin: 15px 0; font-family: monospace; font-size: 14px; line-height: 1.4; color: #fff;">
        </div>
        <div style="display: flex; margin: 15px 0; gap: 10px;">
            <input type="text" id="consoleCommandInput" placeholder="ËæìÂÖ•JavaScriptÂëΩ‰ª§..." style="flex: 1; padding: 10px; border: 1px solid #4CAF50; border-radius: 5px; background: rgba(255,255,255,0.1); color: #fff; font-family: monospace; font-size: 14px;" />
            <button class="menu-button" onclick="executeConsoleCommand()" ontouchstart="executeConsoleCommand()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">ÊâßË°å</button>
        </div>
        <div style="display: flex; justify-content: center; gap: 20px;">
            <button class="menu-button" onclick="refreshConsole()" ontouchstart="refreshConsole()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">Âà∑Êñ∞</button>
            <button class="menu-button" onclick="closeConsoleModal()" ontouchstart="closeConsoleModal()" style="cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="replayModal" class="modal hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header">
                <h2>Ê∏∏ÊàèÂõûÊîæÂ∫ì</h2>
                <button class="close-btn" onclick="closeReplayModal()">√ó</button>
            </div>
            <div class="replay-controls">
                <div class="filter-group">
                    <select id="replayFilter">
                        <option value="all">ÂÖ®ÈÉ®ÂΩïÂÉè</option>
                        <option value="recent">ÊúÄËøë‰∏ÄÂë®</option>
                        <option value="best">ÊúÄ‰Ω≥ÈÄöÂÖ≥</option>
                    </select>
                </div>
            </div>
            
            <div class="replay-list" id="replayList">
                <!-- Âä®ÊÄÅÁîüÊàêÂΩïÂÉèÂàóË°® -->
            </div>
            
            <div class="player-container hidden" id="playerContainer">
                <div class="player-header">
                    <h3 id="replayTitle">ÂÖ≥Âç°1 - 2023-07-15</h3>
                    <button onclick="exitPlayer()">ËøîÂõûÂàóË°®</button>
                </div>
                
                <div class="video-container">
                    <canvas id="replayCanvas"></canvas>
                    
                    <div class="player-controls">
                        <button onclick="seekBack()">‚è™ 5Áßí</button>
                        <button onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è Êí≠Êîæ</button>
                        <button onclick="seekForward()">‚è© 5Áßí</button>
                        <span id="timeDisplay">00:00 / 02:30</span>
                        
                        <div class="speed-control">
                            <select id="playbackSpeed">
                                <option value="0.5">0.5√ó</option>
                                <option value="1" selected>1√ó</option>
                                <option value="2">2√ó</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <progress id="replayProgress" value="0" max="100"></progress>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="event-notifications"></div>
    
    <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div id="imagePreviewModal" class="image-preview-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 7000; display: none; justify-content: center; align-items: center;">
        <div class="image-preview-content" style="position: relative; max-width: 90%; max-height: 90%;">
            <img id="previewImage" src="" alt="ÂõæÁâáÈ¢ÑËßà" style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 10px;">
            <button id="closePreview" class="close-preview" style="position: absolute; top: -30px; right: -30px; background: rgba(244, 67, 54, 0.8); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer;">√ó</button>
            <button id="downloadImage" class="download-preview" style="position: absolute; bottom: -30px; right: 50%; transform: translateX(50%); background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer; font-size: 14px;">‰∏ãËΩΩÂõæÁâá</button>
        </div>
    </div>
    
    <!-- ÁâàÊú¨‰ø°ÊÅØÊòæÁ§∫ -->
    <div id="versionInfo" class="version-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 100;">Ëø∑ÂÆ´ÂÜíÈô© - 1.13.7</div>
    <script>
const CLIENT_VERSION = "1.13.7";
const GAME_SERVER_URL = 'https://maze-game-apiserver.onrender.com'; // ÊúçÂä°Âô®URLÔºåÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµ‰øÆÊîπ
async function checkServerVersion() {
    const button = event.target; // Ëé∑ÂèñË¢´ÁÇπÂáªÁöÑÊåâÈíÆÊú¨Ë∫´
    const originalText = button.textContent;
    
    // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    button.disabled = true;
    button.textContent = 'Ê£ÄÊü•‰∏≠...';
    
    showNotification('Ê≠£Âú®Ê£ÄÊü•ÊúçÂä°Âô®ËøûÊé•...', 3000);

    try {
        const fullUrl = GAME_SERVER_URL + '/api/version-check';

        // ===== ‰øÆÊîπÁÇπÔºöÂú® fetch ËØ∑Ê±Ç‰∏≠Ê∑ªÂä†Ëá™ÂÆö‰πâÂ§¥‰ø°ÊÅØ =====
        const response = await fetch(fullUrl, {
            method: 'GET', // GET ËØ∑Ê±Ç‰πüÂèØ‰ª•Â∏¶ headers
            headers: {
                // 'Content-Type': 'application/json', // GET ËØ∑Ê±ÇÈÄöÂ∏∏‰∏çÈúÄË¶ÅËøô‰∏™
                'Client-Version': CLIENT_VERSION // Ëá™ÂÆö‰πâÁöÑËØ∑Ê±ÇÂ§¥ÔºåÈîÆ‰∏∫ 'Client-Version', ÂÄº‰∏∫Êàë‰ª¨ÁöÑÁâàÊú¨Âè∑
            }
        });

        if (!response.ok) {
            throw new Error(`ÊúçÂä°Âô®ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('ÊúçÂä°Âô®ÁâàÊú¨Ê£ÄÊü•ÁªìÊûú:', data);

        // Ê†πÊçÆËøîÂõûÁöÑÁä∂ÊÄÅÂ§ÑÁêÜÁªìÊûú
        switch(data.status) {
            case 'ok':
                showNotification(`‚úÖ ÁâàÊú¨Ê£ÄÊü•ÊàêÂäüÔºÅÂΩìÂâçÁâàÊú¨: ${data.version}`, 4000);
                break;
            case 'outdated':
                 // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÊúçÂä°Âô®ÁâàÊú¨
                 const serverVerMsg = data.serverVersion ? `\nÊúçÂä°Âô®ÊúÄÊñ∞ÁâàÊú¨: ${data.serverVersion}` : '';
                 const message = `‚ö†Ô∏è ÊèêÁ§∫: ÊÇ®ÁöÑÊ∏∏ÊàèÁâàÊú¨Â∑≤ËøáÊó∂ÔºÅ${serverVerMsg}\n\nËØ∑Âà∑Êñ∞È°µÈù¢ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëòÊõ¥Êñ∞Ê∏∏Êàè„ÄÇ`;
                 alert(message);
                 showNotification('ËØ∑Á´ãÂç≥Êõ¥Êñ∞Ê∏∏Êàè‰ª•‰øùËØÅ‰ΩìÈ™åÔºÅ', 7000);
                 break;
            case 'error':
            default:
                 showNotification(`‚ùå ÈîôËØØ: ${data.message || 'ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈîôËØØ‰ø°ÊÅØ'}`, 5000);
        }

    } catch (error) {
        console.error('ÁâàÊú¨Ê£ÄÊü•ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        showNotification(`‚ùå Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºÅ\nËØ∑Á°Æ‰øùÊúçÂä°Âô®Ê≠£Âú®ËøêË°å‰∏îIPÂú∞ÂùÄÊ≠£Á°Æ„ÄÇ`, 6000);
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}
let teleportSelectionMode = false;
const modal = document.createElement('div');
window.addEventListener('load', function() {
    const levelContainer = document.getElementById('levelContainer');
    let startY = 0;
    let isScrolling = false;
    // Ëß¶Êë∏ÂºÄÂßã‰∫ã‰ª∂
    levelContainer.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
        isScrolling = true;
    }, { passive: true }); // ‰ΩøÁî®passiveÊîπÂñÑÊªöÂä®ÊÄßËÉΩ
    // Ëß¶Êë∏ÁßªÂä®‰∫ã‰ª∂
    levelContainer.addEventListener('touchmove', function(e) {
        if (!isScrolling) return;
        
        const y = e.touches[0].clientY;
        const scrollTop = levelContainer.scrollTop;
        const scrollerHeight = levelContainer.scrollHeight;
        const containerHeight = levelContainer.clientHeight;
        
        // Èò≤Ê≠¢Âú®È°∂ÈÉ®‰∏ãÊãâÊàñÂ∫ïÈÉ®‰∏äÊãâ
        if ((scrollTop <= 0 && y > startY) || 
            (scrollTop >= scrollerHeight - containerHeight && y < startY)) {
            e.preventDefault();
        }
        
        startY = y;
    }, { passive: false });
    // Ëß¶Êë∏ÁªìÊùü‰∫ã‰ª∂
    levelContainer.addEventListener('touchend', function() {
        isScrolling = false;
    }, { passive: true });
});
// ÂÖ®Â±ÄÊ∏∏ÊàèÁä∂ÊÄÅÂèòÈáè
let singlePlayerGame = {
    canvas: null,
    ctx: null,
    maze: [],
    player: { x: 1, y: 1 },
    exit: { x: 0, y: 0 },
    cellSize: 30,
    startTime: 0,
    timerInterval: null,
    moveCount: 0,
    teleporters: [],
    movingTraps: [],
    movingEnemies: [],
    difficultySettings: [
                { size: 7, wallDensity: 0.3, traps: 0, movingTraps: 0, oneWayPaths: 0 },
                { size: 9, wallDensity: 0.35, traps: 1, movingTraps: 0, oneWayPaths: 0 },
                { size: 11, wallDensity: 0.4, traps: 2, movingTraps: 1, oneWayPaths: 0 },
                { size: 13, wallDensity: 0.45, traps: 4, movingTraps: 1, oneWayPaths: 1 },
                { size: 15, wallDensity: 0.5, traps: 6, movingTraps: 2, oneWayPaths: 1 },
                { size: 17, wallDensity: 0.55, traps: 8, movingTraps: 3, oneWayPaths: 2 },
                { size: 19, wallDensity: 0.6, traps: 10, movingTraps: 4, oneWayPaths: 3 },
                { size: 21, wallDensity: 0.65, traps: 12, movingTraps: 5, oneWayPaths: 4 },
                { size: 23, wallDensity: 0.7, traps: 14, movingTraps: 6, oneWayPaths: 5 },
                { size: 25, wallDensity: 0.75, traps: 16, movingTraps: 7, oneWayPaths: 6 }
            ],
    hasKey: false,
    doorPosition: null,
    keyPosition: null,
    isUnlocking: false,
    unlockTimeLeft: 0,
    unlockTimer: null
};

        class Random {
            constructor(seed) {
                this.seed = seed;
            }
            
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
        }
let consoleVisible = false;
let consoleHistory = [];
let historyIndex = -1;
let autoSaveTimer = null; // Ëá™Âä®‰øùÂ≠òËÆ°Êó∂Âô®
// Ê∏∏ÊàèÁä∂ÊÄÅ
let gameState = {
    autoSaveSlot: 0, // Ëá™Âä®‰øùÂ≠ò‰ΩøÁî®ÁöÑÂ≠òÊ°£ÊßΩ‰Ωç
    // Ê∏∏ÊàèÊó∂ÈïøÁªüËÆ°
    totalPlayTime: parseInt(localStorage.getItem('totalPlayTime')) || 0, // ÊÄªÊ∏∏ÊàèÊó∂ÈïøÔºàÊØ´ÁßíÔºâ
    sessionStartTime: Date.now(), // ÂΩìÂâç‰ºöËØùÂºÄÂßãÊó∂Èó¥
    lastSavedTime: Date.now(), // ÊúÄÂêé‰øùÂ≠òÊó∂Èó¥
    coins: 0, // Áé©ÂÆ∂ÊåÅÊúâÁöÑÈáëÂ∏ÅÊï∞Èáè
    currentScreen: 'mainMenu',
    unlockedLevel: parseInt(localStorage.getItem('unlockedLevel')) || 1,
    completedLevels: JSON.parse(localStorage.getItem('completedLevels')) || [],
    currentLevel: 1,
    playerName: 'Áé©ÂÆ∂' + Math.floor(Math.random() * 1000),
    unsolvableLevels: [], // Á©∫ÁöÑÊó†Ëß£ÂÖ≥Âç°ÂàóË°®ÔºàÁî®Êà∑Ëá™ÂÆö‰πâÔºâ
    specialLevels: [30,50], // Á©∫ÁöÑÁâπÊÆäÂÖ≥Âç°ÂàóË°®ÔºàÁî®Êà∑Ëá™ÂÆö‰πâÔºâ
    controlsReversed: false,
    showPathHint: false, // ÊéßÂà∂ÊòØÂê¶ÊòæÁ§∫Ë∑ØÂæÑÊèêÁ§∫
    pathHintTimer: null, // Ë∑ØÂæÑÊèêÁ§∫ÂÆöÊó∂Âô®
    lastPortal: null, // ‰∏ä‰∏ÄÊ¨°‰ΩøÁî®ÁöÑ‰º†ÈÄÅÈó®
    lastPathLength: 0, // ‰∏ä‰∏ÄÊ¨°ÁöÑË∑ØÂæÑÈïøÂ∫¶
    developerMode: false, // ÂºÄÂèëËÄÖÊ®°ÂºèÊ†áÂøó
    playerData: {
        coins: 0,
        skins: {
            current: 'default',
            unlocked: ['default'],
            available: [
                { id: 'default', name: 'ÈªòËÆ§ËßíËâ≤', icon: 'üë§', price: 0 },
                { id: 'warrior', name: 'ÂãáÂ£´', icon: '‚öîÔ∏è', price: 100 },
                { id: 'mage', name: 'Ê≥ïÂ∏à', icon: 'üßô', price: 200 },
                { id: 'ninja', name: 'ÂøçËÄÖ', icon: 'ü•∑', price: 300 },
                { id: 'robot', name: 'Êú∫Âô®‰∫∫', icon: 'ü§ñ', price: 500 },
                { id: 'alien', name: 'Â§ñÊòü‰∫∫', icon: 'üëΩ', price: 800 },
                { id: 'knight', name: 'È™ëÂ£´', icon: 'üõ°Ô∏è', price: 1200 },
                { id: 'dragon', name: 'Èæô', icon: 'üêâ', price: 2000 }
            ]
        }
    },
    multiplayer: {
        connected: false,
        peer: null,
        connections: {},
        players: {},
        currentPlayerId: null,
        roomCode: null,
        roomPassword: '',
        isHost: false,
        maze: [],
        startTime: 0,
        timerInterval: null,
        moveCount: 0,
        maxPlayers: 2, // ÈªòËÆ§ÊúÄÂ§ß‰∫∫Êï∞
        protectedPlayers: {}, // Âèó‰øùÊä§Áé©ÂÆ∂ÂàóË°®
        showPlayerList: true,
        unlockTimeLeft:10
    },
    devMode: false,
    uiSettings: JSON.parse(localStorage.getItem('uiSettings')) || {
        showControls: true,
        controlsPosition: 'bottom-left',
        controlsSize: 100,
        controlsOpacity: 60,
        showGameInfo: true,
        showLevelInfo: true,
        showTimeInfo: true,
        showMoveInfo: true,
        showKeyInfo: true,
        showRoomInfo: true,
        customX: null,
        customY: null,
        showPlayerList: true,
        // Èü≥‰πêËÆæÁΩÆ
        musicEnabled: false,
        musicVolume: 50,
        musicSelected: 'game-music-1',
        // Ëá™ÂÆö‰πâÈü≥‰πêÊï∞ÁªÑ
        customMusic: [],
        // Ê∑ªÂä†Ëá™ÂÆö‰πâ‰ΩçÁΩÆÁöÑxÂíåyÂùêÊ†á
        customX: null,
        customY: null
    },
    // Êñ∞ÂäüËÉΩÁä∂ÊÄÅ
    achievements: JSON.parse(localStorage.getItem('achievements')) || {
        allLevelsCompleted: false,
        multiplayerWins: 0,
        trapHits: 0,
        chineseEmojiUsed: false
    },
    // Èü≥‰πêÊí≠ÊîæÂô®Áä∂ÊÄÅ
    musicPlayer: {
        audio: null,
        isPlaying: false,
        currentTrack: null
    },
    
    gameStats: JSON.parse(localStorage.getItem('gameStats')) || {
        timeChallengeBest: 0,
        puzzleLevelsCompleted: 0,
        totalLevelsCompleted: 0,
        totalPlayTime: 0,
        totalMoves: 0,
        totalTrapsTriggered: 0,
        totalCoinsCollected: 0,
        averageMovesPerLevel: 0,
        completionRate: 0
    },
    
    settings: JSON.parse(localStorage.getItem('gameSettings')) || {
        autoSave: true
    },
    
    currentChallenge: null, // 'time' Êàñ 'puzzle'
    saveSlots: JSON.parse(localStorage.getItem('saveSlots')) || [{}, {}, {}],
    currentSaveSlot: 0,
    autoSave: false,
    
    // ÊØèÊó•ÊåëÊàòÁ≥ªÁªü
    dailyChallenge: JSON.parse(localStorage.getItem('dailyChallenge')) || {
        currentDate: null,
        challengeType: null,
        challengeData: null,
        isCompleted: false,
        isClaimed: false,
        progress: 0,
        history: []
    }
    
    };

// Ëá™Âä®‰øùÂ≠òÂäüËÉΩ
function startAutoSave() {
    // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
    }
    
    // ÊØè2ÂàÜÈíüÔºà120000ÊØ´ÁßíÔºâËá™Âä®‰øùÂ≠ò‰∏ÄÊ¨°
    autoSaveTimer = setInterval(() => {
        if (gameState.currentScreen === 'singlePlayerGame') {
            saveGame(gameState.autoSaveSlot);
        }
    }, 120000); // 2ÂàÜÈíü
}

// ÂÅúÊ≠¢Ëá™Âä®‰øùÂ≠ò
function stopAutoSave() {
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        autoSaveTimer = null;
    }
}

// Â≠òÊ°£ÂäüËÉΩÂÆûÁé∞
function saveGame(slot = 0) {
    if (gameState.currentScreen !== 'singlePlayerGame') {
        showNotification('ËØ∑Âú®Âçï‰∫∫Ê∏∏Êàè‰∏≠‰øùÂ≠òËøõÂ∫¶ÔºÅ');
        return;
    }
    
    const saveData = {
        playerData: {
            x: singlePlayerGame.player.x,
            y: singlePlayerGame.player.y,
            hasKey: singlePlayerGame.hasKey
        },
        currentLevel: gameState.currentLevel,
        mazeState: JSON.parse(JSON.stringify(singlePlayerGame.maze)),
        moveCount: singlePlayerGame.moveCount,
        keyPosition: singlePlayerGame.keyPosition,
        doorPosition: singlePlayerGame.doorPosition,
        startTime: singlePlayerGame.startTime,
        timestamp: new Date().toLocaleString()
    };
    
    gameState.saveSlots[slot] = saveData;
    localStorage.setItem('saveSlots', JSON.stringify(gameState.saveSlots));
    showNotification('‰øùÂ≠òÊàêÂäüÔºÅ');
    
    // Êõ¥Êñ∞Ëá™Âä®‰øùÂ≠òËÆ°Êó∂Âô®
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        startAutoSave();
    }
}


function deleteSave(slot = 0) {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•Â≠òÊ°£ÂêóÔºü')) {
        gameState.saveSlots[slot] = {};
        localStorage.setItem('saveSlots', JSON.stringify(gameState.saveSlots));
        showNotification(`Â∑≤Âà†Èô§Â≠òÊ°£‰ΩçÁΩÆ ${slot+1} ÁöÑÂ≠òÊ°£`);
        updateSaveLoadMenu();
    }
}

function showSaveLoadMenu() {
    document.getElementById('saveLoadModal').classList.remove('hidden');
    updateSaveLoadMenu();
}

function closeSaveLoadMenu() {
    document.getElementById('saveLoadModal').classList.add('hidden');
}

// Êâ©Â±ïÂ≠òÊ°£ÊßΩÂäüËÉΩ
function expandSaveSlots() {
    const password = prompt('ËØ∑ËæìÂÖ•Êâ©Â±ïÂ≠òÊ°£ÊßΩÁöÑÂØÜÁ†ÅÔºö');
    if (password === '11save++') {
        const currentSlots = gameState.saveSlots;
        // ÂàõÂª∫20‰∏™ÊßΩ‰ΩçÁöÑÊñ∞Êï∞ÁªÑ
        const newSlots = Array(20).fill({});
        // ‰øùÁïôÂéüÊúâÂ≠òÊ°£Êï∞ÊçÆ
        for (let i = 0; i < currentSlots.length; i++) {
            if (currentSlots[i] && Object.keys(currentSlots[i]).length > 0) {
                newSlots[i] = currentSlots[i];
            }
        }
        // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
        gameState.saveSlots = newSlots;
        localStorage.setItem('saveSlots', JSON.stringify(gameState.saveSlots));
        showNotification('Â≠òÊ°£ÊßΩÂ∑≤ÊàêÂäüÊâ©Â±ïËá≥20‰∏™ÔºÅ');
        updateSaveLoadMenu();
    } else {
        showNotification('ÂØÜÁ†ÅÈîôËØØÔºåÊó†Ê≥ïÊâ©Â±ïÂ≠òÊ°£ÊßΩÔºÅ');
    }
}

function updateSaveLoadMenu() {
    const slots = document.querySelectorAll('.save-slot');
    slots.forEach((slot, index) => {
        const saveData = gameState.saveSlots[index];
        const slotInfo = slot.querySelector('.slot-info');
        const buttons = slot.querySelectorAll('.menu-button');
        const loadBtn = buttons[1]; // Á¨¨‰∫å‰∏™ÊåâÈíÆÊòØÂä†ËΩΩÊåâÈíÆ
        const deleteBtn = buttons[2]; // Á¨¨‰∏â‰∏™ÊåâÈíÆÊòØÂà†Èô§ÊåâÈíÆ
        
        if (saveData && Object.keys(saveData).length > 0) {
            slotInfo.innerHTML = `ÂÖ≥Âç°: ${saveData.currentLevel}<br>Áé©ÂÆ∂‰ΩçÁΩÆ: (${saveData.playerData.x}, ${saveData.playerData.y})<br>ÊòØÂê¶ÊúâÈí•Âåô: ${saveData.playerData.hasKey ? 'ÊòØ' : 'Âê¶'}<br>ÁßªÂä®Ê¨°Êï∞: ${saveData.moveCount}<br>Êó∂Èó¥: ${saveData.timestamp}`;
            loadBtn.disabled = false;
            deleteBtn.disabled = false;
        } else {
            slotInfo.innerHTML = 'Á©∫Â≠òÊ°£';
            loadBtn.disabled = true;
            deleteBtn.disabled = true;
        }
    });
}

// Â¢ôÂ£ÅÊ∂àÂ§±Ê®°Âºè
let wallRemovalMode = false;
function startWallRemovalMode() {
    if (gameState.currentScreen !== 'singlePlayerGame' && !(gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
        showNotification('ËØ∑Âú®Âçï‰∫∫Ê∏∏Êàè‰∏≠‰ΩøÁî®Ê≠§ÈÅìÂÖ∑ÔºÅ');
        return;
    }
    wallRemovalMode = true;
    showNotification('Â¢ôÂ£ÅÊ∂àÂ§±Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑÂ¢ôÂ£ÅÊù•ÁßªÈô§ÂÆÉ„ÄÇ');
    
    // Ê†πÊçÆÂΩìÂâçÊ∏∏ÊàèÊ®°ÂºèËÆæÁΩÆÊ≠£Á°ÆÁöÑÁîªÂ∏ÉÂÖâÊ†áÊ†∑Âºè
    if (gameState.currentScreen === 'singlePlayerGame') {
        document.getElementById('singlePlayerCanvas').style.cursor = 'crosshair';
    } else if (gameState.currentScreen === 'multiplayerGame') {
        document.getElementById('multiplayerCanvas').style.cursor = 'crosshair';
    }
}

// ÊâìÂºÄÂïÜÂ∫ó
function openShop() {
    // ÈöêËóèÊâÄÊúâÂ±èÂπï
    const screens = [
        'mainMenu', 'singlePlayerLevelSelect', 'singlePlayerGame', 
        'singlePlayerComplete', 'multiplayerSetup', 'multiplayerGame',
        'achievementsScreen', 'moreChallengesScreen', 'statisticsScreen'
    ];
    
    screens.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('hidden');
        }
    });
    
    document.getElementById('shopModal').classList.remove('hidden');
    // ÊâìÂºÄÂïÜÂ∫óÊó∂Êõ¥Êñ∞ÊâÄÊúâÊåâÈíÆÁöÑÁä∂ÊÄÅ
    updateShopButtons();
}

// ÂÖ≥Èó≠ÂïÜÂ∫ó
function closeShop() {
    document.getElementById('shopModal').classList.add('hidden');
    // ÊÅ¢Â§ç‰πãÂâçÊòæÁ§∫ÁöÑÂ±èÂπï
    const currentScreen = gameState.currentScreen;
    if (currentScreen) {
        const screenElement = document.getElementById(currentScreen);
        if (screenElement) {
            screenElement.classList.remove('hidden');
        }
    }
}

// Êõ¥Êñ∞ÂïÜÂ∫óÊåâÈíÆÁöÑÂèØÁî®Áä∂ÊÄÅ
function updateShopButtons() {
    const buttons = document.querySelectorAll('.buy-btn');
    buttons.forEach(btn => {
        const itemKey = btn.parentElement.dataset.item;
        const item = SHOP_ITEMS[itemKey];
        if (item && gameState.coins < item.price) {
            btn.disabled = true;
            btn.textContent = 'ÈáëÂ∏Å‰∏çË∂≥';
        } else {
            btn.disabled = false;
            btn.textContent = 'Ë¥≠‰π∞';
        }
    });
}

// ÂïÜÂ∫óÁâ©ÂìÅÈÖçÁΩÆ
const SHOP_ITEMS = {
    'clear-events': { price: 20, name: 'ÊïàÊûúÊ∏ÖÈô§', description: 'Ê∏ÖÈô§ÊâÄÊúâÈöèÊú∫‰∫ã‰ª∂' },
    'remove-wall': { price: 15, name: 'Â¢ôÂ£ÅÊ∂àÂ§±', description: 'ÁßªÈô§‰ªªÊÑè‰∏Ä‰∏™Â¢ôÂ£Å' },
    'teleport': { price: 25, name: '‰º†ÈÄÅÈó®', description: '‰º†ÈÄÅÂà∞Ëø∑ÂÆ´‰ªªÊÑè‰ΩçÁΩÆ' },
    'speed-boost': { price: 30, name: 'ÈÄüÂ∫¶ÊèêÂçá', description: 'ÁßªÂä®ÈÄüÂ∫¶ÊèêÂçá50%ÔºåÊåÅÁª≠30Áßí' },
    'invincibility': { price: 50, name: 'Êó†ÊïåÊä§Áõæ', description: 'ÂÖçÁñ´Èô∑Èò±‰º§ÂÆ≥ÔºåÊåÅÁª≠20Áßí' },
    'hint': { price: 10, name: 'Ëø∑ÂÆ´ÊèêÁ§∫', description: 'ÊòæÁ§∫‰∏ÄÊù°ÈÄöÂæÄÂá∫Âè£ÁöÑË∑ØÂæÑ' }
};

// Ë¥≠‰π∞Áâ©ÂìÅ
function buyItem(itemKey) {
    const item = SHOP_ITEMS[itemKey];
    if (!item) return;

    if (gameState.coins >= item.price) {
        gameState.coins -= item.price;
        gameState.playerData.coins = gameState.coins;
        updateCoinDisplay();
        updateShopButtons(); // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        showNotification(`ÊàêÂäüË¥≠‰π∞ ${item.name}ÔºÅ`);
        
        // ÈÅìÂÖ∑Ê∑ªÂä†Âà∞ËÉåÂåÖÔºåËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•ÊøÄÊ¥ªÊïàÊûú
        // Âú®ÂÆûÈôÖ‰∏≠Ôºå‰Ω†ÂèØËÉΩÈúÄË¶Å‰∏Ä‰∏™ËÉåÂåÖÁ≥ªÁªüÊù•Â≠òÂÇ®ÈÅìÂÖ∑
        activateItem(itemKey);
        
    } else {
        showNotification('ÈáëÂ∏Å‰∏çË∂≥ÔºåÊó†Ê≥ïË¥≠‰π∞ÔºÅ');
    }
}

// ÊøÄÊ¥ªÈÅìÂÖ∑ÊïàÊûú
function activateItem(itemKey) {
    switch(itemKey) {
        case 'clear-events':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                if (Object.keys(EventSystem.activeEvents).length > 0) {
                    // Ë∞ÉÁî®ÊâÄÊúâ‰∫ã‰ª∂ÁöÑÊ∏ÖÁêÜÂáΩÊï∞
                    Object.values(EventSystem.activeEvents).forEach(event => {
                        if (event.cleanup) event.cleanup();
                    });
                    EventSystem.activeEvents = {}; // Ê∏ÖÁ©∫‰∫ã‰ª∂
                    showNotification('ÊâÄÊúâÈöèÊú∫‰∫ã‰ª∂Â∑≤Ê∏ÖÈô§ÔºÅ');
                } else {
                    showNotification('ÂΩìÂâçÊ≤°ÊúâËß¶ÂèëÁöÑÈöèÊú∫‰∫ã‰ª∂„ÄÇ');
                }
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'remove-wall':
            startWallRemovalMode();
            break;
            
        case 'teleport':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                startTeleportSelectionMode();
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'speed-boost':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                // ‰øùÂ≠òÂéüÂßãÈÄüÂ∫¶
                if (!gameState.originalSpeed) {
                    gameState.originalSpeed = 120;
                }
                // ÊèêÂçáÈÄüÂ∫¶
                clearInterval(gameState.keyboardInputTimer);
                gameState.keyboardInputTimer = setInterval(handleKeyboardInput, 80);
                showNotification('ÈÄüÂ∫¶ÊèêÂçáÔºÅÊåÅÁª≠30Áßí„ÄÇ');
                // 30ÁßíÂêéÊÅ¢Â§çÂéüÂßãÈÄüÂ∫¶
                setTimeout(() => {
                    clearInterval(gameState.keyboardInputTimer);
                    gameState.keyboardInputTimer = setInterval(handleKeyboardInput, gameState.originalSpeed);
                    showNotification('ÈÄüÂ∫¶ÊèêÂçáÊïàÊûúÂ∑≤ÁªìÊùü„ÄÇ');
                }, 30000);
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'vision-enhance':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                // ‰øùÂ≠òÂéüÂßãËßÜÈáé
                if (!gameState.originalVisionRange) {
                    gameState.originalVisionRange = gameState.visionRange || 1;
                }
                // Êâ©Â§ßËßÜÈáé
                gameState.visionRange = 3;
                showNotification('ËßÜÈáéÂ¢ûÂº∫ÔºÅÊåÅÁª≠60Áßí„ÄÇ');
                // ÈáçÊñ∞ÁªòÂà∂Ëø∑ÂÆ´‰ª•Â∫îÁî®Êñ∞ËßÜÈáé
                if (gameState.currentScreen === 'singlePlayerGame') {
                    drawSinglePlayerMaze();
                } else {
                    drawMultiplayerMaze();
                }
                // 60ÁßíÂêéÊÅ¢Â§çÂéüÂßãËßÜÈáé
                setTimeout(() => {
                    gameState.visionRange = gameState.originalVisionRange;
                    if (gameState.currentScreen === 'singlePlayerGame') {
                        drawSinglePlayerMaze();
                    } else {
                        drawMultiplayerMaze();
                    }
                    showNotification('ËßÜÈáéÂ¢ûÂº∫ÊïàÊûúÂ∑≤ÁªìÊùü„ÄÇ');
                }, 60000);
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'invincibility':
            if ((gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) && !gameState.invincible) {
                // ÊøÄÊ¥ªÊó†Êïå
                gameState.invincible = true;
                showNotification('Êó†ÊïåÊä§ÁõæÊøÄÊ¥ªÔºÅÊåÅÁª≠20Áßí„ÄÇ');
                // 20ÁßíÂêéÂèñÊ∂àÊó†Êïå
                setTimeout(() => {
                    gameState.invincible = false;
                    showNotification('Êó†ÊïåÊä§ÁõæÊïàÊûúÂ∑≤ÁªìÊùü„ÄÇ');
                }, 20000);
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'coin-magnet':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                // ÊøÄÊ¥ªÈáëÂ∏ÅÁ£ÅÈìÅ
                gameState.coinMagnetActive = true;
                showNotification('ÈáëÂ∏ÅÁ£ÅÈìÅÊøÄÊ¥ªÔºÅÊåÅÁª≠45Áßí„ÄÇ');
                // 45ÁßíÂêéÂèñÊ∂àÈáëÂ∏ÅÁ£ÅÈìÅ
                setTimeout(() => {
                    gameState.coinMagnetActive = false;
                    showNotification('ÈáëÂ∏ÅÁ£ÅÈìÅÊïàÊûúÂ∑≤ÁªìÊùü„ÄÇ');
                }, 45000);
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
            
        case 'hint':
            if (gameState.currentScreen === 'singlePlayerGame' || (gameState.currentScreen === 'multiplayerGame' && gameState.developerMode)) {
                // ÂØªÊâæ‰ªéÂΩìÂâç‰ΩçÁΩÆÂà∞Âá∫Âè£ÁöÑË∑ØÂæÑ
                const maze = gameState.currentScreen === 'singlePlayerGame' ? singlePlayerGame.maze : multiplayerGame.maze;
                const player = gameState.currentScreen === 'singlePlayerGame' ? singlePlayerGame.player : multiplayerGame.players[gameState.multiplayer.peerId];
                const exit = gameState.currentScreen === 'singlePlayerGame' ? singlePlayerGame.exit : multiplayerGame.exit;
                
                const path = findPathToExit(maze, 
                    player.x, player.y,
                    exit.x, exit.y);
                if (path && path.length > 0) {
                    showNotification('Â∑≤ÊòæÁ§∫ÈÄöÂæÄÂá∫Âè£ÁöÑË∑ØÂæÑÔºÅ');
                    // Ê†áËÆ∞ÈúÄË¶ÅÊòæÁ§∫Ë∑ØÂæÑ
                    gameState.showPathHint = true;
                    // Âú®Ëø∑ÂÆ´‰∏äÁªòÂà∂Ë∑ØÂæÑ
                    drawPathHint(path);
                } else {
                    showNotification('Êó†Ê≥ïÊâæÂà∞ÈÄöÂæÄÂá∫Âè£ÁöÑË∑ØÂæÑ„ÄÇ');
                    addCoins(10);
                }
            } else {
                showNotification('Ê≠§ÈÅìÂÖ∑‰ªÖÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ÂèØÁî®ÔºÅ');
            }
            break;
    }
}

// ‰ΩøÁî®BFSÂØªÊâæ‰ªéÂΩìÂâç‰ΩçÁΩÆÂà∞Âá∫Âè£ÁöÑË∑ØÂæÑ
function findPathToExit(maze, startX, startY, endX, endY) {
    const rows = maze.length;
    const cols = maze[0].length;
    const visited = Array(rows).fill().map(() => Array(cols).fill(false));
    const queue = [];
    const prev = {};
    
    // Âõõ‰∏™ÊñπÂêëÔºö‰∏ä„ÄÅÂè≥„ÄÅ‰∏ã„ÄÅÂ∑¶
    const directions = [
        { dx: -1, dy: 0 },
        { dx: 0, dy: 1 },
        { dx: 1, dy: 0 },
        { dx: 0, dy: -1 }
    ];
    
    // Â∞ÜËµ∑ÁÇπÂä†ÂÖ•ÈòüÂàó
    queue.push({ x: startX, y: startY });
    visited[startY][startX] = true;
    
    while (queue.length > 0) {
        const current = queue.shift();
        
        // Â¶ÇÊûúÂà∞ËææÁªàÁÇπÔºåÂõûÊ∫ØË∑ØÂæÑ
        if (current.x === endX && current.y === endY) {
            const path = [];
            let node = current;
            while (node) {
                path.unshift({ x: node.x, y: node.y });
                node = prev[`${node.x},${node.y}`];
            }
            return path;
        }
        
        // Êé¢Á¥¢Âõõ‰∏™ÊñπÂêë
        for (const dir of directions) {
            const newX = current.x + dir.dx;
            const newY = current.y + dir.dy;
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®Ëø∑ÂÆ´ËåÉÂõ¥ÂÜÖ‰∏îÊú™ËÆøÈóÆËøá‰∏î‰∏çÊòØÂ¢ôÂ£Å
            if (newY >= 0 && newY < rows && newX >= 0 && newX < cols &&
                !visited[newY][newX] && maze[newY][newX] !== 1) {
                
                visited[newY][newX] = true;
                queue.push({ x: newX, y: newY });
                prev[`${newX},${newY}`] = current;
            }
        }
    }
    
    // Ê≤°ÊúâÊâæÂà∞Ë∑ØÂæÑ
    return null;
}

// Âú®Ëø∑ÂÆ´‰∏äÁªòÂà∂Ë∑ØÂæÑÊèêÁ§∫
function drawPathHint(path) {
    // Ê†πÊçÆÂΩìÂâçÊ∏∏ÊàèÊ®°ÂºèÈÄâÊã©ÁîªÂ∏ÉÂíåcellSize
    const gameMode = gameState.currentScreen;
    const ctx = gameMode === 'singlePlayerGame' ? 
        singlePlayerGame.canvas.getContext('2d') : 
        multiplayerGame.canvas.getContext('2d');
    const cellSize = gameMode === 'singlePlayerGame' ? 
        singlePlayerGame.cellSize : 
        multiplayerGame.cellSize;
    
    // ÁªòÂà∂Ë∑ØÂæÑ
    ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
    ctx.lineWidth = 3;
    ctx.setLineDash([5, 5]);
    
    ctx.beginPath();
    ctx.moveTo(
        path[0].x * cellSize + cellSize / 2,
        path[0].y * cellSize + cellSize / 2
    );
    
    for (let i = 1; i < path.length; i++) {
        ctx.lineTo(
            path[i].x * cellSize + cellSize / 2,
            path[i].y * cellSize + cellSize / 2
        );
    }
    
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Ê£ÄÊü•Ë∑ØÂæÑ‰∏äÊòØÂê¶ÊúâÁßªÂä®Êïå‰∫∫
    checkEnemiesOnPath(path);
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
    if (gameState.pathHintTimer) {
        clearTimeout(gameState.pathHintTimer);
    }
    
    // 30ÁßíÂêéÊ∏ÖÈô§Ë∑ØÂæÑÂπ∂ÈáçÁΩÆÁä∂ÊÄÅ
    gameState.pathHintTimer = setTimeout(() => {
        gameState.showPathHint = false;
        document.getElementById('pathEnemyInfo').classList.add('hidden');
        // Ê†πÊçÆÊ∏∏ÊàèÊ®°ÂºèË∞ÉÁî®Ê≠£Á°ÆÁöÑÁªòÂà∂ÂáΩÊï∞
        if (gameMode === 'singlePlayerGame') {
            drawSinglePlayerMaze();
        } else {
            drawMultiplayerMaze();
        }
    }, 30000);
}

function checkEnemiesOnPath(path) {
    const enemiesOnPath = [];
    const gameMode = gameState.currentScreen;
    
    // Ëé∑ÂèñÂΩìÂâçÊ∏∏ÊàèÊ®°ÂºèÁöÑÁßªÂä®Êïå‰∫∫ÂàóË°®
    const movingEnemies = gameMode === 'singlePlayerGame' ? 
        singlePlayerGame.movingEnemies : 
        (multiplayerGame.movingEnemies || []);
    
    // Ê£ÄÊü•Ë∑ØÂæÑ‰∏äÁöÑÊØè‰∏™ÁÇπÊòØÂê¶ÊúâÊïå‰∫∫
    for (const pathPoint of path) {
        for (const enemy of movingEnemies) {
            if (enemy.x === pathPoint.x && enemy.y === pathPoint.y) {
                enemiesOnPath.push(enemy);
                break;
            }
        }
    }
    
    // Â¶ÇÊûúÊúâÊïå‰∫∫ÔºåÊòæÁ§∫Ë≠¶Âëä
    const pathEnemyInfo = document.getElementById('pathEnemyInfo');
    if (enemiesOnPath.length > 0) {
        pathEnemyInfo.classList.remove('hidden');
    } else {
        pathEnemyInfo.classList.add('hidden');
    }
    
    return enemiesOnPath;
}

function createCoinDisplay() {
    const coinDisplay = document.createElement('div');
    coinDisplay.id = 'coinDisplay';
    coinDisplay.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: gold;
        padding: 10px 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 18px;
        font-weight: bold;
        z-index: 100;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        display: none; /* ÈªòËÆ§ÈöêËóè */
    `;
    coinDisplay.innerHTML = `
        <span style="color: gold;">ü™ô</span>
        <span id="coinCount">0</span>
    `;
    document.body.appendChild(coinDisplay);
}

// ÊòæÁ§∫ÈáëÂ∏ÅUI
function showCoinDisplay() {
    document.getElementById('coinDisplay').style.display = 'block';
}

// ÈöêËóèÈáëÂ∏ÅUI
function hideCoinDisplay() {
    document.getElementById('coinDisplay').style.display = 'none';
}

// Êõ¥Êñ∞ÈáëÂ∏ÅÊï∞Èáè
function updateCoinDisplay() {
    document.getElementById('coinCount').textContent = gameState.coins;
}
function startTeleportSelectionMode(targetPlayerId = null) {
    // ‰øùÂ≠òÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅÂíåÁõÆÊ†áÁé©ÂÆ∂
    gameState.mapSelectionMode = true;
    gameState.mapSelectionTarget = targetPlayerId;
    
    // Ê∑ªÂä†Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨
    if (gameState.currentScreen === 'singlePlayerGame') {
        singlePlayerGame.canvas.addEventListener('click', handleMapClick);
        document.getElementById('consoleOutput').innerHTML += 
            '\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ';
            console.log('Âú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª');
            showNotification('Âú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ');
    } else {
        document.getElementById('consoleOutput').innerHTML += 
            '\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂè™ËÉΩÂú®Âçï‰∫∫Ê∏∏Êàè‰∏≠ËøõË°å';
        gameState.mapSelectionMode = false;
    }
}
// Ê∑ªÂä†ÈáëÂ∏Å
function addCoins(amount) {
    gameState.coins += amount;
    // ÂêåÊó∂‰πüÊõ¥Êñ∞ playerData ‰∏≠ÁöÑÔºå‰ª•‰æø‰∫é‰øùÂ≠ò
    gameState.playerData.coins = gameState.coins;
    updateCoinDisplay();
    
    // Âú®ÊØèÊó•ÊåëÊàòÊ®°Âºè‰∏ãÔºå‰πüÊõ¥Êñ∞Êî∂ÈõÜÁöÑÈáëÂ∏ÅÊï∞
    if (gameState.currentChallenge === 'daily' && singlePlayerGame.coinsCollected !== undefined) {
        singlePlayerGame.coinsCollected += amount;
    }
    
    // ÊòæÁ§∫Ëé∑ÂæóÈáëÂ∏ÅÁöÑÊèêÁ§∫
    showNotification(`Ëé∑Âæó ${amount} ‰∏™ÈáëÂ∏ÅÔºÅ`);
}

// Âú®È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÈáëÂ∏ÅÊòæÁ§∫
window.addEventListener('load', () => {
    createCoinDisplay();
    // ‰ªé localStorage Âä†ËΩΩÈáëÂ∏ÅÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÂàùÂßãÂåñ‰∏∫0
    gameState.coins = parseInt(localStorage.getItem('playerCoins')) || 0;
    gameState.playerData.coins = gameState.coins;
    // ÂàùÂßã‰∏çÊòæÁ§∫ÔºåÂú®Ê∏∏ÊàèÂºÄÂßãÊó∂ÂÜçÊòæÁ§∫
});

const EventSystem = {
  events: [],
  activeEvents: {},
  cooldowns: {},

  init() {
    setInterval(() => this.checkEvents(), 5000); // ÊØè5ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
  },

  register(event) {
    this.events.push(event);
  },

  checkEvents() {
    if (gameState.currentScreen !== 'singlePlayerGame') return;

    this.events.forEach(event => {
      if (this.shouldTrigger(event)) {
        this.trigger(event);
      }
    });
  },

  shouldTrigger(event) {
    // Ê£ÄÊü•ÂÜ∑Âç¥
    if (this.cooldowns[event.id] > Date.now()) return false;
    // Ê£ÄÊü•Ê¶ÇÁéá
    return Math.random() < (event.probability || 0.1);
  },

  trigger(event) {
    // ÊâßË°åÊïàÊûú
    const cleanup = event.effect();
    
    // ËÆæÁΩÆÂÜ∑Âç¥
    this.cooldowns[event.id] = Date.now() + (event.cooldown || 60000);
    if (!event || typeof event.effect !== 'function') {
        console.error('ÈîôËØØÁöÑ‰∫ã‰ª∂:', event);
        return; // Áõ¥Êé•ËøîÂõûÔºåÈò≤Ê≠¢Êä•Èîô
    }
    // Â≠òÂÇ®Ê∏ÖÁêÜÂáΩÊï∞
    if (cleanup) {
      this.activeEvents[event.id] = {
        endTime: Date.now() + (event.duration || 10000),
        cleanup
      };
    }

    // ÊòæÁ§∫ÈÄöÁü•
    this.showNotification(event.name, event.description);
  },

  showNotification(title, text) {
    const div = document.createElement('div');
    div.className = 'event-notification';
    div.innerHTML = `<b>${title}</b>: ${text}`;
    document.getElementById('event-notifications').appendChild(div);
    setTimeout(() => div.remove(), 5000);
  },

  update() {
    const now = Date.now();
    Object.keys(this.activeEvents).forEach(id => {
      if (now >= this.activeEvents[id].endTime) {
        this.activeEvents[id].cleanup();
        delete this.activeEvents[id];
      }
    });
  },
  triggerById(eventId) {
    const event = this.events.find(e => 
    e.id.toLowerCase() === eventId.toLowerCase()
    );
    if (!event) {
      console.error(`‰∫ã‰ª∂‰∏çÂ≠òÂú®: ${eventId}`);
      return;
    }
    // ÊâßË°åÊïàÊûú
    const cleanup = event.effect();
    
    // ËÆæÁΩÆÂÜ∑Âç¥ÔºàÂç≥‰ΩøÂº∫Âà∂Ëß¶Âèë‰πü‰ªçÁÑ∂Â∫îÁî®ÂÜ∑Âç¥Ôºâ
    this.cooldowns[event.id] = Date.now() + (event.cooldown || 60000);
    
    // Â≠òÂÇ®Ê∏ÖÁêÜÂáΩÊï∞
    if (cleanup) {
      this.activeEvents[event.id] = {
        endTime: Date.now() + (event.duration || 10000),
        cleanup
      };
    }
    // ÊòæÁ§∫ÈÄöÁü•
    this.showNotification(event.name, `[Âº∫Âà∂Ëß¶Âèë] ${event.description}`);
    }
}
// ÂàùÂßãÂåñ
EventSystem.init();
// ÊéßÂà∂ÂèçËΩ¨‰∫ã‰ª∂
// ‰øÆÊîπÂêéÁöÑÂèçËΩ¨ÊéßÂà∂‰∫ã‰ª∂
EventSystem.register({
  id: 'reverse-controls',
  name: 'ÊñπÂêëÊ∑∑‰π±',
  description: 'ÊéßÂà∂ÊñπÂêëÊöÇÊó∂ÂèçËΩ¨!ÊåÅÁª≠Êó∂Èó¥: 20Áßí',
  probability: 0.1,  // 10%Ê¶ÇÁéáËß¶Âèë
  cooldown: 30000,   // 30ÁßíÂÜ∑Âç¥
  effect: () => {
    const originalHandler = handleSinglePlayerKeyDown;
    
    // ÊòæÁ§∫ÊèêÁ§∫
    const notification = document.createElement('div');
    notification.className = 'event-notification';
    notification.innerHTML = '<b>ÊñπÂêëÊ∑∑‰π±ÔºÅ</b> ÊñπÂêëÊéßÂà∂Â∑≤ÊöÇÊó∂ÂèçËΩ¨';
    document.getElementById('event-notifications').appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
    
    // ÂèçËΩ¨ÊéßÂà∂Áä∂ÊÄÅ
    gameState.controlsReversed = true;
    
    // 50ÁßíÂêéËá™Âä®ÊÅ¢Â§ç
    setTimeout(() => {
      gameState.controlsReversed = false;
      const endNotification = document.createElement('div');
      endNotification.className = 'event-notification';
      endNotification.innerHTML = '<b>ÊñπÂêëÊÅ¢Â§çÊ≠£Â∏∏</b>';
      document.getElementById('event-notifications').appendChild(endNotification);
      setTimeout(() => endNotification.remove(), 3000);
    }, 20000);

    return () => {
      
      gameState.controlsReversed = false;
    };
  }
});

// Ëß£Ë∞úÊ®°ÂºèÁä∂ÊÄÅ
gameState.puzzleMode = {
    buttons: [], // ÊåâÈíÆ‰ΩçÁΩÆÊï∞ÁªÑ [{x, y, id, pressed, color}]
    correctSequence: [], // Ê≠£Á°ÆÈ°∫Â∫è [buttonId1, buttonId2, ...]
    currentSequence: [], // ÂΩìÂâçÁé©ÂÆ∂Êåâ‰∏ãÁöÑÈ°∫Â∫è
    doorPosition: null, // Â§ßÈó®‰ΩçÁΩÆ
    doorOpened: false // Â§ßÈó®ÊòØÂê¶Â∑≤ÊâìÂºÄ
};
// ÈöèÊú∫‰∫ã‰ª∂Á≥ªÁªü

// Ëß£Ë∞úÊ®°Âºè
function startPuzzleMode() {
    gameState.currentChallenge = 'puzzle';
    gameState.currentLevel = 1;
    showScreen('singlePlayerGame');
    
    // ÂàùÂßãÂåñËß£Ë∞úÊ®°Âºè
    initPuzzleMode();
}

// ÂàùÂßãÂåñËß£Ë∞úÊ®°Âºè
function initPuzzleMode() {
    // ÊòæÁ§∫Ëß£Ë∞úÊ®°ÂºèUI
    document.getElementById('puzzleInfo').classList.remove('hidden');
    document.getElementById('sequenceDisplay').classList.remove('hidden');
    
    // ÈáçÁΩÆËß£Ë∞úÁä∂ÊÄÅ
    gameState.puzzleMode = {
        buttons: [],
        correctSequence: [],
        currentSequence: [],
        doorPosition: null,
        doorOpened: false
    };
    
    // ÁîüÊàêËß£Ë∞úËø∑ÂÆ´
    generatePuzzleMaze();
    
    // Êõ¥Êñ∞Â∫èÂàóÊòæÁ§∫
    updateSequenceDisplay();
}


// ÁîüÊàêËß£Ë∞úËø∑ÂÆ´
function generatePuzzleMaze() {
    const size = 15;
    singlePlayerGame.maze = Array(size).fill().map(() => Array(size).fill(1));
    
    // ‰ΩøÁî®PrimÁÆóÊ≥ïÁîüÊàêÂü∫Êú¨Ëø∑ÂÆ´
    const walls = [];
    singlePlayerGame.maze[1][1] = 0;
    walls.push(...getCellWalls(1, 1, singlePlayerGame.maze));
    
    while (walls.length > 0) {
        const wallIndex = Math.floor(Math.random() * walls.length);
        const wall = walls[wallIndex];
        walls.splice(wallIndex, 1);
        
        const opposite = getOppositeCell(wall, singlePlayerGame.maze);
        
        if (opposite.x > 0 && opposite.x < size-1 && 
            opposite.y > 0 && opposite.y < size-1 && 
            singlePlayerGame.maze[opposite.y][opposite.x] === 1) {
            
            singlePlayerGame.maze[wall.y][wall.x] = 0;
            singlePlayerGame.maze[opposite.y][opposite.x] = 0;
            walls.push(...getCellWalls(opposite.x, opposite.y, singlePlayerGame.maze));
        }
    }
    
    // ËÆæÁΩÆËµ∑ÁÇπÂíåÂá∫Âè£
    singlePlayerGame.player = { x: 1, y: 1 };
    singlePlayerGame.exit = { x: size-2, y: size-2 };
    
    // Ê∑ªÂä†ÊåâÈíÆÔºà4-5‰∏™ÊåâÈíÆÔºâ
    const buttonCount = 4 + Math.floor(Math.random() * 2);
    const buttonColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
    
    for (let i = 0; i < buttonCount; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(Math.random() * (size-4)) + 2;
            y = Math.floor(Math.random() * (size-4)) + 2;
            attempts++;
        } while ((singlePlayerGame.maze[y][x] !== 0 || 
                  isNearPlayer(x, y) ||
                  gameState.puzzleMode.buttons.some(b => b.x === x && b.y === y)) && 
                 attempts < 50);
        
        if (attempts < 50) {
            singlePlayerGame.maze[y][x] = 10 + i; // 10-14 Ë°®Á§∫ÊåâÈíÆ
            gameState.puzzleMode.buttons.push({
                x, y, 
                id: i,
                pressed: false,
                color: buttonColors[i]
            });
        }
    }
    
    // ËÆæÁΩÆÊ≠£Á°ÆÈ°∫Â∫èÔºàÈöèÊú∫Êâì‰π±Ôºâ
    gameState.puzzleMode.correctSequence = [];
    for (let i = 0; i < buttonCount; i++) {
        gameState.puzzleMode.correctSequence.push(i);
    }
    // ÈöèÊú∫Êâì‰π±È°∫Â∫è
    gameState.puzzleMode.correctSequence.sort(() => Math.random() - 0.5);
    
    // Ê∑ªÂä†Â§ßÈó®
    let doorX = singlePlayerGame.exit.x;
    let doorY = singlePlayerGame.exit.y;
    
    // Âú®Âá∫Âè£ÂâçÊîæÁΩÆÈó®
    if (doorX < size-1 && singlePlayerGame.maze[doorY][doorX+1] === 0) {
        doorX++;
    } else if (doorX > 0 && singlePlayerGame.maze[doorY][doorX-1] === 0) {
        doorX--;
    } else if (doorY < size-1 && singlePlayerGame.maze[doorY+1][doorX] === 0) {
        doorY++;
    } else if (doorY > 0 && singlePlayerGame.maze[doorY-1][doorX] === 0) {
        doorY--;
    }
    
    singlePlayerGame.maze[doorY][doorX] = 9; // 9 Ë°®Á§∫Èó®
    gameState.puzzleMode.doorPosition = {x: doorX, y: doorY};
    
    // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞èÂπ∂ÁªòÂà∂
    resizeSinglePlayerCanvas();
    drawSinglePlayerMaze();
}

// Ê£ÄÊü•ÊòØÂê¶Èù†ËøëÁé©ÂÆ∂Ëµ∑ÁÇπ
function isNearPlayer(x, y) {
    return Math.abs(x - 1) <= 2 && Math.abs(y - 1) <= 2;
}

// Â§ÑÁêÜÊåâÈíÆÊåâ‰∏ã
function handleButtonPress(buttonId) {
    const button = gameState.puzzleMode.buttons.find(b => b.id === buttonId);
    if (!button || button.pressed) return;
    
    // Ê∑ªÂä†Âà∞ÂΩìÂâçÂ∫èÂàó
    gameState.puzzleMode.currentSequence.push(buttonId);
    
    // Ê†áËÆ∞ÊåâÈíÆ‰∏∫Â∑≤Êåâ‰∏ã
    button.pressed = true;
    
    // Êõ¥Êñ∞ÊòæÁ§∫
    updateSequenceDisplay();
    
    // Ê£ÄÊü•Â∫èÂàóÊòØÂê¶Ê≠£Á°Æ
    checkSequence();
    
    // ÈáçÊñ∞ÁªòÂà∂Ëø∑ÂÆ´‰ª•ÊòæÁ§∫Êåâ‰∏ãÁöÑÊåâÈíÆ
    drawSinglePlayerMaze();
}

// Êõ¥Êñ∞Â∫èÂàóÊòæÁ§∫
function updateSequenceDisplay() {
    const display = document.getElementById('sequenceDisplay');
    let sequenceText = 'ÂΩìÂâçÈ°∫Â∫è: ';
    
    if (gameState.puzzleMode.currentSequence.length === 0) {
        sequenceText += 'Êó†';
        display.className = 'sequence-display';
    } else {
        sequenceText += gameState.puzzleMode.currentSequence.map(id => {
            const button = gameState.puzzleMode.buttons.find(b => b.id === id);
            return `<span style="color:${button.color}">‚óè</span>`;
        }).join(' ');
        
        // Ê£ÄÊü•ÂΩìÂâçÂ∫èÂàóÊòØÂê¶Ê≠£Á°Æ
        const isCorrectSoFar = gameState.puzzleMode.currentSequence.every((id, index) => 
            id === gameState.puzzleMode.correctSequence[index]
        );
        
        if (isCorrectSoFar) {
            display.className = 'sequence-display sequence-correct';
        } else {
            display.className = 'sequence-display sequence-wrong';
        }
    }
    
    display.innerHTML = sequenceText;
}

// Ê£ÄÊü•Â∫èÂàó
function checkSequence() {
    const current = gameState.puzzleMode.currentSequence;
    const correct = gameState.puzzleMode.correctSequence;
    
    // Ê£ÄÊü•ÊòØÂê¶ÂÆåÂÖ®Ê≠£Á°Æ
    if (current.length === correct.length && 
        current.every((id, index) => id === correct[index])) {
        
        // Â∫èÂàóÊ≠£Á°ÆÔºåÊâìÂºÄÂ§ßÈó®
        openPuzzleDoor();
    } else if (current.length > 0) {
        // Ê£ÄÊü•ÂΩìÂâçÈÉ®ÂàÜÊòØÂê¶Ê≠£Á°Æ
        const isCorrectSoFar = current.every((id, index) => id === correct[index]);
        
        if (!isCorrectSoFar) {
            // Â∫èÂàóÈîôËØØÔºåÈáçÁΩÆ
            setTimeout(() => {
                resetPuzzleSequence();
                alert('È°∫Â∫èÈîôËØØÔºÅËØ∑ÈáçÊñ∞ÂºÄÂßã„ÄÇ');
            }, 500);
        }
    }
}

// ÊâìÂºÄËß£Ë∞úÂ§ßÈó®
function openPuzzleDoor() {
    gameState.puzzleMode.doorOpened = true;
    
    // Â∞ÜÈó®Âèò‰∏∫ÈÄöË∑Ø
    singlePlayerGame.maze[gameState.puzzleMode.doorPosition.y][gameState.puzzleMode.doorPosition.x] = 0;
    
    // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
    document.getElementById('sequenceDisplay').innerHTML = 
        '<span style="color:#4CAF50">‚úì Â∫èÂàóÊ≠£Á°ÆÔºÅÂ§ßÈó®Â∑≤ÊâìÂºÄ</span>';
    
    // ÈáçÊñ∞ÁªòÂà∂Ëø∑ÂÆ´
    drawSinglePlayerMaze();
    
    alert('ÊÅ≠ÂñúÔºÅÈ°∫Â∫èÊ≠£Á°ÆÔºåÂ§ßÈó®Â∑≤ÁªèÊâìÂºÄÔºÅ');
}

// ÈáçÁΩÆËß£Ë∞úÂ∫èÂàó
function resetPuzzleSequence() {
    // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆÁä∂ÊÄÅ
    gameState.puzzleMode.buttons.forEach(button => {
        button.pressed = false;
    });
    
    // Ê∏ÖÁ©∫ÂΩìÂâçÂ∫èÂàó
    gameState.puzzleMode.currentSequence = [];
    
    // Êõ¥Êñ∞ÊòæÁ§∫
    updateSequenceDisplay();
    
    // ÈáçÊñ∞ÁªòÂà∂Ëø∑ÂÆ´
    drawSinglePlayerMaze();
}

// ‰øÆÊîπÁªòÂà∂ÂáΩÊï∞‰ª•ÊòæÁ§∫ÊåâÈíÆ
function drawSinglePlayerMaze() {
    const ctx = singlePlayerGame.ctx;
    ctx.clearRect(0, 0, singlePlayerGame.canvas.width, singlePlayerGame.canvas.height);
    
    // ÁªòÂà∂Ëø∑ÂÆ´ÔºàÂéüÊúâÈÄªËæëÔºâ
    for (let y = 0; y < singlePlayerGame.maze.length; y++) {
        for (let x = 0; x < singlePlayerGame.maze[y].length; x++) {
            const cellValue = singlePlayerGame.maze[y][x];
            let fillStyle = '#111';
            
            switch(cellValue) {
                case 1: fillStyle = '#333'; break; // Â¢ô
                case 2: fillStyle = '#FF0'; break; // Èô∑Èò±
                case 3: fillStyle = '#0FF'; break; // ‰º†ÈÄÅÈó®
                case 9: fillStyle = '#8B4513'; break; // Èó®
                default: 
                    if (cellValue >= 10 && cellValue <= 20) {
                        // ÊåâÈíÆ
                        const buttonId = cellValue - 10;
                        const button = gameState.puzzleMode.buttons.find(b => b.id === buttonId);
                        if (button) {
                            fillStyle = button.pressed ? '#666' : button.color;
                        }
                    }
            }
            
            ctx.fillStyle = fillStyle;
            ctx.fillRect(x * singlePlayerGame.cellSize, y * singlePlayerGame.cellSize, 
                        singlePlayerGame.cellSize, singlePlayerGame.cellSize);
            
            // ÁªòÂà∂ÊåâÈíÆÁºñÂè∑ÔºàÂ¶ÇÊûúÊòØËß£Ë∞úÊ®°ÂºèÔºâ
            if (cellValue >= 10 && cellValue <= 20) {
                const buttonId = cellValue - 10;
                ctx.fillStyle = '#000';
                ctx.font = 'bold ' + (singlePlayerGame.cellSize/3) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText((buttonId + 1).toString(), 
                    x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                    y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2
                );
            }
        }
    }
    
    // ÁªòÂà∂Âá∫Âè£ÂíåÁé©ÂÆ∂ÔºàÂéüÊúâÈÄªËæëÔºâ
    ctx.fillStyle = '#F00';
    ctx.fillRect(singlePlayerGame.exit.x * singlePlayerGame.cellSize, 
                singlePlayerGame.exit.y * singlePlayerGame.cellSize, 
                singlePlayerGame.cellSize, singlePlayerGame.cellSize);
    
    drawPlayerWithSkin(
        ctx,
        singlePlayerGame.player.x * singlePlayerGame.cellSize,
        singlePlayerGame.player.y * singlePlayerGame.cellSize,
        singlePlayerGame.cellSize
    );
    
    // ÁªòÂà∂Áé©ÂÆ∂ÂêçÂ≠ó
    ctx.fillStyle = '#FFF';
    ctx.font = 'bold ' + (singlePlayerGame.cellSize/3) + 'px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    // ÁªòÂà∂ÊñáÂ≠óËÉåÊôØ‰ª•ÊèêÈ´òÂèØËØªÊÄß
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    const textWidth = ctx.measureText(gameState.playerName).width;
    ctx.fillRect(
        singlePlayerGame.player.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2 - textWidth/2 - 4,
        singlePlayerGame.player.y * singlePlayerGame.cellSize - 2,
        textWidth + 8,
        singlePlayerGame.cellSize/4 + 4
    );
    // ÁªòÂà∂ÊñáÂ≠ó
    ctx.fillStyle = '#FFF';
    ctx.fillText(gameState.playerName, 
        singlePlayerGame.player.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
        singlePlayerGame.player.y * singlePlayerGame.cellSize
    );
    
    // Âä®ÊÄÅÈáçÊñ∞ÁªòÂà∂Ë∑ØÂæÑÊèêÁ§∫ÔºàÂ¶ÇÊûúÊøÄÊ¥ªÔºâ
    if (gameState.showPathHint) {
        const path = findPathToExit(
            singlePlayerGame.maze,
            singlePlayerGame.player.x,
            singlePlayerGame.player.y,
            singlePlayerGame.exit.x,
            singlePlayerGame.exit.y
        );
        if (path) drawPathHint(path);
    }
}



        // Â∫îÁî®UIËÆæÁΩÆ
        function applyUISettings() {
            const settings = gameState.uiSettings;
            
            // Â∫îÁî®ÊéßÂà∂Èù¢ÊùøËÆæÁΩÆ - Â§ÑÁêÜ‰∏§‰∏™ÊéßÂà∂Èù¢Êùø
            const singlePlayerControls = document.getElementById('singlePlayerControls');
            const multiplayerControls = document.getElementById('multiplayerControls');
            const controlsPanels = [singlePlayerControls, multiplayerControls];
            
            controlsPanels.forEach(controlsPanel => {
                if (controlsPanel) {
                    controlsPanel.classList.toggle('hidden', !settings.showControls);
                    
                    // ËÆæÁΩÆ‰ΩçÁΩÆ
                    controlsPanel.style.position = 'fixed';
                    controlsPanel.style.left = '';
                    controlsPanel.style.right = '';
                    controlsPanel.style.top = '';
                    controlsPanel.style.bottom = '';
                    
                    if (settings.controlsPosition === 'custom' && settings.customX !== null && settings.customY !== null) {
                        controlsPanel.style.left = settings.customX + 'px';
                        controlsPanel.style.top = settings.customY + 'px';
                        // ÂêØÁî®ÊãñÊãΩÂäüËÉΩ - ÁßªÂä®Á´Ø‰ΩøÁî®ÊãñÊãΩÊâãÊüÑ
                        const dragHandle = controlsPanel.querySelector('.drag-handle');
                        if (dragHandle) {
                            dragHandle.style.display = 'block'; // ÊòæÁ§∫ÊãñÂä®ÊääÊâã
                            makeDraggable(controlsPanel, dragHandle);
                        }
                    } else {
                        // ÁßªÈô§ÊãñÊãΩÂäüËÉΩ
                        controlsPanel.removeAttribute('draggable');
                        // ÈöêËóèÊãñÂä®ÊääÊâã
                        const dragHandle = controlsPanel.querySelector('.drag-handle');
                        if (dragHandle) {
                            dragHandle.style.display = 'none';
                        }
                        // ÁßªÈô§ÂèØËÉΩÁöÑÊãñÊãΩ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈÄöËøáÈáçÊñ∞ÂàõÂª∫ÂÖÉÁ¥†ÂÆûÁé∞Ôºâ
                        const newPanel = controlsPanel.cloneNode(true);
                        controlsPanel.parentNode.replaceChild(newPanel, controlsPanel);
                        
                        // ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑÈù¢ÊùøÂÖÉÁ¥†
                        const updatedPanel = newPanel;
                        if (updatedPanel) {
                            switch(settings.controlsPosition) {
                                case 'bottom-left':
                                    updatedPanel.style.left = '20px';
                                    updatedPanel.style.bottom = '20px';
                                    break;
                                case 'bottom-right':
                                    updatedPanel.style.right = '20px';
                                    updatedPanel.style.bottom = '20px';
                                    break;
                                case 'top-left':
                                    updatedPanel.style.left = '20px';
                                    updatedPanel.style.top = '20px';
                                break;
                            case 'top-right':
                                updatedPanel.style.right = '20px';
                                updatedPanel.style.top = '20px';
                                break;
                        }
                    }
                }
            }
            
            // Â∫îÁî®Ê∏∏Êàè‰ø°ÊÅØËÆæÁΩÆ
            const gameInfo = document.getElementById('gameInfo');
            const multiplayerGameInfo = document.getElementById('multiplayerGameInfo');
            
            if (gameInfo) {
                gameInfo.style.display = settings.showGameInfo ? 'flex' : 'none';
                // ÈöêËóè/ÊòæÁ§∫ÂêÑ‰∏™‰ø°ÊÅØÈ°π
                const infoItems = ['levelDisplay', 'timeDisplay', 'moveCount', 'keyStatus'];
                infoItems.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = settings[`show${id.charAt(0).toUpperCase() + id.slice(1).replace('Display', 'Info').replace('Count', 'Info')}`] ? 'flex' : 'none';
                    }
                });
            }
            
            if (multiplayerGameInfo) {
                multiplayerGameInfo.style.display = settings.showGameInfo ? 'flex' : 'none';
                // ÈöêËóè/ÊòæÁ§∫ÂêÑ‰∏™‰ø°ÊÅØÈ°π
                const multiplayerInfoItems = ['multiplayerRoomCode', 'multiplayerTimeDisplay', 'multiplayerMoveCount', 'multiplayerPlayerCount'];
                multiplayerInfoItems.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = settings[`show${id.includes('Room') ? 'Room' : id.includes('Time') ? 'Time' : id.includes('Move') ? 'Move' : 'Room'}Info`] ? 'flex' : 'none';
                    }
                });
            }
            
            // Â∫îÁî®Áé©ÂÆ∂ÂàóË°®ËÆæÁΩÆ
            const playerList = document.getElementById('playerList');
            if (playerList) {
                playerList.style.display = gameState.uiSettings.showPlayerList ? 'block' : 'none';
            }
            })}
        function showScreen(screenId) {
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫Â≠òÊ°£ÊèêÁ§∫
            if (gameState.currentScreen === 'singlePlayerGame' && screenId !== 'singlePlayerComplete') {
                // Âè™Âú®Áé©ÂÆ∂ÊúâËøõÂ∫¶Êó∂ÊèêÁ§∫
                if (singlePlayerGame.moveCount > 0) {
                    const shouldSave = confirm('‰Ω†ÂΩìÂâçÊúâÊú™‰øùÂ≠òÁöÑËøõÂ∫¶ÔºåÊòØÂê¶‰øùÂ≠òÔºü');
                    if (shouldSave) {
                        // ËÆ©Áé©ÂÆ∂ÈÄâÊã©Â≠òÊ°£ÊßΩ
                        const slotChoice = prompt('ËØ∑ÈÄâÊã©Â≠òÊ°£‰ΩçÁΩÆ (1-3):');
                        const slot = parseInt(slotChoice) - 1;
                        if (!isNaN(slot) && slot >= 0 && slot <= 2) {
                            saveGame(slot);
                        } else {
                            // Â¶ÇÊûúÈÄâÊã©Êó†ÊïàÔºåÈªòËÆ§‰øùÂ≠òÂà∞Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆ
                            alert("ÈÄâÊã©Êó†ÊïàÔºåÂ∞Ü‰øùÂ≠òËá≥Á¨¨‰∏Ä‰∏™Â≠òÊ°£ÊßΩ")
                            saveGame(0);
                        }
                    }
                }
            }
            
            // ÈöêËóèÊâÄÊúâÂ±èÂπï
            const screens = [
                'mainMenu', 'singlePlayerLevelSelect', 'singlePlayerGame', 
                'singlePlayerComplete', 'multiplayerSetup', 'multiplayerGame',
                'achievementsScreen', 'moreChallengesScreen', 'statisticsScreen',
                'historyUpdates', 'dailyChallengeScreen'
            ];
            
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // ÊòæÁ§∫ËØ∑Ê±ÇÁöÑÂ±èÂπï
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
            }
            
            gameState.currentScreen = screenId;
            
            // ÊâßË°åÂ±èÂπïÁâπÂÆöÁöÑÂàùÂßãÂåñ
            switch(screenId) {
                case 'singlePlayerLevelSelect':
                    generateLevelButtons();
                    break;
                case 'singlePlayerGame':
                initSinglePlayerGame(gameState.isLoadingSave || false);
                EventSystem.init();
                    startPlayTimeTimer(); // ÂºÄÂßãÊ∏∏ÊàèÊó∂ÈïøËÆ°Êó∂
                    break;
                case 'multiplayerSetup':
                    document.getElementById('playerName').value = gameState.playerName;
                    break;
                case 'multiplayerGame':
                    startPlayTimeTimer(); // ÂºÄÂßãÊ∏∏ÊàèÊó∂ÈïøËÆ°Êó∂
                    break;
                case 'moreChallengesScreen':
                    updateChallengesStats();
                    break;
                case 'achievementsScreen':
                    updateAchievementProgress();
                    break;
                case 'statisticsScreen':
                    updateStatistics();
                    break;
                case 'dailyChallengeScreen':
                    initDailyChallenge();
                    break;
                case 'mainMenu':
                    stopPlayTimeTimer(); // ÂÅúÊ≠¢Ê∏∏ÊàèÊó∂ÈïøËÆ°Êó∂
                    updatePlayTimeDisplay(); // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂ÈïøÊòæÁ§∫
                    break;
            }

            // ÊòæÁ§∫/ÈöêËóèÊéßÂà∂Èù¢Êùø
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const singlePlayerControls = document.getElementById('singlePlayerControls');
            const multiplayerControls = document.getElementById('multiplayerControls');
            
            if (singlePlayerControls) {
                singlePlayerControls.classList.toggle('hidden', screenId !== 'singlePlayerGame' || !isMobile);
            }
            if (multiplayerControls) {
                multiplayerControls.classList.toggle('hidden', screenId !== 'multiplayerGame' || !isMobile);
            }
            
            // Â∫îÁî®UIËÆæÁΩÆ
            applyUISettings();
        }     
        
        // ÊØèÊó•ÊåëÊàòÁ≥ªÁªü
        const CHALLENGE_TYPES = {
            SPEED: {
                id: 'speed',
                name: 'ÈÄüÂ∫¶ÊåëÊàò',
                icon: '‚ö°',
                description: 'Âú®ÈôêÂÆöÊó∂Èó¥ÂÜÖÂÆåÊàêÂÖ≥Âç°',
                rewards: { coins: 12, stars: 4 }
            },
            STEPS: {
                id: 'steps',
                name: 'Ê≠•Êï∞ÊåëÊàò',
                icon: 'üë£',
                description: 'Áî®ÊúÄÂ∞ëÁöÑÊ≠•Êï∞ÂÆåÊàêÂÖ≥Âç°',
                rewards: { coins: 12, stars: 4 }
            },
            NO_TRAPS: {
                id: 'no_traps',
                name: 'Êó†Èô∑Èò±ÊåëÊàò',
                icon: 'üõ°Ô∏è',
                description: '‰∏çËß¶Âèë‰ªª‰ΩïÈô∑Èò±ÂÆåÊàêÂÖ≥Âç°',
                rewards: { coins: 12, stars: 4 }
            },
        };
        
        function getTodayDateString() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }
        
        function generateDailyChallenge() {
            const today = getTodayDateString();
            const seed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const types = Object.values(CHALLENGE_TYPES);
            const typeIndex = seed % types.length;
            const challengeType = types[typeIndex];
            
            const level = (seed % 20) + 1;
            let challengeData = {
                level: level,
                target: 0,
                description: ''
            };
            
            switch(challengeType.id) {
                case 'speed':
                    const timeLimit = 30 + (seed % 60);
                    challengeData.target = timeLimit;
                    challengeData.description = `Âú®${timeLimit}ÁßíÂÜÖÂÆåÊàêÁ¨¨${level}ÂÖ≥`;
                    break;
                case 'steps':
                    const maxSteps = 20 + (seed % 30);
                    challengeData.target = maxSteps;
                    challengeData.description = `Áî®‰∏çË∂ÖËøá${maxSteps}Ê≠•ÂÆåÊàêÁ¨¨${level}ÂÖ≥`;
                    break;
                case 'no_traps':
                    challengeData.target = 0;
                    challengeData.description = `Âú®‰∏çËß¶Âèë‰ªª‰ΩïÈô∑Èò±ÁöÑÊÉÖÂÜµ‰∏ãÂÆåÊàêÁ¨¨${level}ÂÖ≥`;
                    break;
                case 'collection':
                    challengeData.target = 5 + (seed % 10);
                    challengeData.description = `Êî∂ÈõÜËá≥Â∞ë${challengeData.target}‰∏™ÈáëÂ∏ÅÂÆåÊàêÁ¨¨${level}ÂÖ≥`;
                    break;
            }
            
            return {
                currentDate: today,
                challengeType: challengeType,
                challengeData: challengeData,
                isCompleted: false,
                isClaimed: false,
                progress: 0,
                history: []
            };
        }
        
        function initDailyChallenge() {
            const today = getTodayDateString();
            
            if (gameState.dailyChallenge.currentDate !== today) {
                gameState.dailyChallenge = generateDailyChallenge();
                saveDailyChallenge();
            }
            
            updateDailyChallengeUI();
            startChallengeCountdown();
        }
        
        function updateDailyChallengeUI() {
            const challenge = gameState.dailyChallenge;
            
            document.getElementById('challengeDate').textContent = 
                new Date(challenge.currentDate).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            
            document.getElementById('challengeIcon').textContent = challenge.challengeType.icon;
            document.getElementById('challengeTitle').textContent = challenge.challengeType.name;
            document.getElementById('challengeDescription').textContent = challenge.challengeData.description;
            document.getElementById('rewardCoins').textContent = challenge.challengeType.rewards.coins;
            document.getElementById('rewardStars').textContent = challenge.challengeType.rewards.stars;
            
            const statusElement = document.getElementById('challengeStatus');
            if (challenge.isCompleted) {
                if (challenge.isClaimed) {
                    statusElement.innerHTML = '<span class="status-completed">Â∑≤È¢ÜÂèñ</span>';
                } else {
                    statusElement.innerHTML = '<span class="status-completed">Â∑≤ÂÆåÊàê</span>';
                }
            } else {
                statusElement.innerHTML = '<span class="status-pending">Êú™ÂÆåÊàê</span>';
            }
            
            const goalsElement = document.getElementById('challengeGoals');
            goalsElement.innerHTML = '';
            const goals = getChallengeGoals(challenge);
            goals.forEach(goal => {
                const li = document.createElement('li');
                li.textContent = goal;
                goalsElement.appendChild(li);
            });
            
            const progressSection = document.getElementById('challengeProgressSection');
            const startBtn = document.getElementById('startChallengeBtn');
            const claimBtn = document.getElementById('claimRewardBtn');
            
            if (challenge.isCompleted) {
                progressSection.style.display = 'block';
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'ÊåëÊàòÂÆåÊàêÔºÅ';
                
                if (challenge.isClaimed) {
                    startBtn.style.display = 'none';
                    claimBtn.style.display = 'none';
                } else {
                    startBtn.style.display = 'none';
                    claimBtn.style.display = 'block';
                }
            } else {
                progressSection.style.display = 'none';
                startBtn.style.display = 'block';
                claimBtn.style.display = 'none';
            }
            
            updateChallengeHistory();
        }
        
        function getChallengeGoals(challenge) {
            const goals = [];
            goals.push(`ÂÆåÊàêÁ¨¨${challenge.challengeData.level}ÂÖ≥`);
            
            switch(challenge.challengeType.id) {
                case 'speed':
                    goals.push(`Âú®${challenge.challengeData.target}ÁßíÂÜÖÂÆåÊàê`);
                    break;
                case 'steps':
                    goals.push(`‰ΩøÁî®Ê≠•Êï∞‰∏çË∂ÖËøá${challenge.challengeData.target}Ê≠•`);
                    break;
                case 'no_traps':
                    goals.push('‰∏çËß¶Âèë‰ªª‰ΩïÈô∑Èò±');
                    break;
                case 'collection':
                    goals.push(`Êî∂ÈõÜËá≥Â∞ë${challenge.challengeData.target}‰∏™ÈáëÂ∏Å`);
                    break;
            }
            
            return goals;
        }
        
        function startChallengeCountdown() {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        function updateCountdown() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const diff = tomorrow - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('challengeCountdown').textContent = 
                `Ë∑ùÁ¶ªÂà∑Êñ∞: ${hours}Â∞èÊó∂ ${minutes}ÂàÜÈíü ${seconds}Áßí`;
        }
        
        function startDailyChallenge() {
            const challenge = gameState.dailyChallenge;
            gameState.currentLevel = challenge.challengeData.level;
            gameState.currentChallenge = 'daily';
            showScreen('singlePlayerGame');
        }
        
        function checkDailyChallengeCompletion() {
            if (gameState.currentChallenge !== 'daily') return;
            
            const challenge = gameState.dailyChallenge;
            const game = singlePlayerGame;
            
            let completed = false;
            
            switch(challenge.challengeType.id) {
                case 'speed':
                    const timeUsed = (Date.now() - game.startTime) / 1000;
                    completed = timeUsed <= challenge.challengeData.target;
                    break;
                case 'steps':
                    completed = game.moveCount <= challenge.challengeData.target;
                    break;
                case 'no_traps':
                    completed = game.trapHits === 0;
                    break;
                case 'collection':
                    completed = game.coinsCollected >= challenge.challengeData.target;
                    break;
            }
            
            if (completed) {
                challenge.isCompleted = true;
                challenge.history.push({
                    date: new Date().toISOString(),
                    result: 'completed',
                    type: challenge.challengeType.id
                });
                saveDailyChallenge();
                showNotification('üéâ ÊØèÊó•ÊåëÊàòÂÆåÊàêÔºÅ', 3000);
            }
        }
        
        function claimDailyReward() {
            const challenge = gameState.dailyChallenge;
            
            if (!challenge.isCompleted || challenge.isClaimed) {
                showNotification('Êó†Ê≥ïÈ¢ÜÂèñÂ•ñÂä±', 2000);
                return;
            }
            
            gameState.playerData.coins += challenge.challengeType.rewards.coins;
            gameState.coins += challenge.challengeType.rewards.coins;
            challenge.isClaimed = true;
            
            saveDailyChallenge();
            saveGame();
            updateDailyChallengeUI();
            
            showNotification(`üéÅ Â∑≤È¢ÜÂèñ ${challenge.challengeType.rewards.coins} ÈáëÂ∏ÅÂíå ${challenge.challengeType.rewards.stars} ÊòüÊòüÔºÅ`, 3000);
        }
        
        function updateChallengeHistory() {
            const historyContainer = document.getElementById('challengeHistory');
            const history = gameState.dailyChallenge.history;
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p style="color: #ccc; text-align: center;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>';
                return;
            }
            
            historyContainer.innerHTML = '';
            history.slice(-7).reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = `history-item ${record.result}`;
                
                const date = new Date(record.date);
                const dateStr = date.toLocaleDateString('zh-CN', {
                    month: 'short',
                    day: 'numeric'
                });
                
                const typeInfo = CHALLENGE_TYPES[record.type.toUpperCase()] || { name: 'Êú™Áü•ÊåëÊàò' };
                const resultText = record.result === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'Â§±Ë¥•';
                
                item.innerHTML = `
                    <span class="history-date">${dateStr} - ${typeInfo.name}</span>
                    <span class="history-result ${record.result}">${resultText}</span>
                `;
                
                historyContainer.appendChild(item);
            });
        }
        
        function saveDailyChallenge() {
            localStorage.setItem('dailyChallenge', JSON.stringify(gameState.dailyChallenge));
        }
        
        // Ê∏∏ÊàèÊó∂ÈïøÁªüËÆ°Áõ∏ÂÖ≥ÂáΩÊï∞
        let playTimeTimer = null; // Ê∏∏ÊàèÊó∂ÈïøËÆ°Êó∂Âô®

        // ÂêØÂä®Ê∏∏ÊàèÊó∂ÈïøËÆ°Êó∂
        function startPlayTimeTimer() {
            if (playTimeTimer) { clearInterval(playTimeTimer); }
            gameState.sessionStartTime = Date.now();
            playTimeTimer = setInterval(() => {
                const now = Date.now();
                const sessionTime = now - gameState.sessionStartTime;
                gameState.totalPlayTime += sessionTime;
                gameState.sessionStartTime = now;
                if (now - gameState.lastSavedTime > 60000) { // ÊØèÂàÜÈíü‰øùÂ≠ò‰∏ÄÊ¨°
                    localStorage.setItem('totalPlayTime', gameState.totalPlayTime.toString());
                    gameState.lastSavedTime = now;
                }
                updatePlayTimeDisplay();
            }, 1000);
        }

        // ÂÅúÊ≠¢Ê∏∏ÊàèÊó∂ÈïøËÆ°Êó∂
        function stopPlayTimeTimer() {
            if (playTimeTimer) { 
                clearInterval(playTimeTimer); 
                playTimeTimer = null;
            }
            const now = Date.now();
            const sessionTime = now - gameState.sessionStartTime;
            gameState.totalPlayTime += sessionTime;
            localStorage.setItem('totalPlayTime', gameState.totalPlayTime.toString());
            gameState.lastSavedTime = now;
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂ÈïøÊòæÁ§∫
        function updatePlayTimeDisplay() {
            const playTimeElement = document.getElementById('playTimeDisplay');
            if (playTimeElement) {
                const minutes = Math.floor(gameState.totalPlayTime / (1000 * 60));
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                if (days > 0) {
                    playTimeElement.textContent = `Ê∏∏ÊàèÊó∂Èïø: ${days}Â§© ${hours % 24}Â∞èÊó∂ ${minutes % 60}ÂàÜÈíü`;
                } else if (hours > 0) {
                    playTimeElement.textContent = `Ê∏∏ÊàèÊó∂Èïø: ${hours}Â∞èÊó∂ ${minutes % 60}ÂàÜÈíü`;
                } else {
                    playTimeElement.textContent = `Ê∏∏ÊàèÊó∂Èïø: ${minutes}ÂàÜÈíü`;
                }
            }
        }

        // ËÅäÂ§©Á≥ªÁªüÂáΩÊï∞
        // ÊâìÂºÄËÅäÂ§©Ê®°ÊÄÅÊ°Ü
        function openChatModal() {
            const chatModal = document.getElementById('chatModal');
            if (chatModal) {
                chatModal.style.display = 'flex';
            }
        }
        
        // ÂÖ≥Èó≠ËÅäÂ§©Ê®°ÊÄÅÊ°Ü
        function closeChatModal() {
            const chatModal = document.getElementById('chatModal');
            if (chatModal) {
                chatModal.style.display = 'none';
            }
        }
        
        function sendChatMessage() {
            // Ê£ÄÊü•‰∏§‰∏™ËæìÂÖ•Ê°Ü
            const messageInput1 = document.getElementById('chatInput');
            const messageInput2 = document.getElementById('chatInputModal');
            
            let message = '';
            let sourceInput = null;
            
            // Ê£ÄÊü•‰∏§‰∏™ËæìÂÖ•Ê°ÜÔºåËé∑ÂèñÈùûÁ©∫ÂÄºÂíåÂØπÂ∫îÁöÑËæìÂÖ•Ê°Ü
            if (messageInput1 && messageInput1.value.trim()) {
                message = messageInput1.value.trim();
                sourceInput = messageInput1;
            } else if (messageInput2 && messageInput2.value.trim()) {
                message = messageInput2.value.trim();
                sourceInput = messageInput2;
            }
            
            if (message) {
                // ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®‰øùÂ≠òÂΩìÂâçÁé©ÂÆ∂ÁöÑËÑèËØùËÆ°Êï∞ÂíåÁ¶ÅË®ÄÊó∂Èó¥ÔºåÁ°Æ‰øùÂè™ÂΩ±ÂìçÂΩìÂâçÁé©ÂÆ∂
                const now = Date.now();
                
                // Ëé∑ÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑÁ¶ÅË®ÄÊó∂Èó¥
                const localMuteEndTime = parseInt(localStorage.getItem('localMuteEndTime')) || 0;
                
                // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Â§Ñ‰∫éÁ¶ÅË®ÄÁä∂ÊÄÅ
                if (localMuteEndTime > now) {
                    const remainingTime = Math.ceil((localMuteEndTime - now) / 1000 / 60); // ËΩ¨Êç¢‰∏∫ÂàÜÈíü
                    addChatMessage('Á≥ªÁªü', `ÊÇ®Â∑≤Ë¢´Á¶ÅË®ÄÔºåÂâ©‰Ωô ${remainingTime} ÂàÜÈíü`, '#FF5252');
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                }
                
                // ËÑèËØùÊ£ÄÊµãÂíåËøáÊª§
                // ËÑèËØùÂàóË°®ÔºåÂåÖÂê´‰∏≠Ëã±ÊñáÂ∏∏ËßÅËÑèËØù
                const profanityList = [
                    // ‰∏≠ÊñáËÑèËØù
                    'ÂÇªÈÄº', 'Êìç‰Ω†Â¶à', 'ËçâÊ≥•È©¨', 'ÂéªÊ≠ª', 'ÂûÉÂúæ', 'Â∫üÁâ©', 'Ë†¢Ë¥ß',
                    'ËÑëÊÆã', 'Êô∫Èöú', '‰∫åÁôæ‰∫î', 'ÁéãÂÖ´Ëõã', 'ÈæüÂÑøÂ≠ê', 'ÊùÇÁßç', 'ÁïúÁîü',
                    'Á¶ΩÂÖΩ', 'Ëâ≤Áãº', 'ÂèòÊÄÅ', 'Â©äÂ≠ê', 'Ë¥±‰∫∫', 'ÂÇªÂ±å', 'Â¶àËõã', 'ÊªöËõã',
                    'ÊàëÊìç‰Ω†Â¶à','ÊàëËçâÊ≥•È©¨','Ëá™ÊùÄ','Á¥´Á†Ç','ÊØíÂìÅ','ÂÜ∞Á≥ñ','Á•ûÁªèÁóÖ','Âú£ÁªèÂπ∂',
                    'ÊùúÂπ≥','ÊØíÁì∂',
                    // Ëã±ÊñáËÑèËØù
                    'fuck', 'shit', 'damn', 'bitch', 'asshole', 'dick', 'pussy',
                    'cunt', 'bastard', 'nigger', 'nigga', 'faggot', 'dyke', 'retard',
                    'whore', 'slut', 'douche', 'ass', 'shithead','sb','sbm','wcnm','fw',
                    'bt','die'
                ];
                
                // Ê£ÄÊµãÊñáÊú¨‰∏≠ÊòØÂê¶ÂåÖÂê´ËÑèËØù
                function containsProfanity(text) {
                    const lowercaseText = text.toLowerCase();
                    return profanityList.some(profanity => 
                        lowercaseText.includes(profanity.toLowerCase())
                    );
                }
                
                // ËøáÊª§ÊñáÊú¨‰∏≠ÁöÑËÑèËØùÔºåÊõøÊç¢‰∏∫ÊòüÂè∑
                function filterProfanity(text) {
                    let filteredText = text;
                    profanityList.forEach(profanity => {
                        const regex = new RegExp(profanity, 'gi');
                        filteredText = filteredText.replace(regex, '*'.repeat(profanity.length));
                    });
                    return filteredText;
                }
                
                // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÂåÖÂê´ËÑèËØù
                const hasProfanity = containsProfanity(message);
                if (hasProfanity) {
                    // Ëé∑ÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑËÑèËØùËÆ°Êï∞
                    let localProfanityCount = parseInt(localStorage.getItem('localProfanityCount')) || 0;
                    
                    // Â¢ûÂä†ËÑèËØùËÆ°Êï∞
                    localProfanityCount++;
                    
                    // ËøáÊª§ËÑèËØù
                    message = filterProfanity(message);
                    
                    // ÊòæÁ§∫Ë≠¶ÂëäÊ∂àÊÅØÔºåÂåÖÂê´ÂΩìÂâçËÑèËØùÊ¨°Êï∞
                    addChatMessage('Á≥ªÁªü', `ÊÇ®ÁöÑÊ∂àÊÅØ‰∏≠ÂåÖÂê´‰∏çÊñáÊòéÁî®ËØ≠ÔºåÂ∑≤Ëá™Âä®ËøáÊª§„ÄÇËÑèËØùÊ¨°Êï∞: ${localProfanityCount}/10`, '#FF5252');
                    
                    // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞Á¶ÅË®ÄÊù°‰ª∂
                    if (localProfanityCount >= 10) {
                        // ËÆæÁΩÆÁ¶ÅË®ÄÊó∂Èó¥Ôºö5ÂàÜÈíü
                        const newMuteEndTime = Date.now() + 5 * 60 * 1000;
                        // ‰øùÂ≠òÁ¶ÅË®ÄÊó∂Èó¥Âà∞Êú¨Âú∞Â≠òÂÇ®
                        localStorage.setItem('localMuteEndTime', newMuteEndTime.toString());
                        // ÈáçÁΩÆËÑèËØùËÆ°Êï∞
                        localStorage.setItem('localProfanityCount', '0');
                        // ÊòæÁ§∫Á¶ÅË®ÄÊ∂àÊÅØ
                        addChatMessage('Á≥ªÁªü', 'ÊÇ®Â∑≤Á¥ØËÆ°10Ê¨°‰ΩøÁî®‰∏çÊñáÊòéÁî®ËØ≠ÔºåÂ∑≤Ë¢´Á¶ÅË®Ä5ÂàÜÈíü', '#FF5252');
                        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                        if (sourceInput) {
                            sourceInput.value = '';
                        }
                        return;
                    }
                    
                    // ‰øùÂ≠òËÑèËØùËÆ°Êï∞Âà∞Êú¨Âú∞Â≠òÂÇ®
                    localStorage.setItem('localProfanityCount', localProfanityCount.toString());
                }
                
                // ÂºÄÂèëËÄÖÂëΩ‰ª§Â§ÑÁêÜ
                if (message.startsWith('kick ')) {
                    // Ë∏¢‰∫∫ÂëΩ‰ª§Ôºökick {Áé©ÂÆ∂Âêç}
                    const playerName = message.substring(5).trim();
                    if (playerName && gameState.multiplayer && gameState.multiplayer.players) {
                        // Êü•ÊâæÁé©ÂÆ∂
                        const playerId = Object.keys(gameState.multiplayer.players).find(id => 
                            gameState.multiplayer.players[id].name === playerName
                        );
                        if (playerId) {
                            // ÊòæÁ§∫Ë∏¢Âá∫Áé©ÂÆ∂ÁïåÈù¢
                            showKickPlayerModal();
                        } else {
                            addChatMessage('Á≥ªÁªü', `Êú™ÊâæÂà∞Áé©ÂÆ∂: ${playerName}`, '#FF5252');
                        }
                    }
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                } else if (message.startsWith('playmusic ')) {
                    // Êí≠ÊîæÈü≥‰πêÂëΩ‰ª§ÔºöÊîØÊåÅ‰∏§ÁßçÊñπÂºè
                    // 1. playmusic url [URL] - Êí≠ÊîæÊåáÂÆöURLÁöÑÈü≥‰πê
                    // 2. playmusic - ÊâìÂºÄÊñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÈÄâÊã©Èü≥‰πêÊñá‰ª∂
                    const parts = message.split(' ');
                    if (parts.length > 1 && parts[1] === 'url' && parts[2]) {
                        // Êí≠ÊîæÊåáÂÆöURLÁöÑÈü≥‰πê
                        const musicUrl = parts.slice(2).join(' ');
                        
                        // Êí≠ÊîæÈü≥‰πê
                        const audio = document.getElementById('gameAudio');
                        if (audio) {
                            audio.src = musicUrl;
                            audio.play().catch(error => {
                                console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error);
                                addChatMessage('Á≥ªÁªü', 'Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•ÔºåÂèØËÉΩÊòØURLÊó†ÊïàÊàñÊµèËßàÂô®ÈôêÂà∂', '#FF5252');
                            });
                            addChatMessage('Á≥ªÁªü', `ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ: ${musicUrl}`, '#4CAF50');
                        } else {
                            addChatMessage('Á≥ªÁªü', 'Êú™ÊâæÂà∞Èü≥È¢ëÂÖÉÁ¥†', '#FF5252');
                        }
                        
                        // ÂπøÊí≠ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                        if (gameState.multiplayer && gameState.multiplayer.connections) {
                            const playerName = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name || 'Áé©ÂÆ∂';
                            const musicMessage = {
                                type: 'music-command',
                                command: 'play',
                                url: musicUrl
                            };
                            Object.values(gameState.multiplayer.connections).forEach(conn => {
                                if (conn.send) {
                                    conn.send(musicMessage);
                                }
                            });
                        }
                    } else {
                        // ÊâìÂºÄÊñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÈÄâÊã©Èü≥‰πêÊñá‰ª∂
                        const musicFileInput = document.getElementById('musicFileInput');
                        if (musicFileInput) {
                            // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°Ü
                            musicFileInput.click();
                        } else {
                            addChatMessage('Á≥ªÁªü', 'Êú™ÊâæÂà∞Èü≥‰πêÊñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†', '#FF5252');
                        }
                    }
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                }
                
                // Èü≥‰πêÊñá‰ª∂ÈÄâÊã©Â§ÑÁêÜÂáΩÊï∞
                function handleMusicFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const audio = document.getElementById('gameAudio');
                        const fileURL = URL.createObjectURL(file);
                        
                        // Êõ¥Êñ∞Èü≥È¢ëÂÖÉÁ¥†ÁöÑsrc
                        audio.src = fileURL;
                        
                        // Â∞ÜÈü≥È¢ëÊñá‰ª∂ËΩ¨Êç¢‰∏∫Base64
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64AudioData = e.target.result;
                            
                            // Â∞ùËØïÊí≠ÊîæÈü≥‰πê
                            audio.play()
                                .then(() => {
                                    // Êí≠ÊîæÊàêÂäü
                                    addChatMessage('Á≥ªÁªü', `ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ: ${file.name}`, '#4CAF50');
                                    
                                    // ÂπøÊí≠ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                                    if (gameState.multiplayer && gameState.multiplayer.connections) {
                                        const playerName = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name || 'Áé©ÂÆ∂';
                                        const musicNotification = {
                                            type: 'music-command',
                                            command: 'play',
                                            audioData: base64AudioData, // ÂèëÈÄÅBase64Èü≥È¢ëÊï∞ÊçÆ
                                            fileName: file.name
                                        };
                                        Object.values(gameState.multiplayer.connections).forEach(conn => {
                                            if (conn.send) {
                                                conn.send(musicNotification);
                                            }
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error);
                                    // Êí≠ÊîæÂ§±Ë¥•ÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™óÔºà‰º†ÈÄíBase64Êï∞ÊçÆÔºâ
                                    showMusicPlayConfirmModal(fileURL, base64AudioData);
                                });
                        };
                        reader.readAsDataURL(file);
                    }
                }
                
                if (message === 'stop') {
                    // ÂÅúÊ≠¢Èü≥‰πêÂëΩ‰ª§ÔºöÂÅúÊ≠¢Êí≠ÊîæËÉåÊôØÈü≥‰πê
                    const audio = document.getElementById('gameAudio');
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                        addChatMessage('Á≥ªÁªü', 'ËÉåÊôØÈü≥‰πêÂ∑≤ÂÅúÊ≠¢', '#4CAF50');
                    } else {
                        addChatMessage('Á≥ªÁªü', 'Êú™ÊâæÂà∞Èü≥È¢ëÂÖÉÁ¥†', '#FF5252');
                    }
                    
                    // ÈÄöÁü•ÂÖ∂‰ªñÁé©ÂÆ∂Èü≥‰πêÂ∑≤ÂÅúÊ≠¢
                    if (gameState.multiplayer && gameState.multiplayer.connections) {
                        const playerName = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name || 'Áé©ÂÆ∂';
                        const stopNotification = {
                            type: 'chat-message',
                            from: gameState.multiplayer.currentPlayerId,
                            message: `[Èü≥‰πê] ${playerName} Â∑≤ÂÅúÊ≠¢Êí≠ÊîæÈü≥‰πê`,
                            color: '#FFD700'
                        };
                        Object.values(gameState.multiplayer.connections).forEach(conn => {
                            if (conn.send) {
                                conn.send(stopNotification);
                                // ÂèëÈÄÅÈü≥‰πêÂÅúÊ≠¢ÂëΩ‰ª§
                                conn.send({
                                    type: 'music-command',
                                    command: 'stop'
                                });
                            }
                        });
                    }
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                } else if (message === 'help') {
                    // Â∏ÆÂä©ÂëΩ‰ª§ÔºöÊòæÁ§∫ÊâÄÊúâÂèØÁî®Êåá‰ª§
                    const helpMessage = `ÂèØÁî®Êåá‰ª§ÂàóË°®Ôºö\n` +
                        `‚Ä¢ kick {Áé©ÂÆ∂Âêç} - Ë∏¢Âá∫ÊåáÂÆöÁé©ÂÆ∂\n` +
                        `‚Ä¢ playerlist - ÊòæÁ§∫ÂΩìÂâçÊàøÈó¥Áé©ÂÆ∂ÂàóË°®\n` +
                        `‚Ä¢ kickall - Ë∏¢Âá∫Èô§Êàø‰∏ªÂ§ñÁöÑÊâÄÊúâÁé©ÂÆ∂\n` +
                        `‚Ä¢ chatcolor - ÊâìÂºÄËÅäÂ§©È¢úËâ≤ÈÄâÊã©Ê°Ü\n` +
                        `‚Ä¢ playmusic url {Èü≥‰πêURL} - Êí≠ÊîæÊåáÂÆöURLÁöÑËÉåÊôØÈü≥‰πêÂπ∂ÂàÜ‰∫´ÁªôÂÖ∂‰ªñÁé©ÂÆ∂\n` +
                        `‚Ä¢ playmusic - ÈÄâÊã©Êú¨Âú∞Èü≥‰πêÊñá‰ª∂Êí≠ÊîæÔºà‰ªÖÊú¨Âú∞Ôºâ\n` +
                        `‚Ä¢ stop - ÂÅúÊ≠¢Êí≠ÊîæËÉåÊôØÈü≥‰πê\n` +
                        `‚Ä¢ help - ÊòæÁ§∫Ê≠§Â∏ÆÂä©‰ø°ÊÅØ`;
                    addChatMessage('Á≥ªÁªü', helpMessage, '#4CAF50');
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                } else if (message === 'playerlist') {
                    // Áé©ÂÆ∂ÂàóË°®ÂëΩ‰ª§ÔºöÊòæÁ§∫ÂΩìÂâçÊàøÈó¥ÁöÑÁé©ÂÆ∂ÂàóË°®
                    if (gameState.multiplayer && gameState.multiplayer.players) {
                        let playerList = 'ÂΩìÂâçÊàøÈó¥Áé©ÂÆ∂ÂàóË°®Ôºö\n';
                        Object.entries(gameState.multiplayer.players).forEach(([id, player]) => {
                            const hostMark = player.isHost ? ' [Êàø‰∏ª]' : '';
                            playerList += `- ${player.name}${hostMark} (ID: ${id})\n`;
                        });
                        addChatMessage('Á≥ªÁªü', playerList, '#4CAF50');
                    } else {
                        addChatMessage('Á≥ªÁªü', 'Êú™ÊâæÂà∞Áé©ÂÆ∂ÂàóË°®Êï∞ÊçÆ', '#FF5252');
                    }
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                } else if (message === 'kickall') {
                    // Ë∏¢Âá∫ÊâÄÊúâÁé©ÂÆ∂ÂëΩ‰ª§ÔºöË∏¢Âá∫Èô§Êàø‰∏ªÂ§ñÁöÑÊâÄÊúâÁé©ÂÆ∂
                    if (gameState.multiplayer && gameState.multiplayer.players) {
                        const currentPlayerId = gameState.multiplayer.currentPlayerId;
                        const currentPlayer = gameState.multiplayer.players[currentPlayerId];
                        
                        if (currentPlayer && currentPlayer.isHost) {
                            // ÈÅçÂéÜÊâÄÊúâÁé©ÂÆ∂ÔºåË∏¢Âá∫ÈùûÊàø‰∏ªÁé©ÂÆ∂
                            let kickedCount = 0;
                            Object.entries(gameState.multiplayer.players).forEach(([id, player]) => {
                                if (id !== currentPlayerId && !player.isHost) {
                                    // ÂèëÈÄÅË∏¢‰∫∫Ê∂àÊÅØ
                                    const kickMessage = {
                                        type: 'kick-player',
                                        playerId: id
                                    };
                                    
                                    if (gameState.multiplayer.connections && gameState.multiplayer.connections[id]) {
                                        gameState.multiplayer.connections[id].send(kickMessage);
                                        gameState.multiplayer.connections[id].close();
                                    }
                                    
                                    // ‰ªéÊú¨Âú∞Áé©ÂÆ∂ÂàóË°®‰∏≠ÁßªÈô§
                                    delete gameState.multiplayer.players[id];
                                    delete gameState.multiplayer.connections[id];
                                    
                                    kickedCount++;
                                }
                            });
                            
                            // Êõ¥Êñ∞Áé©ÂÆ∂ÂàóË°®ÊòæÁ§∫
                            updatePlayerList();
                            
                            // ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                            addChatMessage('Á≥ªÁªü', `Â∑≤Ë∏¢Âá∫ ${kickedCount} ÂêçÁé©ÂÆ∂`, '#FF5252');
                        } else {
                            addChatMessage('Á≥ªÁªü', 'Âè™ÊúâÊàø‰∏ªÂèØ‰ª•‰ΩøÁî®Ê≠§ÂëΩ‰ª§', '#FF5252');
                        }
                    } else {
                        addChatMessage('Á≥ªÁªü', 'Êú™ÊâæÂà∞Áé©ÂÆ∂ÂàóË°®Êï∞ÊçÆ', '#FF5252');
                    }
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                } else if (message === 'chatcolor') {
                    // ËÅäÂ§©È¢úËâ≤ÂëΩ‰ª§ÔºöÊâìÂºÄÈ¢úËâ≤ÈÄâÊã©Ê°Ü
                    // ÂàõÂª∫‰∏Ä‰∏™Ê®°ÊÄÅÂØπËØùÊ°ÜÊù•ÊòæÁ§∫È¢úËâ≤ÈÄâÊã©Âô®ÔºåÂÖºÂÆπÊâãÊú∫Á´Ø
                    const colorModal = document.createElement('div');
                    colorModal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white;`;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);`;
                    
                    const title = document.createElement('h3');
                    title.textContent = 'ÈÄâÊã©ËÅäÂ§©È¢úËâ≤';
                    title.style.marginBottom = '20px';
                    title.style.color = '#4CAF50';
                    
                    const colorPicker = document.createElement('input');
                    colorPicker.type = 'color';
                    colorPicker.value = gameState.chatColor || '#4CAF50';
                    colorPicker.style.cssText = `width: 100px; height: 100px; border: none; border-radius: 10px; cursor: pointer; margin: 20px 0; box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);`;
                    
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Á°ÆËÆ§';
                    confirmBtn.style.cssText = `background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; transition: all 0.3s;`;
                    
                    confirmBtn.onclick = function() {
                        gameState.chatColor = colorPicker.value;
                        localStorage.setItem('chatColor', gameState.chatColor);
                        addChatMessage('Á≥ªÁªü', `ËÅäÂ§©È¢úËâ≤Â∑≤ËÆæÁΩÆ‰∏∫ ${gameState.chatColor}`, '#4CAF50');
                        document.body.removeChild(colorModal);
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'ÂèñÊ∂à';
                    cancelBtn.style.cssText = `background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; transition: all 0.3s;`;
                    
                    cancelBtn.onclick = function() {
                        document.body.removeChild(colorModal);
                    };
                    
                    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
                    colorModal.onclick = function(e) {
                        if (e.target === colorModal) {
                            document.body.removeChild(colorModal);
                        }
                    };
                    
                    // ÁªÑË£ÖÊ®°ÊÄÅÊ°Ü
                    modalContent.appendChild(title);
                    modalContent.appendChild(colorPicker);
                    modalContent.appendChild(confirmBtn);
                    modalContent.appendChild(cancelBtn);
                    colorModal.appendChild(modalContent);
                    
                    // Ê∑ªÂä†Âà∞DOM
                    document.body.appendChild(colorModal);
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    if (sourceInput) {
                        sourceInput.value = '';
                    }
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÂ§ö‰∫∫Ê∏∏ÊàèÊ®°Âºè
                if (gameState.currentScreen === 'multiplayerGame' && gameState.multiplayer) {
                    // Ëé∑ÂèñÂΩìÂâçÁé©ÂÆ∂‰ø°ÊÅØ
                    const player = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
                    
                    // ÁîüÊàêÊ∂àÊÅØID
                    const messageId = Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    // ÂêëÊâÄÊúâÁé©ÂÆ∂ÂèëÈÄÅÊ∂àÊÅØ
                    const chatMessage = {
                        type: 'chat-message',
                        from: gameState.multiplayer.currentPlayerId,
                        message: message,
                        color: gameState.chatColor || (player ? player.color : '#4CAF50'),
                        messageId: messageId
                    };
                    
                    // ÂèëÈÄÅÁªôÊâÄÊúâËøûÊé•ÁöÑÁé©ÂÆ∂
                    if (gameState.multiplayer.connections) {
                        Object.values(gameState.multiplayer.connections).forEach(conn => {
                            if (conn.send) {
                                conn.send(chatMessage);
                            }
                        });
                    }
                    
                    // Ëá™Â∑±‰πüÊòæÁ§∫Ê∂àÊÅØ
                    if (player) {
                        addChatMessage(player.name, message, gameState.chatColor || player.color, null, messageId);
                    }
                } else {
                    // Âçï‰∫∫Ê∏∏ÊàèÊ®°Âºè‰∏ãÂè™ÊòæÁ§∫Ëá™Â∑±ÁöÑÊ∂àÊÅØ
                    addChatMessage('Êàë', message, gameState.chatColor || '#4CAF50');
                }
                
                // Âè™Ê∏ÖÁ©∫ÂèëÈÄÅÊ∂àÊÅØÁöÑËæìÂÖ•Ê°Ü
                if (sourceInput) {
                    sourceInput.value = '';
                }
            }
        }

        // ËØ≠Èü≥ËÅäÂ§©Áõ∏ÂÖ≥ÂèòÈáè
        const MAX_RECORDING_DURATION = 60; // ÊúÄÂ§ßÂΩïÂà∂Êó∂ÈïøÔºàÁßíÔºâ
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isPaused = false;
        let recordingStartTime = 0;
        let recordingTimer = null;
        let autoStopTimer = null;
        let recordingElapsed = 0; // ÂΩïÂà∂Â∑≤ËøáÂéªÁöÑÊó∂Èó¥ÔºàÁßíÔºâ
        
        // ËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅÁÆ°ÁêÜ
        let currentAudio = null;
        let currentPlayingButton = null;
        let isPlaying = false;
        let playbackTimer = null; // Êí≠ÊîæËøõÂ∫¶ÂÆöÊó∂Âô®
        
        // Èü≥‰πêÊí≠ÊîæÁ°ÆËÆ§Áõ∏ÂÖ≥ÂèòÈáè
        let musicPlayTimer = null;
        let musicPlayCountdown = 10;
        let pendingMusicUrl = null;
        let pendingMusicData = null; // ÂæÖÂèëÈÄÅÁöÑBase64Èü≥‰πêÊï∞ÊçÆ
        
        // ËØ≠Èü≥ÂΩïÂà∂ÂàáÊç¢ÂáΩÊï∞
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        // ÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
        function initSpeechRecognition() {
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩ');
                return null;
            }

            // ÂàõÂª∫ËØ≠Èü≥ËØÜÂà´ÂÆû‰æã
            const recognition = new SpeechRecognition();
            recognition.continuous = true; // ÊåÅÁª≠ËØÜÂà´
            recognition.interimResults = true; // ËøîÂõû‰∏≠Èó¥ÁªìÊûú
            recognition.lang = 'zh-CN'; // ËÆæÁΩÆ‰∏∫‰∏≠Êñá
            recognition.maxAlternatives = 1; // Âè™ËøîÂõû‰∏Ä‰∏™ÁªìÊûú

            // ÁõëÂê¨ËØÜÂà´ÁªìÊûú
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                // Â§ÑÁêÜÊâÄÊúâÁªìÊûú
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Êõ¥Êñ∞ËΩ¨ÂΩïÊñáÊú¨
                transcriptionText = finalTranscript + interimTranscript;
                updateTranscriptionDisplay();
            };

            // ÁõëÂê¨ÈîôËØØ
            recognition.onerror = function(event) {
                console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error);
                if (event.error === 'not-allowed') {
                    addChatMessage('Á≥ªÁªü', 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ', '#FF5252');
                }
                stopSpeechTranscription();
            };

            // ÁõëÂê¨ÁªìÊùü‰∫ã‰ª∂
            recognition.onend = function() {
                if (isTranscribing) {
                    // Â¶ÇÊûúËøòÂú®ËΩ¨ÂΩïÁä∂ÊÄÅÔºåÈáçÊñ∞ÂºÄÂßã
                    recognition.start();
                }
            };

            return recognition;
        }

        // ÂàáÊç¢ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩ
        function toggleSpeechTranscription() {
            if (isTranscribing) {
                stopSpeechTranscription();
            } else {
                startSpeechTranscription();
            }
        }

        // ÂºÄÂßãËØ≠Èü≥ËΩ¨ÊñáÂ≠ó
        function startSpeechTranscription() {
            // ÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
            if (!speechRecognition) {
                speechRecognition = initSpeechRecognition();
                if (!speechRecognition) {
                    return;
                }
            }

            // ÂºÄÂßãËØÜÂà´
            isTranscribing = true;
            transcriptionText = '';
            updateTranscriptionDisplay();
            updateTranscriptionButtonStatus();
            
            // ÂºÄÂßãËØ≠Èü≥ËØÜÂà´
            speechRecognition.start();

            // ËÆæÁΩÆ10ÁßíËá™Âä®ÂÅúÊ≠¢ÂÆöÊó∂Âô®
            recognitionTimer = setTimeout(() => {
                stopSpeechTranscription();
            }, 100000);
        }

        // ÂÅúÊ≠¢ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó
        function stopSpeechTranscription() {
            if (speechRecognition && isTranscribing) {
                isTranscribing = false;
                speechRecognition.stop();
                updateTranscriptionButtonStatus();
                clearTimeout(recognitionTimer);
            }
        }

        // Êõ¥Êñ∞ËΩ¨ÂΩïÊòæÁ§∫
        function updateTranscriptionDisplay() {
            // Ëé∑ÂèñËÅäÂ§©ËæìÂÖ•Ê°Ü
            const inputs = [
                document.getElementById('chatInput'),
                document.getElementById('chatInputModal')
            ];

            inputs.forEach(input => {
                if (input) {
                    input.value = transcriptionText;
                }
            });
        }

        // Êõ¥Êñ∞ËΩ¨ÂΩïÊåâÈíÆÁä∂ÊÄÅ
        function updateTranscriptionButtonStatus() {
            const buttons = [
                document.getElementById('transcribeButton'),
                document.getElementById('transcribeButtonModal')
            ];
        }

        // ÂºÄÂßãËØ≠Èü≥ÂΩïÂà∂
        function startVoiceRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                        sendVoiceMessage(audioBlob, duration);
                        
                        // ÈáçÁΩÆÂΩïÂà∂Áä∂ÊÄÅ
                        audioChunks = [];
                        isRecording = false;
                        updateVoiceButtonStatus();
                        clearInterval(recordingTimer);
                        clearTimeout(autoStopTimer);
                        
                        // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëËΩ®ÈÅì
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    // ÂºÄÂßãÂΩïÂà∂
                    mediaRecorder.start();
                    isRecording = true;
                    isPaused = false;
                    recordingStartTime = Date.now();
                    recordingElapsed = 0;
                    updateVoiceButtonStatus();
                    
                    // ÊòæÁ§∫ÂΩïÈü≥Áä∂ÊÄÅÊ®°ÊÄÅÊ°Ü
                    showRecordingModal();
                    
                    // ÊòæÁ§∫ÂΩïÂà∂Êó∂Èïø
                    recordingTimer = setInterval(() => {
                        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                        if (!isPaused) {
                            recordingElapsed = duration;
                            updateRecordingDuration(duration);
                        }
                    }, 1000);
                    
                    // ËÆæÁΩÆËá™Âä®ÂÅúÊ≠¢ÂÆöÊó∂Âô®
                    autoStopTimer = setTimeout(() => {
                        if (isRecording) {
                            mediaRecorder.stop();
                            // ÂÖ≥Èó≠ÂΩïÈü≥Ê®°ÊÄÅÊ°Ü
                            hideRecordingModal();
                            // ‰ΩøÁî®setTimeoutÂª∂ËøüÂºπÁ™óÔºåÁ°Æ‰øùÂΩïÂà∂Â∑≤ÂÅúÊ≠¢
                            setTimeout(() => {
                                addChatMessage('Á≥ªÁªü', `ÂΩïÂà∂Â∑≤Ëá™Âä®ÂÅúÊ≠¢ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÂΩïÂà∂Êó∂Èïø ${MAX_RECORDING_DURATION} Áßí`, '#FF9800');
                            }, 100);
                        }
                    }, MAX_RECORDING_DURATION * 1000);
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÊùÉÈôêÂ§±Ë¥•:', error);
                    alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                });
        }
        
        // ÂÅúÊ≠¢ËØ≠Èü≥ÂΩïÂà∂
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                // ÂÖ≥Èó≠ÂΩïÈü≥Ê®°ÊÄÅÊ°Ü
                hideRecordingModal();
            }
            // Ê∏ÖÈô§Ëá™Âä®ÂÅúÊ≠¢ÂÆöÊó∂Âô®
            clearTimeout(autoStopTimer);
        }

        // ÊòæÁ§∫ÂΩïÈü≥Áä∂ÊÄÅÊ®°ÊÄÅÊ°Ü
        function showRecordingModal() {
            const modal = document.getElementById('recordingModal');
            if (modal) {
                // ÁßªÈô§hiddenÁ±ªÔºåÂπ∂ËÆæÁΩÆdisplayÊ†∑Âºè
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                // ÈáçÁΩÆÁä∂ÊÄÅ
                recordingElapsed = 0;
                updateRecordingModalDisplay();
            }
        }

        // ÈöêËóèÂΩïÈü≥Áä∂ÊÄÅÊ®°ÊÄÅÊ°Ü
        function hideRecordingModal() {
            const modal = document.getElementById('recordingModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
            isPaused = false;
        }
        
        // ÊòæÁ§∫Èü≥‰πêÊí≠ÊîæÁ°ÆËÆ§ÂºπÁ™ó
        function showMusicPlayConfirmModal(musicUrl, musicData) {
            const modal = document.getElementById('musicPlayConfirmModal');
            if (modal) {
                pendingMusicUrl = musicUrl;
                pendingMusicData = musicData;
                musicPlayCountdown = 10;
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                
                // Êõ¥Êñ∞ÂÄíËÆ°Êó∂ÊòæÁ§∫
                const countdownElement = document.getElementById('rejectCountdown');
                if (countdownElement) {
                    countdownElement.textContent = musicPlayCountdown;
                }
                
                // Á¶ÅÁî®ÊãíÁªùÊåâÈíÆ
                const rejectBtn = document.getElementById('rejectMusicBtn');
                if (rejectBtn) {
                    rejectBtn.disabled = true;
                    rejectBtn.style.opacity = '0.5';
                    rejectBtn.style.cursor = 'not-allowed';
                }
                
                // ÂêØÂä®ÂÄíËÆ°Êó∂
                startMusicPlayCountdown();
            }
        }
        
        // ÈöêËóèÈü≥‰πêÊí≠ÊîæÁ°ÆËÆ§ÂºπÁ™ó
        function hideMusicPlayConfirmModal() {
            const modal = document.getElementById('musicPlayConfirmModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
            stopMusicPlayCountdown();
            pendingMusicUrl = null;
            pendingMusicData = null;
        }
        
        // ÂêØÂä®Èü≥‰πêÊí≠ÊîæÂÄíËÆ°Êó∂
        function startMusicPlayCountdown() {
            stopMusicPlayCountdown(); // ÂÖàÂÅúÊ≠¢‰πãÂâçÁöÑÂÄíËÆ°Êó∂
            
            musicPlayTimer = setInterval(() => {
                musicPlayCountdown--;
                const countdownElement = document.getElementById('rejectCountdown');
                const rejectBtn = document.getElementById('rejectMusicBtn');
                
                if (countdownElement) {
                    countdownElement.textContent = musicPlayCountdown;
                }
                
                // ÂÄíËÆ°Êó∂ÁªìÊùüÔºåÂêØÁî®ÊãíÁªùÊåâÈíÆ
                if (musicPlayCountdown <= 0) {
                    if (rejectBtn) {
                        rejectBtn.disabled = false;
                        rejectBtn.style.opacity = '1';
                        rejectBtn.style.cursor = 'pointer';
                    }
                    stopMusicPlayCountdown();
                }
            }, 1000); // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
        }
        
        // ÂÅúÊ≠¢Èü≥‰πêÊí≠ÊîæÂÄíËÆ°Êó∂
        function stopMusicPlayCountdown() {
            if (musicPlayTimer) {
                clearInterval(musicPlayTimer);
                musicPlayTimer = null;
            }
        }
        
        // ÂêåÊÑèÊí≠ÊîæÈü≥‰πê
        function acceptMusicPlay() {
            const audio = document.getElementById('gameAudio');
            if (audio) {
                // ‰ºòÂÖà‰ΩøÁî®Base64Êï∞ÊçÆÔºåÂê¶Âàô‰ΩøÁî®URL
                const musicSource = pendingMusicData || pendingMusicUrl;
                if (musicSource) {
                    audio.src = musicSource;
                    audio.play()
                        .then(() => {
                            addChatMessage('Á≥ªÁªü', `ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ`, '#4CAF50');
                            
                            // ÂπøÊí≠ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                            if (gameState.multiplayer && gameState.multiplayer.connections) {
                                const playerName = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name || 'Áé©ÂÆ∂';
                                const musicNotification = {
                                    type: 'chat-message',
                                    from: gameState.multiplayer.currentPlayerId,
                                    message: `[Èü≥‰πê] ${playerName} Â∑≤ÂêåÊÑèÊí≠ÊîæËÉåÊôØÈü≥‰πê`,
                                    color: '#FFD700',
                                    isSystem: true
                                };
                                Object.values(gameState.multiplayer.connections).forEach(conn => {
                                    if (conn.send) {
                                        conn.send(musicNotification);
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error);
                            addChatMessage('Á≥ªÁªü', 'Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•ÔºåÂèØËÉΩÊòØURLÊó†ÊïàÊàñÊµèËßàÂô®ÈôêÂà∂', '#FF5252');
                        });
                }
            }
            hideMusicPlayConfirmModal();
        }
        
        // ÊãíÁªùÊí≠ÊîæÈü≥‰πê
        function rejectMusicPlay() {
            if (pendingMusicUrl) {
                addChatMessage('Á≥ªÁªü', 'Â∑≤ÊãíÁªùÊí≠ÊîæËÉåÊôØÈü≥‰πêÁöÑËØ∑Ê±Ç', '#FF5252');
            }
            hideMusicPlayConfirmModal();
        }
        
        // ÊòæÁ§∫Ë∏¢Âá∫Áé©ÂÆ∂ÁïåÈù¢
        function showKickPlayerModal() {
            const modal = document.getElementById('kickPlayerModal');
            const playerList = document.getElementById('kickPlayerList');
            
            if (modal && playerList) {
                // Ê∏ÖÁ©∫Áé©ÂÆ∂ÂàóË°®
                playerList.innerHTML = '';
                
                // ÁîüÊàêÁé©ÂÆ∂ÂàóË°®ÔºàÊéíÈô§Êàø‰∏ªÔºâ
                Object.entries(gameState.multiplayer.players).forEach(([playerId, player]) => {
                    if (playerId !== gameState.multiplayer.currentPlayerId) {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'kick-player-item';
                        playerItem.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border-radius: 8px;
                            margin-bottom: 8px;
                            cursor: pointer;
                            transition: background 0.2s;
                        `;
                        playerItem.innerHTML = `
                            <span style="color: #fff; font-size: 16px;">${player.name}</span>
                            <button class="kick-player-btn" data-player-id="${playerId}" style="
                                padding: 8px 16px;
                                background: linear-gradient(135deg, #f44336, #d32f2f);
                                color: white;
                                border: none;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                            ">Ë∏¢Âá∫</button>
                        `;
                        
                        // ÁÇπÂáªÁé©ÂÆ∂È°πÈÄâÊã©ËØ•Áé©ÂÆ∂
                        playerItem.addEventListener('click', () => {
                            // ÁßªÈô§ÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                            document.querySelectorAll('.kick-player-item').forEach(item => {
                                item.style.background = 'rgba(255, 255, 255, 0.05)';
                            });
                            // È´ò‰∫ÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÁé©ÂÆ∂
                            playerItem.style.background = 'rgba(76, 175, 80, 0.3)';
                        });
                        
                        // ÁÇπÂáªË∏¢Âá∫ÊåâÈíÆ
                        const kickBtn = playerItem.querySelector('.kick-player-btn');
                        if (kickBtn) {
                            kickBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                kickPlayer(playerId, player.name);
                            });
                        }
                        
                        playerList.appendChild(playerItem);
                    }
                });
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }
        
        // ÂÖ≥Èó≠Ë∏¢Âá∫Áé©ÂÆ∂ÁïåÈù¢
        function closeKickPlayerModal() {
            const modal = document.getElementById('kickPlayerModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
        }
        
        // Ë∏¢Âá∫Áé©ÂÆ∂
        function kickPlayer(playerId, playerName) {
            if (confirm(`Á°ÆÂÆöË¶ÅË∏¢Âá∫Áé©ÂÆ∂ "${playerName}" ÂêóÔºü`)) {
                // ÂèëÈÄÅË∏¢Âá∫Ê∂àÊÅØ
                const kickMessage = {
                    type: 'kick-player',
                    playerId: playerId
                };
                
                if (gameState.multiplayer.connections) {
                    Object.values(gameState.multiplayer.connections).forEach(conn => {
                        if (conn.send) {
                            conn.send(kickMessage);
                        }
                    });
                }
                
                // ‰ªéÊú¨Âú∞Áé©ÂÆ∂ÂàóË°®‰∏≠ÁßªÈô§
                delete gameState.multiplayer.players[playerId];
                delete gameState.multiplayer.connections[playerId];
                
                // Êõ¥Êñ∞Áé©ÂÆ∂ÂàóË°®ÊòæÁ§∫
                updatePlayerList();
                
                // ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                addChatMessage('Á≥ªÁªü', `Áé©ÂÆ∂ ${playerName} Â∑≤Ë¢´Ë∏¢Âá∫ÊàøÈó¥`, '#FF5252');
                
                // ÂÖ≥Èó≠Ë∏¢Âá∫ÁïåÈù¢
                closeKickPlayerModal();
            }
        }

        // ÂàáÊç¢ÊöÇÂÅúÂΩïÂà∂
        function togglePauseRecording() {
            const btn = document.getElementById('pauseRecordingBtn');
            if (btn) {
                if (isPaused) {
                    // ÊÅ¢Â§çÂΩïÂà∂
                    isPaused = false;
                    btn.innerHTML = '‚è∏Ô∏è ÊöÇÂÅú';
                    btn.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
                    // ÊÅ¢Â§çÂΩïÂà∂
                    if (mediaRecorder && mediaRecorder.state === 'paused') {
                        mediaRecorder.resume();
                        // ÊÅ¢Â§çÂΩïÂà∂ËÆ°Êó∂ÔºåÂü∫‰∫éÂΩìÂâçÂ∑≤ÂΩïÂà∂Êó∂Èïø
                        recordingStartTime = Date.now() - (recordingElapsed * 1000);
                    }
                } else {
                    // ÊöÇÂÅúÂΩïÂà∂
                    isPaused = true;
                    btn.innerHTML = '‚ñ∂Ô∏è ÁªßÁª≠';
                    btn.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
                    // ÊöÇÂÅúÂΩïÂà∂
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.pause();
                        // ‰øùÂ≠òÂΩìÂâçÂ∑≤ÂΩïÂà∂ÁöÑÊó∂Èïø
                        recordingElapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    }
                }
            }
        }

        // Êõ¥Êñ∞ÂΩïÂà∂Ê®°ÊÄÅÊ°ÜÊòæÁ§∫
        function updateRecordingModalDisplay() {
            const timerElement = document.getElementById('recordingTimer');
            const progressElement = document.getElementById('recordingProgress');
            
            if (timerElement) {
                const minutes = Math.floor(recordingElapsed / 60);
                const seconds = recordingElapsed % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            if (progressElement) {
                const progress = (recordingElapsed / MAX_RECORDING_DURATION) * 100;
                progressElement.style.width = `${Math.min(progress, 100)}%`;
            }
        }
        
        // Êõ¥Êñ∞ËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ
        function updateVoiceButtonStatus() {
            const voiceButtons = [
                document.getElementById('voiceButton'),
                document.getElementById('voiceButtonModal')
            ];
            
            voiceButtons.forEach(button => {
                if (button) {
                    if (isRecording) {
                        button.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
                        button.textContent = '‚èπÔ∏è';
                    } else {
                        button.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
                        button.textContent = 'üé§';
                    }
                }
            });
        }
        
        // Êõ¥Êñ∞ÂΩïÂà∂Êó∂ÈïøÊòæÁ§∫
        function updateRecordingDuration(duration) {
            // Êõ¥Êñ∞ÂΩïÂà∂Ê®°ÊÄÅÊ°ÜÊòæÁ§∫
            recordingElapsed = duration;
            updateRecordingModalDisplay();
            
            // Âú®ÊéßÂà∂Âè∞ËæìÂá∫ÂΩïÂà∂Êó∂Èïø
            console.log(`ÂΩïÂà∂Êó∂Èïø: ${duration}/${MAX_RECORDING_DURATION}Áßí`);
            
            // Êõ¥Êñ∞ÂΩïÂà∂ÊåâÈíÆÁöÑÊñáÊú¨ÔºåÊòæÁ§∫Ââ©‰ΩôÊó∂Èïø
            const voiceButtons = [
                document.getElementById('voiceButton'),
                document.getElementById('voiceButtonModal')
            ];
            
            voiceButtons.forEach(button => {
                if (button && isRecording) {
                    const remaining = MAX_RECORDING_DURATION - duration;
                    button.title = `Ê≠£Âú®ÂΩïÂà∂: ${duration}/${MAX_RECORDING_DURATION}Áßí`;
                    button.style.fontSize = '12px';
                }
            });
        }
        
        // ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ
        function sendVoiceMessage(blob, duration) {
            if (gameState.currentScreen === 'multiplayerGame' && gameState.multiplayer) {
                // Â∞ÜBlobËΩ¨Êç¢‰∏∫Base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const voiceData = e.target.result;
                    
                    // ÁîüÊàêÊ∂àÊÅØID
                    const messageId = Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    // ÂêëÊâÄÊúâÁé©ÂÆ∂ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ
                    const voiceMessage = {
                        type: 'voice-message',
                        from: gameState.multiplayer.currentPlayerId,
                        voice: voiceData,
                        duration: duration,
                        timestamp: Date.now()
                    };
                    
                    // ÂèëÈÄÅÁªôÊâÄÊúâËøûÊé•ÁöÑÁé©ÂÆ∂
                    if (gameState.multiplayer.connections) {
                        Object.values(gameState.multiplayer.connections).forEach(conn => {
                            if (conn.send) {
                                conn.send(voiceMessage);
                            }
                        });
                    }
                    
                    // Ëá™Â∑±‰πüÊòæÁ§∫ËØ≠Èü≥Ê∂àÊÅØ
                    const player = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
                    if (player) {
                        addVoiceMessage(player.name, voiceData, duration, messageId);
                    }
                };
                reader.readAsDataURL(blob);
            }
        }
        
        // Ê∑ªÂä†ËØ≠Èü≥Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function addVoiceMessage(sender, voiceData, duration, messageId) {
            // Ëé∑Âèñ‰∏§‰∏™ËÅäÂ§©ÂÆπÂô®
            const chatMessagesElements = [
                document.getElementById('chatMessages'),
                document.getElementById('chatMessagesModal')
            ];
            
            // Ê†πÊçÆÊó∂ÈïøËÆ°ÁÆóÊåâÈíÆÂÆΩÂ∫¶ÔºàÊúÄÂ∞è60pxÔºåÊúÄÂ§ß200pxÔºâ
            const minWidth = 60;
            const maxWidth = 200;
            const widthPerSecond = 2;
            const buttonWidth = Math.min(maxWidth, minWidth + duration * widthPerSecond);
            
            chatMessagesElements.forEach(chatMessagesElement => {
                if (chatMessagesElement) {
                    const messageElement = document.createElement('div');
                    messageElement.style.marginBottom = '10px';
                    messageElement.style.color = '#4CAF50';
                    messageElement.dataset.messageId = messageId || (Date.now() + Math.random().toString(36).substr(2, 9));
                    
                    let content = `<strong>${sender}:</strong> `;
                    content += `<button onclick="toggleVoicePlayback(this)" data-voice-data="${voiceData}" data-duration="${duration}" style="margin-left: 5px; padding: 4px 10px; background: rgba(76, 175, 80, 0.7); color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 12px; min-width: ${buttonWidth}px; max-width: ${maxWidth}px; width: ${buttonWidth}px; text-align: center;">‚ñ∂Ô∏è ${duration}Áßí</button>`;
                    
                    // Ê∑ªÂä†Êí§ÂõûÊåâÈíÆÔºàÂè™ÊúâËá™Â∑±ÁöÑÊ∂àÊÅØÂèØ‰ª•Êí§ÂõûÔºâ
                    if (sender === 'Êàë' || (gameState.multiplayer && sender === gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name)) {
                        content += `<button onclick="recallMessage('${messageElement.dataset.messageId}')" style="margin-left: 10px; padding: 2px 6px; background: rgba(244, 67, 54, 0.7); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Êí§Âõû</button>`;
                    }
                    
                    messageElement.innerHTML = content;
                    chatMessagesElement.appendChild(messageElement);
                    
                    // ÊªöÂä®Âà∞Â∫ïÈÉ®
                    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
                }
            });
        }
        
        // Êí≠ÊîæËØ≠Èü≥Ê∂àÊÅØ
        function playVoiceMessage(voiceData, buttonElement) {
            // Â¶ÇÊûúÂΩìÂâçÊúâÊ≠£Âú®Êí≠ÊîæÁöÑËØ≠Èü≥ÔºåÂÖàÂÅúÊ≠¢
            if (isPlaying && currentAudio && currentPlayingButton) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêå‰∏Ä‰∏™ÊåâÈíÆÔºåÊöÇÂÅúÊí≠Êîæ
                if (currentPlayingButton === buttonElement) {
                    stopPlaybackTimer(); // ÂÅúÊ≠¢Êí≠ÊîæËøõÂ∫¶ÂÆöÊó∂Âô®
                    currentAudio.pause();
                    isPlaying = false;
                    updatePlayButtonStatus(currentPlayingButton, false);
                    return;
                } else {
                    // Âê¶ÂàôÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÔºåÂºÄÂßãÊí≠ÊîæÊñ∞ÁöÑËØ≠Èü≥
                    stopCurrentAudio();
                }
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑAudioÂØπË±°
            const audio = new Audio(voiceData);
            currentAudio = audio;
            currentPlayingButton = buttonElement;
            
            // Êí≠ÊîæËØ≠Èü≥
            audio.play()
                .then(() => {
                    isPlaying = true;
                    updatePlayButtonStatus(buttonElement, true);
                    // ÂêØÂä®Êí≠ÊîæËøõÂ∫¶Êõ¥Êñ∞ÂÆöÊó∂Âô®
                    startPlaybackTimer(audio, buttonElement);
                })
                .catch(error => {
                    console.error('Êí≠ÊîæËØ≠Èü≥Â§±Ë¥•:', error);
                    isPlaying = false;
                    updatePlayButtonStatus(buttonElement, false);
                });
            
            // ÁõëÂê¨Êí≠ÊîæÁªìÊùü‰∫ã‰ª∂
            audio.onended = function() {
                isPlaying = false;
                updatePlayButtonStatus(buttonElement, false);
                stopPlaybackTimer();
                resetPlayState();
            };
            
            // ÁõëÂê¨ÊöÇÂÅú‰∫ã‰ª∂
            audio.onpause = function() {
                stopPlaybackTimer();
            };
        }
        
        // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥È¢ë
        function stopCurrentAudio() {
            stopPlaybackTimer(); // ÂÅúÊ≠¢Êí≠ÊîæËøõÂ∫¶ÂÆöÊó∂Âô®
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            if (currentPlayingButton) {
                updatePlayButtonStatus(currentPlayingButton, false);
            }
            resetPlayState();
        }
        
        // ÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅ
        function resetPlayState() {
            isPlaying = false;
            currentAudio = null;
            currentPlayingButton = null;
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÁä∂ÊÄÅ
        function updatePlayButtonStatus(buttonElement, isPlaying) {
            if (buttonElement) {
                if (isPlaying) {
                    buttonElement.innerHTML = '‚è∏Ô∏è Êí≠Êîæ‰∏≠...';
                    buttonElement.style.background = 'linear-gradient(135deg, #FFC107, #FFA000)';
                } else {
                    const duration = buttonElement.dataset.duration || '0';
                    buttonElement.innerHTML = `‚ñ∂Ô∏è ${duration}Áßí`;
                    buttonElement.style.background = 'rgba(76, 175, 80, 0.7)';
                }
            }
        }
        
        // ÂêØÂä®Êí≠ÊîæËøõÂ∫¶Êõ¥Êñ∞ÂÆöÊó∂Âô®
        function startPlaybackTimer(audio, buttonElement) {
            stopPlaybackTimer(); // ÂÖàÂÅúÊ≠¢‰πãÂâçÁöÑÂÆöÊó∂Âô®
            
            playbackTimer = setInterval(() => {
                if (audio && buttonElement) {
                    const currentTime = Math.floor(audio.currentTime);
                    let duration = Math.floor(audio.duration);
                    
                    // Ê£ÄÊü•durationÊòØÂê¶‰∏∫ÊúâÊïàÂÄº
                    if (!isFinite(duration) || isNaN(duration) || duration <= 0) {
                        // Â¶ÇÊûúdurationÊó†ÊïàÔºåÊòæÁ§∫Êí≠Êîæ‰∏≠Áä∂ÊÄÅ
                        buttonElement.innerHTML = '‚è∏Ô∏è Êí≠Êîæ‰∏≠...';
                        return;
                    }
                    
                    buttonElement.innerHTML = `‚è∏Ô∏è ${currentTime}/${duration}Áßí`;
                }
            }, 1000); // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
        }
        
        // ÂÅúÊ≠¢Êí≠ÊîæËøõÂ∫¶ÂÆöÊó∂Âô®
        function stopPlaybackTimer() {
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
        }
        
        // ÂàáÊç¢ËØ≠Èü≥Êí≠Êîæ/ÊöÇÂÅú
        function toggleVoicePlayback(buttonElement) {
            const voiceData = buttonElement.dataset.voiceData;
            playVoiceMessage(voiceData, buttonElement);
        }

        // ËΩ¨ÂÜôÂ∑≤ÊúâËØ≠Èü≥Ê∂àÊÅØ
        function transcribeExistingVoice(voiceData) {
            // ËøôÈáåÂ∫îËØ•ÂÆûÁé∞ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÁöÑÈÄªËæë
            // Áî±‰∫éÊµèËßàÂô®ÈôêÂà∂ÔºåÊàë‰ª¨Êó†Ê≥ïÁõ¥Êé•Â∞ÜÈü≥È¢ëÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÊñáÂ≠ó
            // ‰ΩÜÂèØ‰ª•ÊèêÁ§∫Áî®Êà∑‰ΩøÁî®ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩ
            addChatMessage('Á≥ªÁªü', 'üéôÔ∏è ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩÈúÄË¶ÅÂÆûÊó∂ÂΩïÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•ËΩ¨Êç¢Â∑≤ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØ', '#FF9800');
        }

        // ÂºÇÊ≠•Â§ÑÁêÜÂõæÁâáËÉåÊôØÂπ∂ÊòæÁ§∫Ê∂àÊÅØ
        async function addChatMessage(sender, message, color, imageData, messageId) {
            // Â§ÑÁêÜÂõæÁâáËÉåÊôØ
            let processedImageData = imageData;
            if (imageData) {
                processedImageData = await processImageBackground(imageData);
            }
            
            // Ëé∑Âèñ‰∏§‰∏™ËÅäÂ§©ÂÆπÂô®
            const chatMessagesElements = [
                document.getElementById('chatMessages'),
                document.getElementById('chatMessagesModal')
            ];
            
            chatMessagesElements.forEach(chatMessagesElement => {
                if (chatMessagesElement) {
                const messageElement = document.createElement('div');
                messageElement.style.marginBottom = '10px';
                messageElement.style.color = color || 'white';
                const finalMessageId = messageId || (Date.now() + Math.random().toString(36).substr(2, 9)); // ÁîüÊàêÊàñ‰ΩøÁî®Êèê‰æõÁöÑÊ∂àÊÅØID
                messageElement.dataset.messageId = finalMessageId;
                
                let content = `<strong>${sender}:</strong>`;
                if (processedImageData) {
                    content += `<br><img src="${processedImageData}" onclick="openImagePreview('${processedImageData}')" style="max-width: 250px; max-height: 200px; border-radius: 5px; margin-top: 5px; cursor: pointer;">`;
                }
                if (message) {
                    // Â∞ÜÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫HTMLÊç¢Ë°åÊ†áÁ≠æ
                    let formattedMessage = message.replace(/\n/g, '<br>');
                    
                    // Ê£ÄÊµãÂπ∂ËΩ¨Êç¢URL‰∏∫Ë∂ÖÈìæÊé•
                    // ÊîØÊåÅÔºöÂÆåÊï¥URL„ÄÅÊó†ÂçèËÆÆÂüüÂêç„ÄÅIPÂú∞ÂùÄ
                    const urlRegex = /(https?:\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?)|((?:[a-zA-Z0-9\-]+\.)+[a-zA-Z]{2,}(?:\/[\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?)|((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?::[0-9]+)?(?:\/[\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?)/g;
                    formattedMessage = formattedMessage.replace(urlRegex, function(match) {
                        // Â¶ÇÊûúURLÊ≤°ÊúâÂçèËÆÆÂâçÁºÄÔºåÊ∑ªÂä†http://
                        const url = match.startsWith('http') ? match : `http://${match}`;
                        return `<a href="${url}" target="_blank" style="color: #4CAF50; text-decoration: underline; cursor: pointer;">${match}</a>`;
                    });
                    
                    content += ` ${formattedMessage}`;
                }
                
                // Ê∑ªÂä†Êí§ÂõûÊåâÈíÆÔºàÂè™ÊúâËá™Â∑±ÁöÑÊ∂àÊÅØÂèØ‰ª•Êí§ÂõûÔºâ
                if (sender === 'Êàë' || (gameState.multiplayer && sender === gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name)) {
                    content += `<button onclick="recallMessage('${messageElement.dataset.messageId}')" style="margin-left: 10px; padding: 2px 6px; background: rgba(244, 67, 54, 0.7); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Êí§Âõû</button>`;
                }
                
                messageElement.innerHTML = content;
                chatMessagesElement.appendChild(messageElement);
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
            }
            });
        }

        // Ë°®ÊÉÖÂåÖÁõ∏ÂÖ≥ÂáΩÊï∞
        const emojis = ['üòä', 'üòÇ', 'üòç', 'üòé', 'üò¢', 'üò°', 'üëç', 'üëé', 'üéâ', 'üéà', 'üéÆ', 'üöÄ', '‚ù§Ô∏è', 'üî•', '‚≠ê', 'ü§î', 'üò±', 'üò¥', 'ü§£', 'üò§', 'üëÄ', 'üôè', 'üëè', 'ü§ù', 'ü§û', 'ü§©', 'üòá', 'üòà', 'üëª', 'üíÄ', 'üëΩ', 'ü§ñ', 'üí™', 'üåü', '‚ú®', 'üí´', 'üéä', 'üéÅ', 'üéÇ', 'üéÉ', 'üéÑ', 'üéÜ', 'üéá', 'üéµ', 'üé∂', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'üéß', 'üéÆ', 'üéØ', 'üé≤', 'üé≥', 'üé®', 'üì∏', 'üìπ', 'üé¨', 'üì±', 'üíª', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ•Ô∏è', 'üì°', 'üöÅ', '‚úàÔ∏è', 'üöÄ', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'üö≤', 'üõ¥', 'üõµ', 'üèçÔ∏è', 'üõ∫', 'üö®', 'üö•', 'üö¶', 'üõ£Ô∏è', 'üõ§Ô∏è', 'üõ¢Ô∏è', '‚õΩ', 'üöß', 'üèÅ', 'üéå', 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø', 'üè¥Û†ÅµÛ†Å≥Û†Å£Û†Å°Û†Åø', 'üá®üá≥', 'üáØüáµ', 'üá∞üá∑', 'üá∫üá∏', 'üá¨üáß', 'üá´üá∑', 'üá©üá™', 'üáÆüáπ', 'üá™üá∏', 'üá∑üá∫', 'üáÆüá≥', 'üáßüá∑', 'üá¶üá∫', 'üá≥üáø', 'üá®üá¶', 'üá≤üáΩ', 'üáßüá™', 'üá≥üá±', 'üá©üá∞', 'üá∏üá™', 'üá≥üá¥', 'üá´üáÆ', 'üá®üá≠', 'üá¶üáπ', 'üáµüáπ', 'üáÆüá™', 'üá¨üá∑', 'üá∑üá¥', 'üá∫üá¶', 'üáµüá±', 'üá®üáø', 'üá≠üá∫', 'üá∏üá∞', 'üá∏üáÆ', 'üáßüá¨', 'üá∑üá∏', 'üá≤üá©', 'üá¶üá±', 'üá≤üá™', 'üá¶üá´', 'üá¶üáΩ', 'üá¶üá±', 'üá¶üá∏', 'üá¶üá©', 'üá¶üá¥', 'üá¶üáÆ', 'üá¶üá∂', 'üá¶üá¨', 'üá¶üá∑', 'üá¶üá≤', 'üá¶üáº', 'üá¶üá∫', 'üá¶üáπ', 'üá¶üáø', 'üáßüá∏', 'üáßüá≠', 'üáßüá©', 'üáßüáß', 'üáßüáæ', 'üáßüá™', 'üáßüáø', 'üáßüáØ', 'üáßüá≤', 'üáßüáπ', 'üáßüá¥', 'üáßüá¶', 'üáßüáº', 'üáßüá∑', 'üáÆüá¥', 'üáªüá¨', 'üáßüá≥', 'üáßüá¨', 'üáßüá´', 'üáßüáÆ', 'üáßüáπ', 'üáßüá±', 'üáßüáæ', 'üáßüá≤', 'üáßüáπ', 'üáßüá¥', 'üáßüá¶', 'üáßüáº', 'üáßüá∑', 'üáÆüá¥', 'üáªüá¨', 'üáßüá≥', 'üáßüá¨', 'üáßüá´', 'üáßüáÆ', 'üáßüáπ', 'üáßüá±', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', 'üâë', '‚òëÔ∏è', '‚úÖ', '‚ùé', 'üó≥Ô∏è', 'üì≥', 'üì¥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', 'üÜî', 'üâê', 'üàπ', 'üà¥', 'üàµ', 'üà∑Ô∏è', 'üà∂', 'üàö', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', 'üÜî', 'üâê', 'üíÆ', '„äôÔ∏è', '„äóÔ∏è', 'üÄÑ', 'üÉè', 'üé¥', 'üÄÑ', 'üéé', 'üëò', 'ü•∑', 'üë∫', 'üëπ', 'üíÇ', 'ü§¥', 'üë∏', 'üë≥', 'üë≤', 'üßï', 'ü§µ', 'üë∞', 'üëº', 'üéÖ', 'ü§∂', 'üßë', 'üë¶', 'üëß', 'üßí', 'üë∂', 'üë©', 'üë®', 'üßî', 'üëµ', 'üë¥', 'üßì', 'üë≤', 'üë≥', 'üßï', 'ü§µ', 'üë∞', 'üëº', 'üéÖ', 'ü§∂', 'üßë', 'üë¶', 'üëß', 'üßí', 'üë∂', 'üë©', 'üë®', 'üßî', 'üëµ', 'üë¥', 'üßì','‚ñà','‚äû','‚ñÅ','‚ñì','‚ñë','‚ñ†','‚ñß','‚ñ≠','‚óô','‚ñö','‚ñü','‚ó™','‚òÄ','‚Ñâ','‚ÑÉ','‚ö°','‚õÖ','‚õà','‚òº','‚ú≠','‚ùã','‚Üë','‚Üê','‚Üí','‚Üì','‚Üî','‚Üï','‚Üñ','‚Ü©','‚Ü™','‚Ü∫','‚Üª','‚á†','‚á¢','‚á°','‚á£','‚á¶','‚áß','‚á©','‚á®','‚û¢','‚û£','‚ûµ'];
        
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker) {
                if (emojiPicker.style.display === 'none') {
                    loadEmojis();
                    emojiPicker.style.display = 'block';
                } else {
                    emojiPicker.style.display = 'none';
                }
            }
        }
        
        function loadEmojis() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker && emojiPicker.innerHTML === '') {
                emojis.forEach(emoji => {
                    const emojiButton = document.createElement('button');
                    emojiButton.textContent = emoji;
                    emojiButton.style.fontSize = '20px';
                    emojiButton.style.padding = '5px 10px';
                    emojiButton.style.margin = '2px';
                    emojiButton.style.background = 'rgba(255, 255, 255, 0.1)';
                    emojiButton.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                    emojiButton.style.borderRadius = '5px';
                    emojiButton.style.color = 'white';
                    emojiButton.style.fontFamily = 'Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, EmojiOne, sans-serif';
                    emojiButton.style.cursor = 'pointer';
                    emojiButton.style.display = 'inline-block';
                    emojiButton.style.minWidth = '30px';
                    emojiButton.style.minHeight = '30px';
                    emojiButton.style.textAlign = 'center';
                    emojiButton.onclick = () => insertEmoji(emoji);
                    
                    // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
                    emojiButton.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(76, 175, 80, 0.3)';
                        this.style.borderColor = '#4CAF50';
                    });
                    
                    emojiButton.addEventListener('mouseleave', function() {
                        this.style.background = 'rgba(255, 255, 255, 0.1)';
                        this.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    });
                    
                    emojiPicker.appendChild(emojiButton);
                });
            }
        }
        
        function insertEmoji(emoji) {
            // Ê£ÄÊü•ÂΩìÂâçÊ¥ªË∑ÉÁöÑËÅäÂ§©ËæìÂÖ•Ê°Ü
            const chatInput = document.getElementById('chatInput');
            const chatInputModal = document.getElementById('chatInputModal');
            
            // Ê£ÄÊü•Ê®°ÊÄÅÊ°ÜÊòØÂê¶ÊòæÁ§∫Ôºå‰ºòÂÖà‰ΩøÁî®Ê®°ÊÄÅÊ°ÜËæìÂÖ•Ê°Ü
            let activeInput;
            const chatModal = document.getElementById('chatModal');
            if (chatModal && chatModal.style.display !== 'none') {
                activeInput = chatInputModal;
            } else {
                activeInput = chatInput;
            }
            
            if (activeInput) {
                const start = activeInput.selectionStart;
                const end = activeInput.selectionEnd;
                const text = activeInput.value;
                activeInput.value = text.substring(0, start) + emoji + text.substring(end);
                activeInput.focus();
                activeInput.setSelectionRange(start + emoji.length, start + emoji.length);
            }
            
            // Ê£ÄÊµã‰∏≠ÂõΩÂõΩÊóóË°®ÊÉÖÂåÖÂπ∂Ëß£ÈîÅÊàêÂ∞±
            if (emoji === 'üá®üá≥' && !gameState.achievements.chineseEmojiUsed) {
                gameState.achievements.chineseEmojiUsed = true;
                // Â•ñÂä±50ÈáëÂ∏Å
                gameState.coins += 50;
                saveGameData();
                updateAchievementProgress();
                showAchievementUnlocked('‰ºüÂ§ßÁöÑÂõΩÂÆ∂ÔºåÂãøÂøòÂõΩËÄª', '‰ΩøÁî®‰∏≠ÂõΩÂõΩÊóóË°®ÊÉÖÂåÖÔºåËé∑Âæó50ÈáëÂ∏ÅÂ•ñÂä±');
            }
            
            toggleEmojiPicker();
        }
        
        // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ë°®ÊÉÖÂåÖÈù¢Êùø
        document.addEventListener('click', function(e) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiButton = document.getElementById('emojiButton');
            const emojiButtonModal = document.getElementById('emojiButtonModal');
            if (emojiPicker && emojiPicker.style.display === 'block' && 
                !emojiPicker.contains(e.target) && 
                e.target !== emojiButton && 
                e.target !== emojiButtonModal) {
                emojiPicker.style.display = 'none';
            }
        });
        
        // ÂõæÁâáÈ¢ÑËßàÂäüËÉΩ
        function openImagePreview(imageData) {
            const modal = document.getElementById('imagePreviewModal');
            const previewImage = document.getElementById('previewImage');
            if (modal && previewImage) {
                previewImage.src = imageData;
                modal.style.display = 'flex';
            }
        }
        
        // ÂÖ≥Èó≠ÂõæÁâáÈ¢ÑËßà
        document.getElementById('closePreview')?.addEventListener('click', function() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠È¢ÑËßà
        document.getElementById('imagePreviewModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
        
        // ÂõæÁâá‰∏ãËΩΩÂäüËÉΩ
        function downloadImage() {
            const previewImage = document.getElementById('previewImage');
            if (previewImage && previewImage.src) {
                const a = document.createElement('a');
                a.href = previewImage.src;
                a.download = `maze-adventure-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
        
        // ÁªëÂÆö‰∏ãËΩΩÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('downloadImage')?.addEventListener('click', downloadImage);
        
        // Ê∂àÊÅØÊí§ÂõûÂäüËÉΩ
        function recallMessage(messageId) {
            // Âú®‰∏§‰∏™ËÅäÂ§©ÂÆπÂô®‰∏≠Êü•ÊâæÂπ∂Êí§ÂõûÊ∂àÊÅØ
            const chatContainers = [
                document.getElementById('chatMessages'),
                document.getElementById('chatMessagesModal')
            ];
            
            chatContainers.forEach(chatMessages => {
                if (chatMessages) {
                    const messageElement = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                    // ÂèëÈÄÅÊí§ÂõûÊ∂àÊÅØÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                    if (gameState.currentScreen === 'multiplayerGame' && gameState.multiplayer) {
                        const recallMessage = {
                            type: 'chat-recall',
                            from: gameState.multiplayer.currentPlayerId,
                            messageId: messageId
                        };
                        
                        // ÂèëÈÄÅÁªôÊâÄÊúâËøûÊé•ÁöÑÁé©ÂÆ∂
                        if (gameState.multiplayer.connections) {
                            Object.values(gameState.multiplayer.connections).forEach(conn => {
                                if (conn.send) {
                                    conn.send(recallMessage);
                                }
                            });
                        }
                    }
                    
                    // Âú®Êú¨Âú∞Êí§ÂõûÊ∂àÊÅØ
                    messageElement.innerHTML = '<strong>Á≥ªÁªüÊ∂àÊÅØ:</strong> Ê∂àÊÅØÂ∑≤Êí§Âõû';
                    messageElement.style.color = '#888';
                    
                    // 3ÁßíÂêéËá™Âä®Âà†Èô§Êí§ÂõûÊèêÁ§∫
                    setTimeout(() => {
                        if (messageElement.parentElement) {
                            messageElement.parentElement.removeChild(messageElement);
                        }
                    }, 3000);
                    }
                }
            });
        }
        
        // Ê£ÄÊµãÂπ∂Â§ÑÁêÜÂõæÁâáËÉåÊôØ
        function processImageBackground(imageData) {
            return new Promise((resolve) => {
                // ÂàõÂª∫ImageÂØπË±°
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    // ÂàõÂª∫CanvasÂÖÉÁ¥†
                    const canvas = document.createElement('canvas');
                    canvas.width = this.width;
                    canvas.height = this.height;
                    const ctx = canvas.getContext('2d');
                    
                    // ÁªòÂà∂ÂõæÁâá
                    ctx.drawImage(this, 0, 0);
                    
                    // Ëé∑ÂèñÂõæÁâáÊï∞ÊçÆ
                    const pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = pixelData.data;
                    
                    // Ê£ÄÊµãËÉåÊôØÈ¢úËâ≤ÔºàÊ£ÄÊü•Âõõ‰∏™ËßíËêΩÁöÑÂÉèÁ¥†Ôºâ
                    const cornerPixels = [
                        {x: 0, y: 0}, // Â∑¶‰∏äËßí
                        {x: canvas.width - 1, y: 0}, // Âè≥‰∏äËßí
                        {x: 0, y: canvas.height - 1}, // Â∑¶‰∏ãËßí
                        {x: canvas.width - 1, y: canvas.height - 1} // Âè≥‰∏ãËßí
                    ];
                    
                    let isBlackBackground = true;
                    
                    for (const pixel of cornerPixels) {
                        const index = (pixel.y * canvas.width + pixel.x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // ËÆ°ÁÆó‰∫ÆÂ∫¶ (0-255)
                        const brightness = (r + g + b) / 3;
                        
                        // Â¶ÇÊûú‰∫ÆÂ∫¶Ë∂ÖËøáÈòàÂÄºÔºà‰∏çÊòØÈªëËâ≤ËÉåÊôØÔºâ
                        if (brightness > 50) {
                            isBlackBackground = false;
                            break;
                        }
                    }
                    
                    // Â¶ÇÊûúÊòØÈªëËâ≤ËÉåÊôØÔºåÊ∑ªÂä†ÁôΩËâ≤ËÉåÊôØ
                    if (isBlackBackground) {
                        // ÂàõÂª∫Êñ∞ÁöÑCanvasÔºåÊ∑ªÂä†ÁôΩËâ≤ËÉåÊôØ
                        const newCanvas = document.createElement('canvas');
                        newCanvas.width = this.width;
                        newCanvas.height = this.height;
                        const newCtx = newCanvas.getContext('2d');
                        
                        // ÁªòÂà∂ÁôΩËâ≤ËÉåÊôØ
                        newCtx.fillStyle = '#ffffff';
                        newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
                        
                        // ÁªòÂà∂ÂéüÂõæÔºå‰ΩøÁî®globalCompositeOperationÁ°Æ‰øùÂõæÁâáÊòæÁ§∫Âú®ÁôΩËâ≤ËÉåÊôØ‰∏ä
                        newCtx.globalCompositeOperation = 'source-over';
                        newCtx.drawImage(this, 0, 0);
                        
                        // ËøîÂõûÂ§ÑÁêÜÂêéÁöÑÂõæÁâáÊï∞ÊçÆ
                        resolve(newCanvas.toDataURL('image/png'));
                    } else {
                        // ËøîÂõûÂéüÂõæÁöÑData URL
                        const canvas = document.createElement('canvas');
                        canvas.width = this.width;
                        canvas.height = this.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(this, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    }
                };
                
                // Â§ÑÁêÜÂä†ËΩΩÂ§±Ë¥•ÁöÑÊÉÖÂÜµ
                img.onerror = function() {
                    // Âä†ËΩΩÂ§±Ë¥•Êó∂ËøîÂõûÂéüÂßãData URL
                    resolve(imageData);
                };
                
                // ËÆæÁΩÆÂõæÁâáÊ∫ê
                img.src = imageData;
            });
        }

        // ÂõæÁâáÂ§ÑÁêÜÂáΩÊï∞
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // ÊòæÁ§∫‰º†ËæìÊèêÁ§∫
                const chatContainer = document.getElementById('chatModal');
                const transferHint = document.createElement('div');
                transferHint.id = 'imageTransferHint';
                transferHint.style.position = 'absolute';
                transferHint.style.bottom = '50px';
                transferHint.style.left = '20px';
                transferHint.style.background = 'rgba(0, 0, 0, 0.7)';
                transferHint.style.color = '#4CAF50';
                transferHint.style.padding = '5px 10px';
                transferHint.style.borderRadius = '5px';
                transferHint.style.fontSize = '12px';
                transferHint.textContent = '‰º†ËæìÂõæÁâáÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...';
                chatContainer.appendChild(transferHint);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÂ§ö‰∫∫Ê∏∏ÊàèÊ®°Âºè
                    if (gameState.currentScreen === 'multiplayerGame' && gameState.multiplayer) {
                        // ÂêëÊâÄÊúâÁé©ÂÆ∂ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
                        // ÁîüÊàêÊ∂àÊÅØID
                    const messageId = Date.now() + Math.random().toString(36).substr(2, 9);
                    
                    const imageMessage = {
                        type: 'chat-image',
                        from: gameState.multiplayer.currentPlayerId,
                        image: imageData,
                        messageId: messageId
                    };
                        
                        // ÂèëÈÄÅÁªôÊâÄÊúâËøûÊé•ÁöÑÁé©ÂÆ∂
                        if (gameState.multiplayer.connections) {
                            Object.values(gameState.multiplayer.connections).forEach(conn => {
                                if (conn.send) {
                                    conn.send(imageMessage);
                                }
                            });
                        }
                        
                        // Ëá™Â∑±‰πüÊòæÁ§∫ÂõæÁâá
                        const player = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
                        if (player) {
                            addChatMessage(player.name, null, player.color, imageData, messageId);
                        }
                    } else {
                        // Âçï‰∫∫Ê∏∏ÊàèÊ®°Âºè‰∏ãÂè™ÊòæÁ§∫Ëá™Â∑±ÁöÑÂõæÁâá
                        addChatMessage('Êàë', null, '#4CAF50', imageData);
                    }
                    
                    // ÁßªÈô§‰º†ËæìÊèêÁ§∫
                    setTimeout(() => {
                        const transferHint = document.getElementById('imageTransferHint');
                        if (transferHint) {
                            transferHint.remove();
                        }
                    }, 2000);
                    
                    // Ê∏ÖÁ©∫Ëß¶Âèë‰∫ã‰ª∂ÁöÑÊñá‰ª∂ËæìÂÖ•
                    event.target.value = '';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÂèëÈÄÅÊ∂àÊÅØ
        document.addEventListener('DOMContentLoaded', function() {
            // ‰∏∫Â∏∏ËßÑËÅäÂ§©ËæìÂÖ•Ê°ÜÊ∑ªÂä†ÂõûËΩ¶ÈîÆÁõëÂê¨
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
            // ‰∏∫ËÅäÂ§©Ê®°ÊÄÅÊ°ÜËæìÂÖ•Ê°ÜÊ∑ªÂä†ÂõûËΩ¶ÈîÆÁõëÂê¨
            const chatInputModal = document.getElementById('chatInputModal');
            if (chatInputModal) {
                chatInputModal.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });
        // ÊòæÁ§∫Ê∏∏ÊàèËØ¥Êòé
        function showInstructions() {
            document.getElementById('instructionsModal').classList.remove('hidden');
        }
        
        // ÊòæÁ§∫UIËÆæÁΩÆÈù¢Êùø
        function showUISettings() {
            
            let settings;
            try {
                // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
                settings = gameState.uiSettings;
                // console.log('gameState.uiSettings:', settings);
            }catch (error) {
                console.error('Error loading UI settings:', error);
                // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
                settings = gameState.uiSettings;
            }
            
            document.getElementById('showControlsCheckbox').checked = settings.showControls;
            document.getElementById('controlsPosition').value = settings.controlsPosition;
            document.getElementById('controlsSize').value = settings.controlsSize;
            document.getElementById('controlsOpacity').value = settings.controlsOpacity;
            
            document.getElementById('showGameInfoCheckbox').checked = settings.showGameInfo;
            document.getElementById('showLevelInfo').checked = settings.showLevelInfo;
            document.getElementById('showTimeInfo').checked = settings.showTimeInfo;
            document.getElementById('showMoveInfo').checked = settings.showMoveInfo;
            document.getElementById('showKeyInfo').checked = settings.showKeyInfo;
            document.getElementById('showRoomInfo').checked = settings.showRoomInfo;
            
            // Âä†ËΩΩÈü≥‰πêËÆæÁΩÆ
            document.getElementById('musicEnabledCheckbox').checked = settings.musicEnabled;
            document.getElementById('musicVolume').value = settings.musicVolume;
            
            // ÈáçÊñ∞ÁîüÊàêÈü≥‰πêÈÄâÊã©ÂàóË°®ÔºåÂåÖÊã¨Ëá™ÂÆö‰πâÈü≥‰πê
            const musicSelectionList = document.getElementById('musicSelectionList');
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            musicSelectionList.innerHTML = `
                <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-1"> Ê∏∏ÊàèÈü≥‰πê 1
                        </label>
                    </div>
                <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-2"> Ê∏∏ÊàèÈü≥‰πê 2
                        </label>
                    </div>
                <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="game-music-3"> Ê∏∏ÊàèÈü≥‰πê 3
                        </label>
                    </div>
            `;
            // Ê∑ªÂä†Ëá™ÂÆö‰πâÈü≥‰πê
            if (settings.customMusic && Array.isArray(settings.customMusic) && settings.customMusic.length > 0) {
                settings.customMusic.forEach(music => {
                    const musicOption = document.createElement('div');
                    musicOption.className = 'music-option';
                    musicOption.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="custom-${music.id}">
                            <input type="checkbox" class="custom-music-checkbox" data-music-id="${music.id}">
                            Ëá™ÂÆö‰πâ: ${music.name}
                        </label>
                    `;
                    musicSelectionList.appendChild(musicOption);
                });
            }
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈü≥‰πê
            const radioButtons = musicSelectionList.querySelectorAll('input[name="musicSelected"]');
            radioButtons.forEach(radio => {
                if (radio.value === settings.musicSelected) {
                    radio.checked = true;
                }
            });
            // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            const checkboxes = musicSelectionList.querySelectorAll('.custom-music-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButtonState);
            });
            // Ê∑ªÂä†ÂçïÈÄâÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    gameState.uiSettings.musicSelected = this.value;
                    if (gameState.musicPlayer.isPlaying) {
                        // ÂàáÊç¢Âà∞Êñ∞Èü≥‰πê
                        playMusic();
                    }
                    // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                });
            });
            
            // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
            updateDeleteButtonState();
            
            // Ê∑ªÂä†Èü≥‰πêÊéßÂà∂ÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('musicPlay').onclick = function() {
                playMusic();
            };
            document.getElementById('musicPause').onclick = function() {
                pauseMusic();
            };
            document.getElementById('musicStop').onclick = function() {
                stopMusic();
            };
            
            // Ê∑ªÂä†Èü≥‰πêËÆæÁΩÆÁöÑÂÆûÊó∂Êõ¥Êñ∞ÁõëÂê¨Âô®
            document.getElementById('musicVolume').onchange = function() {
                const volume = parseInt(this.value);
                gameState.uiSettings.musicVolume = volume;
                if (gameState.musicPlayer.audio) {
                    gameState.musicPlayer.audio.volume = volume / 100;
                }
            };
            
            document.getElementById('musicEnabledCheckbox').onchange = function() {
                // Â¶ÇÊûúÁî®Êà∑Â∞ùËØïÂêØÁî®Èü≥‰πê‰ΩÜÈü≥‰πêÊú™Ëß£ÈîÅ
                if (this.checked && !gameState.uiSettings.musicEnabled) {
                    // ÊòæÁ§∫Ëß£ÈîÅÊ®°ÊÄÅÊ°Ü
                    document.getElementById('musicUnlockModal').classList.remove('hidden');
                    alert("ËØ∑ÂÖàËß£ÈîÅÈü≥‰πêÔºàÂàíÂà∞ÊúÄ‰∏äÈù¢ÔºåËæìÂÖ•ÂØÜÈí•");
                    // ÊÅ¢Â§çÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
                    this.checked = false;
                } else {
                    // Ê≠£Â∏∏Â§ÑÁêÜÂºÄÂÖ≥Áä∂ÊÄÅ
                    gameState.uiSettings.musicEnabled = this.checked;
                    if (!this.checked) {
                        stopMusic();
                    }
                }
            };
            
            // ÊòæÁ§∫UIËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
            const uiSettingsModal = document.getElementById('uiSettingsModal');
            
            if (uiSettingsModal) {
                uiSettingsModal.classList.remove('hidden');
                
            } else {
                console.error('uiSettingsModalÂÖÉÁ¥†‰∏çÂ≠òÂú®');
            }
        }
        
        // Èü≥‰πêÊí≠ÊîæÂô®ÂäüËÉΩ
        function playMusic() {
            const settings = gameState.uiSettings;
            
            // Ê£ÄÊü•Èü≥‰πêÊòØÂê¶Â∑≤Ëß£ÈîÅ
            if (!settings.musicEnabled) {
                // ÊòæÁ§∫Ëß£ÈîÅÊ®°ÊÄÅÊ°Ü
                document.getElementById('musicUnlockModal').classList.remove('hidden');
                return;
            }
            
            if (!settings.musicEnabled) {
                settings.musicEnabled = true;
                document.getElementById('musicEnabledCheckbox').checked = true;
            }
            
            if (!gameState.musicPlayer.audio) {
                gameState.musicPlayer.audio = new Audio();
                
                // Ê∑ªÂä†ÈîôËØØÂ§ÑÁêÜ
                gameState.musicPlayer.audio.onerror = function(e) {
                    console.error('Èü≥‰πêÂä†ËΩΩÈîôËØØ:', e);
                    gameState.musicPlayer.isPlaying = false;
                };
            }
            
            // ËÆæÁΩÆÂΩìÂâçÈü≥‰πê
            const musicUrl = getMusicUrl(settings.musicSelected);
            console.log('‰ΩøÁî®ÁöÑÈü≥‰πêURL:', musicUrl);
            console.log('ÂΩìÂâçÈÄâÊã©ÁöÑÈü≥‰πê:', settings.musicSelected);
            if (!musicUrl) {
                console.error('Ëé∑ÂèñÈü≥‰πêURLÂ§±Ë¥•');
                return;
            }
            
            gameState.musicPlayer.audio.src = musicUrl;
            console.log('AudioÂØπË±°ÁöÑsrcËÆæÁΩÆ‰∏∫:', gameState.musicPlayer.audio.src);
            gameState.musicPlayer.audio.volume = settings.musicVolume / 100;
            gameState.musicPlayer.audio.loop = true;
            
            // Â§ÑÁêÜÁßªÂä®ËÆæÂ§áÁöÑËá™Âä®Êí≠ÊîæÈôêÂà∂
            try {
                const playPromise = gameState.musicPlayer.audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        gameState.musicPlayer.isPlaying = true;
                        gameState.musicPlayer.currentTrack = settings.musicSelected;
                    }).catch(error => {
                        console.error('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', error);
                        gameState.musicPlayer.isPlaying = false;
                        // Âú®ÁßªÂä®ËÆæÂ§á‰∏äÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®Êí≠Êîæ
                        alert('ËØ∑ÁÇπÂáªÂ±èÂπï‰ªªÊÑè‰ΩçÁΩÆÂºÄÂßãÊí≠ÊîæÈü≥‰πê');
                    });
                } else {
                    gameState.musicPlayer.isPlaying = true;
                    gameState.musicPlayer.currentTrack = settings.musicSelected;
                }
            } catch (error) {
                console.error('Èü≥‰πêÊí≠ÊîæÈîôËØØ:', error);
                gameState.musicPlayer.isPlaying = false;
            }
        }
        
        function pauseMusic() {
            if (gameState.musicPlayer.audio && gameState.musicPlayer.isPlaying) {
                gameState.musicPlayer.audio.pause();
                gameState.musicPlayer.isPlaying = false;
            }
        }
        
        function stopMusic() {
            if (gameState.musicPlayer.audio) {
                gameState.musicPlayer.audio.pause();
                gameState.musicPlayer.audio.currentTime = 0;
                gameState.musicPlayer.isPlaying = false;
                gameState.musicPlayer.currentTrack = null;
            }
        }
        
        function deleteSelectedCustomMusic() {
            // Ëé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑËá™ÂÆö‰πâÈü≥‰πêÂ§çÈÄâÊ°Ü
            const checkedCheckboxes = document.querySelectorAll('.custom-music-checkbox:checked');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÈü≥‰πê
            if (checkedCheckboxes.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËá™ÂÆö‰πâÈü≥‰πêÔºÅ');
                return;
            }
            
            // Á°ÆËÆ§Âà†Èô§Êìç‰Ωú
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${checkedCheckboxes.length} È¶ñËá™ÂÆö‰πâÈü≥‰πêÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                return;
            }
            
            // ÊèêÂèñË¶ÅÂà†Èô§ÁöÑÈü≥‰πêID
            const idsToDelete = Array.from(checkedCheckboxes).map(cb => parseInt(cb.dataset.musicId));
            
            // ÊâπÈáèÂà†Èô§Èü≥‰πê
            idsToDelete.forEach(id => {
                // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ÊåáÂÆöIDÁöÑÈü≥‰πê
                gameState.uiSettings.customMusic = gameState.uiSettings.customMusic.filter(music => music.id !== id);
                
                // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØË¢´Âà†Èô§ÁöÑÈü≥‰πêÔºåÂàáÊç¢Âà∞ÈªòËÆ§Èü≥‰πê
                if (gameState.uiSettings.musicSelected === `custom-${id}`) {
                    gameState.uiSettings.musicSelected = 'game-music-1';
                    
                    // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πê
                    if (gameState.musicPlayer && gameState.musicPlayer.audio) {
                        gameState.musicPlayer.audio.pause();
                        gameState.musicPlayer.audio.currentTime = 0;
                        gameState.musicPlayer.currentTrack = null;
                    }
                }
            });
            
            // Êõ¥Êñ∞Èü≥‰πêÈÄâÊã©ÂàóË°®
            const musicSelectionList = document.getElementById('musicSelectionList');
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            musicSelectionList.innerHTML = `
                <div class="music-option">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="musicSelected" value="game-music-1"> Ê∏∏ÊàèÈü≥‰πê 1
                    </label>
                </div>
                <div class="music-option">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="musicSelected" value="game-music-2"> Ê∏∏ÊàèÈü≥‰πê 2
                    </label>
                </div>
                <div class="music-option">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="musicSelected" value="game-music-3"> Ê∏∏ÊàèÈü≥‰πê 3
                    </label>
                </div>
            `;
            // ÈáçÊñ∞Ê∑ªÂä†Ëá™ÂÆö‰πâÈü≥‰πê
            if (gameState.uiSettings.customMusic && Array.isArray(gameState.uiSettings.customMusic) && gameState.uiSettings.customMusic.length > 0) {
                gameState.uiSettings.customMusic.forEach(music => {
                    const musicOption = document.createElement('div');
                    musicOption.className = 'music-option';
                    musicOption.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="musicSelected" value="custom-${music.id}">
                            <input type="checkbox" class="custom-music-checkbox" data-music-id="${music.id}">
                            Ëá™ÂÆö‰πâ: ${music.name}
                        </label>
                    `;
                    musicSelectionList.appendChild(musicOption);
                });
            }
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈü≥‰πê
            const radioButtons = musicSelectionList.querySelectorAll('input[name="musicSelected"]');
            radioButtons.forEach(radio => {
                if (radio.value === gameState.uiSettings.musicSelected) {
                    radio.checked = true;
                }
            });
            // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            const checkboxes = musicSelectionList.querySelectorAll('.custom-music-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButtonState);
            });
            // Ê∑ªÂä†ÂçïÈÄâÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    gameState.uiSettings.musicSelected = this.value;
                    if (gameState.musicPlayer.isPlaying) {
                        // ÂàáÊç¢Âà∞Êñ∞Èü≥‰πê
                        playMusic();
                    }
                    // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                });
            });
            
            // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
            updateDeleteButtonState();
            
            // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            try {
                localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // Â≠òÂÇ®Ê∫¢Âá∫Êó∂ÔºåÁßªÈô§Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂ÈáçËØï
                    const settingsWithoutMusic = {...gameState.uiSettings, customMusic: []};
                    try {
                        localStorage.setItem('uiSettings', JSON.stringify(settingsWithoutMusic));
                        alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂‰øùÂ≠òÂÖ∂‰ªñËÆæÁΩÆ');
                    } catch (e2) {
                        alert('Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåÊó†Ê≥ï‰øùÂ≠òËÆæÁΩÆ');
                    }
                } else {
                    console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                    alert('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô: ' + e.message);
                }
            }
            
            alert(`Â∑≤ÊàêÂäüÂà†Èô§ ${checkedCheckboxes.length} È¶ñËá™ÂÆö‰πâÈü≥‰πêÔºÅ`);
        }
        
        // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅÁöÑÂáΩÊï∞
        function updateDeleteButtonState() {
            const checkedCheckboxes = document.querySelectorAll('.custom-music-checkbox:checked');
            const deleteBtn = document.getElementById('deleteCustomMusicBtn');
            const deleteAllBtn = document.getElementById('deleteAllMusicBtn');
            const customMusic = gameState.uiSettings.customMusic || [];
            
            if (deleteBtn) {
                // ÂΩìÊúâËá™ÂÆö‰πâÈü≥‰πêË¢´ÈÄâ‰∏≠Êó∂ÂêØÁî®Âà†Èô§ÊåâÈíÆÔºåÂê¶ÂàôÁ¶ÅÁî®
                deleteBtn.disabled = checkedCheckboxes.length === 0;
            }
            
            if (deleteAllBtn) {
                // ÂΩìÊúâËá™ÂÆö‰πâÈü≥‰πêÊó∂ÂêØÁî®Âà†Èô§ÊâÄÊúâÊåâÈíÆÔºåÂê¶ÂàôÁ¶ÅÁî®
                deleteAllBtn.disabled = customMusic.length === 0;
            }
        }
        
        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéË∞ÉÁî®
        window.addEventListener('load', function() {
            // ÂàùÂßãÂåñÂà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
            updateDeleteButtonState();
            
            // ‰∏∫Áé∞ÊúâËá™ÂÆö‰πâÈü≥‰πêÊ∑ªÂä†ÂÖºÂÆπÊÄßÂ§ÑÁêÜ
            if (gameState.uiSettings && gameState.uiSettings.customMusic) {
                gameState.uiSettings.customMusic.forEach(music => {
                    // Â¶ÇÊûúÈü≥‰πêÊï∞ÊçÆ‰∏çÊòØÂéãÁº©Ê†ºÂºè‰ΩÜÂåÖÂê´ÂÆåÊï¥ÁöÑDataURLÔºåÂàôËΩ¨Êç¢‰∏∫ÂéãÁº©Ê†ºÂºè
                    if (!music.isCompressed && music.url.startsWith('data:audio/mp3;base64,')) {
                        const base64Prefix = 'data:audio/mp3;base64,';
                        music.url = music.url.substring(base64Prefix.length);
                        music.isCompressed = true;
                    }
                });
                // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑËÆæÁΩÆ
                localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
            }
        });
        
        function deleteCustomMusic(id) {
            // Á°Æ‰øùgameState.uiSettingsÂíåcustomMusicÊï∞ÁªÑÂ≠òÂú®
            if (!gameState.uiSettings || !gameState.uiSettings.customMusic) {
                return;
            }
            
            // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ÊåáÂÆöIDÁöÑÈü≥‰πê
            const initialLength = gameState.uiSettings.customMusic.length;
            gameState.uiSettings.customMusic = gameState.uiSettings.customMusic.filter(music => music.id !== id);
            
            // Â¶ÇÊûúÊúâÈü≥‰πêË¢´Âà†Èô§
            if (gameState.uiSettings.customMusic.length < initialLength) {
                // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØË¢´Âà†Èô§ÁöÑÈü≥‰πêÔºåÂàáÊç¢Âà∞ÈªòËÆ§Èü≥‰πê
                if (gameState.uiSettings.musicSelected === `custom-${id}`) {
                    gameState.uiSettings.musicSelected = 'game-music-1';
                    
                    // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πê
                    if (gameState.musicPlayer && gameState.musicPlayer.audio) {
                        gameState.musicPlayer.audio.pause();
                        gameState.musicPlayer.audio.currentTime = 0;
                        gameState.musicPlayer.currentTrack = null;
                    }
                }
                
                // Êõ¥Êñ∞Èü≥‰πêÈÄâÊã©ÂàóË°®
                const musicSelectionList = document.getElementById('musicSelectionList');
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                musicSelectionList.innerHTML = `
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-1"> Ê∏∏ÊàèÈü≥‰πê 1
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-2"> Ê∏∏ÊàèÈü≥‰πê 2
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-3"> Ê∏∏ÊàèÈü≥‰πê 3
                        </label>
                    </div>
                `;
                // ÈáçÊñ∞Ê∑ªÂä†Ëá™ÂÆö‰πâÈü≥‰πê
                if (gameState.uiSettings.customMusic && Array.isArray(gameState.uiSettings.customMusic) && gameState.uiSettings.customMusic.length > 0) {
                    gameState.uiSettings.customMusic.forEach(music => {
                        const musicOption = document.createElement('div');
                        musicOption.className = 'music-option';
                        musicOption.innerHTML = `
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="musicSelected" value="custom-${music.id}">
                                <input type="checkbox" class="custom-music-checkbox" data-music-id="${music.id}">
                                Ëá™ÂÆö‰πâ: ${music.name}
                            </label>
                        `;
                        musicSelectionList.appendChild(musicOption);
                    });
                }
                // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈü≥‰πê
                const radioButtons = musicSelectionList.querySelectorAll('input[name="musicSelected"]');
                radioButtons.forEach(radio => {
                    if (radio.value === gameState.uiSettings.musicSelected) {
                        radio.checked = true;
                    }
                });
                // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
                const checkboxes = musicSelectionList.querySelectorAll('.custom-music-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateDeleteButtonState);
                });
                // Ê∑ªÂä†ÂçïÈÄâÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        gameState.uiSettings.musicSelected = this.value;
                        if (gameState.musicPlayer.isPlaying) {
                            // ÂàáÊç¢Âà∞Êñ∞Èü≥‰πê
                            playMusic();
                        }
                        // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                    });
                });
                // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
                updateDeleteButtonState();
                
                // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                try {
                    localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // Â≠òÂÇ®Ê∫¢Âá∫Êó∂ÔºåÁßªÈô§Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂ÈáçËØï
                        const settingsWithoutMusic = {...gameState.uiSettings, customMusic: []};
                        try {
                            localStorage.setItem('uiSettings', JSON.stringify(settingsWithoutMusic));
                            alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂‰øùÂ≠òÂÖ∂‰ªñËÆæÁΩÆ');
                        } catch (e2) {
                            alert('Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåÊó†Ê≥ï‰øùÂ≠òËÆæÁΩÆ');
                        }
                    } else {
                        console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                        alert('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô: ' + e.message);
                    }
                }
                
                alert('Ëá™ÂÆö‰πâÈü≥‰πêÂ∑≤Âà†Èô§ÔºÅ');
            }
        }
        
        function deleteAllCustomMusic() {
            // Á°Æ‰øùgameState.uiSettingsÂíåcustomMusicÊï∞ÁªÑÂ≠òÂú®
            if (!gameState.uiSettings || !gameState.uiSettings.customMusic || gameState.uiSettings.customMusic.length === 0) {
                alert('Ê≤°ÊúâÂèØÂà†Èô§ÁöÑËá™ÂÆö‰πâÈü≥‰πêÔºÅ');
                return;
            }
            
            // Á°ÆËÆ§Âà†Èô§Êìç‰Ωú
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâËá™ÂÆö‰πâÈü≥‰πêÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                return;
            }
            
            // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÈü≥‰πêÊï∞ÁªÑ
            gameState.uiSettings.customMusic = [];
            
            // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØËá™ÂÆö‰πâÈü≥‰πêÔºåÂàáÊç¢Âà∞ÈªòËÆ§Èü≥‰πê
            if (gameState.uiSettings.musicSelected.startsWith('custom-')) {
                gameState.uiSettings.musicSelected = 'game-music-1';
                
                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πê
                if (gameState.musicPlayer && gameState.musicPlayer.audio) {
                    gameState.musicPlayer.audio.pause();
                    gameState.musicPlayer.audio.currentTime = 0;
                    gameState.musicPlayer.currentTrack = null;
                }
            }
            
            // Êõ¥Êñ∞Èü≥‰πêÈÄâÊã©ÂàóË°®
            const musicSelectionList = document.getElementById('musicSelectionList');
            if (musicSelectionList) {
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                musicSelectionList.innerHTML = `
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-1"> Ê∏∏ÊàèÈü≥‰πê 1
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-2"> Ê∏∏ÊàèÈü≥‰πê 2
                        </label>
                    </div>
                    <div class="music-option">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="musicSelected" value="game-music-3"> Ê∏∏ÊàèÈü≥‰πê 3
                        </label>
                    </div>
                `;
                // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈü≥‰πê
                const radioButtons = musicSelectionList.querySelectorAll('input[name="musicSelected"]');
                radioButtons.forEach(radio => {
                    if (radio.value === gameState.uiSettings.musicSelected) {
                        radio.checked = true;
                    }
                });
                // Ê∑ªÂä†ÂçïÈÄâÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        gameState.uiSettings.musicSelected = this.value;
                        if (gameState.musicPlayer.isPlaying) {
                            // ÂàáÊç¢Âà∞Êñ∞Èü≥‰πê
                            playMusic();
                        }
                        // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                    });
                });
            }
            
            // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
            updateDeleteButtonState();
            
            // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            try {
                localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
            } catch (e) {
                console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                alert('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô: ' + e.message);
            }
            
            alert('ÊâÄÊúâËá™ÂÆö‰πâÈü≥‰πêÂ∑≤Âà†Èô§ÔºÅ');
        }
        
        function importCustomMusic() {
            console.log('importCustomMusicÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
            
            // Á°Æ‰øùgameState.uiSettingsÂ≠òÂú®
            if (!gameState.uiSettings) {
                console.log('gameState.uiSettings‰∏çÂ≠òÂú®ÔºåÊ≠£Âú®ÂàùÂßãÂåñ');
                gameState.uiSettings = JSON.parse(localStorage.getItem('uiSettings')) || {
                    showControls: true,
                    controlsPosition: 'bottom-left',
                    controlsSize: 100,
                    controlsOpacity: 60,
                    showGameInfo: true,
                    showLevelInfo: true,
                    showTimeInfo: true,
                    showMoveInfo: true,
                    showKeyInfo: true,
                    showRoomInfo: true,
                    showPlayerList: true,
                    musicEnabled: false,
                    musicVolume: 50,
                    musicSelected: 'game-music-1',
                    customMusic: [],
                    customX: null,
                    customY: null
                };
            }
    
            const musicName = document.getElementById('customMusicName').value.trim();
            const musicFile = document.getElementById('customMusicFile').files[0];
            
            console.log('Ëé∑ÂèñÂà∞ÁöÑÈü≥‰πêÂêçÁß∞:', musicName);
            console.log('Ëé∑ÂèñÂà∞ÁöÑÈü≥‰πêÊñá‰ª∂:', musicFile);
            
            if (!musicName || !musicFile) {
                console.log('Èü≥‰πêÂêçÁß∞ÊàñÊñá‰ª∂‰∏∫Á©∫ÔºåÂèñÊ∂àÂØºÂÖ•');
                alert('ËØ∑ËæìÂÖ•Èü≥‰πêÂêçÁß∞Âπ∂ÈÄâÊã©MP3Êñá‰ª∂ÔºÅ');
                return;
            }
            
            console.log('Èü≥‰πêÊñá‰ª∂Á±ªÂûã:', musicFile.type);
            console.log('Èü≥‰πêÊñá‰ª∂ÂêçÁß∞:', musicFile.name);
            if (musicFile.type !== 'audio/mp3' && !musicFile.name.endsWith('.mp3')) {
                console.log('Êñá‰ª∂Ê†ºÂºè‰∏çÊòØMP3ÔºåÂèñÊ∂àÂØºÂÖ•');
                alert('ËØ∑ÈÄâÊã©MP3Ê†ºÂºèÁöÑÈü≥È¢ëÊñá‰ª∂ÔºÅ');
                return;
            }
            
            // ÈôêÂà∂Êñá‰ª∂Â§ßÂ∞èÔºà20MBÔºâ
            const MAX_FILE_SIZE = 20 * 1024 * 1024;
            console.log('Èü≥‰πêÊñá‰ª∂Â§ßÂ∞è:', musicFile.size, 'Â≠óËäÇ');
            if (musicFile.size > MAX_FILE_SIZE) {
                console.log('Êñá‰ª∂Â§ßÂ∞èË∂ÖËøá20MBÔºåÂèñÊ∂àÂØºÂÖ•');
                alert('Èü≥È¢ëÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá20MBÔºÅ');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // Á°Æ‰øùcustomMusicÊï∞ÁªÑÂ≠òÂú®
                    if (!gameState.uiSettings.customMusic) {
                        gameState.uiSettings.customMusic = [];
                    }
                    // ÁîüÊàêÂîØ‰∏ÄID
                    const maxId = gameState.uiSettings.customMusic.length > 0 ? 
                        Math.max(...gameState.uiSettings.customMusic.map(music => music.id)) : 0;
                    const newId = maxId + 1;
                    
                    // Ê∑ªÂä†Âà∞Ëá™ÂÆö‰πâÈü≥‰πêÊï∞ÁªÑ - ÂéãÁº©‰øùÂ≠òÔºàÁßªÈô§DataURLÂ§¥ÈÉ®Ôºâ
                    let musicData = e.target.result;
                    // ÁßªÈô§DataURLÂ§¥ÈÉ®ÔºåÂè™‰øùÂ≠òbase64Â≠óÁ¨¶‰∏≤
                    const base64Prefix = 'data:audio/mp3;base64,';
                    if (musicData.startsWith(base64Prefix)) {
                        musicData = musicData.substring(base64Prefix.length);
                    }
                    gameState.uiSettings.customMusic.push({
                        id: newId,
                        name: musicName,
                        url: musicData, // Âè™‰øùÂ≠òbase64Â≠óÁ¨¶‰∏≤
                        fileName: musicFile.name,
                        isCompressed: true // Ê†áËÆ∞‰∏∫Â∑≤ÂéãÁº©
                    });
                    
                    // Êõ¥Êñ∞Èü≥‰πêÈÄâÊã©ÂàóË°®
                    const musicSelectionList = document.getElementById('musicSelectionList');
                    if (musicSelectionList) {
                        // ÂàõÂª∫Êñ∞ÁöÑÈü≥‰πêÈÄâÈ°π
                        const musicOption = document.createElement('div');
                        musicOption.className = 'music-option';
                        musicOption.innerHTML = `
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="radio" name="musicSelected" value="custom-${newId}">
                                <input type="checkbox" class="custom-music-checkbox" data-music-id="${newId}">
                                Ëá™ÂÆö‰πâ: ${musicName}
                            </label>
                        `;
                        musicSelectionList.appendChild(musicOption);
                        
                        // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
                        const checkbox = musicOption.querySelector('.custom-music-checkbox');
                        if (checkbox) {
                            checkbox.addEventListener('change', updateDeleteButtonState);
                        }
                        
                        // Ê∑ªÂä†ÂçïÈÄâÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                        const radioButton = musicOption.querySelector('input[name="musicSelected"]');
                        if (radioButton) {
                            radioButton.addEventListener('change', function() {
                                gameState.uiSettings.musicSelected = this.value;
                                if (gameState.musicPlayer.isPlaying) {
                                    // ÂàáÊç¢Âà∞Êñ∞Èü≥‰πê
                                    playMusic();
                                }
                                // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                                localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                            });
                        }
                    }
                    
                    // Ëá™Âä®ÈÄâÊã©Êñ∞ÂØºÂÖ•ÁöÑÈü≥‰πê
                    gameState.uiSettings.musicSelected = `custom-${newId}`;
                    // ËÆæÁΩÆÂçïÈÄâÊåâÈíÆ‰∏∫ÈÄâ‰∏≠Áä∂ÊÄÅ
                    const newRadio = document.querySelector(`input[name="musicSelected"][value="custom-${newId}"]`);
                    if (newRadio) {
                        newRadio.checked = true;
                    }
                    
                    // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
                    updateDeleteButtonState();
                    
                    // ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                    
                    // Ê∏ÖÁ©∫ËæìÂÖ•
                    document.getElementById('customMusicName').value = '';
                    document.getElementById('customMusicFile').value = '';
                    
                    alert('Ëá™ÂÆö‰πâÈü≥‰πêÂØºÂÖ•ÊàêÂäüÔºÅ');
                } catch (error) {
                    console.error('Â§ÑÁêÜÈü≥‰πêÊñá‰ª∂Êó∂Âá∫Èîô:', error);
                    alert('Â§ÑÁêÜÈü≥‰πêÊñá‰ª∂Êó∂Âá∫Èîô: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('ËØªÂèñÈü≥‰πêÊñá‰ª∂Â§±Ë¥•:', error);
                alert('ËØªÂèñÈü≥‰πêÊñá‰ª∂Â§±Ë¥•: ' + error.message);
            };
            
            reader.readAsDataURL(musicFile);

        }        
        function getMusicUrl(trackId) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØËá™ÂÆö‰πâÈü≥‰πê
            if (trackId.startsWith('custom-')) {
                const customMusicId = parseInt(trackId.split('-')[1]);
                const customMusic = gameState.uiSettings.customMusic.find(music => music.id === customMusicId);
                if (customMusic) {
                    // Â¶ÇÊûúURLÂ∑≤ÁªèÊòØÂÆåÊï¥ÁöÑDataURLÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
                    if (customMusic.url.startsWith('data:')) {
                        return customMusic.url;
                    }
                    // Âê¶ÂàôÊ∑ªÂä†Ê≠£Á°ÆÁöÑDataURLÂ§¥ÈÉ®
                    return 'data:audio/mp3;base64,' + customMusic.url;
                }
                return null;
            }
            
            // È¢ÑËÆæÈü≥‰πêÊñá‰ª∂
            const musicFiles = {
                'game-music-1': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'game-music-2': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'game-music-3': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            };
            return musicFiles[trackId] || musicFiles['game-music-1'];
        }
        
        // ‰øùÂ≠òUIËÆæÁΩÆ
        function saveUISettings() {
            // Á°Æ‰øùgameState.uiSettingsÂ≠òÂú®
            const oldSettings = gameState.uiSettings || {};
            
            // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑ‰ΩçÁΩÆ
            const controlsPosition = document.getElementById('controlsPosition').value;
            
            // ‰øùÂ≠òËá™ÂÆö‰πâ‰ΩçÁΩÆÂùêÊ†áÔºåÂ¶ÇÊûúÊòØËá™ÂÆö‰πâ‰ΩçÁΩÆ‰∏îÂùêÊ†á‰∏∫nullÔºåÂàôËÆæÁΩÆÈªòËÆ§ÂÄº
            let customX = oldSettings.customX;
            let customY = oldSettings.customY;
            
            if (controlsPosition === 'custom' && (customX === null || customY === null)) {
                // ËÆæÁΩÆÈªòËÆ§‰ΩçÁΩÆ‰∏∫Â±èÂπï‰∏≠Â§ÆÂÅè‰∏ã
                customX = window.innerWidth / 2 - 50;
                customY = window.innerHeight / 2 - 50;
            }
            
            gameState.uiSettings = {
                showControls: document.getElementById('showControlsCheckbox').checked,
                controlsPosition: controlsPosition,
                controlsSize: parseInt(document.getElementById('controlsSize').value),
                controlsOpacity: parseInt(document.getElementById('controlsOpacity').value),
                showGameInfo: document.getElementById('showGameInfoCheckbox').checked,
                showLevelInfo: document.getElementById('showLevelInfo').checked,
                showTimeInfo: document.getElementById('showTimeInfo').checked,
                showMoveInfo: document.getElementById('showMoveInfo').checked,
                showKeyInfo: document.getElementById('showKeyInfo').checked,
                showRoomInfo: document.getElementById('showRoomInfo').checked,
            showPlayerList: document.getElementById('showPlayerListCheckbox').checked,
            // ‰øùÂ≠òÈü≥‰πêËÆæÁΩÆ
            musicEnabled: document.getElementById('musicEnabledCheckbox').checked,
            musicVolume: parseInt(document.getElementById('musicVolume').value),
            // ‰ªéÂçïÈÄâÊåâÈíÆ‰∏≠Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÈü≥‰πê
            musicSelected: document.querySelector('input[name="musicSelected"]:checked')?.value || 'game-music-1',
            // ‰øùÁïôËá™ÂÆö‰πâ‰ΩçÁΩÆÂùêÊ†á
            customX: customX,
            customY: customY,
            // ‰øùÂ≠òËá™ÂÆö‰πâÈü≥‰πêÔºåÂ¶ÇÊûúÂ≠òÂú®ÁöÑËØù
            customMusic: oldSettings.customMusic || []
            };
            try {
                localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
                document.getElementById('uiSettingsModal').classList.add('hidden');
                applyUISettings();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // Â≠òÂÇ®Ê∫¢Âá∫Êó∂ÔºåÁßªÈô§Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂ÈáçËØï
                    const settingsWithoutMusic = {...gameState.uiSettings, customMusic: []};
                    try {
                        localStorage.setItem('uiSettings', JSON.stringify(settingsWithoutMusic));
                        alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂‰øùÂ≠òÂÖ∂‰ªñËÆæÁΩÆ');
                        document.getElementById('uiSettingsModal').classList.add('hidden');
                        applyUISettings();
                    } catch (e2) {
                        // Â¶ÇÊûú‰ªçÁÑ∂Â§±Ë¥•ÔºåËøõ‰∏ÄÊ≠•ÁÆÄÂåñËÆæÁΩÆ
                        const minimalSettings = {
                            showControls: gameState.uiSettings.showControls,
                            controlsPosition: gameState.uiSettings.controlsPosition,
                            controlsSize: gameState.uiSettings.controlsSize,
                            controlsOpacity: gameState.uiSettings.controlsOpacity,
                            customX: gameState.uiSettings.customX,
                            customY: gameState.uiSettings.customY
                        };
                        try {
                            localStorage.setItem('uiSettings', JSON.stringify(minimalSettings));
                            alert('Â≠òÂÇ®Á©∫Èó¥‰∏•Èáç‰∏çË∂≥Ôºå‰ªÖ‰øùÂ≠ò‰∫ÜÊ†∏ÂøÉÊéßÂà∂Èù¢ÊùøËÆæÁΩÆ');
                            document.getElementById('uiSettingsModal').classList.add('hidden');
                            applyUISettings();
                        } catch (e3) {
                            alert('Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåÊó†Ê≥ï‰øùÂ≠òËÆæÁΩÆ');
                        }
                    }
                } else {
                    // ÂÖ∂‰ªñÈîôËØØ
                    console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                    alert('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô: ' + e.message);
                }
            }
        }
class LevelEditor {
    constructor() {
        this.currentLevel = null;
        this.isTesting = false;
        this.initEditor();
    }
    
    initEditor() {
        // ÂàõÂª∫Canvas
        this.canvas = document.createElement('canvas');
        this.canvas.width = 800;
        this.canvas.height = 600;
        document.getElementById('editorContainer').appendChild(this.canvas);
        this.ctx = this.canvas.getContext('2d');
        
        // ÁΩëÊ†ºÁªòÂà∂
        this.cellSize = 32;
        this.drawGrid();
        
        // Â∑•ÂÖ∑ÈÄâÊã©
        this.selectedTool = 'wall';
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.selectedTool = btn.dataset.tool;
            });
        });
        
        // ÁîªÂ∏É‰∫§‰∫í
        this.canvas.addEventListener('mousedown', this.handleCanvasClick.bind(this));
    }
    
    startNewLevel() {
        const creator = prompt("ËæìÂÖ•‰Ω†ÁöÑÂàõ‰ΩúËÄÖÂêçÁß∞:");
        if(!creator || creator.length < 2) {
            alert("Âàõ‰ΩúËÄÖÂêçÁß∞Ëá≥Â∞ëÈúÄË¶Å2‰∏™Â≠óÁ¨¶");
            return;
        }
        
        const levelName = prompt("ËæìÂÖ•ÂÖ≥Âç°ÂêçÁß∞:");
        if(!levelName) {
            alert("ÂøÖÈ°ªËæìÂÖ•ÂÖ≥Âç°ÂêçÁß∞");
            return;
        }
        
        this.currentLevel = {
            meta: {
                version: 2,
                creator: creator,
                name: levelName,
                created: Date.now(),
                verified: false
            },
            data: {
                tiles: Array(20).fill().map(() => Array(20).fill(0)), // 20x20Á©∫ÁΩëÊ†º
                entities: [],
                start: { x: 1, y: 1 },
                end: { x: 15, y: 15 }
            }
        };
        
        this.renderMap();
    }
    
    handleCanvasClick(e) {
        if(!this.currentLevel || this.isTesting) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / this.cellSize);
        const y = Math.floor((e.clientY - rect.top) / this.cellSize);
        
        // ËæπÁïåÊ£ÄÊü•
        if(x < 0 || y < 0 || x >= 20 || y >= 20) return;
        
        switch(this.selectedTool) {
            case 'wall':
                this.currentLevel.data.tiles[y][x] = 1;
                break;
            case 'start':
                this.currentLevel.data.start = { x, y };
                break;
            case 'spike':
                this.currentLevel.data.entities.push({
                    type: 'spike',
                    x, y,
                    damage: 1
                });
                break;
            // ÂÖ∂‰ªñÂ∑•ÂÖ∑...
        }
        
        this.renderMap();
    }
    
    renderMap() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ÁªòÂà∂ÁΩëÊ†º
        this.drawGrid();
        
        // ÁªòÂà∂Âú∞Âùó
        for(let y = 0; y < 20; y++) {
            for(let x = 0; x < 20; x++) {
                if(this.currentLevel.data.tiles[y][x] === 1) {
                    this.ctx.fillStyle = '#886644';
                    this.ctx.fillRect(
                        x * this.cellSize, 
                        y * this.cellSize, 
                        this.cellSize, 
                        this.cellSize
                    );
                }
            }
        }
        
        // ÁªòÂà∂ÂÆû‰Ωì
        this.currentLevel.data.entities.forEach(entity => {
            switch(entity.type) {
                case 'spike':
                    this.drawSpike(entity.x, entity.y);
                    break;
                // ÂÖ∂‰ªñÂÆû‰Ωì...
            }
        });
        
        // ÁªòÂà∂Ëµ∑ÁÇπÁªàÁÇπ
        this.drawStartEnd();
    }
    
    async testLevel() {
        if(!this.currentLevel) return;
        this.isTesting = true;
        
        // ÂøÖÈ°ªÈÄöËøáÈ™åËØÅÊâçËÉΩÂàÜ‰∫´
        const success = await simulateGameTest(this.currentLevel);
        
        if(success) {
            this.currentLevel.meta.verified = true;
            const shareCode = LevelEncryptor.encrypt(
                this.currentLevel,
                this.currentLevel.meta.creator
            );
            
            alert(`ÊµãËØïÊàêÂäüÔºÅ‰Ω†ÁöÑÂàÜ‰∫´Á†Å: ${shareCode}`);
        } else {
            alert("ÊµãËØïÂ§±Ë¥•ÔºåÂøÖÈ°ª‰∫≤Ëá™ÈÄöÂÖ≥ÊâçËÉΩÂàÜ‰∫´");
        }
        
        this.isTesting = false;
    }
}
class LevelLoader {
    static loadFromCode(shareCode, creatorName) {
        // 1. Ëß£ÂØÜÊï∞ÊçÆ
        const levelData = LevelEncryptor.decrypt(shareCode, creatorName);
        if(!levelData) {
            throw new Error("Êó†ÊïàÁöÑÂàÜ‰∫´Á†ÅÊàñÂàõ‰ΩúËÄÖÂêç");
        }
        
        // 2. È™åËØÅÊï∞ÊçÆÁªìÊûÑ
        if(!this.validateLevel(levelData)) {
            throw new Error("ÂÖ≥Âç°Êï∞ÊçÆÊçüÂùè");
        }
        
        // 3. È™åËØÅÂàõ‰ΩúËÄÖÊòØÂê¶ÂÆåÊàêËøáÂÖ≥
        if(!levelData.meta.verified) {
            throw new Error("ËØ•ÂÖ≥Âç°Êú™ÈÄöËøáÂàõ‰ΩúËÄÖÈ™åËØÅ");
        }
        
        return levelData;
    }
    
    static validateLevel(levelData) {
        return levelData.meta &&
               levelData.meta.version >= 2 &&
               levelData.data &&
               Array.isArray(levelData.data.tiles) &&
               levelData.data.start &&
               levelData.data.end;
    }
}
class LocalLevelManager {
    static STORAGE_KEY = 'savedLevels_v2';
    
    static saveLevel(levelData) {
        const levels = this.getSavedLevels();
        levels.push({
            name: levelData.meta.name,
            code: LevelEncryptor.encrypt(
                levelData, 
                levelData.meta.creator
            ),
            creator: levelData.meta.creator,
            timestamp: Date.now()
        });
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(levels));
    }
    
    static getSavedLevels() {
        return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
    }
    
    static deleteLevel(code) {
        const levels = this.getSavedLevels()
            .filter(l => l.code !== code);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(levels));
    }
    
    static exportAllLevels() {
        const levels = this.getSavedLevels();
        const blob = new Blob([JSON.stringify(levels)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_levels_backup.json';
        a.click();
    }
}


const ENCRYPTION_CONFIG = {
    salt: "GAME_LEVEL_SALT_V1", // ‰øÆÊîπÊ≠§ÂÄº‰ΩøÊóßÂàÜ‰∫´Á†ÅÂ§±Êïà
    iv: CryptoJS.enc.Hex.parse("0102030405060708")
};

class LevelEncryptor {
    static encrypt(levelData, creatorName) {
        // 1. ÂáÜÂ§áÊï∞ÊçÆ
        const jsonStr = JSON.stringify(levelData);
        
        // 2. ÁîüÊàêÂü∫‰∫éÂàõ‰ΩúËÄÖÂêçÁöÑÂØÜÈí•
        const key = this._generateKey(creatorName);
        
        // 3. AES-CBCÂä†ÂØÜ
        const encrypted = CryptoJS.AES.encrypt(jsonStr, key, {
            iv: ENCRYPTION_CONFIG.iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        });
        
        // 4. ËΩ¨‰∏∫URLÂÆâÂÖ®ÁöÑBase64
        return encrypted.toString()
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
    }
    
    static decrypt(encryptedCode, creatorName) {
        try {
            // 1. ËøòÂéüÊ†áÂáÜBase64
            const standardB64 = encryptedCode
                .replace(/-/g, '+')
                .replace(/_/g, '/') + 
                '='.repeat((4 - encryptedCode.length % 4) % 4);
                
            // 2. ÁîüÊàêÂØÜÈí•
            const key = this._generateKey(creatorName);
            
            // 3. Ëß£ÂØÜ
            const decrypted = CryptoJS.AES.decrypt(standardB64, key, {
                iv: ENCRYPTION_CONFIG.iv,
                padding: CryptoJS.pad.Pkcs7,
                mode: CryptoJS.mode.CBC
            });
            
            // 4. ËΩ¨‰∏∫JSONÂØπË±°
            return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
        } catch(e) {
            console.error("Ëß£ÂØÜÂ§±Ë¥•:", e);
            return null;
        }
    }
    
    static _generateKey(creatorName) {
        return CryptoJS.PBKDF2(
            creatorName + ENCRYPTION_CONFIG.salt,
            CryptoJS.enc.Hex.parse("0102030405060708"),
            { keySize: 256/32, iterations: 100 }
        );
    }
}
// Â∫îÁî®UIËÆæÁΩÆ
function makeDraggable(element, handle) {
    let isDragging = false;
    let offsetX, offsetY;

    const startDrag = (clientX, clientY) => {
        isDragging = true;
        const rect = element.getBoundingClientRect();
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
        element.style.transition = 'none';
        document.body.style.userSelect = 'none';
    };

    const moveDrag = (clientX, clientY) => {
        if (!isDragging) return;
        
        let newLeft = clientX - offsetX;
        let newTop = clientY - offsetY;
        
        // ËæπÁïåÊ£ÄÊü•
        newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - element.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, window.innerHeight - element.offsetHeight));
        
        element.style.left = `${newLeft}px`;
        element.style.top = `${newTop}px`;
    };

    const endDrag = () => {
        if (!isDragging) return;
        isDragging = false;
        document.body.style.userSelect = '';
        
        // ‰øùÂ≠òÊñ∞‰ΩçÁΩÆ
        gameState.uiSettings.customX = parseInt(element.style.left);
        gameState.uiSettings.customY = parseInt(element.style.top);
        
        try {
            localStorage.setItem('uiSettings', JSON.stringify(gameState.uiSettings));
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                // Â≠òÂÇ®Ê∫¢Âá∫Êó∂ÔºåÁßªÈô§Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂ÈáçËØï
                const settingsWithoutMusic = {...gameState.uiSettings, customMusic: []};
                try {
                    localStorage.setItem('uiSettings', JSON.stringify(settingsWithoutMusic));
                    console.log('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÈü≥‰πêÂπ∂‰øùÂ≠òÊéßÂà∂Èù¢Êùø‰ΩçÁΩÆ');
                } catch (e2) {
                    // Â¶ÇÊûú‰ªçÁÑ∂Â§±Ë¥•Ôºå‰ªÖ‰øùÂ≠òÊéßÂà∂Èù¢Êùø‰ΩçÁΩÆÁöÑÊúÄÂ∞èËÆæÁΩÆ
                    const minimalSettings = {
                        showControls: gameState.uiSettings.showControls,
                        controlsPosition: gameState.uiSettings.controlsPosition,
                        controlsSize: gameState.uiSettings.controlsSize,
                        controlsOpacity: gameState.uiSettings.controlsOpacity,
                        customX: gameState.uiSettings.customX,
                        customY: gameState.uiSettings.customY
                    };
                    try {
                        localStorage.setItem('uiSettings', JSON.stringify(minimalSettings));
                        console.log('Â≠òÂÇ®Á©∫Èó¥‰∏•Èáç‰∏çË∂≥Ôºå‰ªÖ‰øùÂ≠ò‰∫ÜÊ†∏ÂøÉÊéßÂà∂Èù¢ÊùøËÆæÁΩÆ');
                    } catch (e3) {
                        console.warn('Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåÊó†Ê≥ï‰øùÂ≠òÊéßÂà∂Èù¢Êùø‰ΩçÁΩÆ');
                    }
                }
            } else {
                console.error('‰øùÂ≠òÊéßÂà∂Èù¢Êùø‰ΩçÁΩÆÊó∂Âá∫Èîô:', e);
            }
        }
    };

    // Èº†Ê†á‰∫ã‰ª∂
    handle.addEventListener('mousedown', (e) => {
        startDrag(e.clientX, e.clientY);
    });

    document.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
    document.addEventListener('mouseup', endDrag);

    // Ëß¶Êë∏‰∫ã‰ª∂
    handle.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            startDrag(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
        if (isDragging) moveDrag(e.touches[0].clientX, e.touches[0].clientY);
        e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchend', endDrag);
}

        // Â§ÑÁêÜÊéßÂà∂ÊåâÈíÆÁÇπÂáª


function handleControlButtonClick(key) {
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑÊñπÂêëÈîÆ
    if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
        // Áõ¥Êé•Ë∞ÉÁî®Ê†∏ÂøÉÁßªÂä®ÂáΩÊï∞Ôºå‰º†ÂÖ•ÂéüÂßãÊåâÈîÆ
        // movePlayer ÂÜÖÈÉ®‰ºöÂ§ÑÁêÜÂèçËΩ¨ÈÄªËæë
        movePlayer(key);
    }
}

        // =============== ÊéßÂà∂Âè∞ÂäüËÉΩ ===============
function toggleConsole() {
    consoleVisible = !consoleVisible;
    const consoleDiv = document.getElementById('console');
    
    if (consoleVisible) {
        consoleDiv.classList.remove('console-hidden');
        document.getElementById('consoleInput').focus();
        gameState.developerMode = true; // ÊâìÂºÄÊéßÂà∂Âè∞Êó∂ÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè
        showNotification('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºÅ');
    } else {
        consoleDiv.classList.add('console-hidden');
    }
}

function handleConsoleInput(e) {
    // Âè™ÈòªÊ≠¢ÁâπÂÆöÈîÆÁöÑÈªòËÆ§Ë°å‰∏∫
    if (e.key === 'Enter') {
        const input = document.getElementById('consoleInput');
        const command = input.value.trim();
        input.value = '';
            
        if (command) {
            consoleHistory.push(command);
            historyIndex = consoleHistory.length;
            executeCommand(command);
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (consoleHistory.length > 0) {
            if (historyIndex > 0) historyIndex--;
            document.getElementById('consoleInput').value = consoleHistory[historyIndex] || '';
        }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (consoleHistory.length > 0) {
                    if (historyIndex < consoleHistory.length - 1) historyIndex++;
                    document.getElementById('consoleInput').value = consoleHistory[historyIndex] || '';
                } else {
                    document.getElementById('consoleInput').value = '';
                }
            }
            // ÂÖ∂‰ªñÊåâÈîÆ‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåÂÖÅËÆ∏Ê≠£Â∏∏ËæìÂÖ•
        }
function sendKickRequest(playerId, reason) {
    // ÊâæÂà∞Êàø‰∏ªËøûÊé•
    let hostConnection = null;
    for (const id in gameState.multiplayer.players) {
        if (gameState.multiplayer.players[id].isHost) {
            hostConnection = gameState.multiplayer.connections[id];
            break;
        }
    }
    
    if (hostConnection) {
        hostConnection.send({
            type: 'kick-request',
            playerId: playerId,
            requestorId: gameState.multiplayer.currentPlayerId,
            reason: reason
        });
    }
}
function sendPrivateMessage(playerId, message) {
    if (gameState.multiplayer.connections[playerId]) {
        try {
            gameState.multiplayer.connections[playerId].send({
                type: 'private-message',
                from: gameState.multiplayer.currentPlayerId,
                message: message,
                timestamp: Date.now()
            });
            
            // ÁªôËá™Â∑±‰πüÊòæÁ§∫‰∏ÄÊù°ÂèëÈÄÅÊàêÂäüÁöÑÊ∂àÊÅØ
            // showMessageToSelf(`‰Ω† ‚Üí ${gameState.multiplayer.players[playerId].name}: ${message}`);
        } catch (err) {
            console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', err);
        }
    }
}
// ÁªôËá™Â∑±ÊòæÁ§∫Ê∂àÊÅØ
function showMessageToSelf(message) {
    const consoleOutput = document.getElementById('consoleOutput');
    consoleOutput.innerHTML += `\n[ÁßÅËÅä] ${message}`;
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    
    // Â¶ÇÊûúÊòØÂºπÁ™óÂΩ¢Âºè
    alert(message);
}


function executeCommand(command) {
            const output = document.getElementById('consoleOutput');
            output.innerHTML += `\n> ${command}`;
            output.scrollTop = output.scrollHeight;
            
            const parts = command.split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(cmd) {
                case 'help':
                    output.innerHTML += '\nÂèØÁî®ÂëΩ‰ª§:';
                    output.innerHTML += '\n- help: ÊòæÁ§∫Â∏ÆÂä©‰ø°ÊÅØ';
                    output.innerHTML += '\n- dev [password]: ËøõÂÖ•ÂºÄÂèëËÄÖÊ®°Âºè';
                    output.innerHTML += '\n- win: Á´ãÂç≥ÂÆåÊàêÂΩìÂâçÂÖ≥Âç°';
                    output.innerHTML += '\n- level [n]: Ë∑≥ËΩ¨Âà∞Á¨¨nÂÖ≥ (1-80)';
                    output.innerHTML += '\n- unlockall: Ëß£ÈîÅÊâÄÊúâÂÖ≥Âç°';
                    output.innerHTML += '\n- reset: ÈáçÁΩÆÂΩìÂâçÂÖ≥Âç°';
                    output.innerHTML += '\n- clear: Ê∏ÖÁ©∫ÊéßÂà∂Âè∞ËæìÂá∫';
                    output.innerHTML += '\n- twoplayer: ËøõÂÖ•Â§ö‰∫∫Ê∏∏ÊàèÈ°µÈù¢';
                    output.innerHTML += '\n- tp [x] [y]: ‰º†ÈÄÅËá≥‰∏Ä‰∏™‰ΩçÁΩÆ';
                    output.innerHTML += '\n- tp select: ‰º†ÈÄÅËá≥‰∏Ä‰∏™‰ΩçÁΩÆÔºàÂú∞ÂõæÈÄâÊã©Ôºâ';
                    output.innerHTML += '\n- tp [playername] select: ‰º†ÈÄÅÁé©ÂÆ∂Âà∞ÈÄâÊã©ÁöÑ‰ΩçÁΩÆ';
                    output.innerHTML += '\n- kick [playername]: Ë∏¢Âá∫Áé©ÂÆ∂ÔºàÊàø‰∏ªÊùÉÈôêÔºâ';
                    output.innerHTML += '\n- protect [playername]: ‰øùÊä§Áé©ÂÆ∂ÔºàÊó†ÊïåÁä∂ÊÄÅÔºåÊó†Ê≥ïË¢´Ë∏¢Âá∫Ôºâ';
                    output.innerHTML += '\n- unprotect [playername]: ÂèñÊ∂à‰øùÊä§Áé©ÂÆ∂';
                    output.innerHTML += '\n- players: ÊòæÁ§∫Áé©ÂÆ∂ÂàóË°®';
                    output.innerHTML += '\n- msg: ÂêëÁé©ÂÆ∂ÂèëÂá∫‰ø°ÊÅØ';
                    break;
                    
                case 'dev':
                    if (args.length > 0 && args[0] === 'dev') {
                        gameState.devMode = true;
                        output.innerHTML += '\nÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºÅ';
                    } else {
                        output.innerHTML += '\nÈúÄË¶ÅÂØÜÁ†ÅÔºÅËæìÂÖ• "dev [password]" ÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè';
                    }
                    break;
                   
                case 'tp':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
            
                    if (args.length === 0) {
                        output.innerHTML += '\nÁî®Ê≥ï: tp [Áé©ÂÆ∂] [x] [y] Êàñ tp [Áé©ÂÆ∂] select';
                        output.innerHTML += '\nÁ§∫‰æã: tp 5 10 - ‰º†ÈÄÅÂà∞ÂùêÊ†á(5,10)';
                        output.innerHTML += '\n       tp player1 5 10 - ‰º†ÈÄÅplayer1Âà∞ÂùêÊ†á(5,10)';
                        output.innerHTML += '\n       tp select - ËøõÂÖ•Âú∞ÂõæÈÄâÊã©Ê®°Âºè';
                        output.innerHTML += '\n       tp player1 select - ‰∏∫player1ËøõÂÖ•Âú∞ÂõæÈÄâÊã©Ê®°Âºè';
                        output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                        break;
                    }
            
                    // Ëß£ÊûêÁé©ÂÆ∂ÂèÇÊï∞
                    let targetPlayerId = null;
                    let coordArgs = args;
                    
                    // Ê£ÄÊü•Á¨¨‰∏Ä‰∏™ÂèÇÊï∞ÊòØÂê¶ÊòØÁé©ÂÆ∂ÂêçÊàñID
                    if (args.length >= 3 || (args.length === 2 && args[1] === 'select')) {
                        const playerIdentifier = args[0];
                        
                        // Êü•ÊâæÁé©ÂÆ∂
                        if (gameState.currentScreen === 'singlePlayerGame') {
                            // Âçï‰∫∫Ê∏∏ÊàèÂè™ÊúâËá™Â∑±
                            if (playerIdentifier === 'me' || playerIdentifier === 'self') {
                                targetPlayerId = 'singleplayer';
                            } else {
                                output.innerHTML += '\nÂçï‰∫∫Ê®°Âºè‰∏ãÂè™ËÉΩ‰º†ÈÄÅËá™Â∑±Ôºå‰ΩøÁî® "me" ÊàñÁúÅÁï•Áé©ÂÆ∂ÂèÇÊï∞';
                                break;
                            }
                        } else if (gameState.currentScreen === 'multiplayerGame') {
                            // Âú®Â§ö‰∫∫Ê∏∏Êàè‰∏≠Êü•ÊâæÁé©ÂÆ∂
                            const players = gameState.multiplayer.players;
                            for (const id in players) {
                                if (players[id].name === playerIdentifier || id === playerIdentifier) {
                                    targetPlayerId = id;
                                    break;
                                }
                            }
                            
                            if (!targetPlayerId) {
                                output.innerHTML += `\nÊú™ÊâæÂà∞Áé©ÂÆ∂: ${playerIdentifier}`;
                                output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                                break;
                            }
                        }
                        
                        // ÁßªÈô§Áé©ÂÆ∂ÂèÇÊï∞Ôºå‰øùÁïôÂùêÊ†áÂèÇÊï∞
                        coordArgs = args.slice(1);
                    }
            
                    if (coordArgs[0] === 'select') {
                        // ËøõÂÖ•Âú∞ÂõæÈÄâÊã©Ê®°Âºè
                        startMapSelection(targetPlayerId);
                        output.innerHTML += `\nÂ∑≤ËøõÂÖ•Âú∞ÂõæÈÄâÊã©Ê®°ÂºèÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ${targetPlayerId ? ' ÁõÆÊ†áÁé©ÂÆ∂: ' + targetPlayerId : ''}`;
                    } else if (coordArgs.length === 2) {
                        // Áõ¥Êé•‰º†ÈÄÅÂà∞ÊåáÂÆöÂùêÊ†á
                        const x = parseInt(coordArgs[0]);
                        const y = parseInt(coordArgs[1]);
                
                        if (isNaN(x) || isNaN(y)) {
                            output.innerHTML += '\nÂùêÊ†áÂøÖÈ°ªÊòØÊï∞Â≠ó';
                            break;
                        }
                    
                        const success = teleportPlayer(x, y, targetPlayerId);
                        if (success) {
                            output.innerHTML += `\nÂ∑≤‰º†ÈÄÅ${targetPlayerId ? 'Áé©ÂÆ∂ ' + targetPlayerId : 'Ëá™Â∑±'}Âà∞ÂùêÊ†á(${x},${y})`;
                        }
                    } else {
                        output.innerHTML += '\nÁî®Ê≥ï: tp [Áé©ÂÆ∂] [x] [y] Êàñ tp [Áé©ÂÆ∂] select';
                    }
                    break;
                case 'msg':
                case 'message':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (args.length < 2) {
                        output.innerHTML += '\nÁî®Ê≥ï: msg [Áé©ÂÆ∂ÂêçÊàñID] [Ê∂àÊÅØÂÜÖÂÆπ]';
                        output.innerHTML += '\nÁ§∫‰æã: msg player1 ‰Ω†Â•ΩÔºÅ';
                        output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                        break;
                    }
                    
                    const recipient = args[0];
                    const message = args.slice(1).join(' ');
                    
                    if (gameState.currentScreen === 'multiplayerGame') {
                        // Êü•ÊâæÁé©ÂÆ∂
                        let playerId = null;
                        const players = gameState.multiplayer.players;
                        for (const id in players) {
                            if (players[id].name === recipient || id === recipient) {
                                playerId = id;
                                break;
                            }
                        }
                        
                        if (playerId) {
                            // ÂèëÈÄÅÊ∂àÊÅØ
                            sendPrivateMessage(playerId, message);
                            output.innerHTML += `\nÂ∑≤Âêë ${recipient} ÂèëÈÄÅÊ∂àÊÅØ: ${message}`;
                        } else {
                            output.innerHTML += `\nÊú™ÊâæÂà∞Áé©ÂÆ∂: ${recipient}`;
                        }
                    } else {
                        output.innerHTML += '\nÊ≠§ÂëΩ‰ª§Âè™ËÉΩÂú®Â§ö‰∫∫Ê∏∏Êàè‰∏≠‰ΩøÁî®';
                    }
                    break;                    
                case 'players':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (gameState.currentScreen === 'singlePlayerGame') {
                        output.innerHTML += '\nÂΩìÂâçÁé©ÂÆ∂: Ëá™Â∑± (Âçï‰∫∫Ê®°Âºè)';
                    } else if (gameState.currentScreen === 'multiplayerGame') {
                        output.innerHTML += '\nÁé©ÂÆ∂ÂàóË°®:';
                        const players = gameState.multiplayer.players;
                        for (const id in players) {
                            const player = players[id];
                            const isCurrent = id === gameState.multiplayer.currentPlayerId;
                            const isProtected = gameState.multiplayer.protectedPlayers[id];
                            output.innerHTML += `\n- ${player.name} (ID: ${id})${isCurrent ? ' [ÂΩìÂâçÁé©ÂÆ∂]' : ''}${isProtected ? ' [Âèó‰øùÊä§]' : ''}`;
                        }
                    } else {
                        output.innerHTML += '\nÊ≠§ÂëΩ‰ª§Âè™ËÉΩÂú®Ê∏∏Êàè‰∏≠‰ΩøÁî®';
                    }
                    break;
                    
                case 'twoplayer':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè';
                        break;
                    }
                    showScreen('multiplayerSetup');
                    output.innerHTML += '\nÂ∑≤ËøõÂÖ•Â§ö‰∫∫Ê∏∏ÊàèËÆæÁΩÆ';
                    break;
                    
                case 'kick':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (args.length === 0) {
                        output.innerHTML += '\nÁî®Ê≥ï: kick [Áé©ÂÆ∂ÂêçÊàñID] [force]';
                        output.innerHTML += '\nÁ§∫‰æã: kick player1 - ÂêëÊàø‰∏ªÂèëÈÄÅË∏¢Âá∫ËØ∑Ê±Ç';
                        output.innerHTML += '\n       kick player1 force - Âº∫Âà∂Ë∏¢Âá∫(Êó†ÈúÄÊàø‰∏ªÁ°ÆËÆ§)';
                        output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                        break;
                    }
            
                    const playerToKick = args[0];
                    const forceKick = args[1] === 'force'; // ÊòØÂê¶Âº∫Âà∂Ë∏¢Âá∫
                    if (gameState.currentScreen === 'multiplayerGame') {
                        // Êü•ÊâæÁé©ÂÆ∂
                        let playerId = null;
                        const players = gameState.multiplayer.players;
                        for (const id in players) {
                            if (players[id].name === playerToKick || id === playerToKick) {
                                playerId = id;
                                break;
                            }
                        }
                
                        if (playerId) {
                            // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§
                            if (gameState.multiplayer.protectedPlayers[playerId]) {
                                output.innerHTML += '\nË∏¢Âá∫Â§±Ë¥•Ôºöerr75937 (Áé©ÂÆ∂Âèó‰øùÊä§)';
                            } else {
                                if (forceKick || !gameState.multiplayer.isHost) {
                                    // Âº∫Âà∂Ë∏¢Âá∫ÊàñÈùûÊàø‰∏ªÁõ¥Êé•ÂèëÈÄÅË∏¢Âá∫ËØ∑Ê±Ç
                                    sendKickRequest(playerId, 'ÊéßÂà∂Âè∞Ë∏¢Âá∫' + (forceKick ? '(Âº∫Âà∂)' : ''));
                                    output.innerHTML += `\nÂ∑≤ÂèëÈÄÅË∏¢Âá∫ ${playerToKick} ÁöÑËØ∑Ê±Ç` + (forceKick ? ' (Âº∫Âà∂)' : '');
                                } else {
                                    // Êàø‰∏ªÁõ¥Êé•Ë∏¢‰∫∫
                                    kickPlayer(playerId, 'ÊéßÂà∂Âè∞Ë∏¢Âá∫');
                                    output.innerHTML += `\nÂ∑≤Ë∏¢Âá∫Áé©ÂÆ∂: ${playerToKick}`;
                                }
                            }
                        } else {
                            output.innerHTML += `\nÊú™ÊâæÂà∞Áé©ÂÆ∂: ${playerToKick}`;
                        }
                    } else {
                        output.innerHTML += '\nÊ≠§ÂëΩ‰ª§Âè™ËÉΩÂú®Â§ö‰∫∫Ê∏∏Êàè‰∏≠‰ΩøÁî®';
                    }
                    break;
                case 'protect':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (args.length === 0) {
                        output.innerHTML += '\nÁî®Ê≥ï: protect [Áé©ÂÆ∂ÂêçÊàñID]';
                        output.innerHTML += '\nÁ§∫‰æã: protect player1';
                        output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                        break;
                    }
                    
                    const playerToProtect = args[0];
                    if (gameState.currentScreen === 'multiplayerGame') {
                        // Êü•ÊâæÁé©ÂÆ∂
                        let playerId = null;
                        const players = gameState.multiplayer.players;
                        for (const id in players) {
                            if (players[id].name === playerToProtect || id === playerToProtect) {
                                playerId = id;
                                break;
                            }
                        }
                        
                        if (playerId) {
                            gameState.multiplayer.protectedPlayers[playerId] = true;
                            output.innerHTML += `\nÂ∑≤‰øùÊä§Áé©ÂÆ∂: ${playerToProtect}`;
                            
                            // ÂπøÊí≠‰øùÊä§Áä∂ÊÄÅ
                            broadcast({
                                type: 'player-protected',
                                playerId: playerId,
                                protected: true
                            });
                        } else {
                            output.innerHTML += `\nÊú™ÊâæÂà∞Áé©ÂÆ∂: ${playerToProtect}`;
                        }
                    } else {
                        output.innerHTML += '\nÊ≠§ÂëΩ‰ª§Âè™ËÉΩÂú®Â§ö‰∫∫Ê∏∏Êàè‰∏≠‰ΩøÁî®';
                    }
                    break;
                    
                case 'unprotect':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (args.length === 0) {
                        output.innerHTML += '\nÁî®Ê≥ï: unprotect [Áé©ÂÆ∂ÂêçÊàñID]';
                        output.innerHTML += '\nÁ§∫‰æã: unprotect player1';
                        output.innerHTML += '\n‰ΩøÁî® "players" ÂëΩ‰ª§Êü•ÁúãÊâÄÊúâÁé©ÂÆ∂';
                        break;
                    }
                    
                    const playerToUnprotect = args[0];
                    if (gameState.currentScreen === 'multiplayerGame') {
                        // Êü•ÊâæÁé©ÂÆ∂
                        let playerId = null;
                        const players = gameState.multiplayer.players;
                        for (const id in players) {
                            if (players[id].name === playerToUnprotect || id === playerToUnprotect) {
                                playerId = id;
                                break;
                            }
                        }
                        
                        if (playerId) {
                            delete gameState.multiplayer.protectedPlayers[playerId];
                            output.innerHTML += `\nÂ∑≤ÂèñÊ∂à‰øùÊä§Áé©ÂÆ∂: ${playerToUnprotect}`;
                            
                            // ÂπøÊí≠‰øùÊä§Áä∂ÊÄÅ
                            broadcast({
                                type: 'player-protected',
                                playerId: playerId,
                                protected: false
                            });
                        } else {
                            output.innerHTML += `\nÊú™ÊâæÂà∞Áé©ÂÆ∂: ${playerToUnprotect}`;
                        }
                    } else {
                        output.innerHTML += '\nÊ≠§ÂëΩ‰ª§Âè™ËÉΩÂú®Â§ö‰∫∫Ê∏∏Êàè‰∏≠‰ΩøÁî®';
                    }
                    break;
                    
                case 'win':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (gameState.currentScreen === 'singlePlayerGame') {
                        // ÂÆåÊàêÂΩìÂâçÂÖ≥Âç°
                        singlePlayerGame.player.x = singlePlayerGame.exit.x;
                        singlePlayerGame.player.y = singlePlayerGame.exit.y;
                        checkSinglePlayerExit();
                        output.innerHTML += '\nÂΩìÂâçÂÖ≥Âç°Â∑≤ÈÄöÂÖ≥ÔºÅ';
                    } else {
                        output.innerHTML += '\nÂè™ËÉΩÂú®Ê∏∏ÊàèÂÖ≥Âç°‰∏≠‰ΩøÁî®Ê≠§ÂëΩ‰ª§';
                    }
                    break;
                    
                case 'level':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (args.length === 0) {
                        output.innerHTML += '\nÈúÄË¶ÅÂÖ≥Âç°Âè∑ (1-80)';
                        break;
                    }
                    
                    const levelNum = parseInt(args[0]);
                    if (isNaN(levelNum) || levelNum < 1 || levelNum > 80) {
                        output.innerHTML += '\nÊó†ÊïàÁöÑÂÖ≥Âç°Âè∑ (ÂøÖÈ°ª‰ªã‰∫é1-80)';
                        break;
                    }
                    
                    gameState.currentLevel = levelNum;
                    if (gameState.currentScreen === 'singlePlayerGame') {
                        initSinglePlayerGame();
                        output.innerHTML += `\nÂ∑≤Ë∑≥ËΩ¨Âà∞Á¨¨ ${levelNum} ÂÖ≥`;
                    } else {
                        showScreen('singlePlayerGame');
                        output.innerHTML += `\nÂ∑≤ÂºÄÂßãÁ¨¨ ${levelNum} ÂÖ≥`;
                    }
                    break;
                    
                case 'unlockall':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    gameState.unlockedLevel = 80;
                    localStorage.setItem('unlockedLevel', 80);
                    output.innerHTML += '\nÊâÄÊúâÂÖ≥Âç°Â∑≤Ëß£ÈîÅÔºÅ';
                    if (gameState.currentScreen === 'singlePlayerLevelSelect') {
                        generateLevelButtons();
                    }
                    break;
                    
                case 'reset':
                    if (!gameState.devMode) {
                        output.innerHTML += '\nËØ∑ÂÖàÊøÄÊ¥ªÂºÄÂèëËÄÖÊ®°Âºè (ËæìÂÖ• "dev [password]")';
                        break;
                    }
                    
                    if (gameState.currentScreen === 'singlePlayerGame') {
                        resetSinglePlayerLevel();
                        output.innerHTML += '\nÂΩìÂâçÂÖ≥Âç°Â∑≤ÈáçÁΩÆ';
                    } else {
                        output.innerHTML += '\nÂè™ËÉΩÂú®Ê∏∏ÊàèÂÖ≥Âç°‰∏≠‰ΩøÁî®Ê≠§ÂëΩ‰ª§';
                    }
                    break;
                    
                case 'clear':
                    output.innerHTML = '> ÊéßÂà∂Âè∞Â∑≤Ê∏ÖÁ©∫';
                    break;
                case 'kick-request':
                        console.log(data);
                        // Âè™ÊúâÊàø‰∏ªËÉΩÂ§ÑÁêÜË∏¢‰∫∫ËØ∑Ê±Ç
                        if (gameState.multiplayer.isHost) {
                            const playerId = data.playerId;
                            const requestorId = data.requestorId;
                            const reason = data.reason || 'Êú™Áü•ÂéüÂõ†';
                            
                            // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§
                            if (gameState.multiplayer.protectedPlayers[playerId]) {
                                // ÂèëÈÄÅË∏¢Âá∫Â§±Ë¥•Ê∂àÊÅØÁªôËØ∑Ê±ÇËÄÖ
                                if (gameState.multiplayer.connections[requestorId]) {
                                    gameState.multiplayer.connections[requestorId].send({
                                        type: 'kick-failed',
                                        playerId: playerId,
                                        reason: 'err75937'
                                    });
                                }
                            } else {
                                // Ë∏¢Âá∫Áé©ÂÆ∂
                                kickPlayer(playerId, reason + ' (Áî±Áé©ÂÆ∂ËØ∑Ê±Ç)');
                                
                                // ÈÄöÁü•ËØ∑Ê±ÇËÄÖË∏¢Âá∫ÊàêÂäü
                                if (gameState.multiplayer.connections[requestorId]) {
                                    gameState.multiplayer.connections[requestorId].send({
                                        type: 'kick-success',
                                        playerId: playerId
                                    });
                                }
                            }
                        }
                        break;
                        
                    case 'kick-success':
                        console.log(data);
                        document.getElementById('consoleOutput').innerHTML += `\nÁé©ÂÆ∂ ${data.playerId} Â∑≤Ë¢´Êàø‰∏ªË∏¢Âá∫`;
                        break;
                    case 'eventsystem':
                        if (args.length > 0) {
                            EventSystem.triggerById(args[0]);
                            output.innerHTML += `\nÂΩìÂâçËß¶Âèë‰∫Ü‰∫ã‰ª∂: ${args[0]}`;
                        }
                        break;
                        default:
                            output.innerHTML += `\nÊú™Áü•ÂëΩ‰ª§: ${command}\nËæìÂÖ• "help" Êü•ÁúãÂèØÁî®ÂëΩ‰ª§`;
                    }
            
            output.scrollTop = output.scrollHeight;
        }

function startMapSelection(targetPlayerId = null) {
    // ‰øùÂ≠òÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅÂíåÁõÆÊ†áÁé©ÂÆ∂
    gameState.mapSelectionMode = true;
    gameState.mapSelectionTarget = targetPlayerId;
    
    // Ê∑ªÂä†Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨
    if (gameState.currentScreen === 'singlePlayerGame') {
        singlePlayerGame.canvas.addEventListener('click', handleMapClick);
        document.getElementById('consoleOutput').innerHTML += 
            '\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ';
        console.log('Âú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª');
        showNotification('Âú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ');
    } else if (gameState.currentScreen === 'multiplayerGame') {
        multiplayerCanvas.addEventListener('click', handleMapClick);
        document.getElementById('consoleOutput').innerHTML += 
            `\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆËøõË°å‰º†ÈÄÅ${targetPlayerId ? ' ÁõÆÊ†áÁé©ÂÆ∂: ' + targetPlayerId : ''}`;
    } else {
        document.getElementById('consoleOutput').innerHTML += 
            '\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂè™ËÉΩÂú®Ê∏∏Êàè‰∏≠ËøõË°å';
        gameState.mapSelectionMode = false;
    }
}

function handleMapClick(e) {
    if (!gameState.mapSelectionMode) return;
    
    let canvas, cellSize, maze;
    
    // Ê†πÊçÆÂΩìÂâçÊ∏∏ÊàèÊ®°ÂºèËé∑ÂèñÊ≠£Á°ÆÁöÑÁîªÂ∏ÉÂíåÂèÇÊï∞
    if (gameState.currentScreen === 'singlePlayerGame') {
        canvas = singlePlayerGame.canvas;
        cellSize = singlePlayerGame.cellSize;
        maze = singlePlayerGame.maze;
    } else if (gameState.currentScreen === 'multiplayerGame') {
        canvas = document.getElementById('multiplayerCanvas');
        // ËÆ°ÁÆóÂ§ö‰∫∫Ê∏∏ÊàèÁöÑÂçïÂÖÉÊ†ºÂ§ßÂ∞è
        const mazeWidth = gameState.multiplayer.maze[0].length;
        cellSize = canvas.width / mazeWidth;
        maze = gameState.multiplayer.maze;
    } else {
        return;
    }
    
    // Ëé∑ÂèñÁîªÂ∏ÉÁõ∏ÂØπ‰∫éËßÜÂè£ÁöÑ‰ΩçÁΩÆ
    const rect = canvas.getBoundingClientRect();
    
    // ËÆ°ÁÆóÁÇπÂáª‰ΩçÁΩÆÁõ∏ÂØπ‰∫éÁîªÂ∏ÉÁöÑÂùêÊ†á
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // ËΩ¨Êç¢‰∏∫Ëø∑ÂÆ´ÂùêÊ†á
    const x = Math.floor(clickX / cellSize);
    const y = Math.floor(clickY / cellSize);
    
    // È™åËØÅÂùêÊ†áÊòØÂê¶ÊúâÊïà
    if (x < 0 || x >= maze[0].length || y < 0 || y >= maze.length) {
        document.getElementById('consoleOutput').innerHTML += 
            `\nÈîôËØØ: ÂùêÊ†á(${x},${y})Ë∂ÖÂá∫Ëø∑ÂÆ´ËåÉÂõ¥`;
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ¢ô
    if (maze[y][x] === 1) {
        document.getElementById('consoleOutput').innerHTML += 
            `\nÈîôËØØ: ÂùêÊ†á(${x},${y})ÊòØÂ¢ôÔºåÊó†Ê≥ï‰º†ÈÄÅ`;
        return;
    }
    
    // ‰º†ÈÄÅÁé©ÂÆ∂
    const success = teleportPlayer(x, y, gameState.mapSelectionTarget);
    
    if (success) {
        document.getElementById('consoleOutput').innerHTML += 
            `\nÂ∑≤‰º†ÈÄÅÂà∞ÂùêÊ†á(${x},${y})`;
    }
    
    // ÈÄÄÂá∫Âú∞ÂõæÈÄâÊã©Ê®°Âºè
    gameState.mapSelectionMode = false;
    gameState.mapSelectionTarget = null;
    showNotification(`‰º†ÈÄÅÊàêÂäüÔºÅ‰Ω†Â∑≤Âà∞ËææÂùêÊ†á(${x},${y})„ÄÇ`);
    
    
    // ÁßªÈô§ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨
    canvas.removeEventListener('click', handleMapClick);
    
    document.getElementById('consoleOutput').innerHTML += 
        `\nÂú∞ÂõæÈÄâÊã©Ê®°ÂºèÂ∑≤ÂÖ≥Èó≠`;
}

// =============== Áé©ÂÆ∂‰º†ÈÄÅÂäüËÉΩ ===============
function teleportPlayer(x, y, targetPlayerId = null) {
    // Ê£ÄÊü•ÂùêÊ†áÊòØÂê¶ÊúâÊïà
    if (!isValidPosition(x, y)) {
        document.getElementById('consoleOutput').innerHTML += 
            `\nÈîôËØØ: ÂùêÊ†á(${x},${y})Êó†ÊïàÊàñ‰∏çÂèØÂà∞Ëææ`;
        return false;
    }
    
    if (gameState.currentScreen === 'singlePlayerGame') {
        // Âçï‰∫∫Ê∏∏ÊàèÂè™ËÉΩ‰º†ÈÄÅËá™Â∑±
        if (targetPlayerId && targetPlayerId !== 'singleplayer') {
            document.getElementById('consoleOutput').innerHTML += 
                '\nÂçï‰∫∫Ê®°Âºè‰∏ãÂè™ËÉΩ‰º†ÈÄÅËá™Â∑±';
            return false;
        }
        
        singlePlayerGame.player.x = x;
        singlePlayerGame.player.y = y;
        drawSinglePlayerMaze();
        
        // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
        checkSinglePlayerExit();
        
    } else if (gameState.currentScreen === 'multiplayerGame') {
        // Á°ÆÂÆöË¶Å‰º†ÈÄÅÁöÑÁé©ÂÆ∂
        let playerId;
        if (targetPlayerId) {
            playerId = targetPlayerId;
        } else {
            playerId = gameState.multiplayer.currentPlayerId;
        }
        
        const player = gameState.multiplayer.players[playerId];
        
        if (!player) {
            document.getElementById('consoleOutput').innerHTML += 
                `\nÈîôËØØ: Êâæ‰∏çÂà∞Áé©ÂÆ∂ ID ${playerId}`;
            return false;
        }
           
        player.x = x;
        player.y = y;
        
        // ÂπøÊí≠
        broadcast({
            type: 'player-teleport',
            playerId: playerId,
            x: x,
            y: y
        });
        
        drawMultiplayerMaze();
        updatePlayerList();
        
        // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
        if (x === gameState.multiplayer.exit.x && y === gameState.multiplayer.exit.y) {
            player.reachedExit = true;
            
            // ÂπøÊí≠Âà∞ËææÂá∫Âè£
            broadcast({
                type: 'player-reached-exit',
                playerId: playerId
            });
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÁé©ÂÆ∂ÈÉΩÂà∞ËææÂá∫Âè£
            checkAllPlayersReachedExit();
        }
    }
    
    return true;
}

// =============== ‰ΩçÁΩÆÈ™åËØÅ ===============
function isValidPosition(x, y) {
    let maze;
    
    if (gameState.currentScreen === 'singlePlayerGame') {
        maze = singlePlayerGame.maze;
    } else if (gameState.currentScreen === 'multiplayerGame') {
        maze = gameState.multiplayer.maze;
    } else {
        return false;
    }
    
    // Ê£ÄÊü•Ëø∑ÂÆ´ÊòØÂê¶ÊúâÊïà
    if (!maze || maze.length === 0) {
        return false;
    }
    
    // Ê£ÄÊü•ÂùêÊ†áÊòØÂê¶Âú®Ëø∑ÂÆ´ËåÉÂõ¥ÂÜÖ
    if (x < 0 || x >= maze[0].length || y < 0 || y >= maze.length) {
        return false;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ¢ô
    if (maze[y][x] === 1) {
        return false;
    }
    
    return true;
}

        // =============== Âçï‰∫∫Ê∏∏ÊàèÈÄªËæë ===============

        function generateLevelButtons() {
            const container = document.getElementById('levelContainer');
            container.innerHTML = '';
            container.style.touchAction = 'pan-y'; // Á°Æ‰øùËß¶Êë∏Ë°å‰∏∫‰ºòÂåñ
            
            // Ê∑ªÂä†"Êé•ÁùÄÁé©ÂÖ≥Âç°X"ÊåâÈíÆ
            const saveData = findLatestSave();
            if (saveData) {
                const continueButton = document.createElement('button');
                continueButton.className = 'level-button continue';
                continueButton.textContent = `Êé•ÁùÄÁé©ÂÖ≥Âç° ${saveData.currentLevel}`;
                continueButton.onclick = () => {
                    loadGame();
                    showScreen('singlePlayerGame');
                };
                container.appendChild(continueButton);
            }
            // Ê∑ªÂä†"Êñ∞ÂÖ≥Âç°"ÊåâÈíÆÔºåËÆ©Áî®Êà∑Ëá™Â∑±Ê∑ªÂä†ÂÖ≥Âç°
            const newLevelButton = document.createElement('button');
            newLevelButton.className = 'level-button new-level';
            newLevelButton.textContent = 'Êñ∞ÂÖ≥Âç°';
            newLevelButton.onclick = () => {
                // ‰ΩøÁî®ÂΩìÂâçÊúÄÂ§ßÂÖ≥Âç°Êï∞+1‰Ωú‰∏∫Êñ∞ÂÖ≥Âç°
                const currentLevels = Math.max(1, ...gameState.completedLevels, gameState.unlockedLevel);
                gameState.currentLevel = currentLevels;
                showScreen('singlePlayerGame');
            };
            container.appendChild(newLevelButton);
            
            // ÊòæÁ§∫Â∑≤ÂÆåÊàêÁöÑÂÖ≥Âç°ÂéÜÂè≤ËÆ∞ÂΩïÔºàÂ¶ÇÊûúÊúâÔºâ
            if (gameState.completedLevels.length > 0) {
                const historyDiv = document.createElement('div');
                historyDiv.className = 'level-history';
                historyDiv.innerHTML = '<h3>Â∑≤ÂÆåÊàêÂÖ≥Âç°</h3>';
                
                // ÊéíÂ∫èÂπ∂ÊòæÁ§∫Â∑≤ÂÆåÊàêÁöÑÂÖ≥Âç°
                [...gameState.completedLevels].sort((a, b) => a - b).forEach(level => {
                    const levelButton = document.createElement('button');
                    levelButton.className = 'level-button completed';
                    levelButton.textContent = level;
                    levelButton.onclick = () => {
                        gameState.currentLevel = level;
                        showScreen('singlePlayerGame');
                    };
                    historyDiv.appendChild(levelButton);
                });
                
                container.appendChild(historyDiv);
            }
        }
        
        // ÊâæÂà∞ÊúÄËøëÁöÑÂ≠òÊ°£
        function findLatestSave() {
            let latestSave = null;
            let latestTime = 0;
            
            for (let i = 0; i < gameState.saveSlots.length; i++) {
                const save = gameState.saveSlots[i];
                if (save && save.timestamp && save.currentLevel) {
                    const saveTime = new Date(save.timestamp).getTime();
                    if (saveTime > latestTime) {
                        latestTime = saveTime;
                        latestSave = save;
                    }
                }
            }
            
            return latestSave;
        }

function initSinglePlayerGame(isLoadingSave = false) {
    window.removeEventListener('keydown', handleSinglePlayerKeyDown);
    singlePlayerGame.canvas = document.getElementById('singlePlayerCanvas');
    singlePlayerGame.ctx = singlePlayerGame.canvas.getContext('2d');
    singlePlayerGame.movingEnemies = [];
    singlePlayerGame.isUnlocking = false;
    singlePlayerGame.unlockTimeLeft = 10;
    clearInterval(singlePlayerGame.unlockTimer);
    
    // ÈáçÁΩÆË∑ØÂæÑÊèêÁ§∫Áä∂ÊÄÅ
    gameState.showPathHint = false;
    if (gameState.pathHintTimer) {
        clearTimeout(gameState.pathHintTimer);
        gameState.pathHintTimer = null;
    }
    
    if (!isLoadingSave) {
        singlePlayerGame.moveCount = 0;
        singlePlayerGame.doorPosition = null;
        singlePlayerGame.keyPosition = null;
        singlePlayerGame.hasKey = false;
        singlePlayerGame.coinsCollected = 0;
        singlePlayerGame.trapHits = 0;
        const difficulty = Math.min(
            Math.floor(gameState.currentLevel / 7), 
            singlePlayerGame.difficultySettings.length - 1
        );
        const settings = singlePlayerGame.difficultySettings[difficulty];
        singlePlayerGame.maze = generateDifficultMaze(gameState.currentLevel, settings);
        singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
        singlePlayerGame.hasKey = false;
    } else {
        if (!singlePlayerGame.coinsCollected) singlePlayerGame.coinsCollected = 0;
        if (!singlePlayerGame.trapHits) singlePlayerGame.trapHits = 0;
    }
    if (!window.EventSystemInitialized) {
        EventSystem.init();
        window.EventSystemInitialized = true;
    }
    document.getElementById('regularNextButton').style.display = 'none';
    document.getElementById('unsolvableNextButton').style.display = 'none';
    document.getElementById('levelDisplay').textContent = `ÂÖ≥Âç°: ${gameState.currentLevel}`;
    document.getElementById('moveCount').textContent = `ÁßªÂä®: ${singlePlayerGame.moveCount}`;
    document.getElementById('keyStatus').textContent = `Èí•Âåô: ${singlePlayerGame.hasKey ? 'Â∑≤Ëé∑Âæó' : 'Êú™Ëé∑Âæó'}`;
    
    // Âú®ÊØèÊó•ÊåëÊàòÊ®°Âºè‰∏ãÊòæÁ§∫ÈáëÂ∏Å‰ø°ÊÅØ
    if (gameState.currentChallenge === 'daily') {
        document.getElementById('coinDisplay').style.display = 'flex';
        document.getElementById('coinDisplay').textContent = `ÈáëÂ∏Å: ${singlePlayerGame.coinsCollected || 0}`;
    } else {
        document.getElementById('coinDisplay').style.display = 'none';
    }
    
    // ÈáçÁΩÆÂä†ËΩΩÂ≠òÊ°£Ê†áÂøó
    gameState.isLoadingSave = false;
    
    // ÈöêËóèÁâπÊÆäÂÖÉÁ¥†ÊèêÁ§∫
    document.getElementById('keyInfo').classList.add('hidden');
    document.getElementById('unlockTimer').classList.add('hidden');
    document.getElementById('enemyInfo').classList.add('hidden');
    
    // ÂêØÂä®Ëá™Âä®‰øùÂ≠ò
    startAutoSave();
    
    // Ê†πÊçÆÂÖ≥Âç°ÈöæÂ∫¶ËÆæÁΩÆÁîüÊàêËø∑ÂÆ´
    const difficulty = Math.min(
        Math.floor(gameState.currentLevel / 7), 
        singlePlayerGame.difficultySettings.length - 1
    );
    const settings = singlePlayerGame.difficultySettings[difficulty];
    if (gameState.autoSave) {
        loadGame(); // Â∞ùËØïÂä†ËΩΩ‰∏äÊ¨°ÁöÑÂ≠òÊ°£
    }
    // ÁîüÊàêÊ†áÂáÜËø∑ÂÆ´
    else if (gameState.specialLevels.includes(gameState.currentLevel)) {
        singlePlayerGame.maze = generateSpiralMaze(settings.size);
        // ËÆæÁΩÆËµ∑ÁÇπÂíåÁªàÁÇπ
        const size = settings.size;
        singlePlayerGame.player = { x: 1, y: size - 2 };
        singlePlayerGame.exit = { x: Math.floor(size/2), y: Math.floor(size/2) };
        // Ê∑ªÂä†ÁßªÂä®Êïå‰∫∫
        addMovingEnemies(settings.size, gameState.currentLevel === 60 ? 5 : 3);
        // ÊòæÁ§∫Êïå‰∫∫Ë≠¶Âëä
        document.getElementById('enemyInfo').classList.remove('hidden');
        
        // Ê∑ªÂä†Èí•ÂåôÂíåÈó®
        addKeyAndDoor(size);
        document.getElementById('keyInfo').classList.remove('hidden');
    } 
    else {
        singlePlayerGame.maze = generateDifficultMaze(gameState.currentLevel, settings);
    }
    
    // ËÆæÁΩÆÁé©ÂÆ∂ÂíåÂá∫Âè£‰ΩçÁΩÆÔºàÈùûÁâπÊÆäÂÖ≥Âç°Ôºâ
    if (!gameState.specialLevels.includes(gameState.currentLevel)) {
        singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
        singlePlayerGame.exit = findExitPosition(singlePlayerGame.maze);
    }
    
    // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
    resizeSinglePlayerCanvas();
    
    // ÂºÄÂßãÊ∏∏Êàè
    startSinglePlayerTimer();
    drawSinglePlayerMaze();
    
    // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
    window.addEventListener('keydown', handleSinglePlayerKeyDown);
    
    // ÂêØÂä®ÁßªÂä®Èô∑Èò±
    if (settings.movingTraps > 0 || 
        gameState.specialLevels.includes(gameState.currentLevel)) {
        startMovingTraps();
    }
    updateNextLevelButtons();
    // Â∫îÁî®UIËÆæÁΩÆ
    applyUISettings();
    if (gameState.specialLevels.includes(gameState.currentLevel)) {
        document.getElementById('enemyInfo').classList.remove('hidden');
    }
}
class GameRecorder {
    constructor() {
        this.frames = [];
        this.startTime = 0;
        this.isRecording = false;
    }

    startRecording(canvas) {
        this.frames = [];
        this.startTime = Date.now();
        this.isRecording = true;
        
        // ‰ΩøÁî®requestAnimationFrameÊçïËé∑ÁîªÈù¢
        const captureFrame = () => {
            if(!this.isRecording) return;
            this.frames.push({
                timestamp: Date.now() - this.startTime,
                imageData: canvas.toDataURL('image/webp', 0.8)
            });
            requestAnimationFrame(captureFrame);
        };
        captureFrame();
    }
    static getAllRecords() {
        return JSON.parse(localStorage.getItem('gameRecords') || "[]")
            .map((record, index) => ({ ...record, id: index }))
            .sort((a,b) => new Date(b.metadata.timestamp) - new Date(a.metadata.timestamp));
    }
    static deleteRecord(id) {
        const records = this.getAllRecords();
        const newRecords = records.filter(r => r.id !== id);
        localStorage.setItem('gameRecords', JSON.stringify(newRecords));
    }
    static getStorageUsage() {
        const records = this.getAllRecords();
        const used = JSON.stringify(records).length / (1024 * 1024);
        const max = parseInt(localStorage.getItem('maxRecordStorage') || "300");
        return { used: used.toFixed(1), max, percent: (used/max*100).toFixed(1) };
    }
    stopRecording() {
        this.isRecording = false;
        this.saveToLocalStorage();
    }

    saveToLocalStorage() {
        const recordData = {
            version: 1.0,
            metadata: {
                level: gameState.currentLevel,
                timestamp: new Date().toISOString(),
                duration: Date.now() - this.startTime,
                playerName: gameState.playerName
            },
            frames: this.frames
        };
        
        // Â≠òÂÇ®ÁÆ°ÁêÜ
        const records = JSON.parse(localStorage.getItem('gameRecords') || "[]");
        records.push(recordData);
        
        // Ëá™Âä®Ê∏ÖÁêÜÊóßÂΩïÂÉè
        let totalSize = 0;
        const cleanRecords = records.reverse().filter(record => {
            totalSize += JSON.stringify(record).length;
            return totalSize < document.getElementById('maxStorage').value * 1024 * 1024;
        }).reverse();
        
        localStorage.setItem('gameRecords', JSON.stringify(cleanRecords));
    }

    replay(recordId) {
        const record = JSON.parse(localStorage.getItem('gameRecords'))[recordId];
        const replayCanvas = document.createElement('canvas');
        // ÂÆûÁé∞ÂõûÊîæÈÄªËæë...
    }
}
class ReplayPlayer {
    constructor() {
        this.currentFrame = 0;
        this.isPlaying = false;
        this.playbackSpeed = 1;
        this.animationFrame = null;
    }
    load(replayData) {
        this.replayData = replayData;
        this.canvas = document.getElementById('replayCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = replayData.metadata.width || 800;
        this.canvas.height = replayData.metadata.height || 600;
        
        document.getElementById('replayTitle').textContent = 
            `ÂÖ≥Âç°${replayData.metadata.level} - ${new Date(replayData.metadata.timestamp).toLocaleString()}`;
        
        this.showFrame(0);
    }
    showFrame(index) {
        this.currentFrame = Math.max(0, Math.min(index, this.replayData.frames.length-1));
        const frame = this.replayData.frames[this.currentFrame];
        
        const img = new Image();
        img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0);
            this.updateProgress();
        };
        img.src = frame.imageData;
    }
    play() {
        if(this.isPlaying) return;
        this.isPlaying = true;
        document.getElementById('playBtn').textContent = '‚è∏Ô∏è ÊöÇÂÅú';
        
        const startTime = Date.now() - (this.currentFrame * 1000 / this.playbackSpeed);
        
        const playLoop = () => {
            if(!this.isPlaying) return;
            
            const elapsed = (Date.now() - startTime) * this.playbackSpeed;
            const targetFrame = Math.floor(elapsed / 1000 * 60); // ÂÅáËÆæ60fps
            
            if(targetFrame < this.replayData.frames.length) {
                this.showFrame(targetFrame);
                this.animationFrame = requestAnimationFrame(playLoop);
            } else {
                this.stop();
            }
        };
        
        playLoop();
    }
    stop() {
        this.isPlaying = false;
        cancelAnimationFrame(this.animationFrame);
        document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Êí≠Êîæ';
    }
    updateProgress() {
        const progress = (this.currentFrame / this.replayData.frames.length) * 100;
        document.getElementById('replayProgress').value = progress;
        
        const currentTime = (this.currentFrame / 60).toFixed(1);
        const totalTime = (this.replayData.frames.length / 60).toFixed(1);
        document.getElementById('timeDisplay').textContent = 
            `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
    }
}
// ÂÖ®Â±ÄÊí≠ÊîæÂô®ÂÆû‰æã
const replayPlayer = new ReplayPlayer();
// ÊâìÂºÄÂõûÊîæÁïåÈù¢
function showReplayModal() {
    document.getElementById('replayModal').classList.remove('hidden');
    renderReplayList();
    updateStorageInfo();
}
function closeReplayModal() {
    document.getElementById('replayModal').classList.add('hidden');
    replayPlayer.stop();
}
function renderReplayList(filter = 'all') {
    const listEl = document.getElementById('replayList');
    listEl.innerHTML = '';
    
    const records = GameRecorder.getAllRecords();
    
    // Â∫îÁî®Á≠õÈÄâ
    const filteredRecords = filter === 'recent' 
        ? records.filter(r => new Date(r.metadata.timestamp) > Date.now() - 7*86400000)
        : records;
    
    if(filteredRecords.length === 0) {
        listEl.innerHTML = '<div class="no-records">ÊöÇÊó†ÂΩïÂÉèËÆ∞ÂΩï</div>';
        return;
    }
    
    filteredRecords.forEach(record => {
        const item = document.createElement('div');
        item.className = 'replay-item';
        item.innerHTML = `
            <div class="replay-meta">
                <strong>ÂÖ≥Âç° ${record.metadata.level}</strong>
                <span>${new Date(record.metadata.timestamp).toLocaleString()}</span>
            </div>
            <div>
                Êó∂ÈïøÔºö${formatTime(record.metadata.duration/1000)} | 
                Áé©ÂÆ∂Ôºö${record.metadata.playerName || 'ÂåøÂêç'}
            </div>
            <div class="replay-actions">
                <button onclick="playReplay(${record.id})">Êí≠Êîæ</button>
                <button onclick="deleteReplay(${record.id})">Âà†Èô§</button>
            </div>
        `;
        listEl.appendChild(item);
    });
}
function playReplay(id) {
    const records = GameRecorder.getAllRecords();
    const record = records.find(r => r.id === id);
    if(!record) return;
    
    document.getElementById('replayList').classList.add('hidden');
    document.getElementById('playerContainer').classList.remove('hidden');
    
    replayPlayer.load(record);
}
function exitPlayer() {
    replayPlayer.stop();
    document.getElementById('replayList').classList.remove('hidden');
    document.getElementById('playerContainer').classList.add('hidden');
}
function togglePlay() {
    if(replayPlayer.isPlaying) {
        replayPlayer.stop();
    } else {
        replayPlayer.play();
    }
}
function seekForward() {
    replayPlayer.showFrame(replayPlayer.currentFrame + 5*60); // ÂâçËøõ5Áßí(ÂÅáËÆæ60fps)
}
function seekBack() {
    replayPlayer.showFrame(replayPlayer.currentFrame - 5*60); // ÂêéÈÄÄ5Áßí
}
function deleteReplay(id) {
    if(confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ÂΩïÂÉèÂêóÔºü')) {
        GameRecorder.deleteRecord(id);
        renderReplayList(document.getElementById('replayFilter').value);
        updateStorageInfo();
    }
}
function updateStorageInfo() {
    const usage = GameRecorder.getStorageUsage();
    document.getElementById('storageInfo').textContent = 
        `Â∑≤‰ΩøÁî®Ôºö${usage.used}MB/${usage.max}MB (${usage.percent}%)`;
}
// Â∑•ÂÖ∑ÂáΩÊï∞
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
// Âú®ÂÖ≥Âç°ÁîüÊàêÈÄªËæë‰∏≠Ê∑ªÂä†
function generateMovingPlatforms(level) {
    const platformCount = Math.min(Math.floor(level/5), 5);
    singlePlayerGame.movingPlatforms = [];
    
    for(let i=0; i<platformCount; i++) {
        singlePlayerGame.movingPlatforms.push({
            id: i,
            x: Math.floor(Math.random() * (mazeWidth-4)) + 2,
            y: Math.floor(Math.random() * (mazeHeight-4)) + 2,
            path: generatePlatformPath(),
            speed: 0.5 + Math.random(),
            passengers: []
        });
    }
}

function generatePlatformPath() {
    // ÁîüÊàêÁßªÂä®Ë∑ØÂæÑÔºöÁõ¥Á∫ø/ÊñπÂΩ¢/ÂúÜÂΩ¢
    const pathType = Math.floor(Math.random() * 3);
    const centerX = Math.floor(Math.random() * mazeWidth);
    const centerY = Math.floor(Math.random() * mazeHeight);
    
    switch(pathType) {
        case 0: // Ê∞¥Âπ≥
            return { type: 'horizontal', start: centerX-3, end: centerX+3, y: centerY };
        case 1: // Á´ñÁõ¥
            return { type: 'vertical', start: centerY-3, end: centerY+3, x: centerX };
        case 2: // ÂúÜÂΩ¢
            return { type: 'circular', centerX, centerY, radius: 2 };
    }
}
// Âú®drawSinglePlayerMaze‰∏≠Ê∑ªÂä†
function drawMovingPlatforms() {
    const ctx = singlePlayerGame.ctx;
    singlePlayerGame.movingPlatforms.forEach(platform => {
        // Êõ¥Êñ∞‰ΩçÁΩÆ
        updatePlatformPosition(platform);
        
        // ÁªòÂà∂Âπ≥Âè∞
        ctx.fillStyle = '#8BC34A';
        ctx.fillRect(
            platform.x * singlePlayerGame.cellSize,
            platform.y * singlePlayerGame.cellSize,
            singlePlayerGame.cellSize * 2,
            singlePlayerGame.cellSize
        );
        
        // Ê£ÄÊµãÁé©ÂÆ∂Á¢∞Êíû
        checkPlayerOnPlatform(platform);
    });
}

function updatePlatformPosition(platform) {
    switch(platform.path.type) {
        case 'horizontal':
            platform.x += platform.speed * (platform.movingForward ? 1 : -1);
            if(platform.x > platform.path.end) platform.movingForward = false;
            if(platform.x < platform.path.start) platform.movingForward = true;
            break;
        case 'vertical':
            platform.y += platform.speed * (platform.movingForward ? 1 : -1);
            if(platform.y > platform.path.end) platform.movingForward = false;
            if(platform.y < platform.path.start) platform.movingForward = true;
            break;
        case 'circular':
            const angle = Date.now()/1000 * platform.speed;
            platform.x = platform.path.centerX + Math.cos(angle) * platform.path.radius;
            platform.y = platform.path.centerY + Math.sin(angle) * platform.path.radius;
            break;
    }
}


        // Ê∑ªÂä†Èí•ÂåôÂíåÈó®ÔºàÁî®‰∫éÁâπÊÆäÂÖ≥Âç°Ôºâ
        function addKeyAndDoor(size) {
            // ÈöèÊú∫ÊîæÁΩÆÈí•ÂåôÔºàÈÅøÂºÄËµ∑ÁÇπÂíåÁªàÁÇπÔºâ
            let keyX, keyY;
            do {
                keyX = Math.floor(Math.random() * (size - 4)) + 2;
                keyY = Math.floor(Math.random() * (size - 4)) + 2;
            } while (singlePlayerGame.maze[keyY][keyX] === 1 || 
                     (keyX === 1 && keyY === size - 2) || 
                     (keyX === Math.floor(size/2) && keyY === Math.floor(size/2)));
            
            // Âú®Èí•Âåô‰ΩçÁΩÆÊîæÁΩÆÈí•ÂåôÔºàÂÖÉÁ¥†ÂÄº8Ôºâ
            singlePlayerGame.maze[keyY][keyX] = 8;
            singlePlayerGame.keyPosition = {x: keyX, y: keyY};
            
            // Âú®Âá∫Âè£ÂâçÊîæÁΩÆÈó®ÔºàÂÖÉÁ¥†ÂÄº9Ôºâ
            let doorX = singlePlayerGame.exit.x;
            let doorY = singlePlayerGame.exit.y;
            
            // Á°ÆÂÆöÈó®ÁöÑ‰ΩçÁΩÆÔºàÂú®Âá∫Âè£ÊóÅËæπÔºâ
            if (doorX < size-1 && singlePlayerGame.maze[doorY][doorX+1] === 0) {
                doorX++;
            } else if (doorX > 0 && singlePlayerGame.maze[doorY][doorX-1] === 0) {
                doorX--;
            } else if (doorY < size-1 && singlePlayerGame.maze[doorY+1][doorX] === 0) {
                doorY++;
            } else if (doorY > 0 && singlePlayerGame.maze[doorY-1][doorX] === 0) {
                doorY--;
            }
            
            singlePlayerGame.maze[doorY][doorX] = 9;
            singlePlayerGame.doorPosition = {x: doorX, y: doorY};
        }

        // ÁîüÊàêËû∫ÊóãËø∑ÂÆ´ÔºàÁî®‰∫éÁ¨¨30Âíå60ÂÖ≥Ôºâ
        function generateSpiralMaze(size) {
            // Á°Æ‰øùÂ•áÊï∞Â∞∫ÂØ∏
            if (size % 2 === 0) size++;
            
            const maze = Array(size).fill().map(() => Array(size).fill(1));
            
            // ÂàõÂª∫Ëû∫ÊóãË∑ØÂæÑ
            let x = 0, y = 0;
            let dx = 0, dy = 1;
            let steps = size - 1;
            let currentSteps = 0;
            let stepCount = 0;
            let turnCount = 0;
            
            for (let i = 0; i < size * size; i++) {
                maze[y][x] = 0;
                
                // Ê£ÄÊü•ÊòØÂê¶Âà∞Ëææ‰∏≠ÂøÉ
                if (steps <= 0) break;
                
                currentSteps++;
                if (currentSteps === steps) {
                    currentSteps = 0;
                    turnCount++;
                    
                    // ÊØè‰∏§Ê¨°ËΩ¨ÂêëÂáèÂ∞ëÊ≠•Èïø
                    if (turnCount % 2 === 0) {
                        steps--;
                    }
                    
                    // ËΩ¨Âêë
                    const temp = dx;
                    dx = dy;
                    dy = -temp;
                }
                
                x += dx;
                y += dy;
            }
            
            // Á°Æ‰øùÂá∫Âè£Âú®‰∏≠ÂøÉ
            const center = Math.floor(size / 2);
            maze[center][center] = 0;
            
            // Á°Æ‰øùËµ∑ÁÇπÂú®Â∑¶‰∏ãËßí
            maze[size - 2][1] = 0;
            
            return maze;
        }
        
        // Ê∑ªÂä†ÁßªÂä®Êïå‰∫∫ÔºàÁî®‰∫éËû∫ÊóãÂÖ≥Âç°Ôºâ
        function addMovingEnemies(size, count) {
            singlePlayerGame.movingEnemies = [];
            
            for (let i = 0; i < count; i++) {
                // ÈöèÊú∫‰ΩçÁΩÆÔºàÈÅøÂºÄËµ∑ÁÇπÂíåÁªàÁÇπÔºâ
                let x, y;
                do {
                    x = Math.floor(Math.random() * (size - 4)) + 2;
                    y = Math.floor(Math.random() * (size - 4)) + 2;
                } while (singlePlayerGame.maze[y][x] === 1 || 
                         (x === 1 && y === size - 2) || 
                         (x === Math.floor(size/2) && y === Math.floor(size/2)));
                
                singlePlayerGame.movingEnemies.push({
                    x, y,
                    dx: Math.random() > 0.5 ? 1 : -1,
                    dy: Math.random() > 0.5 ? 1 : -1,
                    speed: 0.3 + Math.random() * 0.4,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    lastMove: 0
                });
            }
        }

        // È™åËØÅËø∑ÂÆ´ÊòØÂê¶ÊúâËß£
        function validateMaze(maze) {
            // ÂàõÂª∫ËÆøÈóÆÊ†áËÆ∞Êï∞ÁªÑ
            const visited = Array(maze.length).fill().map(() => Array(maze[0].length).fill(false));
            const queue = [{x: 1, y: 1}];
            visited[1][1] = true;
            
            const exit = findExitPosition(maze);
            
            while (queue.length > 0) {
                const cell = queue.shift();
                
                // Â¶ÇÊûúÂà∞ËææÂá∫Âè£ÔºåËøîÂõûtrue
                if (cell.x === exit.x && cell.y === exit.y) {
                    return true;
                }
                
                // Ê£ÄÊü•ÊâÄÊúâÊñπÂêë
                const directions = [
                    {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
                    {dx: 0, dy: 1}, {dx: 0, dy: -1}
                ];
                
                for (const dir of directions) {
                    const nx = cell.x + dir.dx;
                    const ny = cell.y + dir.dy;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Âú®ËæπÁïåÂÜÖ
                    if (nx >= 0 && nx < maze[0].length && ny >= 0 && ny < maze.length) {
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ¢ôÊàñÊú™Ë¢´ËÆøÈóÆ
                        if (maze[ny][nx] !== 1 && !visited[ny][nx]) {
                            visited[ny][nx] = true;
                            queue.push({x: nx, y: ny});
                        }
                    }
                }
            }
            
            return false;
        }
        
        // Â∞ÜvalidateMaze„ÄÅfindExitPositionÂíåfindCriticalPathÂ§çÂà∂Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æõÂ§ö‰∫∫Ê∏∏Êàè‰ΩøÁî®
        window.validateMaze = validateMaze;
        window.findExitPosition = findExitPosition;
        window.findCriticalPath = findCriticalPath;
        
        // Â§áÁî®Ëø∑ÂÆ´ÁîüÊàêÔºàÁ°Æ‰øùÊúâËß£Ôºâ
        function generateBackupMaze(size) {
            const maze = Array(size).fill().map(() => Array(size).fill(1));
            
            // ÂàõÂª∫‰∏ÄÊù°‰ªéËµ∑ÁÇπÂà∞ÁªàÁÇπÁöÑË∑ØÂæÑ
            for (let y = 1; y < size - 1; y++) {
                for (let x = 1; x < size - 1; x++) {
                    // ÂàõÂª∫ÂçÅÂ≠ó‰∫§ÂèâË∑ØÂæÑ
                    if (x === Math.floor(size/2) || y === Math.floor(size/2)) {
                        maze[y][x] = 0;
                    }
                }
            }
            
            // Á°Æ‰øùËµ∑ÁÇπÂíåÁªàÁÇπ
            maze[1][1] = 0;
            maze[size-2][size-1] = 0;
            
            return maze;
        }

function generateDifficultMaze(level, settings) {
    const size = settings.size;
    const seed = level;
    const random = new Random(seed);
    
    // ÂàõÂª∫Ëø∑ÂÆ´ (1=Â¢ô, 0=Ë∑Ø, 2=Èô∑Èò±, 3=‰º†ÈÄÅÈó®, 4=ÁßªÂä®Èô∑Èò±, 5=ÂçïÂêëÈÄöÈÅì, 8=Èí•Âåô, 9=Èó®)
    const maze = Array(size).fill().map(() => Array(size).fill(1));
    
    // ‰ΩøÁî®ÊîπËøõÁöÑÈöèÊú∫PrimÁÆóÊ≥ïÁîüÊàêËø∑ÂÆ´
    const walls = [];
    maze[1][1] = 0;
    walls.push(...getCellWalls(1, 1, maze));
    
    while (walls.length > 0) {
        const wallIndex = Math.floor(random.next() * walls.length);
        const wall = walls[wallIndex];
        walls.splice(wallIndex, 1);
        
        const opposite = getOppositeCell(wall, maze);
        
        if (opposite.x > 0 && opposite.x < size-1 && 
            opposite.y > 0 && opposite.y < size-1 && 
            maze[opposite.y][opposite.x] === 1) {
            
            maze[wall.y][wall.x] = 0;
            maze[opposite.y][opposite.x] = 0;
            walls.push(...getCellWalls(opposite.x, opposite.y, maze));
        }
    }
    
    // Á°Æ‰øùÂá∫Âè£ÂèØËææ
    ensureExitPath(maze, random);
    
    // Ê∑ªÂä†Èô∑Èò±ÔºàÈÅøÂºÄÂÖ≥ÈîÆË∑ØÂæÑÔºâ
    const criticalPath = findCriticalPath(maze);
    for (let i = 0; i < settings.traps; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(random.next() * (size-2)) + 1;
            y = Math.floor(random.next() * (size-2)) + 1;
            attempts++;
        } while ((maze[y][x] !== 0 || criticalPath.some(p => p.x === x && p.y === y)) && attempts < 50);
        
        if (attempts < 50) {
            maze[y][x] = 2;
        }
    }
    
    // Ê∑ªÂä†‰º†ÈÄÅÈó®
    if (level > 10) {
        addTeleporters(maze, random, Math.min(4, Math.floor(level/10)));
    }
    
    // Ê∑ªÂä†ÁßªÂä®Èô∑Èò±
    singlePlayerGame.movingTraps = [];
    for (let i = 0; i < settings.movingTraps; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(random.next() * (size-2)) + 1;
            y = Math.floor(random.next() * (size-2)) + 1;
            attempts++;
        } while ((maze[y][x] !== 0 || criticalPath.some(p => p.x === x && p.y === y)) && attempts < 50);
        
        if (attempts < 50) {
            maze[y][x] = 4;
            singlePlayerGame.movingTraps.push({
                x, y, 
                dx: Math.random() > 0.5 ? 1 : -1,
                dy: Math.random() > 0.5 ? 1 : -1,
                speed: 0.5 + Math.random() * 0.5
            });
        }
    }
    
    // Ê∑ªÂä†ÂçïÂêëÈÄöÈÅì
    for (let i = 0; i < settings.oneWayPaths; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(random.next() * (size-2)) + 1;
            y = Math.floor(random.next() * (size-2)) + 1;
            attempts++;
        } while ((maze[y][x] !== 0 || criticalPath.some(p => p.x === x && p.y === y)) && attempts < 50);
        
        if (attempts < 50) {
            // 5Ë°®Á§∫ÂçïÂêëÈÄöÈÅì (1=Âè≥, 2=Â∑¶, 3=‰∏ã, 4=‰∏ä)
            maze[y][x] = 50 + Math.floor(random.next() * 4) + 1;
        }
    }
    
    // Ê∑ªÂä†ÈáëÂ∏Å (10=ÈáëÂ∏Å)
    const coinCount = Math.max(1, Math.floor(size / 3)); // Ê†πÊçÆËø∑ÂÆ´Â§ßÂ∞èËÆæÁΩÆÈáëÂ∏ÅÊï∞Èáè
    for (let i = 0; i < coinCount; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(random.next() * (size-2)) + 1;
            y = Math.floor(random.next() * (size-2)) + 1;
            attempts++;
        } while ((maze[y][x] !== 0 || criticalPath.some(p => p.x === x && p.y === y)) && attempts < 50);
        
        if (attempts < 50) {
            maze[y][x] = 10; // 10Ë°®Á§∫ÈáëÂ∏Å
        }
    }
    
    // Áî®Êà∑Ëá™ÂÆö‰πâÂÖ≥Âç°Á≥ªÁªüÔºåÊâÄÊúâÂÖ≥Âç°ÈÉΩÊòØÂèØËß£ÁöÑ
    
    return maze;
    
    // ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÂçïÂÖÉÊ†ºÁöÑÂ¢ô
    function getCellWalls(x, y, maze) {
        const walls = [];
        const directions = [
            {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
            {dx: 0, dy: 1}, {dx: 0, dy: -1}
        ];
        
        for (const dir of directions) {
            const nx = x + dir.dx;
            const ny = y + dir.dy;
            
            if (nx >= 0 && nx < maze[0].length && 
                ny >= 0 && ny < maze.length && 
                maze[ny][nx] === 1) {
                walls.push({x: nx, y: ny});
            }
        }
        
        return walls;
    }
    
    // ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÂØπÈù¢ÁöÑÂçïÂÖÉÊ†º
    function getOppositeCell(wall, maze) {
        const directions = [
            {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
            {dx: 0, dy: 1}, {dx: 0, dy: -1}
        ];
        
        for (const dir of directions) {
            const nx = wall.x + dir.dx;
            const ny = wall.y + dir.dy;
            
            if (nx >= 0 && nx < maze[0].length && 
                ny >= 0 && ny < maze.length && 
                maze[ny][nx] === 0) {
                return {x: wall.x - dir.dx, y: wall.y - dir.dy};
            }
        }
        
        return {x: -1, y: -1};
    }
}
        
        // ÊâæÂà∞ÂÖ≥ÈîÆË∑ØÂæÑÔºà‰ªéËµ∑ÁÇπÂà∞ÁªàÁÇπÁöÑÊúÄÁü≠Ë∑ØÂæÑÔºâ
        function findCriticalPath(maze) {
            const start = {x: 1, y: 1};
            const exit = findExitPosition(maze);
            
            // BFSÂØªÊâæÊúÄÁü≠Ë∑ØÂæÑ
            const visited = Array(maze.length).fill().map(() => Array(maze[0].length).fill(false));
            const queue = [{...start, path: []}];
            visited[start.y][start.x] = true;
            
            while (queue.length > 0) {
                const cell = queue.shift();
                const newPath = [...cell.path, {x: cell.x, y: cell.y}];
                
                if (cell.x === exit.x && cell.y === exit.y) {
                    return newPath;
                }
                
                const directions = [
                    {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
                    {dx: 0, dy: 1}, {dx: 0, dy: -1}
                ];
                
                for (const dir of directions) {
                    const nx = cell.x + dir.dx;
                    const ny = cell.y + dir.dy;
                    
                    if (nx >= 0 && nx < maze[0].length && 
                        ny >= 0 && ny < maze.length && 
                        !visited[ny][nx] && maze[ny][nx] !== 1) {
                        visited[ny][nx] = true;
                        queue.push({x: nx, y: ny, path: newPath});
                    }
                }
            }
            
            return [];
        }
        
        function ensureExitPath(maze, random) {
            const size = maze.length;
            const exit = findExitPosition(maze);
            
            // ‰ΩøÁî®BFSÁ°Æ‰øùËµ∑ÁÇπÂà∞Âá∫Âè£ÊúâË∑ØÂæÑ
            const visited = Array(size).fill().map(() => Array(size).fill(false));
            const queue = [{x: 1, y: 1}];
            visited[1][1] = true;
            
            let found = false;
            
            while (queue.length > 0) {
                const cell = queue.shift();
                
                if (cell.x === exit.x && cell.y === exit.y) {
                    found = true;
                    break;
                }
                
                const directions = [
                    {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
                    {dx: 0, dy: 1}, {dx: 0, dy: -1}
                ];
                
                for (const dir of directions) {
                    const nx = cell.x + dir.dx;
                    const ny = cell.y + dir.dy;
                    
                    if (nx >= 0 && nx < size && ny >= 0 && ny < size && 
                        !visited[ny][nx] && maze[ny][nx] !== 1) {
                        visited[ny][nx] = true;
                        queue.push({x: nx, y: ny});
                    }
                }
            }
            
            // Â¶ÇÊûúË∑ØÂæÑ‰∏çÂ≠òÂú®ÔºåÊâìÂºÄ‰∏ÄÊù°Ë∑ØÂæÑ
            if (!found) {
                let x = 1, y = 1;
                while (x !== exit.x || y !== exit.y) {
                    if (x < exit.x) x++;
                    else if (x > exit.x) x--;
                    else if (y < exit.y) y++;
                    else if (y > exit.y) y--;
                    
                    maze[y][x] = 0;
                }
            }
        }
        
        function addTeleporters(maze, random, count) {
            const size = maze.length;
            singlePlayerGame.teleporters = [];
            
            for (let i = 0; i < count * 2; i++) {
                let x, y;
                do {
                    x = Math.floor(random.next() * (size-2)) + 1;
                    y = Math.floor(random.next() * (size-2)) + 1;
                } while (maze[y][x] !== 0 || singlePlayerGame.teleporters.some(t => t.x === x && t.y === y));
                
                maze[y][x] = 3;
                singlePlayerGame.teleporters.push({x, y, id: Math.floor(i/2)});
            }
        }

        function findStartPosition(maze) {
            return { x: 1, y: 1 };
        }

        function findExitPosition(maze) {
            const size = maze.length;
            const random = new Random(gameState.currentLevel);
            
            // Âú®ËæπÁºòÂØªÊâæÂêàÈÄÇÁöÑ‰ΩçÁΩÆ‰Ωú‰∏∫Âá∫Âè£
            const edgePositions = [];
            
            // Âè≥‰æßËæπÁºò (x = size-1)
            for (let y = 1; y < size-1; y++) {
                if (maze[y][size-2] === 0) {
                    edgePositions.push({x: size-1, y});
                }
            }
            
            // ‰∏ã‰æßËæπÁºò (y = size-1)
            for (let x = 1; x < size-1; x++) {
                if (maze[size-2][x] === 0) {
                    edgePositions.push({x, y: size-1});
                }
            }
            
            if (edgePositions.length > 0) {
                const exit = edgePositions[Math.floor(random.next() * edgePositions.length)];
                maze[exit.y][exit.x] = 0;
                return exit;
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÂêàÈÄÇ‰ΩçÁΩÆÔºå‰ΩøÁî®Âè≥‰∏ãËßí
            maze[size-2][size-1] = 0;
            return {x: size-1, y: size-2};
        }

function resizeSinglePlayerCanvas() {
    // Ê£ÄÊü•mazeÊòØÂê¶Â∑≤Ê≠£Á°ÆÂàùÂßãÂåñ
    if (!singlePlayerGame.maze || singlePlayerGame.maze.length === 0) {
        console.error("Maze not initialized in resizeSinglePlayerCanvas");
        
        // ËÆæÁΩÆÈªòËÆ§ÁîªÂ∏ÉÂ§ßÂ∞è
        singlePlayerGame.canvas.width = 300;
        singlePlayerGame.canvas.height = 300;
        return;
    }
    
    const maxWidth = window.innerWidth - 40;
    const maxHeight = window.innerHeight - 180;
    
    const mazeWidth = singlePlayerGame.maze[0].length;
    const mazeHeight = singlePlayerGame.maze.length;
    
    singlePlayerGame.cellSize = Math.min(
        40,
        Math.floor(maxWidth / mazeWidth),
        Math.floor(maxHeight / mazeHeight)
    );
    
    singlePlayerGame.canvas.width = mazeWidth * singlePlayerGame.cellSize;
    singlePlayerGame.canvas.height = mazeHeight * singlePlayerGame.cellSize;
}

        function drawSinglePlayerMaze() {
            const ctx = singlePlayerGame.ctx;
            ctx.clearRect(0, 0, singlePlayerGame.canvas.width, singlePlayerGame.canvas.height);
            
            // ÁªòÂà∂Ëø∑ÂÆ´
            for (let y = 0; y < singlePlayerGame.maze.length; y++) {
                for (let x = 0; x < singlePlayerGame.maze[y].length; x++) {
                    const cellValue = singlePlayerGame.maze[y][x];
                    
                    // Ê†πÊçÆÂçïÂÖÉÊ†ºÂÄºËÆæÁΩÆÈ¢úËâ≤
                    switch(cellValue) {
                        case 1: // Â¢ô
                            ctx.fillStyle = '#333';
                            break;
                        case 2: // Èô∑Èò±
                            ctx.fillStyle = '#FF0';
                            break;
                        case 3: // ‰º†ÈÄÅÈó®
                            ctx.fillStyle = '#0FF';
                            break;
                        case 4: // ÁßªÂä®Èô∑Èò±
                            ctx.fillStyle = '#F0F';
                            break;
                        case 8: // Èí•Âåô
                            ctx.fillStyle = 'gold';
                            break;
                        case 9: // Èó®
                            ctx.fillStyle = '#8B4513';
                            break;
                        default: // Ë∑Ø
                            if (cellValue >= 50 && cellValue <= 54) {
                                ctx.fillStyle = '#F90'; // ÂçïÂêëÈÄöÈÅì
                            } else {
                                ctx.fillStyle = '#111';
                            }
                    }
                    
                    ctx.fillRect(x * singlePlayerGame.cellSize, y * singlePlayerGame.cellSize, 
                                singlePlayerGame.cellSize, singlePlayerGame.cellSize);
                    
                    // ÁªòÂà∂ÁâπÊÆäÂÖÉÁ¥†ÁöÑÂõæÊ°à
                    if (cellValue === 2) { // Èô∑Èò±
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(
                            x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            singlePlayerGame.cellSize/4,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                    } else if (cellValue === 8) { // Èí•Âåô
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(
                            x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            singlePlayerGame.cellSize/4,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                        ctx.fillStyle = 'gold';
                        ctx.font = 'bold ' + (singlePlayerGame.cellSize/2) + 'px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('üîë', 
                            x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2
                        );
                    } else if (cellValue === 9) { // Èó®
                        ctx.fillStyle = '#5D4037';
                        ctx.fillRect(
                            x * singlePlayerGame.cellSize, 
                            y * singlePlayerGame.cellSize, 
                            singlePlayerGame.cellSize, 
                            singlePlayerGame.cellSize
                        );
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(
                            x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/4, 
                            y * singlePlayerGame.cellSize, 
                            singlePlayerGame.cellSize/2, 
                            singlePlayerGame.cellSize
                        );
                    } else if (cellValue >= 50 && cellValue <= 54) { // ÂçïÂêëÈÄöÈÅì
                        ctx.fillStyle = '#FFF';
                        ctx.font = 'bold ' + (singlePlayerGame.cellSize/2) + 'px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        let arrow = '';
                        switch(cellValue) {
                            case 51: arrow = '‚Üí'; break; // Âè≥
                            case 52: arrow = '‚Üê'; break; // Â∑¶
                            case 53: arrow = '‚Üì'; break; // ‰∏ã
                            case 54: arrow = '‚Üë'; break; // ‰∏ä
                        }
                        
                        ctx.fillText(arrow, 
                            x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                            y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2
                        );
                    }
                }
            }
            
            // ÁªòÂà∂Âá∫Âè£
            ctx.fillStyle = '#F00';
            ctx.fillRect(singlePlayerGame.exit.x * singlePlayerGame.cellSize, 
                        singlePlayerGame.exit.y * singlePlayerGame.cellSize, 
                        singlePlayerGame.cellSize, singlePlayerGame.cellSize);
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold ' + (singlePlayerGame.cellSize/2) + 'px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Âá∫', 
                singlePlayerGame.exit.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                singlePlayerGame.exit.y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2
            );
            
            // ÁªòÂà∂Áé©ÂÆ∂
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(
                singlePlayerGame.player.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                singlePlayerGame.player.y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                singlePlayerGame.cellSize/2 - 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // ÁªòÂà∂ÁßªÂä®Êïå‰∫∫ÔºàÁâπÊÆäÂÖ≥Âç°Ôºâ
            for (const enemy of singlePlayerGame.movingEnemies) {
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(
                    enemy.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                    enemy.y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/2,
                    singlePlayerGame.cellSize/2 - 2,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // ÁªòÂà∂Êïå‰∫∫ÁúºÁùõ
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(
                    enemy.x * singlePlayerGame.cellSize + singlePlayerGame.cellSize/3,
                    enemy.y * singlePlayerGame.cellSize + singlePlayerGame.cellSize/3,
                    singlePlayerGame.cellSize/8,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
            
            // Âä®ÊÄÅÁªòÂà∂Ë∑ØÂæÑÊèêÁ§∫
            if (gameState.showPathHint) {
                const path = findPathToExit(
                    singlePlayerGame.maze,
                    singlePlayerGame.player.x,
                    singlePlayerGame.player.y,
                    singlePlayerGame.exit.x,
                    singlePlayerGame.exit.y
                );
                if (path) drawPathHint(path);
            }
        }

        function startSinglePlayerTimer() {
            clearInterval(singlePlayerGame.timerInterval);
            singlePlayerGame.startTime = Date.now();
            singlePlayerGame.moveCount = 0;
            singlePlayerGame.unlockTimeLeft = 10
            updateSinglePlayerTimer();
            singlePlayerGame.timerInterval = setInterval(updateSinglePlayerTimer, 1000);
        }
function saveGameData() {
    try {
        // Á°Æ‰øùgameStateÂØπË±°ÂèäÂÖ∂Â±ûÊÄßÂ≠òÂú®
        if (!gameState.achievements) gameState.achievements = { allLevelsCompleted: false, multiplayerWins: 0, trapHits: 0, chineseEmojiUsed: false };
        if (!gameState.gameStats) gameState.gameStats = { timeChallengeBest: 0, puzzleLevelsCompleted: 0, totalLevelsCompleted: 0, totalPlayTime: 0, totalMoves: 0, totalTrapsTriggered: 0, totalCoinsCollected: 0, averageMovesPerLevel: 0, completionRate: 0 };
        if (!gameState.settings) gameState.settings = { autoSave: true };
        
        // ÂÆâÂÖ®Âú∞Â∫èÂàóÂåñÊï∞ÊçÆ
        localStorage.setItem('achievements', JSON.stringify(gameState.achievements));
        localStorage.setItem('gameStats', JSON.stringify(gameState.gameStats));
        localStorage.setItem('gameSettings', JSON.stringify(gameState.settings));
    } catch (error) {
        console.error('‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÂ§±Ë¥•:', error);
    }
}

// ÂÖ®Â±ÄÂèòÈáèË∑üË∏™ÂΩìÂâçÊâìÂºÄÁöÑÊ®°ÊÄÅÊ°Ü
let currentModal = null;
function confirmLoadGame(slot) {
    if (gameState.currentScreen !== 'singlePlayerLevelSelect' && 
        gameState.currentScreen !== 'mainMenu') {
        if (!confirm('ÊòØÂê¶ÊîæÂºÉÂΩìÂâçËøõÂ∫¶Âπ∂Âä†ËΩΩÂ≠òÊ°£Ôºü')) {
            return;
        }
    }
    
    if (loadGame(slot)) {
        const modal = document.getElementById('saveLoadModal');
        if (modal) modal.remove();
        
        // Ê†πÊçÆÂΩìÂâçÁïåÈù¢ÂÅö‰∏çÂêåÂ§ÑÁêÜ
        if (gameState.currentScreen === 'singlePlayerGame') {
            // ÈáçÊñ∞ÂàùÂßãÂåñÊ∏∏Êàè‰ΩÜ‰øùÁïôÂä†ËΩΩÁöÑ‰ΩçÁΩÆ
            initSinglePlayerGame(true); // ‰º†ÂÖ•trueË°®Á§∫ÊòØÂä†ËΩΩÂ≠òÊ°£
        } else {
            showScreen('singlePlayerGame');
        }
    }
}

function showSaveLoadMenu() {
    // ÂÖàÂÖ≥Èó≠‰ªª‰ΩïÁé∞ÊúâÁöÑÂ≠òÊ°£ÂØπËØùÊ°Ü
    const existingModal = document.getElementById('saveLoadModal');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    const modal = document.createElement('div');
    modal.id = 'saveLoadModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="background: #333; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3 style="color: white; margin-top: 0; text-align: center;">Â≠òÊ°£/ËØªÊ°£</h3>
            <div style="display: flex; justify-content: space-between; margin: 20px 0;">
                <button onclick="saveGame(0)" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">‰øùÂ≠òÂà∞Â≠òÊ°£1</button>
                <button onclick="confirmLoadGame(0)" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">ËØªÂèñÂ≠òÊ°£1</button>
                <button onclick="deleteSave(0)" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">Âà†Èô§Â≠òÊ°£1</button>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 20px 0;">
                <button onclick="saveGame(1)" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">‰øùÂ≠òÂà∞Â≠òÊ°£2</button>
                <button onclick="confirmLoadGame(1)" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">ËØªÂèñÂ≠òÊ°£2</button>
                <button onclick="deleteSave(1)" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">Âà†Èô§Â≠òÊ°£2</button>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 20px 0;">
                <button onclick="saveGame(2)" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">‰øùÂ≠òÂà∞Â≠òÊ°£3</button>
                <button onclick="confirmLoadGame(2)" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">ËØªÂèñÂ≠òÊ°£3</button>
                <button onclick="deleteSave(2)" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 5px; flex: 1; margin: 0 5px;">Âà†Èô§Â≠òÊ°£3</button>
            </div>
            <button id="saveLoadCloseBtn" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; width: 100%;">ÂÖ≥Èó≠</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
    const closeBtn = document.getElementById('saveLoadCloseBtn');
    closeBtn.addEventListener('click', () => {
        modal.remove();
    });
}



function completeLevel() {
    // 1. ÂÅúÊ≠¢ÊâÄÊúâËÆ°Êó∂Âô®ÂíåÂä®Áîª
    clearInterval(singlePlayerGame.timerInterval);
    clearInterval(singlePlayerGame.movingTrapsInterval);
    clearInterval(singlePlayerGame.unlockTimer);
    
    // 2. Âº∫Âà∂ÈöêËóèÊâÄÊúâÊåâÈíÆ
    document.getElementById('regularNextButton').style.display = 'none';
    document.getElementById('unsolvableNextButton').style.display = 'none';
    
    // 3. Êõ¥Êñ∞ÈÄöÂÖ≥‰ø°ÊÅØÊòæÁ§∫
    const elapsed = Math.floor((Date.now() - singlePlayerGame.startTime) / 1000);
    document.getElementById('singlePlayerCompleteTime').textContent = 
        `Áî®Êó∂: ${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
    document.getElementById('singlePlayerCompleteMoves').textContent = 
        `ÁßªÂä®Ê¨°Êï∞: ${singlePlayerGame.moveCount}`;
    
    // 4. Êõ¥Êñ∞Ê∏∏ÊàèËøõÂ∫¶
    if (gameState.currentLevel === gameState.unlockedLevel) {
        gameState.unlockedLevel++;
        localStorage.setItem('unlockedLevel', gameState.unlockedLevel);
    }
    
    if (!gameState.completedLevels.includes(gameState.currentLevel)) {
        gameState.completedLevels.push(gameState.currentLevel);
        localStorage.setItem('completedLevels', JSON.stringify(gameState.completedLevels));
    }
    
    // 5. ÊòæÁ§∫ÈÄöÂÖ≥Èù¢Êùø
    document.getElementById('singlePlayerComplete').classList.remove('hidden');
    
    // 6. Ëß£Èô§ÈîÆÁõòÊéßÂà∂
    window.removeEventListener('keydown', handleSinglePlayerKeyDown);
    
    // 7. ‰øùÂ≠òÊï∞ÊçÆ
    recordAchievement('levelComplete', 1);

    addCoins(5);

    // ‰øùÂ≠òÈáëÂ∏ÅÂà∞ localStorage
    localStorage.setItem('playerCoins', gameState.coins);
    
    // 8. Ê£ÄÊü•ÊØèÊó•ÊåëÊàòÂÆåÊàêÊÉÖÂÜµ
    checkDailyChallengeCompletion();
}

function loadNextLevel() {
    if (gameState.currentLevel < 80) {
        gameState.currentLevel++;
        
        // Âº∫Âà∂ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ
        document.getElementById('singlePlayerComplete').classList.add('hidden');
        document.getElementById('regularNextButton').style.display = 'none';
        document.getElementById('unsolvableNextButton').style.display = 'none';
        
        initSinglePlayerGame();
    } else {
        alert('ÊÅ≠Âñú‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÂÖ≥Âç°ÔºÅ');
        showScreen('singlePlayerLevelSelect');
    }
}

function resetSinglePlayerLevel() {
    // Âº∫Âà∂ÈöêËóèÊåâÈíÆ
    document.getElementById('regularNextButton').style.display = 'none';
    document.getElementById('unsolvableNextButton').style.display = 'none';
    
    // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
    singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
    singlePlayerGame.moveCount = 0;
    singlePlayerGame.hasKey = false;
    singlePlayerGame.isUnlocking = false;
    singlePlayerGame.unlockTimeLeft = 10;
    clearInterval(singlePlayerGame.unlockTimer);
    
    // ÈáçÁΩÆË∑ØÂæÑÊèêÁ§∫Áä∂ÊÄÅ
    gameState.showPathHint = false;
    if (gameState.pathHintTimer) {
        clearTimeout(gameState.pathHintTimer);
        gameState.pathHintTimer = null;
    }
    
    // Êõ¥Êñ∞UI
    document.getElementById('moveCount').textContent = `ÁßªÂä®: 0`;
    document.getElementById('keyStatus').textContent = `Èí•Âåô: Êú™Ëé∑Âæó`;
    document.getElementById('unlockTimer').classList.add('hidden');
    
    drawSinglePlayerMaze();
}

        function updateSinglePlayerTimer() {
            const elapsed = Math.floor((Date.now() - singlePlayerGame.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timeDisplay').textContent = 
                `Êó∂Èó¥: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('moveCount').textContent = `ÁßªÂä®: ${singlePlayerGame.moveCount}`;
        }

        function startMovingTraps() {
            if (singlePlayerGame.movingTrapsInterval) {
                clearInterval(singlePlayerGame.movingTrapsInterval);
            }
            
            singlePlayerGame.movingTrapsInterval = setInterval(moveTraps, 500);
        }

        function moveTraps() {
            const maze = singlePlayerGame.maze;
            const size = maze.length;
            const now = Date.now();
            
            // ÁßªÂä®ÊôÆÈÄöÈô∑Èò±
            for (let i = 0; i < singlePlayerGame.movingTraps.length; i++) {
                const trap = singlePlayerGame.movingTraps[i];
                
                // Â∞ùËØïÁßªÂä®
                let newX = trap.x + Math.round(trap.dx);
                let newY = trap.y + Math.round(trap.dy);
                
                // Ê£ÄÊü•ËæπÁïåÂíåÂ¢ôÂ£Å
                if (newX <= 0 || newX >= size-1 || newY <= 0 || newY >= size-1 || 
                    maze[newY][newX] === 1 || maze[newY][newX] >= 50) {
                    // ÊîπÂèòÊñπÂêë
                    trap.dx = Math.random() > 0.5 ? 1 : -1;
                    trap.dy = Math.random() > 0.5 ? 1 : -1;
                    continue;
                }
                
                // Êõ¥Êñ∞Èô∑Èò±‰ΩçÁΩÆ
                maze[trap.y][trap.x] = 0; // Ê∏ÖÈô§Êóß‰ΩçÁΩÆ
                trap.x = newX;
                trap.y = newY;
                maze[newY][newX] = 4; // ËÆæÁΩÆÊñ∞‰ΩçÁΩÆ
                
                // Ê£ÄÊü•ÊòØÂê¶Á¢∞Âà∞Áé©ÂÆ∂
                if (trap.x === singlePlayerGame.player.x && trap.y === singlePlayerGame.player.y) {
                    // ÂõûÂà∞Ëµ∑ÁÇπ
                    singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
                    // singlePlayerGame.hasKey = false;
                    // document.getElementById('keyStatus').textContent = `Èí•Âåô: Êú™Ëé∑Âæó`;
                }
            }
            
            // ÁßªÂä®Êïå‰∫∫ÔºàÁâπÊÆäÂÖ≥Âç°Ôºâ
            for (const enemy of singlePlayerGame.movingEnemies) {
                // Ê†πÊçÆÊó∂Èó¥Èó¥ÈöîÁßªÂä®
                if (now - enemy.lastMove < 500 / enemy.speed) continue;
                enemy.lastMove = now;
                
                // ËøΩÈÄêÁé©ÂÆ∂
                const dx = singlePlayerGame.player.x - enemy.x;
                const dy = singlePlayerGame.player.y - enemy.y;
                
                // ‰ºòÂÖàÁßªÂä®ÊñπÂêëÔºàÊ∞¥Âπ≥ÊàñÂûÇÁõ¥Ôºâ
                if (Math.abs(dx) > Math.abs(dy)) {
                    enemy.dx = dx > 0 ? 1 : -1;
                    enemy.dy = 0;
                } else {
                    enemy.dx = 0;
                    enemy.dy = dy > 0 ? 1 : -1;
                }
                
                // Â∞ùËØïÁßªÂä®
                let newX = enemy.x + enemy.dx;
                let newY = enemy.y + enemy.dy;
                
                // Ê£ÄÊü•ÊòØÂê¶ÂèØÁßªÂä®
                if (newX >= 0 && newX < size && newY >= 0 && newY < size && 
                    maze[newY][newX] !== 1 && maze[newY][newX] < 50) {
                    enemy.x = newX;
                    enemy.y = newY;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Á¢∞Âà∞Áé©ÂÆ∂
                if (enemy.x === singlePlayerGame.player.x && enemy.y === singlePlayerGame.player.y) {
                    // ÂõûÂà∞Ëµ∑ÁÇπ
                    singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
                    // singlePlayerGame.hasKey = false;
                    // document.getElementById('keyStatus').textContent = `Èí•Âåô: Êú™Ëé∑Âæó`;
                }
            }
            
            // Êïå‰∫∫ÁßªÂä®ÂêéÔºåÈáçÊñ∞Ê£ÄÊü•Ë∑ØÂæÑ‰∏äÊòØÂê¶ËøòÊúâÊïå‰∫∫
            if (gameState.showPathHint) {
                const path = findPathToExit(
                    singlePlayerGame.maze,
                    singlePlayerGame.player.x,
                    singlePlayerGame.player.y,
                    singlePlayerGame.exit.x,
                    singlePlayerGame.exit.y
                );
                if (path) checkEnemiesOnPath(path);
            }
            
            drawSinglePlayerMaze();
        }
function movePlayer(rawKey, isFromSystem = false) {
    // 1. Â∫îÁî®ÂèçËΩ¨Áä∂ÊÄÅ
    let effectiveKey = rawKey;
    if (gameState.controlsReversed) {
        // ÂèçËΩ¨ÈÄªËæë
        effectiveKey = {
            'ArrowUp': 'ArrowDown',
            'ArrowDown': 'ArrowUp',
            'ArrowLeft': 'ArrowRight',
            'ArrowRight': 'ArrowLeft'
        }[rawKey] || rawKey;
        console.log('ÊéßÂà∂ÂèçËΩ¨‰∏≠:', rawKey, '->', effectiveKey);
    }
    
    // 2. Ê†πÊçÆÊúÄÁªàÁ°ÆÂÆöÁöÑÊñπÂêëËøõË°åÁßªÂä®
    let newX = 0, newY = 0;
    
    switch(effectiveKey) {
        case 'ArrowUp': newY--; break;
        case 'ArrowDown': newY++; break;
        case 'ArrowLeft': newX--; break;
        case 'ArrowRight': newX++; break;
        default: return; // ‰∏çÊòØÊñπÂêëÈîÆÔºå‰∏çÂ§ÑÁêÜ
    }
    // 3. Ë∞ÉÁî®Â∑≤Â≠òÂú®ÁöÑÁßªÂä®ÈÄªËæë
    if (gameState.currentScreen === 'singlePlayerGame') {
        handleSinglePlayerMoveLogic(newX, newY);
    }
    else if (gameState.currentScreen === 'multiplayerGame') {
        handleMultiplayerMoveLogic(newX, newY);
    }
}

function handleSinglePlayerMoveLogic(dx, dy) {
    const originalPlayerX = singlePlayerGame.player.x;
    const originalPlayerY = singlePlayerGame.player.y;
    
    const newX = originalPlayerX + dx;
    const newY = originalPlayerY + dy;
    
    // ËæπÁïåÊ£ÄÊü•
    if (newY < 0 || newY >= singlePlayerGame.maze.length || 
        newX < 0 || newX >= singlePlayerGame.maze[0].length) {
        return;
    }

    const cellValue = singlePlayerGame.maze[newY][newX];

    // Â¢ô
    if (cellValue === 1) return;

    // ÂçïÂêëÈÄöÈÅì
    if (cellValue >= 50 && cellValue <= 54) {
        let allowed = false;
        switch(cellValue) {
            case 51: allowed = (dx > 0); break; // Âè≥
            case 52: allowed = (dx < 0); break; // Â∑¶
            case 53: allowed = (dy > 0); break; // ‰∏ã
            case 54: allowed = (dy < 0); break; // ‰∏ä
        }
        if (!allowed) return;
    }

    // Èô∑Èò±
    if (cellValue === 2 || cellValue === 4) {
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÊó†ÊïåÁä∂ÊÄÅ
        if (!gameState.invincible) {
            recordAchievement('trapHit', 1);
            
            // Âú®ÊØèÊó•ÊåëÊàòÊ®°Âºè‰∏ãÔºåËÆ∞ÂΩïÈô∑Èò±Ëß¶ÂèëÊ¨°Êï∞
            if (gameState.currentChallenge === 'daily' && singlePlayerGame.trapHits !== undefined) {
                singlePlayerGame.trapHits++;
            }
            
            singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
            singlePlayerGame.moveCount++;
            document.getElementById('moveCount').textContent = `ÁßªÂä®: ${singlePlayerGame.moveCount}`;
            drawSinglePlayerMaze();
            return;
        }
        // Â¶ÇÊûúÂ§Ñ‰∫éÊó†ÊïåÁä∂ÊÄÅÔºåÂÖÅËÆ∏Áé©ÂÆ∂ÁªßÁª≠ÁßªÂä®
        showNotification('Êó†ÊïåÊä§ÁõæÁîüÊïàÔºåÂÖçÂèóÈô∑Èò±‰º§ÂÆ≥ÔºÅ');
    }

    // ‰º†ÈÄÅÈó®
    if (cellValue === 3 && singlePlayerGame.teleporters.length > 0) {
        const currentPortal = singlePlayerGame.teleporters.find(t => t.x === newX && t.y === newY);
        if (currentPortal) {
            const pairPortals = singlePlayerGame.teleporters.filter(t => 
                t.id === currentPortal.id && (t.x !== newX || t.y !== newY)
            );
            if (pairPortals.length > 0) {
                // ‰øùÂ≠òÂΩìÂâçË∑ØÂæÑÈïøÂ∫¶Âíå‰º†ÈÄÅÈó®‰ø°ÊÅØ
                if (gameState.showPathHint) {
                    const currentPath = findPathToExit(
                        singlePlayerGame.maze, 
                        singlePlayerGame.player.x, 
                        singlePlayerGame.player.y,
                        singlePlayerGame.exit.x, 
                        singlePlayerGame.exit.y
                    );
                    if (currentPath) {
                        gameState.lastPathLength = currentPath.length;
                        gameState.lastPortal = currentPortal;
                    }
                }
                
                const targetPortal = pairPortals[Math.floor(Math.random() * pairPortals.length)];
                // Âè™Êõ¥Êñ∞ÂùêÊ†áÊï∞ÂÄºÔºåËøôÊòØÂÆâÂÖ®ÁöÑ
                singlePlayerGame.player.x = targetPortal.x;
                singlePlayerGame.player.y = targetPortal.y;
                singlePlayerGame.moveCount++;
                document.getElementById('moveCount').textContent = `ÁßªÂä®: ${singlePlayerGame.moveCount}`;
                drawSinglePlayerMaze();
                checkSinglePlayerExit();
                
                // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫Ë∑ØÂæÑÊèêÁ§∫ÔºåÈáçÊñ∞ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Ë∑ØÂæÑ
                if (gameState.showPathHint) {
                    const newPath = findPathToExit(
                        singlePlayerGame.maze, 
                        singlePlayerGame.player.x, 
                        singlePlayerGame.player.y,
                        singlePlayerGame.exit.x, 
                        singlePlayerGame.exit.y
                    );
                    if (newPath && gameState.lastPortal && newPath.length > gameState.lastPathLength) {
                        // Êñ∞Ë∑ØÂæÑÊõ¥ÈïøÔºåÊîπ‰∏∫ËøîÂõû‰º†ÈÄÅÈó®
                        const backToPortalPath = findPathToExit(
                            singlePlayerGame.maze, 
                            singlePlayerGame.player.x, 
                            singlePlayerGame.player.y,
                            gameState.lastPortal.x, 
                            gameState.lastPortal.y
                        );
                        if (backToPortalPath) {
                            drawPathHint(backToPortalPath);
                            // Êõ¥Êñ∞Ë∑ØÂæÑÈïøÂ∫¶
                            gameState.lastPathLength = backToPortalPath.length;
                        }
                    } else if (newPath) {
                        drawPathHint(newPath);
                        // Êõ¥Êñ∞Ë∑ØÂæÑÈïøÂ∫¶
                        gameState.lastPathLength = newPath.length;
                    }
                }
                
                return; // ‰º†ÈÄÅÈÄªËæëÁªìÊùüÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ÁöÑÊôÆÈÄöÁßªÂä®ÈÄªËæë
            }
        }
    }

    // Èí•Âåô
    if (cellValue === 8) {
        singlePlayerGame.hasKey = true;
        document.getElementById('keyStatus').textContent = `Èí•Âåô: Â∑≤Ëé∑Âæó`;
        singlePlayerGame.maze[newY][newX] = 0; // ÁßªÈô§Èí•Âåô
    }

    // ÈáëÂ∏Å
    if (cellValue === 10) {
        addCoins(1); // Êî∂ÈõÜ1‰∏™ÈáëÂ∏Å
        singlePlayerGame.maze[newY][newX] = 0; // ÁßªÈô§ÈáëÂ∏Å
        
        // Âú®ÊØèÊó•ÊåëÊàòÊ®°Âºè‰∏ãÊõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫
        if (gameState.currentChallenge === 'daily') {
            document.getElementById('coinDisplay').textContent = `ÈáëÂ∏Å: ${singlePlayerGame.coinsCollected || 0}`;
        }
    }

    // Èó®
    if (cellValue === 9) {
        if (singlePlayerGame.hasKey) {
            startUnlockDoor();
            return;
        } else {
            alert("‰Ω†ÈúÄË¶ÅÈí•ÂåôÊâçËÉΩÊâìÂºÄËøôÊâáÈó®ÔºÅ");
            return;
        }
    }
    
    // ÊâÄÊúâÊ£ÄÊü•ÈÄöËøáÔºåÊâßË°åÊ†áÂáÜÁßªÂä®
    singlePlayerGame.player.x = newX;
    singlePlayerGame.player.y = newY;
    singlePlayerGame.moveCount++;
    document.getElementById('moveCount').textContent = `ÁßªÂä®: ${singlePlayerGame.moveCount}`;
    drawSinglePlayerMaze();
    checkSinglePlayerExit();
}


function handleSinglePlayerKeyDown(e) {
    // Ê£ÄÊü•ÊåâÈîÆÊòØÂê¶ÊòØÊàë‰ª¨ÂÖ≥ÂøÉÁöÑÊñπÂêëÈîÆ
    const key = e.key;
    if(!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
        return; // ‰∏çÊòØÊñπÂêëÈîÆÔºå‰∏çÂ§ÑÁêÜ
    }
    
    // „ÄêÈáçË¶Å„Äë‰∏çÂÜçÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåÈÅøÂÖçÂΩ±ÂìçÈ°µÈù¢ÊªöÂä®
    // if (typeof e.preventDefault === 'function') {
    //     e.preventDefault();
    // }
    movePlayer(key);
}



// Êõ¥Êñ∞ËÆ°Êó∂Âô®ÊòæÁ§∫
function updateUnlockTimer() {
    document.getElementById('unlockTimer').textContent = 
        `ÂºÄÈó®ÂÄíËÆ°Êó∂: ${singlePlayerGame.unlockTimeLeft}Áßí`;
}
function checkSinglePlayerExit() {
    // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âú®Âá∫Âè£‰ΩçÁΩÆ
    if (singlePlayerGame.player.x === singlePlayerGame.exit.x && 
        singlePlayerGame.player.y === singlePlayerGame.exit.y) {
        
        // Â¶ÇÊûúÊòØÁâπÊÆäÂÖ≥Âç°‰∏îÊúâÈó®ÁöÑ‰ΩçÁΩÆ
        if (gameState.specialLevels.includes(gameState.currentLevel) && 
            singlePlayerGame.doorPosition) {
            
            // Ê£ÄÊü•Èó®ÊòØÂê¶Â∑≤ÁªèÊâìÂºÄ
            if (singlePlayerGame.maze[singlePlayerGame.doorPosition.y][singlePlayerGame.doorPosition.x] === 0) {
                // Èó®Â∑≤ÊâìÂºÄÔºåÂèØ‰ª•ÈÄöÂÖ≥
                completeLevel();
            } else {
                // Èó®Êú™ÊâìÂºÄÔºåÊèêÁ§∫Áé©ÂÆ∂ÈúÄË¶ÅÈí•Âåô
                alert("‰Ω†ÈúÄË¶ÅÊâæÂà∞Èí•ÂåôÂπ∂ÊâìÂºÄÈó®ÊâçËÉΩÈÄöÂÖ≥ÔºÅ");
                // Â∞ÜÁé©ÂÆ∂ÁßªÂõûÈó®ÂâçÁöÑ‰ΩçÁΩÆ
                const directions = [
                    {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
                    {dx: 0, dy: 1}, {dx: 0, dy: -1}
                ];
                
                let moved = false;
                for (const dir of directions) {
                    const nx = singlePlayerGame.exit.x + dir.dx;
                    const ny = singlePlayerGame.exit.y + dir.dy;
                    
                    if (nx >= 0 && nx < singlePlayerGame.maze[0].length && 
                        ny >= 0 && ny < singlePlayerGame.maze.length &&
                        singlePlayerGame.maze[ny][nx] === 0) {
                        singlePlayerGame.player.x = nx;
                        singlePlayerGame.player.y = ny;
                        moved = true;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÊó†Ê≥ïÁßªÂä®Áé©ÂÆ∂ÔºåÂàôÈáçÁΩÆÂà∞Ëµ∑ÁÇπ
                if (!moved) {
                    singlePlayerGame.player = findStartPosition(singlePlayerGame.maze);
                }
                
                drawSinglePlayerMaze();
            }
        } else {
            // ÊôÆÈÄöÂÖ≥Âç°ÔºåÁõ¥Êé•ÈÄöÂÖ≥
            completeLevel();
        }
    }
}

        // =============== Â§ö‰∫∫Ê∏∏ÊàèP2PÂäüËÉΩ ===============
        function connectToMultiplayerGame() {
            console.log("Ëß¶ÂèëËøûÊé•Ëá≥Â§ö‰∫∫ËÅîÊú∫Ê∏∏ÊàèÂáΩÊï∞")
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // ÊòæÁ§∫Áä∂ÊÄÅÊèêÁ§∫Âπ∂Á¶ÅÁî®ÊåâÈíÆ
            const statusElement = document.getElementById('roomStatus');
            const startBtn = document.getElementById('multiplayerStartBtn');
            const roomCodeInput = document.getElementById('roomCode').value.trim();
            
            if (roomCodeInput) {
                statusElement.textContent = 'Âä†ÂÖ•ÊàøÈó¥‰∏≠...';
            } else {
                statusElement.textContent = 'ÂàõÂª∫ÊàøÈó¥‰∏≠...';
            }
            startBtn.disabled = true;
            
            gameState.playerName = document.getElementById('playerName').value.trim() || 'Áé©ÂÆ∂';
            
            // Ëé∑ÂèñÊàøÈó¥ÂØÜÁ†Å
            const roomPassword = document.getElementById('roomPassword').value.trim();
            
            // ËÆæÁΩÆÊúÄÂ§ßÁé©ÂÆ∂Êï∞ÂíåÂØÜÁ†Å
            if (roomCodeInput === '') {
                gameState.multiplayer.maxPlayers = parseInt(document.getElementById('maxPlayers').value);
                gameState.multiplayer.roomPassword = roomPassword;
            }
            
            // ÂàùÂßãÂåñPeerËøûÊé•
            try {
                if (roomCodeInput) {
                // Âä†ÂÖ•Áé∞ÊúâÊàøÈó¥
                console.log("Âä†ÂÖ•Áé∞ÊúâÊàøÈó¥")
                gameState.multiplayer.isHost = false;
                // Á°Æ‰øùÊàøÈó¥Âè∑Ê†ºÂºèÊ≠£Á°ÆÔºåÊ∑ªÂä†room_ÂâçÁºÄ
                gameState.multiplayer.roomCode = roomCodeInput.startsWith('room_') ? roomCodeInput : `room_${roomCodeInput}`;
                gameState.multiplayer.peer = new Peer({
                    debug: 2,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' },
                            // Ê∑ªÂä†Â§ö‰∏™TURNÊúçÂä°Âô®ÊîØÊåÅË∑®ÁΩëÊÆµËøûÊé•
                            { urls: 'turn:turn.peerjs.com:3478', username: 'peerjs', credential: 'peerjsp' },
                            { urls: 'turn:numb.viagenie.ca:3478', username: 'webrtc@live.com', credential: 'muazkh' },
                            { urls: 'turn:relay.metered.ca:80', username: '0f3183b2c5a5d9b65c26f1f3', credential: '5FwA9cC8TQ6X8Y7Z' },
                            { urls: 'turn:relay.metered.ca:443', username: '0f3183b2c5a5d9b65c26f1f3', credential: '5FwA9cC8TQ6X8Y7Z' }
                        ]
                    }
                });
            } else {
                    // ÂàõÂª∫Êñ∞ÊàøÈó¥
                    console.log("ÂàõÂª∫Êñ∞ÊàøÈó¥")
                    gameState.multiplayer.isHost = true;
                    
                    // ‰ΩøÁî®Êó∂Èó¥Êà≥ÂíåÈöèÊú∫Êï∞ÁîüÊàêÊõ¥ÂîØ‰∏ÄÁöÑID
                    const timestamp = new Date().getTime().toString(36);
                    const randomStr = Math.random().toString(36).substring(2, 10);
                    // const roomCode = `room_${timestamp}_${randomStr}`;
                    const roomCode = generateShortRoomCode();

                    gameState.multiplayer.roomCode = roomCode;
                    gameState.multiplayer.peer = new Peer(roomCode, {
                        debug: 2,
                        config: {
                            'iceServers': [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' },
                                { urls: 'stun:stun3.l.google.com:19302' },
                                { urls: 'stun:stun4.l.google.com:19302' },
                                // Ê∑ªÂä†Â§ö‰∏™TURNÊúçÂä°Âô®ÊîØÊåÅË∑®ÁΩëÊÆµËøûÊé•
                                { urls: 'turn:turn.peerjs.com:3478', username: 'peerjs', credential: 'peerjsp' },
                                { urls: 'turn:numb.viagenie.ca:3478', username: 'webrtc@live.com', credential: 'muazkh' },
                                { urls: 'turn:relay.metered.ca:80', username: '0f3183b2c5a5d9b65c26f1f3', credential: '5FwA9cC8TQ6X8Y7Z' },
                                { urls: 'turn:relay.metered.ca:443', username: '0f3183b2c5a5d9b65c26f1f3', credential: '5FwA9cC8TQ6X8Y7Z' }
                            ]
                        }
                    });
                }
                
                // ËÆæÁΩÆPeer‰∫ã‰ª∂Â§ÑÁêÜ
                gameState.multiplayer.peer.on('open', (id) => {
                    console.log('PeerËøûÊé•Âª∫Á´ãÔºåID:', id);
                    gameState.multiplayer.currentPlayerId = id;
                    
                    // ËøûÊé•ÊàêÂäüÔºåÊõ¥Êñ∞Áä∂ÊÄÅ
                    const statusElement = document.getElementById('roomStatus');
                    const startBtn = document.getElementById('multiplayerStartBtn');
                    
                    if (gameState.multiplayer.isHost) {
                        statusElement.textContent = 'ÊàøÈó¥ÂàõÂª∫ÊàêÂäüÔºÅ';
                        // ‰∏ªÊú∫ÈÄªËæë
                        setupAsHost(id);
                    } else {
                        statusElement.textContent = 'Ê≠£Âú®ËøûÊé•Âà∞‰∏ªÊú∫...';
                        // ËøûÊé•Âà∞‰∏ªÊú∫Ôºå‰ΩøÁî®Â§ÑÁêÜÂêéÁöÑÊàøÈó¥Âè∑
                        connectToHost(gameState.multiplayer.roomCode);
                    }
                });
                
                gameState.multiplayer.peer.on('connection', (conn) => {
                    console.log('Êî∂Âà∞ËøûÊé•ËØ∑Ê±Ç:', conn.peer);
                    setupConnection(conn);
                });
                
                gameState.multiplayer.peer.on('error', (err) => {
                    console.error('PeerÈîôËØØ:', err);
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    const statusElement = document.getElementById('roomStatus');
                    const startBtn = document.getElementById('multiplayerStartBtn');
                    statusElement.textContent = 'ËøûÊé•Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                    statusElement.style.color = '#FF5252';
                    startBtn.disabled = false;
                    
                    // Â§ÑÁêÜIDË¢´Âç†Áî®ÁöÑÊÉÖÂÜµ
                    if (err.type === 'peer-unavailable' || err.type === 'unavailable-id') {
                        alert('ËøûÊé•Âá∫Èîô',err);
                    } else {
                        alert('ËøûÊé•ÈîôËØØ: ' + err);
                    }
                    
                    showScreen('multiplayerSetup');
                });
                
                // Êõ¥Êñ∞UIÊòæÁ§∫ËøûÊé•Áä∂ÊÄÅ
                updateConnectionStatus('connecting');
                
            } catch (err) {
                console.error('ÂàùÂßãÂåñPeerÂ§±Ë¥•:', err);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const statusElement = document.getElementById('roomStatus');
                const startBtn = document.getElementById('multiplayerStartBtn');
                statusElement.textContent = 'ËøûÊé•ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                statusElement.style.color = '#FF5252';
                startBtn.disabled = false;
                
                alert('ËøûÊé•ÂàùÂßãÂåñÂ§±Ë¥•: ' + err);
            }
        }

        function setupAsHost(peerId) {
            // ÁîüÊàêÂ§ö‰∫∫Ê∏∏ÊàèËø∑ÂÆ´
            console.log("ÁîüÊàêÂ§ö‰∫∫Ê∏∏ÊàèËø∑ÂÆ´")
            gameState.multiplayer.maze = generateMultiplayerMaze();
            
            // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©ÁöÑÈ¢úËâ≤
            const playerColor = document.getElementById('playerColor').value;
            
            // Ê∑ªÂä†Ëá™Â∑±‰Ωú‰∏∫Áé©ÂÆ∂
            gameState.multiplayer.players[peerId] = {
                id: peerId,
                name: gameState.playerName,
                x: 1,
                y: 1,
                color: playerColor,
                reachedExit: false,
                isHost: true
            };
            
            // ËÆæÁΩÆÊàøÈó¥‰ª£Á†ÅÊòæÁ§∫
            document.getElementById('multiplayerRoomCode').textContent = 
                `ÊàøÈó¥: ${peerId}`;
            
            // ÂêëAPIÊúçÂä°Âô®ÂèëÈÄÅÊàøÈó¥ÂàõÂª∫ËØ∑Ê±Ç
            async function registerRoomWithServer() {
                try {
                    const roomData = {
                        playerName: gameState.playerName,
                        maxPlayers: gameState.multiplayer.maxPlayers,
                        roomName: `${gameState.playerName}ÁöÑÊàøÈó¥`,
                        isPrivate: !!gameState.multiplayer.roomPassword,
                        password: gameState.multiplayer.roomPassword
                    };
                    
                    console.log('ÂèëÈÄÅÊàøÈó¥ÂàõÂª∫ËØ∑Ê±ÇÂà∞APIÊúçÂä°Âô®:', roomData);
                    
                    const response = await fetch(GAME_SERVER_URL + '/api/create-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(roomData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('ÊàøÈó¥ÂàõÂª∫ËØ∑Ê±ÇÊàêÂäü:', result);
                    } else {
                        const error = await response.json();
                        console.error('ÊàøÈó¥ÂàõÂª∫ËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    }
                } catch (err) {
                    console.error('ÂèëÈÄÅÊàøÈó¥ÂàõÂª∫ËØ∑Ê±ÇÊó∂ÂèëÁîüÈîôËØØ:', err);
                }
            }
            
            // Ê≥®ÂÜåÊàøÈó¥Âà∞ÊúçÂä°Âô®
            registerRoomWithServer();
            
            // ÂºÄÂßãÂ§ö‰∫∫Ê∏∏Êàè
            console.log("ÂºÄÂßãÂ§ö‰∫∫Ê∏∏Êàè")
            startMultiplayerGame();
        }

        function connectToHost(hostId) {
            try {
                // Á°Æ‰øùhostIdÂ∏¶Êúâroom_ÂâçÁºÄ
                const formattedHostId = hostId.startsWith('room_') ? hostId : `room_${hostId}`;
                
                // ËøûÊé•Âà∞‰∏ªÊú∫
                console.log("ËøûÊé•Ëá≥‰∏ªÊú∫", formattedHostId)
                const conn = gameState.multiplayer.peer.connect(formattedHostId, {
                    reliable: true
                });
                
                if (!conn) {
                    console.error("Êó†Ê≥ïÂª∫Á´ãËøûÊé•")
                    throw new Error('Êó†Ê≥ïÂª∫Á´ãËøûÊé•');
                }
                
                console.log('ËøûÊé•ÂØπË±°Â∑≤ÂàõÂª∫ÔºåÁ≠âÂæÖËøûÊé•ÊâìÂºÄ...');
                
                setupConnection(conn);
                
                // Ê∑ªÂä†ËøûÊé•Ë∂ÖÊó∂Â§ÑÁêÜ
                const connectionTimeout = setTimeout(() => {
                    console.error('ËøûÊé•Ë∂ÖÊó∂');
                    alert('ËøûÊé•‰∏ªÊú∫Ë∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊàøÈó¥Âè∑ÊòØÂê¶Ê≠£Á°Æ\n\nË∞ÉËØï‰ø°ÊÅØÔºö\n- ÊàøÈó¥Âè∑Ôºö' + formattedHostId + '\n- ‰Ω†ÁöÑIDÔºö' + gameState.multiplayer.currentPlayerId);
                    updateConnectionStatus('disconnected');
                    disconnectMultiplayer();
                    showScreen('multiplayerSetup');
                }, 10000); // 10ÁßíË∂ÖÊó∂
                
                conn.on('open', () => {
                    console.log('Â∑≤ËøûÊé•Âà∞‰∏ªÊú∫');
                    clearTimeout(connectionTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                    // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©ÁöÑÈ¢úËâ≤ÂíåÂØÜÁ†Å
                    const playerColor = document.getElementById('playerColor').value;
                    const roomPassword = document.getElementById('roomPassword').value.trim();
                    
                    // ÂèëÈÄÅÂä†ÂÖ•ËØ∑Ê±Ç
                    conn.send({
                        type: 'player-join',
                        player: {
                            id: gameState.multiplayer.currentPlayerId,
                            name: gameState.playerName,
                            color: playerColor
                        },
                        password: roomPassword
                    });
                    
                    updateConnectionStatus('connected');
                });
                
                conn.on('error', (err) => {
                    console.error('ËøûÊé•ÈîôËØØ:', err);
                    clearTimeout(connectionTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                    alert('ËøûÊé•‰∏ªÊú∫Â§±Ë¥•: ' + err + '\n\nË∞ÉËØï‰ø°ÊÅØÔºö\n- ÊàøÈó¥Âè∑Ôºö' + formattedHostId + '\n- ÈîôËØØÁ±ªÂûãÔºö' + err.type + '\n- ÈîôËØØËØ¶ÊÉÖÔºö' + JSON.stringify(err));
                    updateConnectionStatus('disconnected');
                    disconnectMultiplayer();
                    showScreen('multiplayerSetup');
                });
                
                // Ê∑ªÂä†ËøûÊé•ÂÖ≥Èó≠‰∫ã‰ª∂ÁõëÂê¨
                conn.on('close', () => {
                    console.error('ËøûÊé•ÊÑèÂ§ñÂÖ≥Èó≠');
                    clearTimeout(connectionTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                    alert('‰∏é‰∏ªÊú∫ÁöÑËøûÊé•Â∑≤ÂÖ≥Èó≠\n\nË∞ÉËØï‰ø°ÊÅØÔºö\n- ÊàøÈó¥Âè∑Ôºö' + formattedHostId);
                    updateConnectionStatus('disconnected');
                    disconnectMultiplayer();
                    showScreen('multiplayerSetup');
                });
                
            } catch (err) {
                console.error('ËøûÊé•ÂºÇÂ∏∏:', err);
                alert('ËøûÊé•ÂºÇÂ∏∏: ' + err.message);
                updateConnectionStatus('disconnected');
                disconnectMultiplayer();
            }
        }

        function setupConnection(conn) {
            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÊúÄÂ§ßÁé©ÂÆ∂Êï∞
            if (gameState.multiplayer.isHost && 
                Object.keys(gameState.multiplayer.players).length >= gameState.multiplayer.maxPlayers) {
                console.log('ÊàøÈó¥Â∑≤Êª°ÔºåÊãíÁªùËøûÊé•:', conn.peer);
                conn.send({
                    type: 'room-full',
                    message: 'ÊàøÈó¥Â∑≤Êª°ÔºåÊó†Ê≥ïÂä†ÂÖ•'
                });
                conn.close();
                return;
            }
            
            // Â≠òÂÇ®ËøûÊé•
            gameState.multiplayer.connections[conn.peer] = conn;
            
            // Â§ÑÁêÜÊî∂Âà∞ÁöÑÊ∂àÊÅØ
            conn.on('data', (data) => {
                handleMultiplayerData(data, conn.peer);
            });
            
            conn.on('close', () => {
                console.log('ËøûÊé•ÂÖ≥Èó≠:', conn.peer);
                removePlayer(conn.peer);
            });
            
            conn.on('error', (err) => {
                console.error('ËøûÊé•ÈîôËØØ:', conn.peer, err);
                removePlayer(conn.peer);
            });
        }
// ÁîüÊàêÁÆÄÁü≠ÊàøÈó¥Âè∑Ôºà5‰ΩçÊï∞Â≠óÔºâ
function generateShortRoomCode() {
    // ÁîüÊàê5‰ΩçÈöèÊú∫Êï∞Â≠ó
    const code = Math.floor(10000 + Math.random() * 90000).toString();
    return `room_${code}`;
}
// Êó∂Èó¥ÊåëÊàòÊ®°Âºè
function startTimeChallenge() {
    gameState.currentChallenge = 'time';
    gameState.currentLevel = 1;
    showScreen('singlePlayerGame');
    
    // Ê∑ªÂä†Êó∂Èó¥ÊåëÊàòUI
    const timeChallengeInfo = document.createElement('div');
    timeChallengeInfo.className = 'time-challenge-info';
    timeChallengeInfo.id = 'timeChallengeInfo';
    timeChallengeInfo.innerHTML = '‚è±Ô∏è Êó∂Èó¥ÊåëÊàòÊ®°Âºè<br>Ââ©‰ΩôÊó∂Èó¥: <span id="challengeTimeLeft">60</span>Áßí';
    document.getElementById('singlePlayerGame').appendChild(timeChallengeInfo);
    
    // ÂêØÂä®Êó∂Èó¥ÊåëÊàòËÆ°Êó∂Âô®
    startTimeChallengeTimer();
}

function startTimeChallengeTimer() {
    let timeLeft = 60; // 60ÁßíÊåëÊàò
    const timerElement = document.getElementById('challengeTimeLeft');
    
    const challengeTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(challengeTimer);
            alert('Êó∂Èó¥Âà∞ÔºÅÊåëÊàòÂ§±Ë¥•ÔºÅ');
            showScreen('moreChallenges');
            document.getElementById('timeChallengeInfo').remove();
        }
        
        // Êó∂Èó¥Ë≠¶Âëä
        if (timeLeft <= 10) {
            timerElement.style.color = '#ff4444';
            timerElement.style.animation = 'pulse 0.5s infinite';
        }
    }, 1000);
    
    // ‰øùÂ≠òËÆ°Êó∂Âô®ÂºïÁî®‰ª•‰æøÊ∏ÖÁêÜ
    gameState.challengeTimer = challengeTimer;
}

// Ëß£Ë∞úÊ®°Âºè
function startPuzzleMode() {
    gameState.currentChallenge = 'puzzle';
    gameState.currentLevel = 1;
    showScreen('singlePlayerGame');
    
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁâπÊÆäÁöÑËß£Ë∞úÂÖ≥Âç°ÈÄªËæë
    // ‰æãÂ¶ÇÔºöÈúÄË¶ÅÊåâÁÖßÁâπÂÆöÈ°∫Â∫èË∏©Ë∏èÊåâÈíÆÁ≠â
}

// ÊàêÂ∞±Á≥ªÁªüÂáΩÊï∞
function updateAchievementProgress() {
    // Êõ¥Êñ∞ÊàêÂ∞±1ÔºöÈÄöÂÖ≥ÊâÄÊúâÂÖ≥Âç°
    const totalLevels = 80;
    const progress1 = (gameState.achievements.allLevelsCompleted ? totalLevels : gameState.gameStats.totalLevelsCompleted) / totalLevels * 100;
    document.getElementById('progress1').style.width = progress1 + '%';
    document.getElementById('progressText1').textContent = 
        gameState.achievements.allLevelsCompleted ? '80/80' : gameState.gameStats.totalLevelsCompleted + '/80';
    
    if (gameState.achievements.allLevelsCompleted) {
        document.getElementById('achievement1').classList.add('completed');
        document.getElementById('status1').textContent = 'Â∑≤ÂÆåÊàê';
    }
    
    // Êõ¥Êñ∞ÊàêÂ∞±2ÔºöÂ§ö‰∫∫Ê∏∏ÊàèËÉúÂà©
    const progress2 = Math.min(gameState.achievements.multiplayerWins / 10 * 100, 100);
    document.getElementById('progress2').style.width = progress2 + '%';
    document.getElementById('progressText2').textContent = gameState.achievements.multiplayerWins + '/10';
    
    if (gameState.achievements.multiplayerWins >= 10) {
        document.getElementById('achievement2').classList.add('completed');
        document.getElementById('status2').textContent = 'Â∑≤ÂÆåÊàê';
    }
    
    // Êõ¥Êñ∞ÊàêÂ∞±3ÔºöÈô∑Èò±Ê¨°Êï∞
    const progress3 = Math.min(gameState.achievements.trapHits / 30 * 100, 100);
    document.getElementById('progress3').style.width = progress3 + '%';
    document.getElementById('progressText3').textContent = gameState.achievements.trapHits + '/30';
    
    if (gameState.achievements.trapHits >= 30) {
        document.getElementById('achievement3').classList.add('completed');
        document.getElementById('status3').textContent = 'Â∑≤ÂÆåÊàê';
    }
    
    // Êõ¥Êñ∞ÊàêÂ∞±4Ôºö‰ΩøÁî®‰∏≠ÂõΩÂõΩÊóóË°®ÊÉÖÂåÖ
    const progress4 = gameState.achievements.chineseEmojiUsed ? 100 : 0;
    document.getElementById('progress4').style.width = progress4 + '%';
    document.getElementById('progressText4').textContent = gameState.achievements.chineseEmojiUsed ? '1/1' : '0/1';
    
    if (gameState.achievements.chineseEmojiUsed) {
        const achievement4 = document.getElementById('achievement4');
        achievement4.classList.add('completed');
        achievement4.classList.remove('hidden');
        document.getElementById('status4').textContent = 'Â∑≤ÂÆåÊàê';
    }
}

// Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÈù¢Êùø
// Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÈù¢Êùø
function updateStatistics() {
    // Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÔºåÁ°Æ‰øùÊúâÈªòËÆ§ÂÄº
    const stats = gameState.gameStats || {
        timeChallengeBest: 0,
        puzzleLevelsCompleted: 0,
        totalLevelsCompleted: 0,
        totalPlayTime: 0,
        totalMoves: 0,
        totalTrapsTriggered: 0,
        totalCoinsCollected: 0,
        averageMovesPerLevel: 0,
        completionRate: 0
    };
    
    // Êõ¥Êñ∞ÊÄªÊ∏∏ÊàèÊó∂Èó¥ÔºàËΩ¨Êç¢‰∏∫ÂàÜÈíüÔºâ
    const totalPlayTimeMinutes = Math.floor((gameState.totalPlayTime || 0) / 60000);
    document.getElementById('totalPlayTime').textContent = totalPlayTimeMinutes + ' ÂàÜÈíü';
    
    // Êõ¥Êñ∞ÊÄªÁßªÂä®Ê¨°Êï∞
    document.getElementById('totalMoves').textContent = stats.totalMoves || 0;
    
    // Êõ¥Êñ∞ÈÄöÂÖ≥ÊÄªÂÖ≥Âç°Êï∞
    document.getElementById('totalLevelsCompleted').textContent = stats.totalLevelsCompleted || 0;
    
    // Êõ¥Êñ∞Ëß¶ÂèëÈô∑Èò±Ê¨°Êï∞
    document.getElementById('totalTrapsTriggered').textContent = stats.totalTrapsTriggered || 0;
    
    // Êõ¥Êñ∞Êî∂ÈõÜÈáëÂ∏ÅÊÄªÊï∞
    document.getElementById('totalCoinsCollected').textContent = stats.totalCoinsCollected || 0;
    
    // Êõ¥Êñ∞Ëß£Ë∞úÂÖ≥Âç°ÂÆåÊàêÊï∞
    document.getElementById('puzzleLevelsCompleted').textContent = stats.puzzleLevelsCompleted || 0;
    
    // Êõ¥Êñ∞ÊúÄÂø´ÈÄöÂÖ≥Êó∂Èó¥
    document.getElementById('timeChallengeBest').textContent = (stats.timeChallengeBest || 0) + ' Áßí';
    
    // Êõ¥Êñ∞Âπ≥ÂùáÊØèÂÖ≥ÁßªÂä®Ê¨°Êï∞Ôºà‰øùÁïô‰∏Ä‰ΩçÂ∞èÊï∞Ôºâ
    const totalLevels = stats.totalLevelsCompleted || 0;
    const totalMoves = stats.totalMoves || 0;
    const avgMoves = totalLevels > 0 ? (totalMoves / totalLevels).toFixed(1) : 0;
    document.getElementById('averageMovesPerLevel').textContent = avgMoves;
    
    // Êõ¥Êñ∞ÈÄöÂÖ≥ÁéáÔºàÁôæÂàÜÊØîÔºâ
    const completionRate = (stats.completionRate || 0).toFixed(1);
    document.getElementById('completionRate').textContent = completionRate + '%';
} {
    // Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ
    const stats = gameState.gameStats;
    
    // Êõ¥Êñ∞ÊÄªÊ∏∏ÊàèÊó∂Èó¥ÔºàËΩ¨Êç¢‰∏∫ÂàÜÈíüÔºâ
    const totalPlayTimeMinutes = Math.floor((gameState.totalPlayTime || 0) / 60000);
    document.getElementById('totalPlayTime').textContent = totalPlayTimeMinutes + ' ÂàÜÈíü';
    
    // Êõ¥Êñ∞ÊÄªÁßªÂä®Ê¨°Êï∞
    document.getElementById('totalMoves').textContent = stats.totalMoves;
    
    // Êõ¥Êñ∞ÈÄöÂÖ≥ÊÄªÂÖ≥Âç°Êï∞
    document.getElementById('totalLevelsCompleted').textContent = stats.totalLevelsCompleted;
    
    // Êõ¥Êñ∞Ëß¶ÂèëÈô∑Èò±Ê¨°Êï∞
    document.getElementById('totalTrapsTriggered').textContent = stats.totalTrapsTriggered;
    
    // Êõ¥Êñ∞Êî∂ÈõÜÈáëÂ∏ÅÊÄªÊï∞
    document.getElementById('totalCoinsCollected').textContent = stats.totalCoinsCollected;
    
    // Êõ¥Êñ∞Ëß£Ë∞úÂÖ≥Âç°ÂÆåÊàêÊï∞
    document.getElementById('puzzleLevelsCompleted').textContent = stats.puzzleLevelsCompleted;
    
    // Êõ¥Êñ∞ÊúÄÂø´ÈÄöÂÖ≥Êó∂Èó¥
    document.getElementById('timeChallengeBest').textContent = stats.timeChallengeBest + ' Áßí';
    
    // Êõ¥Êñ∞Âπ≥ÂùáÊØèÂÖ≥ÁßªÂä®Ê¨°Êï∞Ôºà‰øùÁïô‰∏Ä‰ΩçÂ∞èÊï∞Ôºâ
    const avgMoves = stats.totalLevelsCompleted > 0 ? 
        (stats.totalMoves / stats.totalLevelsCompleted).toFixed(1) : 0;
    document.getElementById('averageMovesPerLevel').textContent = avgMoves;
    
    // Êõ¥Êñ∞ÈÄöÂÖ≥ÁéáÔºàÁôæÂàÜÊØîÔºâ
    const completionRate = stats.completionRate.toFixed(1);
    document.getElementById('completionRate').textContent = completionRate + '%';
}

// ÈáçÁΩÆÁªüËÆ°Êï∞ÊçÆ
function resetStatistics() {
    if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÁªüËÆ°Êï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
        // ÈáçÁΩÆgameStatsÂØπË±°
        gameState.gameStats = {
            timeChallengeBest: 0,
            puzzleLevelsCompleted: 0,
            totalLevelsCompleted: 0,
            totalPlayTime: 0,
            totalMoves: 0,
            totalTrapsTriggered: 0,
            totalCoinsCollected: 0,
            averageMovesPerLevel: 0,
            completionRate: 0
        };
        
        // ‰øùÂ≠òÂà∞localStorage
        localStorage.setItem('gameStats', JSON.stringify(gameState.gameStats));
        
        // Êõ¥Êñ∞ÁªüËÆ°Èù¢ÊùøÊòæÁ§∫
        updateStatistics();
        
        // ÊòæÁ§∫ÊèêÁ§∫
        alert('ÁªüËÆ°Êï∞ÊçÆÂ∑≤ÈáçÁΩÆÔºÅ');
    }
}

// ËÆ∞ÂΩïÊàêÂ∞±ËøõÂ∫¶
function recordAchievement(type, value = 1) {
    switch(type) {
        case 'levelComplete':
            gameState.gameStats.totalLevelsCompleted += value;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàêÊâÄÊúâÂÖ≥Âç°
            if (gameState.gameStats.totalLevelsCompleted == 80) {
                gameState.achievements.allLevelsCompleted = true;
                showAchievementUnlocked('Ëø∑ÂÆ´Â§ßÂ∏à', 'ÊÅ≠Âñú‰Ω†ÈÄöÂÖ≥ÊâÄÊúâÂÖ≥Âç°ÔºÅ');
            }
            break;
            
        case 'multiplayerWin':
            gameState.achievements.multiplayerWins += value;
            
            if (gameState.achievements.multiplayerWins == 10) {
                showAchievementUnlocked('Á§æ‰∫§Ëææ‰∫∫', 'ÂÆåÊàê10Ê¨°Â§ö‰∫∫ËÅîÊú∫ÊåëÊàòÔºÅ');
            }
            break;
            
        case 'trapHit':
            gameState.achievements.trapHits += value;
            
            if (gameState.achievements.trapHits == 30) {
                showAchievementUnlocked('Èô∑Èò±‰∏ìÂÆ∂', 'ÊàêÂäüË∏©‰∏≠Èô∑Èò±30Ê¨°ÔºÅ');
            }
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const trapHitElement = document.getElementById('trapHit');
            if (trapHitElement) {
                trapHitElement.textContent = `Èô∑Èò±Ëß¶Âèë: ${gameState.achievements.trapHits}`;
            }
            break;
    }
    
    saveGameData();
    updateAchievementProgress();
}

// ÊòæÁ§∫ÊàêÂ∞±Ëß£ÈîÅÊèêÁ§∫
function showAchievementUnlocked(title, description) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        border: 3px solid #FFD700;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        z-index: 10000;
        animation: popIn 0.5s ease-out;
    `;
    
    notification.innerHTML = `
        <h3 style="color: #FFD700; margin: 0 0 10px 0;">üèÜ ÊàêÂ∞±Ëß£ÈîÅÔºÅ</h3>
        <h4 style="color: white; margin: 0 0 10px 0;">${title}</h4>
        <p style="color: #ccc; margin: 0;">${description}</p>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Â≠òÊ°£Á≥ªÁªü
// Êñ∞Â¢ûÂà†Èô§Â≠òÊ°£ÂäüËÉΩ
function deleteSave(slot) {
    gameState.saveSlots[slot] = {};
    localStorage.setItem('saveSlots', JSON.stringify(gameState.saveSlots));
    showNotification(`Â≠òÊ°£‰ΩçÁΩÆ ${slot + 1} Â∑≤Âà†Èô§`);
}

// ‰øÆÊîπ‰øùÂ≠òÊ∏∏ÊàèÂáΩÊï∞ - Á°Æ‰øù‰øùÂ≠òÁé©ÂÆ∂‰ΩçÁΩÆ
function saveGame() {
    const slot = 0; // ÈªòËÆ§‰ΩøÁî®Á¨¨‰∏Ä‰∏™Â≠òÊ°£ÊßΩ‰Ωç
    // ‰øùÂ≠òÊ†∏ÂøÉËøõÂ∫¶Êï∞ÊçÆÂíåÂΩìÂâçÁé©ÂÆ∂‰ΩçÁΩÆ
    const saveData = {
        unlockedLevel: gameState.unlockedLevel,
        completedLevels: gameState.completedLevels,
        achievements: gameState.achievements,
        gameStats: gameState.gameStats,
        currentLevel: gameState.currentLevel,
        playerData: {
            x: singlePlayerGame.player.x,
            y: singlePlayerGame.player.y,
            hasKey: singlePlayerGame.hasKey
        },
        mazeState: JSON.parse(JSON.stringify(singlePlayerGame.maze)), // ‰øùÂ≠òËø∑ÂÆ´Áä∂ÊÄÅ
        timestamp: new Date().getTime() // Ê∑ªÂä†Êó∂Èó¥Êà≥Áî®‰∫éÊü•ÊâæÊúÄËøëÂ≠òÊ°£
    };
    
    gameState.saveSlots[slot] = saveData;
    localStorage.setItem('saveSlots', JSON.stringify(gameState.saveSlots));
    // ÁßªÈô§ÈÄöÁü•ÔºåËá™Âä®Â≠òÊ°£Êó†ÈúÄÁî®Êà∑ÂèçÈ¶à
}

// Ê≠£Á°ÆÂä†ËΩΩÁé©ÂÆ∂‰ΩçÁΩÆ
function loadGame() {
    const slot = 0; // ÈªòËÆ§‰ΩøÁî®Á¨¨‰∏Ä‰∏™Â≠òÊ°£ÊßΩ‰Ωç
    const saveData = gameState.saveSlots[slot];
    if (!saveData) return false;
    
    // ËÆæÁΩÆÂä†ËΩΩÂ≠òÊ°£Ê†áÂøó
    gameState.isLoadingSave = true;
    
    // ÊÅ¢Â§çÊ∏∏ÊàèÁä∂ÊÄÅ
    gameState.unlockedLevel = saveData.unlockedLevel;
    gameState.completedLevels = saveData.completedLevels;
    gameState.achievements = saveData.achievements;
    gameState.gameStats = saveData.gameStats;
    gameState.currentLevel = saveData.currentLevel;
    
    // ÊÅ¢Â§çÁé©ÂÆ∂‰ΩçÁΩÆÂíåÁä∂ÊÄÅ
    if (saveData.playerData) {
        singlePlayerGame.player.x = saveData.playerData.x;
        singlePlayerGame.player.y = saveData.playerData.y;
        singlePlayerGame.hasKey = saveData.playerData.hasKey || false;
    } else {
        // ÂÖºÂÆπÊóßÂ≠òÊ°£
        singlePlayerGame.player.x = 1;
        singlePlayerGame.player.y = 1;
        singlePlayerGame.hasKey = false;
    }
    
    // ÊÅ¢Â§çËø∑ÂÆ´Áä∂ÊÄÅ
    if (saveData.mazeState) {
        singlePlayerGame.maze = saveData.mazeState;
        
        // ÊÅ¢Â§çÈí•ÂåôÂíåÈó®ÁöÑ‰ΩçÁΩÆÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        if (saveData.playerData && saveData.playerData.hasKey) {
            // Êü•ÊâæÈí•Âåô‰ΩçÁΩÆÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            for (let y = 0; y < singlePlayerGame.maze.length; y++) {
                for (let x = 0; x < singlePlayerGame.maze[y].length; x++) {
                    if (singlePlayerGame.maze[y][x] === 8) {
                        singlePlayerGame.keyPosition = {x, y};
                        break;
                    }
                }
            }
            
            // Êü•ÊâæÈó®‰ΩçÁΩÆÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            for (let y = 0; y < singlePlayerGame.maze.length; y++) {
                for (let x = 0; x < singlePlayerGame.maze[y].length; x++) {
                    if (singlePlayerGame.maze[y][x] === 9) {
                        singlePlayerGame.doorPosition = {x, y};
                        break;
                    }
                }
            }
        }
    }
    
    // ÁßªÈô§ÈÄöÁü•ÔºåËá™Âä®Âä†ËΩΩÊó†ÈúÄÁî®Êà∑ÂèçÈ¶à
    
    return true;
}



// Ê∑ªÂä†ÈÄöÁü•ÊòæÁ§∫ÂäüËÉΩ
function showNotification(message, duration = 2000) {
    // ÁßªÈô§Áé∞ÊúâÁöÑÈÄöÁü•
    const existingNotification = document.getElementById('gameNotification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•ÂÖÉÁ¥†
    const notification = document.createElement('div');
    notification.id = 'gameNotification';
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    // Ëá™Âä®Ê∂àÂ§±
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, duration);

    // Ê∑ªÂä†Âä®ÁîªÂÖ≥ÈîÆÂ∏ß
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
    `;
    document.head.appendChild(style);
}



// ÈÄÄÂá∫Á°ÆËÆ§
function showExitConfirmation() {
    const modal = document.createElement('div');
    modal.id = 'exitConfirmationModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="background: #333; padding: 20px; border-radius: 10px; width: 300px; max-width: 90%;">
            <h3 style="color: white; margin-top: 0; text-align: center;">ÈÄÄÂá∫ÂÖ≥Âç°</h3>
            <p style="color: #ccc; text-align: center;">ÊòØÂê¶Ë¶Å‰øùÂ≠òÂΩìÂâçËøõÂ∫¶Ôºü</p>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button id="saveAndExitBtn" style="padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px;">‰øùÂ≠òÂπ∂ÈÄÄÂá∫</button>
                <button id="exitWithoutSavingBtn" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px;">‰∏ç‰øùÂ≠òÈÄÄÂá∫</button>
                <button id="cancelExitBtn" style="padding: 10px; background: #555; color: white; border: none; border-radius: 5px;">ÂèñÊ∂à</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('saveAndExitBtn').addEventListener('click', () => {
        saveGame();  // ÈÄÄÂá∫Êó∂‰øùÂ≠ò
        showScreen('singlePlayerLevelSelect');
        modal.remove();
    });
    
    document.getElementById('exitWithoutSavingBtn').addEventListener('click', () => {
        showScreen('singlePlayerLevelSelect');
        modal.remove();
    });
    
    document.getElementById('cancelExitBtn').addEventListener('click', () => {
        modal.remove();
    });
}

function handleMultiplayerData(data, peerId) {
            if (peerId === gameState.multiplayer.currentPlayerId && (data.type !== 'game-state')) {
                return;
            }
            switch(data.type) {
                case 'private-message':
                    // Êî∂Âà∞ÁßÅËÅäÊ∂àÊÅØ
                    console.log(data);
                    const sender = gameState.multiplayer.players[data.from];
                    if (sender) {
                        const msg = `${data.message}`;
                        showMessageToSelf(msg);
                        alert(msg); // ÂºπÂá∫ÊèêÁ§∫
                    }
                    break;
                case 'chat-message':
                    // Êî∂Âà∞ËÅäÂ§©Ê∂àÊÅØ
                    const chatSender = gameState.multiplayer.players[data.from];
                    if (chatSender) {
                        // ‰ΩøÁî®Ê∂àÊÅØ‰∏≠Êê∫Â∏¶ÁöÑÈ¢úËâ≤ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Áé©ÂÆ∂ÈªòËÆ§È¢úËâ≤
                        const messageColor = data.color || chatSender.color;
                        addChatMessage(chatSender.name, data.message, messageColor, null, data.messageId);
                    }
                    break;
                case 'chat-image':
                    // Êî∂Âà∞ÂõæÁâáÊ∂àÊÅØ
                    const imageSender = gameState.multiplayer.players[data.from];
                    if (imageSender) {
                        addChatMessage(imageSender.name, null, imageSender.color, data.image, data.messageId);
                    }
                    break;
                case 'voice-message':
                    // Êî∂Âà∞ËØ≠Èü≥Ê∂àÊÅØ
                    const voiceSender = gameState.multiplayer.players[data.from];
                    if (voiceSender) {
                        addVoiceMessage(voiceSender.name, data.voice, data.duration, data.messageId);
                    }
                    break;
                case 'room-full':
                    disconnectMultiplayer();
                    showScreen('multiplayerSetup');
                    alert('ÊàøÈó¥Â∑≤Êª°ÔºåÊó†Ê≥ïÂä†ÂÖ•');
                    break;
                case 'password-error':
                    disconnectMultiplayer();
                    showScreen('multiplayerSetup');
                    alert('ÂØÜÁ†ÅÈîôËØØÔºåÊó†Ê≥ïÂä†ÂÖ•ÊàøÈó¥');
                    break;
                case 'door-open':
                        gameState.multiplayer.maze[data.y][data.x] = 0;
                        document.getElementById('unlockTimer').classList.add('hidden');
                        gameState.multiplayer.isUnlocking = false;
                        drawMultiplayerMaze();
                    break;  
                case 'player-join':
                    // Êñ∞Áé©ÂÆ∂Âä†ÂÖ•
                    console.log(data);
                    
                    // ÂØÜÁ†ÅÈ™åËØÅ
                    if (gameState.multiplayer.isHost && gameState.multiplayer.roomPassword) {
                        const receivedPassword = data.password || '';
                        if (receivedPassword !== gameState.multiplayer.roomPassword) {
                            console.log('ÂØÜÁ†ÅÈ™åËØÅÂ§±Ë¥•:', receivedPassword, 'È¢ÑÊúü:', gameState.multiplayer.roomPassword);
                            gameState.multiplayer.connections[peerId].send({
                                type: 'password-error',
                                message: 'ÂØÜÁ†ÅÈîôËØØÔºåÊó†Ê≥ïÂä†ÂÖ•ÊàøÈó¥'
                            });
                            gameState.multiplayer.connections[peerId].close();
                            delete gameState.multiplayer.connections[peerId];
                            return;
                        }
                    }
                    
                    addPlayer(data.player);
                    // Â¶ÇÊûúÊòØ‰∏ªÊú∫ÔºåÂèëÈÄÅÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅÁªôÊñ∞Áé©ÂÆ∂
                    if (gameState.multiplayer.isHost) {
                        gameState.multiplayer.connections[peerId].send({
                            type: 'game-state',
                            maze: gameState.multiplayer.maze,
                            players: gameState.multiplayer.players,
                            exit: gameState.multiplayer.exit,
                            teleporters: gameState.multiplayer.teleporters,
                            maxPlayers: gameState.multiplayer.maxPlayers,
                            protectedPlayers: gameState.multiplayer.protectedPlayers
                        });
                    }
                    drawMultiplayerMaze();
                    break;
                case 'key-pickup':
                    if (gameState.multiplayer.players[data.playerId]) {
                        gameState.multiplayer.players[data.playerId].hasKey = true;
                        delete gameState.multiplayer.keyPosition;
                        drawMultiplayerMaze();
                    }
                    break;
                case 'game-state':
                        // Êî∂Âà∞Ê∏∏ÊàèÁä∂ÊÄÅÔºàÂÆ¢Êà∑Á´ØÔºâ
                        gameState.multiplayer.maze = data.maze;
                        gameState.multiplayer.players = data.players;
                        gameState.multiplayer.exit = data.exit;
                        gameState.multiplayer.teleporters = data.teleporters;
                        gameState.multiplayer.movingEnemies = data.movingEnemies || [];
                        gameState.multiplayer.keyPosition = data.keyPosition || null;
                        gameState.multiplayer.doorPosition = data.doorPosition || null;
                        gameState.multiplayer.maxPlayers = data.maxPlayers;
                        gameState.multiplayer.protectedPlayers = data.protectedPlayers || {};
                        
                        // Ê∑ªÂä†Ëá™Â∑±Âà∞Áé©ÂÆ∂ÂàóË°®
                        if (!gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]) {
                            gameState.multiplayer.players[gameState.multiplayer.currentPlayerId] = {
                                id: gameState.multiplayer.currentPlayerId,
                                name: gameState.playerName,
                                x: 1,
                                y: 1,
                                color: getRandomColor(),
                                reachedExit: false
                            };
                        }
                        
                        // ÂºÄÂßãÊ∏∏Êàè
                        startMultiplayerGame();
                        break;
                    
                case 'enemy-move':
                    // Êõ¥Êñ∞Êïå‰∫∫‰ΩçÁΩÆ
                    if (data.enemies) {
                        gameState.multiplayer.movingEnemies = data.enemies;
                        drawMultiplayerMaze();
                    }
                    break;
                case 'player-move':
                    if (peerId === gameState.multiplayer.currentPlayerId) {
                        break;
                    }
                    // Áé©ÂÆ∂ÁßªÂä®
                    if (gameState.multiplayer.players[peerId]) {
                        gameState.multiplayer.players[peerId].x = data.x;
                        gameState.multiplayer.players[peerId].y = data.y;
                        
                        // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
                        if (data.x === gameState.multiplayer.exit.x && 
                            data.y === gameState.multiplayer.exit.y) {
                            gameState.multiplayer.players[peerId].reachedExit = true;
                            
                            // ÂπøÊí≠Áé©ÂÆ∂Âà∞ËææÂá∫Âè£
                            broadcast({
                                type: 'player-reached-exit',
                                playerId: peerId
                            });
                        }
                        
                        drawMultiplayerMaze();
                        updatePlayerList();
                    }
                    break;
                case 'key-pickup':
                        if (gameState.multiplayer.players[data.playerId]) {
                            gameState.multiplayer.players[data.playerId].hasKey = true;
                            delete gameState.multiplayer.keyPosition;
                            drawMultiplayerMaze();
                        }
                        break;
                        
                case 'door-open':
                        gameState.multiplayer.maze[data.y][data.x] = 0;
                        drawMultiplayerMaze();
                        break;
                        
                case 'enemy-move':
                        if (gameState.multiplayer.movingEnemies) {
                            gameState.multiplayer.movingEnemies = data.enemies;
                            drawMultiplayerMaze();
                        }
                        break;    
                case 'teleport-request':
                    // Â§ÑÁêÜ‰º†ÈÄÅËØ∑Ê±ÇÔºàÂè™Êúâ‰∏ªÊú∫‰ºöÊî∂Âà∞Ôºâ
                    console.log(data);
                    if (gameState.multiplayer.isHost) {
                        const teleporter = gameState.multiplayer.teleporters.find(t => 
                            t.x === data.teleporterX && t.y === data.teleporterY);
                        
                        if (teleporter && gameState.multiplayer.players[data.playerId]) {
                            // ‰º†ÈÄÅÁé©ÂÆ∂
                            gameState.multiplayer.players[data.playerId].x = teleporter.pairX;
                            gameState.multiplayer.players[data.playerId].y = teleporter.pairY;
                            
                            // ÂπøÊí≠‰º†ÈÄÅ
                            broadcast({
                                type: 'player-teleport',
                                playerId: data.playerId,
                                x: teleporter.pairX,
                                y: teleporter.pairY
                            });
                            
                            drawMultiplayerMaze();
                            updatePlayerList();
                        }
                    }
                    break;
                    
                case 'player-teleport':
                    console.log(data);
                    // Â§ÑÁêÜÁé©ÂÆ∂‰º†ÈÄÅ
                    if (gameState.multiplayer.players[data.playerId]) {
                        gameState.multiplayer.players[data.playerId].x = data.x;
                        gameState.multiplayer.players[data.playerId].y = data.y;
                        drawMultiplayerMaze();
                        updatePlayerList();
                    }
                    break;
                    
                case 'player-reached-exit':
                    console.log(data);
                    // Áé©ÂÆ∂Âà∞ËææÂá∫Âè£
                    if (gameState.multiplayer.players[data.playerId]) {
                        gameState.multiplayer.players[data.playerId].reachedExit = true;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÁé©ÂÆ∂ÈÉΩÂà∞ËææÂá∫Âè£
                        checkAllPlayersReachedExit();
                        
                        updatePlayerList();
                    }
                    break;
                    
                case 'player-joined':
                    console.log(data);
                    // Êñ∞Áé©ÂÆ∂Âä†ÂÖ•ÈÄöÁü•
                    if (!gameState.multiplayer.players[data.player.id]) {
                        gameState.multiplayer.players[data.player.id] = data.player;
                        updatePlayerList();
                        drawMultiplayerMaze();
                    }
                    break;
                    
                case 'player-kicked':
                    console.log(data);
                    // Áé©ÂÆ∂Ë¢´Ë∏¢Âá∫ÈÄöÁü•
                    if (data.playerId === gameState.multiplayer.currentPlayerId) {
                        alert(`‰Ω†Â∑≤Ë¢´ÁÆ°ÁêÜÂëòË∏¢Âá∫ÊàøÈó¥${data.reason ? `ÔºåÂéüÂõ†Ôºö${data.reason}` : ''}`);
                        disconnectMultiplayer();
                        showScreen('mainMenu'); // Áõ¥Êé•ËøîÂõû‰∏ªÈ°µÈù¢
                    } else {
                        removePlayer(data.playerId);
                    }
                    break;
                    
                case 'player-protected':
                    console.log(data);
                    // Áé©ÂÆ∂‰øùÊä§Áä∂ÊÄÅÊõ¥Êñ∞
                    if (data.protected) {
                        gameState.multiplayer.protectedPlayers[data.playerId] = true;
                    } else {
                        delete gameState.multiplayer.protectedPlayers[data.playerId];
                    }
                    updatePlayerList();
                    break;
                case 'music-command':
                    console.log(data);
                    // Èü≥‰πêÊéßÂà∂ÂëΩ‰ª§
                    const audio = document.getElementById('gameAudio');
                    if (audio) {
                        if (data.command === 'play') {
                            // Â¶ÇÊûúÊúâBase64Èü≥È¢ëÊï∞ÊçÆÔºå‰ΩøÁî®Base64Êï∞ÊçÆ
                            if (data.audioData) {
                                audio.src = data.audioData;
                            }
                            // Â¶ÇÊûúÊúâURLÂèÇÊï∞ÔºåÊõ¥Êñ∞Èü≥È¢ëÊ∫ê
                            else if (data.url) {
                                audio.src = data.url;
                            }
                            // Â∞ùËØïÊí≠ÊîæÈü≥‰πê
                            audio.play()
                                .then(() => {
                                    // Êí≠ÊîæÊàêÂäü
                                    const musicInfo = data.fileName || data.url || 'Èü≥‰πê';
                                    addChatMessage('Á≥ªÁªü', `ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ: ${musicInfo}`, '#4CAF50');
                                })
                                .catch(error => {
                                    console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error);
                                    // Á¨¨‰∏ÄÊ¨°Êí≠ÊîæÂ§±Ë¥•ÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                                    const musicUrl = data.audioData || data.url;
                                    showMusicPlayConfirmModal(musicUrl);
                                });
                        } else if (data.command === 'stop') {
                            audio.pause();
                            audio.currentTime = 0;
                            addChatMessage('Á≥ªÁªü', 'ËÉåÊôØÈü≥‰πêÂ∑≤ÂÅúÊ≠¢', '#4CAF50');
                        }
                    }
                    break;
                    
                case 'chat-recall':
                    console.log(data);
                    // Â§ÑÁêÜÊ∂àÊÅØÊí§Âõû
                    const chatContainers = [
                        document.getElementById('chatMessages'),
                        document.getElementById('chatMessagesModal')
                    ];
                    
                    chatContainers.forEach(chatMessages => {
                        if (chatMessages) {
                            const messageElement = chatMessages.querySelector(`[data-message-id="${data.messageId}"]`);
                            if (messageElement) {
                                // Ê£ÄÊü•ÊòØÂê¶ÊòØËá™Â∑±ÁöÑÊ∂àÊÅØ
                                const isOwnMessage = messageElement.dataset.sender === gameState.multiplayer.currentPlayerId;
                                
                                if (isOwnMessage) {
                                    // Ëá™Â∑±ÁöÑÊ∂àÊÅØÔºöÊòæÁ§∫Êí§ÂõûÊèêÁ§∫
                                    messageElement.innerHTML = '<strong>Á≥ªÁªüÊ∂àÊÅØ:</strong> Ê∂àÊÅØÂ∑≤Êí§Âõû';
                                    messageElement.style.color = '#888';
                                    
                                    // 3ÁßíÂêéËá™Âä®Âà†Èô§Êí§ÂõûÊèêÁ§∫
                                    setTimeout(() => {
                                        if (messageElement.parentElement) {
                                            messageElement.parentElement.removeChild(messageElement);
                                        }
                                    }, 3000);
                                } else {
                                    // Âà´‰∫∫ÁöÑÊ∂àÊÅØÔºöÈöêËóèÂÜÖÂÆπÂπ∂ÊòæÁ§∫Êí§ÂõûÈÄöÁü•
                                    // ÈöêËóèÊâÄÊúâÂ≠êÂÖÉÁ¥†ÔºàÊñáÊú¨„ÄÅÂõæÁâá„ÄÅÈü≥È¢ë„ÄÅÊåâÈíÆÔºâ
                                    const allChildren = messageElement.children;
                                    for (let i = 0; i < allChildren.length; i++) {
                                        allChildren[i].style.display = 'none';
                                    }
                                    
                                    // ÊòæÁ§∫Êí§ÂõûÈÄöÁü•
                                    const senderName = gameState.multiplayer.players[data.from]?.name || 'Áé©ÂÆ∂';
                                    messageElement.innerHTML = `<strong>Á≥ªÁªüÊ∂àÊÅØ:</strong> ${senderName} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
                                    
                                    // 3ÁßíÂêéËá™Âä®Âà†Èô§Êí§ÂõûÊèêÁ§∫
                                    setTimeout(() => {
                                        if (messageElement.parentElement) {
                                            messageElement.parentElement.removeChild(messageElement);
                                        }
                                    }, 3000);
                                }
                            }
                        }
                    });
                    break;
                    
                case 'kick-player':
                    console.log(data);
                    // Ë∏¢Âá∫Áé©ÂÆ∂ËØ∑Ê±ÇÔºàÂè™Êúâ‰∏ªÊú∫‰ºöÊî∂Âà∞Ôºâ
                    if (gameState.multiplayer.isHost) {
                        const playerId = data.playerId;
                        const reason = data.reason || 'Êú™Áü•ÂéüÂõ†';
                        
                        // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§
                        if (gameState.multiplayer.protectedPlayers[playerId]) {
                            // ÂèëÈÄÅË∏¢Âá∫Â§±Ë¥•Ê∂àÊÅØ
                            gameState.multiplayer.connections[data.requestorId].send({
                                type: 'kick-failed',
                                playerId: playerId,
                                reason: 'err75937'
                            });
                        } else {
                            // Ë∏¢Âá∫Áé©ÂÆ∂
                            kickPlayer(playerId, reason);
                        }
                    }
                    break;
                    
                case 'kick-failed':
                    console.log(data);
                    // Ë∏¢Âá∫Â§±Ë¥•ÈÄöÁü•
                    alert(`Ë∏¢Âá∫Áé©ÂÆ∂Â§±Ë¥•: ${data.reason}`);
                    break;
            }
        }

        function addPlayer(player) {
            gameState.multiplayer.players[player.id] = {
                ...player,
                x: 1,
                y: 1,
                reachedExit: false
            };
            
            // ÂπøÊí≠Êñ∞Áé©ÂÆ∂Âä†ÂÖ•ÔºàÈô§‰∫ÜËá™Â∑±Ôºâ
            broadcast({
                type: 'player-joined',
                player: gameState.multiplayer.players[player.id]
            }, player.id);
            
            updatePlayerList();
            drawMultiplayerMaze();
        }

        function removePlayer(playerId) {
            delete gameState.multiplayer.players[playerId];
            delete gameState.multiplayer.connections[playerId];
            delete gameState.multiplayer.protectedPlayers[playerId];
            
            updatePlayerList();
            drawMultiplayerMaze();
        }


function broadcast(data, excludePlayerId = null) {
    for (const connId in gameState.multiplayer.connections) {
        if (connId !== excludePlayerId) {
            const connection = gameState.multiplayer.connections[connId];
            if (connection.open) {  // Âè™ÊúâËøûÊé•ÊâìÂºÄÊó∂ÊâçÂèëÈÄÅ
                try {
                    connection.send(data);
                } catch (err) {
                    console.error('ÂπøÊí≠ÈîôËØØ:', err);
                    // Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•ÔºåÂ§ÑÁêÜËøûÊé•Â§±ÊïàÁöÑÊÉÖÂÜµ
                    removePlayer(connId);
                }
            }
        }
    }
}

        function startMultiplayerGame() {
            gameState.multiplayer.connected = true;
            gameState.multiplayer.moveCount = 0;
            gameState.multiplayer.hasKey = false;
            gameState.multiplayer.isUnlocking = false;
            gameState.multiplayer.unlockTimeLeft = 10;
            clearInterval(gameState.multiplayer.unlockTimer);
            
            // Â¶ÇÊûúÊòØËû∫ÊóãËø∑ÂÆ´ÔºåÊòæÁ§∫Êïå‰∫∫Ë≠¶Âëä
            if (gameState.multiplayer.movingEnemies) {
                document.getElementById('enemyInfo').classList.remove('hidden');
                document.getElementById('keyInfo').classList.remove('hidden');
            } else {
                document.getElementById('enemyInfo').classList.add('hidden');
                document.getElementById('keyInfo').classList.add('hidden');
            }
                    
            // ËÆæÁΩÆÊàøÈó¥‰ª£Á†ÅÊòæÁ§∫
            document.getElementById('multiplayerRoomCode').textContent = 
                `ÊàøÈó¥: ${gameState.multiplayer.roomCode}`;
            document.getElementById('multiplayerMoveCount').textContent = `ÁßªÂä®: 0`;
            updatePlayerCount();

            // ÂàùÂßãÂåñÁîªÂ∏É
            console.log("ÂàùÂßãÂåñÁîªÂ∏É")
            initMultiplayerCanvas();
            // ÂºÄÂßãËÆ°Êó∂
            console.log("ÂºÄÂßãËÆ°Êó∂")
            startMultiplayerTimer();
            
            // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
            console.log("Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ")
            updateConnectionStatus('connected');
            
            // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
            console.log("ÊòæÁ§∫Ê∏∏ÊàèÁîªÈù¢")
            showScreen('multiplayerGame');
            
            // ÁßªÈô§Âçï‰∫∫Ê∏∏ÊàèÁöÑÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜ
            window.removeEventListener('keydown', handleSinglePlayerKeyDown);
            
            // Ê∑ªÂä†Â§ö‰∫∫Ê∏∏ÊàèÁöÑÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Âô®
            window.addEventListener('keydown', handleMultiplayerKeyDown);

            function gameLoop() {
                // updateMultiplayerGame();
                EventSystem.update();
                requestAnimationFrame(gameLoop);
            }
            
            // ÂêØÂä®Ê∏∏ÊàèÂæ™ÁéØ
            gameLoop();
            // Â∫îÁî®UIËÆæÁΩÆ
            console.log("Â∫îÁî®UIËÆæÁΩÆ")
            applyUISettings();
        }

function handleMultiplayerMoveLogic(dx, dy) {
    // 1. Ëé∑ÂèñÂΩìÂâçÂõûÂêàÁöÑÁé©ÂÆ∂ÂØπË±°
    const currentPlayer = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
    if (!currentPlayer || currentPlayer.reachedExit) {
        return; // Â¶ÇÊûúÁé©ÂÆ∂‰∏çÂ≠òÂú®ÊàñÂ∑≤ÁªèÂà∞ËææÁªàÁÇπÔºåÂàô‰∏çÂÅö‰ªª‰Ωï‰∫ã
    }

    // 2. ËÆ°ÁÆóÊñ∞ÁöÑÁõÆÊ†á‰ΩçÁΩÆ
    const newX = currentPlayer.x + dx;
    const newY = currentPlayer.y + dy;

    // 3. ËæπÁïåÊ£ÄÊü•
    if (newY < 0 || newY >= gameState.multiplayer.maze.length || 
        newX < 0 || newX >= gameState.multiplayer.maze[0].length) {
        return;
    }

    const cellValue = gameState.multiplayer.maze[newY][newX];
    
    // 4. ËßÑÂàôÊ£ÄÊü•
    // --------------------------------------------------

    // 4.1 Â¢ô
    if (cellValue === 1) return;

    // 4.2 Èô∑Èò±
    if (cellValue === 2) {
        // Â¶ÇÊûúÁé©ÂÆ∂ÊòØ‰∏ªÊú∫‰∏îÂèó‰øùÊä§ÔºàÊó†ÊïåÔºâÔºåÂàôÂøΩÁï•Èô∑Èò±
        if (currentPlayer.isHost && gameState.multiplayer.protectedPlayers[currentPlayer.id]) {
            console.log('‰∏ªÊú∫Áé©ÂÆ∂Êó†ÊïåÔºåÊó†ËßÜÈô∑Èò±');
        } else {
            // ÊôÆÈÄöÁé©ÂÆ∂ÔºåÂõûÂà∞Ëµ∑ÁÇπ
            currentPlayer.x = 1;
            currentPlayer.y = 1;
            gameState.multiplayer.moveCount++;
            document.getElementById('multiplayerMoveCount').textContent = `ÁßªÂä®: ${gameState.multiplayer.moveCount}`;
            console.log('Ë∏©Âà∞Èô∑Èò±ÔºåÂõûÂà∞Ëµ∑ÁÇπÔºÅ');
            
            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç 1„ÄëÂç≥‰ΩøÂõûÂà∞Ëµ∑ÁÇπÔºå‰πüÈúÄË¶ÅÂπøÊí≠ËøôÊ¨°ÁßªÂä®Ôºå‰ª•Êõ¥Êñ∞ÊâÄÊúâÁé©ÂÆ∂ÁöÑËßÜÂõæ
            if (currentPlayer.isHost) {
                // ‰∏ªÊú∫Áé©ÂÆ∂ÁßªÂä®ÂêéÔºåÈúÄË¶ÅÊõ¥Êñ∞ÊâÄÊúâÁé©ÂÆ∂ÁöÑËßÜÂõæ
                broadcast({
                    type: 'player-move',
                    playerId: currentPlayer.id,
                    x: currentPlayer.x,
                    y: currentPlayer.y
                });
            } else {
                // ÊôÆÈÄöÁé©ÂÆ∂Âè™ÈúÄË¶ÅÊõ¥Êñ∞Ëá™Â∑±ÁöÑËßÜÂõæ
                drawMultiplayerMaze();
                updatePlayerList();
            }
            return; // Èô∑Èò±Â§ÑÁêÜÁªìÊùüÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ÈÄªËæë
        }
    }
    
    // 4.3 ‰º†ÈÄÅÈó®
    if (cellValue === 3) {
        // ÊâæÂà∞‰º†ÈÄÅÈó®ÂØπË±°
        const teleporter = gameState.multiplayer.teleporters.find(t => t.x === newX && t.y === newY);
        if (teleporter) {
            // ÊâßË°å‰º†ÈÄÅ
            currentPlayer.x = teleporter.pairX;
            currentPlayer.y = teleporter.pairY;
            
            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç 2„Äë‰º†ÈÄÅÊìç‰ΩúÂÆåÊàêÂêéÔºåÂøÖÈ°ªÂπøÊí≠Êñ∞‰ΩçÁΩÆ
            broadcast({
                type: 'player-teleport',
                playerId: currentPlayer.id,
                x: currentPlayer.x,
                y: currentPlayer.y
            });
            
            gameState.multiplayer.moveCount++;
            document.getElementById('multiplayerMoveCount').textContent = `ÁßªÂä®: ${gameState.multiplayer.moveCount}`;
            
            console.log('‰º†ÈÄÅ!');

            drawMultiplayerMaze();
            updatePlayerList();
            // ‰º†ÈÄÅÂêéÊ£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
            checkPlayerAtExit(currentPlayer);
            return; // ‰º†ÈÄÅÈÄªËæëÁªìÊùü
        }
    }

    // 4.4 Èí•Âåô
    if (cellValue === 8) {
        // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§ÔºåÈò≤Ê≠¢ÂÖ∂‰ªñÁé©ÂÆ∂ÂÅ∑Èí•Âåô
        if (gameState.multiplayer.protectedPlayers[currentPlayer.id]) {
            console.log('Áé©ÂÆ∂Âèó‰øùÊä§ÔºåÂÖ∂‰ªñÁé©ÂÆ∂Êó†Ê≥ïÊç°Èí•Âåô');
        } else {
            currentPlayer.hasKey = true;
            gameState.multiplayer.maze[newY][newX] = 0; // ÁßªÈô§Èí•Âåô
            delete gameState.multiplayer.keyPosition;

            // ÂπøÊí≠Èí•ÂåôÊãæÂèñ‰∫ã‰ª∂
            broadcast({
                type: 'key-pickup',
                playerId: currentPlayer.id
            });
            console.log('ÊãøÂà∞Èí•Âåô!');
        }
    }

    // 4.5 Èó®
    if (cellValue === 9) {
        if (currentPlayer.hasKey) {
            startMultiplayerUnlockDoor();
            return; // ÂºÄÈó®ÂÄíËÆ°Êó∂ÂºÄÂßãÔºåÊú¨Ê¨°ÁßªÂä®ÁªìÊùü
        } else {
            alert("‰Ω†ÈúÄË¶ÅÈí•ÂåôÊâçËÉΩÊâìÂºÄËøôÊâáÈó®ÔºÅ");
            return; // Ê≤°ÊúâÈí•ÂåôÔºåÂºÄÈó®Â§±Ë¥•ÔºåÊú¨Ê¨°ÁßªÂä®ÁªìÊùü
        }
    }

    // 5. ÊâßË°åÊ†áÂáÜÁßªÂä®
    // --------------------------------------------------
    // Â¶ÇÊûúÈÄöËøá‰∫ÜÊâÄÊúâÊ£ÄÊü•ÔºåËØ¥ÊòéÊòØÊúâÊïàÁöÑÊôÆÈÄöÁßªÂä®
    currentPlayer.x = newX;
    currentPlayer.y = newY;
    
    gameState.multiplayer.moveCount++;
    document.getElementById('multiplayerMoveCount').textContent = `ÁßªÂä®: ${gameState.multiplayer.moveCount}`;
    
    // ÂπøÊí≠ÁßªÂä®
    broadcast({
        type: 'player-move',
        playerId: currentPlayer.id,
        x: currentPlayer.x,
        y: currentPlayer.y
    });
    
    console.log('ÁßªÂä®!');

    // 6. ÁªòÂà∂UIÂíåÊ£ÄÊü•Âá∫Âè£
    drawMultiplayerMaze();
    updatePlayerList();
    
    // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
    checkPlayerAtExit(currentPlayer);
}

/**
 * Ê£ÄÊü•ÁâπÂÆöÁé©ÂÆ∂ÊòØÂê¶Âà∞Ëææ‰∫ÜÂá∫Âè£ÔºåÂπ∂Ëß¶ÂèëÁõ∏Â∫îÈÄªËæë„ÄÇ
 * @param {object} player - Ë¶ÅÊ£ÄÊü•ÁöÑÁé©ÂÆ∂ÂØπË±°
 */
function checkPlayerAtExit(player) {
    const exit = gameState.multiplayer.exit;
    if (player.x === exit.x && player.y === exit.y) {
        // Áé©ÂÆ∂Âà∞ËææÂá∫Âè£
        player.reachedExit = true;
        console.log(`${player.name} Âà∞Ëææ‰∫ÜÂá∫Âè£ÔºÅ`);

        // ÂπøÊí≠Âà∞ËææÂá∫Âè£‰∫ã‰ª∂
        broadcast({
            type: 'player-reached-exit',
            playerId: player.id
        });

        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâ‰∫∫ÈÉΩÂà∞‰∫Ü
        checkAllPlayersReachedExit();
    }
}

        function initMultiplayerCanvas() {
            const canvas = document.getElementById('multiplayerCanvas');
            const ctx = canvas.getContext('2d');
            
            // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
            console.log("ÂàùÂßãÂåñÁîªÂ∏É")
            const maxWidth = window.innerWidth - 40;
            const maxHeight = window.innerHeight - 180;
            
            // Á°Æ‰øùËø∑ÂÆ´Â∑≤ÂàùÂßãÂåñ
            if (!gameState.multiplayer.maze || gameState.multiplayer.maze.length === 0) {
                console.error("Â§ö‰∫∫Ê∏∏ÊàèËø∑ÂÆ´Êú™ÂàùÂßãÂåñ");
                canvas.width = 300;
                canvas.height = 300;
                return;
            }
            
            const mazeWidth = gameState.multiplayer.maze[0].length;
            const mazeHeight = gameState.multiplayer.maze.length;
            
            const cellSize = Math.min(30, Math.floor(maxWidth / mazeWidth), 
                                     Math.floor(maxHeight / mazeHeight));
            
            canvas.width = mazeWidth * cellSize;
            canvas.height = mazeHeight * cellSize;
            
            // ‰øùÂ≠òÂçïÂÖÉÊ†ºÂ§ßÂ∞è‰æõÂêéÁª≠‰ΩøÁî®
            gameState.multiplayer.cellSize = cellSize;
            
            // ÁªòÂà∂ÂàùÂßãËø∑ÂÆ´
            drawMultiplayerMaze();
            
            // Êõ¥Êñ∞Áé©ÂÆ∂ÂàóË°®
            updatePlayerList();
        }

        function handleMultiplayerKeyDown(e) {
            if (!gameState.multiplayer.connected) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®ËÅäÂ§©ËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•ÔºåÈÅøÂÖçÈòªÊ≠¢ËæìÂÖ•
            const chatInput = document.getElementById('chatInput');
            const chatInputModal = document.getElementById('chatInputModal');
            if ((chatInput && document.activeElement === chatInput) || 
                (chatInputModal && document.activeElement === chatInputModal)) {
                return;
            }
            
            // Âè™Âú®ÊñπÂêëÈîÆÊó∂Â§ÑÁêÜ
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                return;
            }
            
            e.preventDefault();
            const player = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
            if (!player || player.reachedExit) return;
            
            let newX = player.x;
            let newY = player.y;
            
            switch(e.key) {
                case 'ArrowUp': newY--; break;
                case 'ArrowDown': newY++; break;
                case 'ArrowLeft': newX--; break;
                case 'ArrowRight': newX++; break;
                default: return;
            }
            
            // Ê£ÄÊü•ÁßªÂä®ÊòØÂê¶ÊúâÊïà
            if (newX >= 0 && newX < gameState.multiplayer.maze[0].length && 
                newY >= 0 && newY < gameState.multiplayer.maze.length) {
                
                const cellValue = gameState.multiplayer.maze[newY][newX];
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ¢ô
                if (cellValue === 1) return;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÈô∑Èò±
                if (cellValue === 2) {
                    // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§ÔºàÊó†ÊïåÁä∂ÊÄÅÔºâ
                    if (gameState.multiplayer.protectedPlayers[gameState.multiplayer.currentPlayerId]) {
                        // Êó†ÊïåÁä∂ÊÄÅÔºåÂøΩÁï•Èô∑Èò±
                        console.log('Êó†ÊïåÁä∂ÊÄÅÔºåÂøΩÁï•Èô∑Èò±');
                    } else {
                        // ÂõûÂà∞Ëµ∑ÁÇπ
                        player.x = 1;
                        player.y = 1;
                        gameState.multiplayer.moveCount++;
                        document.getElementById('multiplayerMoveCount').textContent = 
                            `ÁßªÂä®: ${gameState.multiplayer.moveCount}`;
                        
                        // ÂπøÊí≠ÁßªÂä®
                        broadcast({
                            type: 'player-move',
                            playerId: gameState.multiplayer.currentPlayerId,
                            x: player.x,
                            y: player.y
                        });
                        
                        drawMultiplayerMaze();
                        
                    }
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰º†ÈÄÅÈó®
                if (cellValue === 3) {
                    // ÊâæÂà∞ÈÖçÂØπÁöÑ‰º†ÈÄÅÈó®
                    const teleporter = gameState.multiplayer.teleporters.find(t => 
                        t.x === newX && t.y === newY);
                    
                    if (teleporter) {
                        // Â¶ÇÊûúÊòØ‰∏ªÊú∫ÔºåÁõ¥Êé•Â§ÑÁêÜ‰º†ÈÄÅ
                        if (gameState.multiplayer.isHost) {
                            newX = teleporter.pairX;
                            newY = teleporter.pairY;
                            
                            player.x = newX;
                            player.y = newY;
                            
                            // ÂπøÊí≠‰º†ÈÄÅ
                            broadcast({
                                type: 'player-teleport',
                                playerId: gameState.multiplayer.currentPlayerId,
                                x: newX,
                                y: newY
                            });
                            drawMultiplayerMaze();
                        } else {
                            // Â¶ÇÊûúÊòØÂÆ¢Êà∑Á´ØÔºåÂêë‰∏ªÊú∫ÂèëÈÄÅ‰º†ÈÄÅËØ∑Ê±Ç
                            const conn = Object.values(gameState.multiplayer.connections)[0];
                            if (conn) {
                                conn.send({
                                    type: 'teleport-request',
                                    playerId: gameState.multiplayer.currentPlayerId,
                                    teleporterX: newX,
                                    teleporterY: newY
                                });
                            }
                            return; // Á≠âÂæÖ‰∏ªÊú∫Â§ÑÁêÜ
                            drawMultiplayerMaze();
                        }
                    }
                } else {
                    // ÊôÆÈÄöÁßªÂä®
                    player.x = newX;
                    player.y = newY;
                }
                
                gameState.multiplayer.moveCount++;
                document.getElementById('multiplayerMoveCount').textContent = 
                    `ÁßªÂä®: ${gameState.multiplayer.moveCount}`;
                
                // ÂπøÊí≠ÁßªÂä®
                broadcast({
                    type: 'player-move',
                    playerId: gameState.multiplayer.currentPlayerId,
                    x: player.x,
                    y: player.y
                });
                drawMultiplayerMaze();
                // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂá∫Âè£
                if (player.x === gameState.multiplayer.exit.x && player.y === gameState.multiplayer.exit.y) {
                    player.reachedExit = true;
                    
                    // ÂπøÊí≠Âà∞ËææÂá∫Âè£
                    broadcast({
                        type: 'player-reached-exit',
                        playerId: gameState.multiplayer.currentPlayerId
                    });
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÁé©ÂÆ∂ÈÉΩÂà∞ËææÂá∫Âè£
                    checkAllPlayersReachedExit();
                }
                drawMultiplayerMaze();
                if (cellValue === 8) {
                    gameState.multiplayer.hasKey = true;
                    // ÁßªÈô§Èí•Âåô
                    gameState.multiplayer.maze[newY][newX] = 0;
                    delete gameState.multiplayer.keyPosition;
                    
                    // ÂπøÊí≠Èí•ÂåôÊãæÂèñ
                    broadcast({
                        type: 'key-pickup',
                        playerId: gameState.multiplayer.currentPlayerId
                    });
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÈó®
                if (cellValue === 9) {
                        if (gameState.multiplayer.hasKey) {
                            // ÂºÄÂßãÂºÄÈó®ÂÄíËÆ°Êó∂
                            startMultiplayerUnlockDoor();
                            
                        } else {
                            // Ê≤°ÊúâÈí•ÂåôÔºå‰∏çËÉΩÈÄöËøá
                            alert("‰Ω†ÈúÄË¶ÅÈí•ÂåôÊâçËÉΩÊâìÂºÄËøôÊâáÈó®ÔºÅ");
                            
                        }
                drawMultiplayerMaze();
                updatePlayerList();
            }
        }
    }
function startUnlockDoor() {
    // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÂÆöÊó∂Âô®
    clearInterval(singlePlayerGame.unlockTimer);
    
    singlePlayerGame.isUnlocking = true;
    singlePlayerGame.unlockTimeLeft = 10;
    document.getElementById('unlockTimer').classList.remove('hidden');
    updateUnlockTimer();
    
    singlePlayerGame.unlockTimer = setInterval(() => {
        singlePlayerGame.unlockTimeLeft--;
        updateUnlockTimer();
        
        if (singlePlayerGame.unlockTimeLeft <= 0) {
            clearInterval(singlePlayerGame.unlockTimer);
            // ÂºÄÈó®ÊàêÂäü
            singlePlayerGame.maze[singlePlayerGame.doorPosition.y][singlePlayerGame.doorPosition.x] = 0;
            document.getElementById('unlockTimer').classList.add('hidden');
            singlePlayerGame.isUnlocking = false;
            
            drawSinglePlayerMaze();
            alert("Èó®Â∑≤ÊâìÂºÄÔºÅÁé∞Âú®‰Ω†ÂèØ‰ª•ËøõÂÖ•Âá∫Âè£‰∫Ü„ÄÇ");
        }
    }, 1000);
}


function startMultiplayerUnlockDoor() {
    // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÂÆöÊó∂Âô®
    clearInterval(gameState.multiplayer.unlockTimer);
    
    gameState.multiplayer.isUnlocking = true;
    gameState.multiplayer.unlockTimeLeft = 10;
    document.getElementById('unlockTimer').classList.remove('hidden');
    updateMultiplayerUnlockTimer();
    
    gameState.multiplayer.unlockTimer = setInterval(() => {
        gameState.multiplayer.unlockTimeLeft--;
        updateMultiplayerUnlockTimer();
        
        if (gameState.multiplayer.unlockTimeLeft <= 0) {
            clearInterval(gameState.multiplayer.unlockTimer);
            // ÂºÄÈó®ÊàêÂäü
            gameState.multiplayer.maze[
                gameState.multiplayer.doorPosition.y][
                gameState.multiplayer.doorPosition.x] = 0;
            document.getElementById('unlockTimer').classList.add('hidden');
            gameState.multiplayer.isUnlocking = false;
            
            // Â¶ÇÊûúÊòØ‰∏ªÊú∫ÔºåÂπøÊí≠ÂºÄÈó®
            if (gameState.multiplayer.isHost) {
                broadcast({
                    type: 'door-open',
                    x: gameState.multiplayer.doorPosition.x,
                    y: gameState.multiplayer.doorPosition.y
                });
            }
            
            drawMultiplayerMaze();
            alert("Èó®Â∑≤ÊâìÂºÄÔºÅ");
        }
    }, 1000);
}

function updateUnlockTimer() {
    document.getElementById('unlockTimer').textContent = 
        `ÂºÄÈó®ÂÄíËÆ°Êó∂: ${singlePlayerGame.unlockTimeLeft}Áßí`;
}

function checkAllPlayersReachedExit() {
    const allReached = Object.values(gameState.multiplayer.players).every(p => p.reachedExit);
    if (allReached) {
        alert('ÊâÄÊúâÁé©ÂÆ∂ÈÉΩÂà∞Ëææ‰∫ÜÂá∫Âè£ÔºÅÊ∏∏ÊàèËÉúÂà©ÔºÅ');
        
        // ËÆ∞ÂΩïÂ§ö‰∫∫Ê∏∏ÊàèÊàêÂ∞±
        recordAchievement('multiplayerWin', 1);
    }
}

// ÂàùÂßãÂåñÂáΩÊï∞
function initializeNewFeatures() {
    updateAchievementProgress();
    
    // Êõ¥Êñ∞ÊåëÊàòÁïåÈù¢Êï∞ÊçÆ
    document.getElementById('timeChallengeBest').textContent = 
        gameState.gameStats.timeChallengeBest > 0 ? 
        gameState.gameStats.timeChallengeBest + 'Áßí' : 'ÊöÇÊó†';
    
    document.getElementById('puzzleCompleted').textContent = 
        gameState.gameStats.puzzleLevelsCompleted + '/10';
    
    
}
// Âú®È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®
window.addEventListener('load', initializeNewFeatures);

        function disconnectMultiplayer() {
            if (gameState.multiplayer.peer) {
                gameState.multiplayer.peer.destroy();
            }
            
            gameState.multiplayer.connected = false;
            gameState.multiplayer.connections = {};
            gameState.multiplayer.players = {};
            gameState.multiplayer.protectedPlayers = {};
            clearInterval(gameState.multiplayer.timerInterval);
            window.removeEventListener('keydown', handleMultiplayerKeyDown);
            showScreen('mainMenu');
            
            // ÊÅ¢Â§çÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆÁä∂ÊÄÅÂπ∂Ê∏ÖÈô§ÊàøÈó¥Áä∂ÊÄÅÊèêÁ§∫
            const startBtn = document.getElementById('multiplayerStartBtn');
            const statusElement = document.getElementById('roomStatus');
            if (startBtn) {
                startBtn.disabled = false;
            }
            if (statusElement) {
                statusElement.textContent = '';
            }
        }

        // ÊàøÈó¥ÊµèËßàÂô®Ê®°ÊÄÅÊ°ÜÈÄªËæë
        function openRoomBrowserModal() {
            console.log('Â∞ùËØïÊâìÂºÄÊàøÈó¥ÊµèËßàÂô®Ê®°ÊÄÅÊ°Ü');
            
            try {
                const modal = document.getElementById('roomBrowserModal');
                if (!modal) {
                    console.error('Êú™ÊâæÂà∞roomBrowserModalÂÖÉÁ¥†');
                    alert('ÊàøÈó¥ÊµèËßàÂô®Êó†Ê≥ïÊâìÂºÄÔºöÊú™ÊâæÂà∞ÂøÖË¶ÅÁöÑÁïåÈù¢ÂÖÉÁ¥†');
                    return;
                }
                
                console.log('ÊâæÂà∞Ê®°ÊÄÅÊ°ÜÂÖÉÁ¥†ÔºåÂΩìÂâçÁ±ªÂêç:', modal.className);
                console.log('ÂΩìÂâçÊòæÁ§∫Áä∂ÊÄÅ:', modal.style.display);
                
                // ÁßªÈô§hiddenÁ±ªÔºåÁ°Æ‰øùÊ®°ÊÄÅÊ°ÜÂèØËßÅ
                if (modal.classList.contains('hidden')) {
                    console.log('ÁßªÈô§hiddenÁ±ª');
                    modal.classList.remove('hidden');
                }
                
                // Âº∫Âà∂ËÆæÁΩÆÊòæÁ§∫Ê†∑Âºè
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                
                console.log('Ê®°ÊÄÅÊ°ÜÊ†∑ÂºèËÆæÁΩÆÂÆåÊàêÔºåÊñ∞ÁöÑÊòæÁ§∫Áä∂ÊÄÅ:', modal.style.display);
                console.log('Êñ∞ÁöÑÁ±ªÂêç:', modal.className);
                
                // Ê£ÄÊü•GAME_SERVER_URLÊòØÂê¶ÂÆö‰πâ
                if (typeof GAME_SERVER_URL === 'undefined') {
                    console.error('GAME_SERVER_URLÊú™ÂÆö‰πâ');
                    const statusElement = document.getElementById('roomBrowserStatus');
                    if (statusElement) {
                        statusElement.textContent = 'ÈÖçÁΩÆÈîôËØØÔºöÊúçÂä°Âô®URLÊú™ÂÆö‰πâ';
                        statusElement.style.color = '#FF5252';
                    }
                    return;
                }
                
                // Âä†ËΩΩÊàøÈó¥ÂàóË°®
                console.log('Ë∞ÉÁî®loadRoomsInModalÂä†ËΩΩÊàøÈó¥ÂàóË°®');
                loadRoomsInModal();
            } catch (error) {
                console.error('ÊâìÂºÄÊàøÈó¥ÊµèËßàÂô®Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('ÊàøÈó¥ÊµèËßàÂô®Êó†Ê≥ïÊâìÂºÄÔºö' + error.message);
            }
        }
        
        function closeRoomBrowserModal() {
            const modal = document.getElementById('roomBrowserModal');
            modal.style.display = 'none';
        }
        
        // ÊàøÈó¥ÊêúÁ¥¢ÂäüËÉΩ
        async function loadRoomsInModal() {
            try {
                const statusElement = document.getElementById('roomBrowserStatus');
                statusElement.textContent = 'Ê≠£Âú®Âä†ËΩΩÊàøÈó¥ÂàóË°®...';
                statusElement.style.color = '#FF9800';
                
                const url = GAME_SERVER_URL + '/api/rooms';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayRoomsInModal(data.rooms);
                    statusElement.textContent = `ÂÖ±ÊâæÂà∞ ${data.rooms.length} ‰∏™ÊàøÈó¥`;
                    statusElement.style.color = '#4CAF50';
                } else {
                    statusElement.textContent = 'Âä†ËΩΩÊàøÈó¥ÂàóË°®Â§±Ë¥•';
                    statusElement.style.color = '#FF5252';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊàøÈó¥ÂàóË°®Â§±Ë¥•:', error);
                const statusElement = document.getElementById('roomBrowserStatus');
                statusElement.textContent = 'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®';
                statusElement.style.color = '#FF5252';
            }
        }
        
        async function searchRoomsInModal() {
            try {
                const searchQuery = document.getElementById('roomBrowserSearch').value.trim();
                const statusElement = document.getElementById('roomBrowserStatus');
                
                if (!searchQuery) {
                    loadRoomsInModal();
                    return;
                }
                
                statusElement.textContent = 'Ê≠£Âú®ÊêúÁ¥¢ÊàøÈó¥...';
                statusElement.style.color = '#FF9800';
                
                const url = GAME_SERVER_URL + '/api/rooms/search?q=' + encodeURIComponent(searchQuery);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayRoomsInModal(data.rooms);
                    statusElement.textContent = `ÊêúÁ¥¢ÁªìÊûú: ${data.rooms.length} ‰∏™ÊàøÈó¥`;
                    statusElement.style.color = '#4CAF50';
                } else {
                    statusElement.textContent = 'ÊêúÁ¥¢Â§±Ë¥•';
                    statusElement.style.color = '#FF5252';
                }
            } catch (error) {
                console.error('ÊêúÁ¥¢ÊàøÈó¥Â§±Ë¥•:', error);
                const statusElement = document.getElementById('roomBrowserStatus');
                statusElement.textContent = 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                statusElement.style.color = '#FF5252';
            }
        }
        
        function displayRoomsInModal(rooms) {
            const roomListElement = document.getElementById('roomBrowserList');
            
            if (rooms.length === 0) {
                roomListElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 16px;">Ê≤°ÊúâÊâæÂà∞ÊàøÈó¥</div>';
                return;
            }
            
            roomListElement.innerHTML = '';
            
            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                
                const roomInfo = document.createElement('div');
                roomInfo.className = 'room-info';
                
                const roomName = document.createElement('div');
                roomName.className = 'room-name';
                roomName.textContent = room.name;
                
                const roomHost = document.createElement('div');
                roomHost.className = 'room-host';
                roomHost.textContent = `Êàø‰∏ª: ${room.hostName}`;
                
                const roomPlayers = document.createElement('div');
                roomPlayers.className = 'room-players';
                roomPlayers.textContent = `${room.players}/${room.maxPlayers} ‰∫∫`;
                
                const statusSpan = document.createElement('span');
                statusSpan.className = `room-status ${room.status}`;
                statusSpan.textContent = room.status === 'waiting' ? 'Á≠âÂæÖ‰∏≠' : 'Ê∏∏Êàè‰∏≠';
                
                roomPlayers.appendChild(statusSpan);
                roomInfo.appendChild(roomName);
                roomInfo.appendChild(roomHost);
                roomInfo.appendChild(roomPlayers);
                
                const joinBtn = document.createElement('button');
                joinBtn.className = 'join-button';
                joinBtn.textContent = 'Âä†ÂÖ•';
                console.log('ÂàõÂª∫Âä†ÂÖ•ÊåâÈíÆÔºåÊàøÈó¥ID:', room.id);
                
                // Á°Æ‰øùÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂‰ºòÂÖàÊâßË°åÂπ∂ÈòªÊ≠¢ÂÜíÊ≥°
                joinBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞roomItem
                    console.log('Âä†ÂÖ•ÊåâÈíÆË¢´ÁÇπÂáªÔºåÊàøÈó¥ID:', room.id);
                    joinRoomFromModal(room.id);
                });
                
                roomItem.appendChild(roomInfo);
                roomItem.appendChild(joinBtn);
                
                roomItem.addEventListener('click', (e) => {
                    // Á°Æ‰øùÁÇπÂáªÁõÆÊ†á‰∏çÊòØÂä†ÂÖ•ÊåâÈíÆ
                    console.log('ÊàøÈó¥È°πË¢´ÁÇπÂáªÔºåÁõÆÊ†á:', e.target);
                    console.log('ÁõÆÊ†áÁ±ªÂêç:', e.target.className);
                    console.log('closest join-button:', e.target.closest('.join-button'));
                    
                    // Ê£ÄÊü•ÁÇπÂáªÁõÆÊ†áÊòØÂê¶ÊòØÊåâÈíÆÊàñÊåâÈíÆÁöÑÂ≠êÂÖÉÁ¥†
                    const isButtonClick = e.target.classList.contains('join-button') || e.target.closest('.join-button');
                    if (!isButtonClick) {
                        console.log('ÁÇπÂáªÁöÑÊòØÊàøÈó¥È°πÔºå‰∏çÊòØÊåâÈíÆÔºåË∞ÉÁî® joinRoomFromModalÔºåÊàøÈó¥ID:', room.id);
                        joinRoomFromModal(room.id);
                    } else {
                        console.log('ÁÇπÂáªÁöÑÊòØÂä†ÂÖ•ÊåâÈíÆÔºåË∑≥ËøáÊàøÈó¥È°πÁÇπÂáªÈÄªËæë');
                    }
                });
                
                roomListElement.appendChild(roomItem);
            });
        }
        
        function joinRoomFromModal(roomId) {
            console.log('joinRoomFromModal ÂáΩÊï∞Ë¢´Ë∞ÉÁî®ÔºåroomId:', roomId);
            
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            const roomCodeElement = document.getElementById('roomCode');
            const statusElement = document.getElementById('roomStatus');
            
            console.log('roomCodeElement:', roomCodeElement);
            console.log('statusElement:', statusElement);
            
            if (roomCodeElement) {
                // ËÆæÁΩÆÊàøÈó¥‰ª£Á†ÅÂπ∂Ëá™Âä®Âä†ÂÖ•
                roomCodeElement.value = roomId;
            }
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeRoomBrowserModal();
            
            // ÊòæÁ§∫ÊèêÁ§∫
            if (statusElement) {
                statusElement.textContent = `Ê≠£Âú®Âä†ÂÖ•ÊàøÈó¥ ${roomId}...`;
                statusElement.style.color = '#FF9800';
            }
            
            // Ëá™Âä®ËøûÊé•Âà∞ÊàøÈó¥
            console.log('ÂáÜÂ§áË∞ÉÁî® connectToMultiplayerGame()');
            connectToMultiplayerGame();
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connecting':
                    statusElement.textContent = 'ËøûÊé•‰∏≠...';
                    statusElement.className = 'connection-status disconnected';
                    break;
                case 'connected':
                    statusElement.textContent = 'Â∑≤ËøûÊé• Â§ö‰∫∫ËÅîÊú∫ÊµãËØï';
                    statusElement.className = 'connection-status connected';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'Êñ≠ÂºÄËøûÊé• Â§ö‰∫∫ËÅîÊú∫ÊµãËØï';
                    statusElement.className = 'connection-status disconnected';
                    break;
            }
        }

        function updatePlayerList() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';
            
            for (const playerId in gameState.multiplayer.players) {
                const player = gameState.multiplayer.players[playerId];
                const div = document.createElement('div');
                div.className = 'player-item';
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                playerInfo.innerHTML = `
                    <div class="player-color" style="background-color:${player.color}"></div>
                    ${player.name} ${player.isHost ? 'üè†' : ''} ${player.reachedExit ? '‚úì' : ''}
                    ${gameState.multiplayer.protectedPlayers[playerId] ? 'üõ°Ô∏è' : ''}
                `;
                
                div.appendChild(playerInfo);
                
                // Â¶ÇÊûúÊòØÊàø‰∏ª‰∏î‰∏çÊòØËá™Â∑±ÔºåÊòæÁ§∫Ë∏¢Âá∫ÊåâÈíÆ
                if (gameState.multiplayer.isHost && 
                    gameState.multiplayer.currentPlayerId !== playerId) {
                    const kickButton = document.createElement('button');
                    kickButton.className = 'kick-button';
                    kickButton.textContent = 'Ë∏¢Âá∫';
                    kickButton.onclick = () => {
                        if (confirm(`Á°ÆÂÆöË¶ÅË∏¢Âá∫Áé©ÂÆ∂ ${player.name} ÂêóÔºü`)) {
                            // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Âèó‰øùÊä§
                            if (gameState.multiplayer.protectedPlayers[playerId]) {
                                alert('Ë∏¢Âá∫Â§±Ë¥•Ôºöerr75937 (Áé©ÂÆ∂Âèó‰øùÊä§)');
                            } else {
                                kickPlayer(playerId, 'Ë¢´ÁÆ°ÁêÜÂëòË∏¢Âá∫');
                            }
                        }
                    };
                    div.appendChild(kickButton);
                }
                
                container.appendChild(div);
            }
            
            updatePlayerCount();
        }

        function updatePlayerCount() {
            const currentPlayers = Object.keys(gameState.multiplayer.players).length;
            const maxPlayers = gameState.multiplayer.maxPlayers;
            document.getElementById('multiplayerPlayerCount').textContent = 
                `Áé©ÂÆ∂: ${currentPlayers}/${maxPlayers}`;
        }

function kickPlayer(playerId, reason) {
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊàø‰∏ª‰∏î‰∏çÊòØÂº∫Âà∂Ë∏¢Âá∫
    const isHost = gameState.multiplayer.players[playerId]?.isHost;
    if (isHost && !reason.includes('(Âº∫Âà∂)')) {
        // ‰ΩøÁî®Á≥ªÁªüÊ∂àÊÅØÊòæÁ§∫ÈîôËØØ
        addChatMessage('Á≥ªÁªü', 'ÈîôËØØ: ‰∏çËÉΩË∏¢Âá∫Êàø‰∏ª(Èô§Èùû‰ΩøÁî®forceÂèÇÊï∞)', '#FF5252');
        return;
    }
    
    // ÂèëÈÄÅË∏¢Âá∫Ê∂àÊÅØÁªôËØ•Áé©ÂÆ∂
    if (gameState.multiplayer.connections[playerId]) {
        gameState.multiplayer.connections[playerId].send({
            type: 'player-kicked',
            playerId: playerId,
            reason: reason
        });
        gameState.multiplayer.connections[playerId].close();
    }
    
    // ÂπøÊí≠ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
    broadcast({
        type: 'player-kicked',
        playerId: playerId,
        reason: reason
    });
    
    // ‰ªéÂàóË°®‰∏≠ÁßªÈô§
    removePlayer(playerId);
}


        function resetMultiplayerPlayer() {
            const player = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId];
            if (player) {
                player.x = 1;
                player.y = 1;
                player.reachedExit = false;
                
                // ÂπøÊí≠ÁßªÂä®
                broadcast({
                    type: 'player-move',
                    playerId: gameState.multiplayer.currentPlayerId,
                    x: player.x,
                    y: player.y
                });
                
                drawMultiplayerMaze();
                updatePlayerList();
            }
        }
function addKeyAndDoormultiplayer(size, maze) {
    // ÈöèÊú∫ÊîæÁΩÆÈí•Âåô
    let keyX, keyY;
    do {
        keyX = Math.floor(Math.random() * (size - 4)) + 2;
        keyY = Math.floor(Math.random() * (size - 4)) + 2;
    } while (maze[keyY][keyX] === 1 || 
             (keyX === 1 && keyY === size - 2) || 
             (keyX === Math.floor(size/2) && keyY === Math.floor(size/2)));
    
    // ÊîæÁΩÆÈí•Âåô(8)
    maze[keyY][keyX] = 8;
    gameState.multiplayer.keyPosition = {x: keyX, y: keyY};
    
    // Âú®Âá∫Âè£ÂâçÊîæÁΩÆÈó®(9)
    let doorX = gameState.multiplayer.exit.x;
    let doorY = gameState.multiplayer.exit.y;
    
    // Á°ÆÂÆöÈó®ÁöÑ‰ΩçÁΩÆ
    if (doorX < size-1 && maze[doorY][doorX+1] === 0) {
        doorX++;
    } else if (doorX > 0 && maze[doorY][doorX-1] === 0) {
        doorX--;
    } else if (doorY < size-1 && maze[doorY+1][doorX] === 0) {
        doorY++;
    } else if (doorY > 0 && maze[doorY-1][doorX] === 0) {
        doorY--;
    }
    
    maze[doorY][doorX] = 9;
    gameState.multiplayer.doorPosition = {x: doorX, y: doorY};
}

function generateMultiplayerMaze() {
    const size = 15;
    let maze;
    let validMaze = false;
    let attempts = 0;
    
    // 10%Ê¶ÇÁéáÁîüÊàêËû∫ÊóãËø∑ÂÆ´(Â∫îÊïå‰∫∫Êó†Ê≥ïÊ∏≤ÊüìÔºåÊöÇÊó∂ÂÖ≥Èó≠)
    const isSpiralMaze = false;
    // const isSpiralMaze = Math.random() < 0.1;
    // %100ÁîüÊàê
    // const isSpiralMaze = true;
    if (isSpiralMaze) {
        maze = generateSpiralMaze(size);
        gameState.multiplayer.exit = { 
            x: Math.floor(size/2), 
            y: Math.floor(size/2) 
        };
        
        // Ê∑ªÂä†Èí•ÂåôÂíåÈó®
        addKeyAndDoormultiplayer(size, maze);
    } else {
        // ÊôÆÈÄöËø∑ÂÆ´
        while (!validMaze && attempts < 5) {
            maze = Array(size).fill().map(() => Array(size).fill(1));
            validMaze = tryGenerateValidMaze(maze, size);
            attempts++;
        }
        
        
        // ËÆæÁΩÆÂá∫Âè£
        maze[size-2][size-1] = 0;
        gameState.multiplayer.exit = {x: size-1, y: size-2};
    }
    
    // Ê∑ªÂä†‰º†ÈÄÅÈó®
    addMultiplayerTeleporters(maze, size);
    
    return maze;
}

function tryGenerateValidMaze(maze, size) {
    // ‰ΩøÁî®ÈöèÊú∫PrimÁÆóÊ≥ïÁîüÊàêËø∑ÂÆ´
    const walls = [];
    maze[1][1] = 0;
    walls.push(...getCellWalls(1, 1, maze));
    
    while (walls.length > 0) {
        const wallIndex = Math.floor(Math.random() * walls.length);
        const wall = walls[wallIndex];
        walls.splice(wallIndex, 1);
        
        const opposite = getOppositeCell(wall, maze);
        
        if (opposite.x > 0 && opposite.x < size-1 && 
            opposite.y > 0 && opposite.y < size-1 && 
            maze[opposite.y][opposite.x] === 1) {
            
            maze[wall.y][wall.x] = 0;
            maze[opposite.y][opposite.x] = 0;
            walls.push(...getCellWalls(opposite.x, opposite.y, maze));
        }
    }
    
    // Á°Æ‰øùÊúâ‰∏ÄÊù°‰ªéËµ∑ÁÇπ(1,1)Âà∞ÁªàÁÇπ(size-2, size-1)ÁöÑË∑ØÂæÑ
    return validateMaze(maze);
}

function addMultiplayerTraps(maze, size) {
    // Ê∑ªÂä†Èô∑Èò±ÔºàÈÅøÂºÄÂÖ≥ÈîÆË∑ØÂæÑÔºâ
    const criticalPath = findCriticalPath(maze);
    for (let i = 0; i < 8; i++) {
        let x, y;
        let attempts = 0;
        do {
            x = Math.floor(Math.random() * (size-2)) + 1;
            y = Math.floor(Math.random() * (size-2)) + 1;
            attempts++;
        } while ((maze[y][x] !== 0 || 
                  criticalPath.some(p => p.x === x && p.y === y) || 
                  (x === 1 && y === 1)) && attempts < 50);
        
        if (attempts < 50) {
            maze[y][x] = 2;
        }
    }
}

function addMultiplayerTeleporters(maze, size) {
    gameState.multiplayer.teleporters = [];
    for (let i = 0; i < 4; i++) {
        let x1, y1, x2, y2;
        let attempts = 0;
        do {
            x1 = Math.floor(Math.random() * (size-2)) + 1;
            y1 = Math.floor(Math.random() * (size-2)) + 1;
            x2 = Math.floor(Math.random() * (size-2)) + 1;
            y2 = Math.floor(Math.random() * (size-2)) + 1;
            attempts++;
        } while ((maze[y1][x1] !== 0 || maze[y2][x2] !== 0 || 
                 (x1 === 1 && y1 === 1) || (x2 === 1 && y2 === 1)) && attempts < 50);
        
        if (attempts < 50) {
            maze[y1][x1] = 3;
            maze[y2][x2] = 3;
            gameState.multiplayer.teleporters.push({x: x1, y: y1, pairX: x2, pairY: y2});
            gameState.multiplayer.teleporters.push({x: x2, y: y2, pairX: x1, pairY: y1});
        }
    }
}



function getOppositeCell(wall, maze) {
    const directions = [
        {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
        {dx: 0, dy: 1}, {dx: 0, dy: -1}
    ];
    
    for (const dir of directions) {
        const nx = wall.x + dir.dx;
        const ny = wall.y + dir.dy;
        
        if (nx >= 0 && nx < maze[0].length && 
            ny >= 0 && ny < maze.length && 
            maze[ny][nx] === 0) {
            return {x: wall.x - dir.dx, y: wall.y - dir.dy};
        }
    }
    
    return {x: -1, y: -1};
}

function getCellWalls(x, y, maze) {
    const walls = [];
    const directions = [
        {dx: 1, dy: 0}, {dx: -1, dy: 0}, 
        {dx: 0, dy: 1}, {dx: 0, dy: -1}
    ];
    
    for (const dir of directions) {
        const nx = x + dir.dx;
        const ny = y + dir.dy;
        
        if (nx >= 0 && nx < maze[0].length && 
            ny >= 0 && ny < maze.length && 
            maze[ny][nx] === 1) {
            walls.push({x: nx, y: ny});
        }
    }
    
    return walls;
}
        

        function drawMultiplayerMaze() {
            const canvas = document.getElementById('multiplayerCanvas');
            const ctx = canvas.getContext('2d');
            const cellSize = gameState.multiplayer.cellSize;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ÁªòÂà∂Ëø∑ÂÆ´
            for (let y = 0; y < gameState.multiplayer.maze.length; y++) {
                for (let x = 0; x < gameState.multiplayer.maze[y].length; x++) {
                    const cellValue = gameState.multiplayer.maze[y][x];
                    
                    switch(cellValue) {
                        case 1: // Â¢ô
                            ctx.fillStyle = '#333';
                            break;
                        case 2: // Èô∑Èò±
                            ctx.fillStyle = '#FF0';
                            break;
                        case 3: // ‰º†ÈÄÅÈó®
                            ctx.fillStyle = '#0FF';
                            break;
                        default: // Ë∑Ø
                            ctx.fillStyle = '#111';
                    }
                    
                    ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                    
                    // ÁªòÂà∂Èô∑Èò±ÂõæÊ°à
                    if (cellValue === 2) {
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(
                            x * cellSize + cellSize/2,
                            y * cellSize + cellSize/2,
                            cellSize/4,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                    }
                       if (gameState.multiplayer.keyPosition) {
                            ctx.fillStyle = 'gold';
                            ctx.fillRect(
                                gameState.multiplayer.keyPosition.x * cellSize,
                                gameState.multiplayer.keyPosition.y * cellSize,
                                cellSize, cellSize
                            );
                        }
                        
                        // ÁªòÂà∂Èó®
                        if (gameState.multiplayer.doorPosition) {
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(
                                gameState.multiplayer.doorPosition.x * cellSize,
                                gameState.multiplayer.doorPosition.y * cellSize,
                                cellSize, cellSize
                            );
                        }
                        
                        // ÁªòÂà∂ÁßªÂä®Êïå‰∫∫ÔºàÂ¶ÇÊûúÊòØËû∫ÊóãËø∑ÂÆ´Ôºâ
                        if (gameState.multiplayer.movingEnemies) {
                            gameState.multiplayer.movingEnemies.forEach(enemy => {
                                ctx.fillStyle = enemy.color;
                                ctx.beginPath();
                                ctx.arc(
                                    enemy.x * cellSize + cellSize/2,
                                    enemy.y * cellSize + cellSize/2,
                                    cellSize/2 - 2,
                                    0,
                                    Math.PI * 2
                                );
                                ctx.fill();
                                
                                // ÁªòÂà∂Êïå‰∫∫ÁúºÁùõ
                                ctx.fillStyle = '#FFF';
                                ctx.beginPath();
                                ctx.arc(
                                    enemy.x * cellSize + cellSize/3,
                                    enemy.y * cellSize + cellSize/3,
                                    cellSize/8,
                                    0,
                                    Math.PI * 2
                                );
                                ctx.fill();
                            });
                        }
                }
            
                
            
            
            // ÁªòÂà∂Âá∫Âè£
            ctx.fillStyle = '#F00';
            ctx.fillRect(gameState.multiplayer.exit.x * cellSize, 
                        gameState.multiplayer.exit.y * cellSize, 
                        cellSize, cellSize);
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold ' + (cellSize/2) + 'px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Âá∫', 
                gameState.multiplayer.exit.x * cellSize + cellSize/2,
                gameState.multiplayer.exit.y * cellSize + cellSize/2
            );
            
            // ÁªòÂà∂ÊâÄÊúâÁé©ÂÆ∂
            for (const playerId in gameState.multiplayer.players) {
                const player = gameState.multiplayer.players[playerId];
                
                if (playerId === gameState.multiplayer.peer.id) {
                    // ÁªòÂà∂Êú¨Âú∞Áé©ÂÆ∂‰ΩøÁî®ÁöÆËÇ§Á≥ªÁªü
                    drawPlayerWithSkin(
                        ctx,
                        player.x * cellSize,
                        player.y * cellSize,
                        cellSize
                    );
                } else {
                    // ÁªòÂà∂ÂÖ∂‰ªñÁé©ÂÆ∂‰ΩøÁî®ÈªòËÆ§Ê†∑Âºè
                    ctx.fillStyle = player.color;
                    ctx.beginPath();
                    ctx.arc(
                        player.x * cellSize + cellSize/2,
                        player.y * cellSize + cellSize/2,
                        cellSize/2 - 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
                
                // ÁªòÂà∂Áé©ÂÆ∂ÂêçÂ≠ó
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold ' + (cellSize/3) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                // ÁªòÂà∂ÊñáÂ≠óËÉåÊôØ‰ª•ÊèêÈ´òÂèØËØªÊÄß
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                const textWidth = ctx.measureText(player.name).width;
                ctx.fillRect(
                    player.x * cellSize + cellSize/2 - textWidth/2 - 4,
                    player.y * cellSize - 2,
                    textWidth + 8,
                    cellSize/4 + 4
                );
                // ÁªòÂà∂ÊñáÂ≠ó
                ctx.fillStyle = '#FFF';
                ctx.fillText(player.name, 
                    player.x * cellSize + cellSize/2,
                    player.y * cellSize
                );
            }
        }
    }
function updateMultiplayerGame() {
    // ÁßªÂä®Êïå‰∫∫
    const now = Date.now();
    const size = gameState.multiplayer.maze.length; // Ëé∑ÂèñËø∑ÂÆ´Â§ßÂ∞è
    
    if (gameState.multiplayer.movingEnemies) {
        gameState.multiplayer.movingEnemies.forEach(enemy => {
            // Ê†πÊçÆÊó∂Èó¥Èó¥ÈöîÁßªÂä®
            if (now - enemy.lastMove < 500 / enemy.speed) return;
            enemy.lastMove = now;
            
            // ËøΩÈÄêÊúÄËøëÁöÑÁé©ÂÆ∂
            let closestPlayer = null;
            let minDistance = Infinity;
            
            for (const playerId in gameState.multiplayer.players) {
                const player = gameState.multiplayer.players[playerId];
                const distance = Math.sqrt(
                    Math.pow(player.x - enemy.x, 2) + 
                    Math.pow(player.y - enemy.y, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPlayer = player;
                }
            }
            
            if (closestPlayer) {
                // ËÆ°ÁÆóÁßªÂä®ÊñπÂêë
                enemy.dx = closestPlayer.x - enemy.x > 0 ? 1 : -1;
                enemy.dy = closestPlayer.y - enemy.y > 0 ? 1 : -1;
                
                // Â∞ùËØïÁßªÂä®
                let newX = enemy.x + enemy.dx;
                let newY = enemy.y + enemy.dy;
                
                // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÁßªÂä®
                if (newX >= 0 && newX < size && newY >= 0 && newY < size && 
                    gameState.multiplayer.maze[newY][newX] !== 1) {
                    enemy.x = newX;
                    enemy.y = newY;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Á¢∞Âà∞Áé©ÂÆ∂
                    for (const playerId in gameState.multiplayer.players) {
                        const player = gameState.multiplayer.players[playerId];
                        
                        if (enemy.x === player.x && enemy.y === player.y && 
                            !gameState.multiplayer.protectedPlayers[playerId]) {
                            // Áé©ÂÆ∂Ë¢´ÈÄÅÂõûËµ∑ÁÇπ
                            player.x = 1;
                            player.y = 1;
                            
                            // ÂπøÊí≠ÁßªÂä®
                            broadcast({
                                type: 'player-move',
                                playerId: playerId,
                                x: player.x,
                                y: player.y
                            });
                        }
                    }
                }
            }
        });
        
        // ÂπøÊí≠Êïå‰∫∫ÁßªÂä®
        broadcast({
            type: 'enemy-move',
            enemies: gameState.multiplayer.movingEnemies
        });
        
        drawMultiplayerMaze();
    }
}

        function updateMultiplayerUnlockTimer() {
            document.getElementById('unlockTimer').textContent = 
                `ÂºÄÈó®ÂÄíËÆ°Êó∂: ${gameState.multiplayer.unlockTimeLeft}Áßí`;
        }

        function startMultiplayerTimer() {
            clearInterval(gameState.multiplayer.timerInterval);
            gameState.multiplayer.startTime = Date.now();
            updateMultiplayerUnlockTimer();
            gameState.multiplayer.timerInterval = setInterval(updateMultiplayerUnlockTimer, 1000);
        }



        function getRandomColor() {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            return colors[Math.floor(Math.random() * colors.length)];
        }




        // =============== ÈîÆÁõòÂø´Êç∑ÈîÆ ===============
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+C ÊâìÂºÄ/ÂÖ≥Èó≠ÊéßÂà∂Âè∞
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                toggleConsole();
            }
            
            // Ctrl+Shift+D ÂàáÊç¢ÂºÄÂèëËÄÖÊ®°Âºè
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                gameState.devMode = !gameState.devMode;
                console.log('ÂºÄÂèëËÄÖÊ®°Âºè:', gameState.devMode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠');
                
                // ÊòæÁ§∫ÊèêÁ§∫
                const hint = document.createElement('div');
                hint.className = 'console-hint';
                hint.textContent = `ÂºÄÂèëËÄÖÊ®°Âºè ${gameState.devMode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`;
                document.body.appendChild(hint);
                
                setTimeout(() => {
                    hint.classList.add('hidden');
                    setTimeout(() => hint.remove(), 500);
                }, 2000);
            }
            
            // ÊéßÂà∂Âè∞ËæìÂÖ•Â§ÑÁêÜ
            if (consoleVisible && e.key === 'Enter') {
                const input = document.getElementById('consoleInput');
                const command = input.value.trim();
                input.value = '';
                    
                if (command) {
                    consoleHistory.push(command);
                    historyIndex = consoleHistory.length;
                    executeCommand(command);
                }
            }
        });

        // ÊéßÂà∂Âè∞ËæìÂÖ•Ê°Ü‰∫ã‰ª∂Â§ÑÁêÜ
        document.getElementById('consoleInput').addEventListener('keydown', handleConsoleInput);

        // ÂàùÂßãÂåñÂÖ≥Âç°ÊåâÈíÆ
        generateLevelButtons();
        
        // Êõ¥Êñ∞‰∏ã‰∏ÄÂÖ≥ÊåâÈíÆÊòæÁ§∫
function updateNextLevelButtons() {
    const regularBtn = document.getElementById('regularNextButton');
    const unsolvableBtn = document.getElementById('unsolvableNextButton');
    
    // Á°Æ‰øùÂú®‰ªª‰ΩïÊó∂ÂÄôË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞ÈÉΩËÉΩÊ≠£Á°ÆËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
    if (gameState.unsolvableLevels.includes(gameState.currentLevel)) {
        regularBtn.style.display = 'none';
        unsolvableBtn.style.display = 'block'; // Êîπ‰∏∫block‰ª•Á°Æ‰øùÊòæÁ§∫
    } else {
        regularBtn.style.display = 'block'; // Êîπ‰∏∫block‰ª•Á°Æ‰øùÊòæÁ§∫
        unsolvableBtn.style.display = 'none';
    }
}

// Èü≥‰πêËß£ÈîÅÁõ∏ÂÖ≥ÂáΩÊï∞
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    const cookieString = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
    document.cookie = cookieString;
    console.log('CookieËÆæÁΩÆ:', name, '=', value, 'ËøáÊúüÊó∂Èó¥:', expires.toUTCString());
    console.log('ÂΩìÂâçÊâÄÊúâCookie:', document.cookie);
}

function getCookie(name) {
    const cookieString = document.cookie;
    console.log('Ëé∑ÂèñCookieÊó∂ÁöÑÊâÄÊúâCookie:', cookieString);
    const cookies = cookieString.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            const value = decodeURIComponent(cookie.substring(name.length + 1));
            console.log('Ëé∑ÂèñÂà∞Cookie:', name, '=', value);
            return value;
        }
    }
    console.log('Êú™ÊâæÂà∞Cookie:', name);
    return null;
}

function validateMusicPassword() {
    const passwordInput = document.getElementById('musicPasswordInput');
    const errorMessage = document.getElementById('passwordError');
    
    if (passwordInput.value === '11musicgood') {
        // ÂØÜÁ†ÅÊ≠£Á°ÆÔºåËß£ÈîÅÈü≥‰πê
        gameState.uiSettings.musicEnabled = true;
        setCookie('musicUnlocked', 'true', 365); // ‰øùÂ≠ò‰∏ÄÂπ¥
        
        // Êõ¥Êñ∞UI
        document.getElementById('musicEnabledCheckbox').checked = true;
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        document.getElementById('musicUnlockModal').classList.add('hidden');
        errorMessage.style.display = 'none';
        passwordInput.value = '';
        
        // Â∫îÁî®ËÆæÁΩÆ
        applyUISettings();
    } else {
        // ÂØÜÁ†ÅÈîôËØØ
        errorMessage.style.display = 'block';
        passwordInput.value = '';
    }
}

function checkMusicUnlockStatus() {
    console.log('Ê£ÄÊü•Èü≥‰πêËß£ÈîÅÁä∂ÊÄÅ...');
    const isUnlocked = getCookie('musicUnlocked');
    console.log('Èü≥‰πêËß£ÈîÅÁä∂ÊÄÅ:', isUnlocked);
    if (isUnlocked === 'true') {
        gameState.uiSettings.musicEnabled = true;
        console.log('Èü≥‰πêÂ∑≤Ëß£ÈîÅ');
    } else {
        gameState.uiSettings.musicEnabled = false;
        console.log('Èü≥‰πêÊú™Ëß£ÈîÅ');
    }
}

        // Ê£ÄÊü•Èü≥‰πêËß£ÈîÅÁä∂ÊÄÅ
        checkMusicUnlockStatus();
        // ÂàùÂßãÂ∫îÁî®UIËÆæÁΩÆ
        applyUISettings();
document.addEventListener('touchstart', function(e) {
    // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØÁõÆÊ†áÊåâÈíÆ
    if (e.target.id === 'multiplayerBtn' || e.target.parentElement.id === 'multiplayerBtn') {
        e.preventDefault();
        showScreen('multiplayerSetup');
    }
    
    if (e.target.id === 'startMultiplayerBtn' || e.target.parentElement.id === 'startMultiplayerBtn') {
        e.preventDefault();
        connectToMultiplayerGame();
    }
    
    if (e.target.id === 'backToMenuBtn' || e.target.parentElement.id === 'backToMenuBtn') {
        e.preventDefault();
        showScreen('mainMenu');
    }
}, { passive: false });

// ÊéßÂà∂Âè∞ÂäüËÉΩÂÆûÁé∞
// Â≠òÂÇ®ÊéßÂà∂Âè∞Ê∂àÊÅØÁöÑÊï∞ÁªÑ
const consoleMessages = [];

// ÈáçÂÜôÊéßÂà∂Âè∞ÊñπÊ≥ï‰ª•Êã¶Êà™Ê∂àÊÅØ
(function() {
    // ‰øùÂ≠òÂéüÂßãÊéßÂà∂Âè∞ÊñπÊ≥ï
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    const originalInfo = console.info;
    const originalDebug = console.debug;
    
    // Áªü‰∏ÄÁöÑÊ∂àÊÅØÂ§ÑÁêÜÂáΩÊï∞
    function logMessage(type, args) {
        // Ê†ºÂºèÂåñÊ∂àÊÅØ
        const timestamp = new Date().toLocaleTimeString();
        let message = '';
        
        // Â∞ÜÂèÇÊï∞ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
        for (let i = 0; i < args.length; i++) {
            if (args[i] === undefined) {
                message += 'undefined';
            } else if (args[i] === null) {
                message += 'null';
            } else if (typeof args[i] === 'object') {
                try {
                    message += JSON.stringify(args[i], null, 2);
                } catch (e) {
                    message += args[i].toString();
                }
            } else {
                message += args[i].toString();
            }
            if (i < args.length - 1) {
                message += ' ';
            }
        }
        
        // Â≠òÂÇ®Ê∂àÊÅØ
        consoleMessages.push({
            type: type,
            message: message,
            timestamp: timestamp
        });
        
        // ÈôêÂà∂Ê∂àÊÅØÊï∞ÈáèÔºåÈÅøÂÖçÂÜÖÂ≠òÂç†Áî®ËøáÂ§ß
        if (consoleMessages.length > 1000) {
            consoleMessages.shift();
        }
    }
    
    // ÈáçÂÜôÊéßÂà∂Âè∞ÊñπÊ≥ï
    console.log = function() {
        logMessage('log', arguments);
        originalLog.apply(console, arguments);
    };
    
    console.warn = function() {
        logMessage('warn', arguments);
        originalWarn.apply(console, arguments);
    };
    
    console.error = function() {
        logMessage('error', arguments);
        // originalError.apply(console, arguments);
    };
    
    console.info = function() {
        logMessage('info', arguments);
        originalInfo.apply(console, arguments);
    };
    
    console.debug = function() {
        logMessage('debug', arguments);
        originalDebug.apply(console, arguments);
    };
})();

// ÂØÜÁ†ÅÈ™åËØÅÂäüËÉΩ

// ÂÆåÂÖ®ÈáçÂÜôÊéßÂà∂Âè∞ÂäüËÉΩÁöÑÂÆûÁé∞ÔºåÁ°Æ‰øùÊâÄÊúâÂáΩÊï∞ÈÉΩËÉΩÊ≠£Â∏∏Â∑•‰Ωú
// 1. ÂØÜÁ†ÅÈ™åËØÅÂäüËÉΩ
window.openConsolePasswordModal = function() {
    console.log('[DEBUG] openConsolePasswordModalÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
    try {
        const modal = document.getElementById('consolePasswordModal');
        if (modal) {
            // Á°Æ‰øùÊâÄÊúâÂÖ∂‰ªñÂ±èÂπïÈÉΩË¢´ÈöêËóè
            const screens = [
                'mainMenu', 'singlePlayerLevelSelect', 'singlePlayerGame', 
                'singlePlayerComplete', 'multiplayerSetup', 'multiplayerGame',
                'achievementsScreen', 'moreChallengesScreen', 'statisticsScreen',
                'shopModal'
            ];
            
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            modal.classList.remove('hidden');
            // Ëá™Âä®ËÅöÁÑ¶Âà∞ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
            const input = document.getElementById('consolePasswordInput');
            if (input) {
                input.focus();
            }
        } else {
            console.error('Êú™ÊâæÂà∞ consolePasswordModal ÂÖÉÁ¥†');
            alert('ÊéßÂà∂Âè∞ÂØÜÁ†ÅÊ®°ÊÄÅÊ°ÜÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }
    } catch (e) {
        console.error('ÊâìÂºÄÂØÜÁ†ÅÊ®°ÊÄÅÊ°ÜÊó∂Âá∫Èîô:', e);
        alert('ÊâìÂºÄÊéßÂà∂Âè∞Êó∂Âá∫Èîô: ' + e.message);
    }
};

window.closeConsolePasswordModal = function() {
    try {
        const modal = document.getElementById('consolePasswordModal');
        if (modal) {
            modal.classList.add('hidden');
            
            // ÊÅ¢Â§ç‰∏ªËèúÂçï
            const mainMenu = document.getElementById('mainMenu');
            if (mainMenu) {
                mainMenu.classList.remove('hidden');
            }
        }
        const input = document.getElementById('consolePasswordInput');
        if (input) input.value = '';
    } catch (e) {
        console.error('ÂÖ≥Èó≠ÂØÜÁ†ÅÊ®°ÊÄÅÊ°ÜÊó∂Âá∫Èîô:', e);
    }
};

window.checkConsolePassword = function() {
    try {
        // Áõ¥Êé•ÁªïËøáÂØÜÁ†ÅÈ™åËØÅÔºåÊòæÁ§∫ÊèêÁ§∫Âπ∂ÊâìÂºÄÊéßÂà∂Âè∞
        alert('ÊéßÂà∂Âè∞Â∑≤ÊâìÂºÄ');
        window.closeConsolePasswordModal();
        window.openConsoleModal();
    } catch (e) {
        console.error('ÊâìÂºÄÊéßÂà∂Âè∞Êó∂Âá∫Èîô:', e);
        alert('ÊâìÂºÄÊéßÂà∂Âè∞Êó∂Âá∫Èîô: ' + e.message);
    }
};

// 2. ÊéßÂà∂Âè∞ÂÜÖÂÆπÊòæÁ§∫ÂäüËÉΩ
window.openConsoleModal = function() {
    try {
        const modal = document.getElementById('consoleModal');
        if (modal) {
            modal.classList.remove('hidden');
            // ÊâìÂºÄÊéßÂà∂Âè∞Êó∂ÂºÄÂêØÂºÄÂèëËÄÖÊ®°Âºè
            gameState.developerMode = true;
            console.log('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÂºÄÂêØ');
            
            // ÊòæÁ§∫ÊâÄÊúâÊéßÂà∂Âè∞Ê∂àÊÅØ
            const consoleContent = document.getElementById('consoleContent');
            if (consoleContent) {
                consoleContent.innerHTML = '';
                
                
                consoleMessages.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '5px';
                    switch (msg.type) {
                    case 'log': div.style.color = '#fff'; break;
                    case 'warn': div.style.color = '#FFC107'; break;
                    case 'error': div.style.color = '#F44336'; break;
                    case 'info': div.style.color = '#2196F3'; break;
                    case 'debug': div.style.color = '#9C27B0'; break;
                    case 'command': div.style.color = '#4CAF50'; break;
                    case 'result': div.style.color = '#8BC34A'; break;
                    default: div.style.color = '#fff';
                }
                    let feedbackButton = '';
                if (msg.type === 'error') {
                    // ‰ΩøÁî®ÁºñÁ†ÅÂêéÁöÑÊ∂àÊÅØÂÜÖÂÆπÈÅøÂÖçÂºïÂè∑ÂíåÁâπÊÆäÂ≠óÁ¨¶ÈóÆÈ¢ò
                    const encodedMessage = encodeURIComponent(msg.message);
                    feedbackButton = `<button style="margin-left: 10px; padding: 2px 8px; background-color: #F44336; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;" onclick="sendErrorFeedback('${encodedMessage}')">ÂèçÈ¶à</button>`;
                }
                div.innerHTML = `<span style="color: #9E9E9E; font-size: 12px;">[${msg.timestamp}]</span> <span style="font-weight: bold;">${msg.type.toUpperCase()}:</span> ${msg.message}${feedbackButton}`;
                    consoleContent.appendChild(div);
                });
                
                consoleContent.scrollTop = consoleContent.scrollHeight;
            
            // Ëá™Âä®ËÅöÁÑ¶Âà∞ÂëΩ‰ª§ËæìÂÖ•Ê°Ü
            const input = document.getElementById('consoleCommandInput');
            if (input) {
                setTimeout(() => {
                    input.focus();
                }, 100);
            }
            
        } else {
            console.error('Êú™ÊâæÂà∞ consoleContent ÂÖÉÁ¥†');
            alert('ÊéßÂà∂Âè∞ÂÜÖÂÆπÂå∫ÂüüÊú™ÊâæÂà∞');
        }
    } else {
        console.error('Êú™ÊâæÂà∞ consoleModal ÂÖÉÁ¥†');
        alert('ÊéßÂà∂Âè∞Ê®°ÊÄÅÊ°ÜÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
    }
    } catch (e) {
        console.error('ÊâìÂºÄÊéßÂà∂Âè∞Êó∂Âá∫Èîô:', e);
        alert('ÊâìÂºÄÊéßÂà∂Âè∞Êó∂Âá∫Èîô: ' + e.message);
    }
};

window.closeConsoleModal = function() {
    
    try {
        const modal = document.getElementById('consoleModal');
        if (modal) {
            modal.classList.add('hidden');
            
            // ÊÅ¢Â§ç‰πãÂâçÊòæÁ§∫ÁöÑÂ±èÂπïÔºåËøôÈáåÁõ¥Êé•ÊòæÁ§∫‰∏ªËèúÂçï
            const mainMenu = document.getElementById('mainMenu');
            if (mainMenu) {
                mainMenu.classList.remove('hidden');
            }
        }
    } catch (e) {
        console.error('ÂÖ≥Èó≠ÊéßÂà∂Âè∞Êó∂Âá∫Èîô:', e);
    }
};

// ÊéßÂà∂Âè∞Âà∑Êñ∞ÂäüËÉΩ
window.refreshConsole = function() {
    
    try {
        const consoleContent = document.getElementById('consoleContent');
        if (consoleContent) {
            consoleContent.innerHTML = '';
        
            
            consoleMessages.forEach(msg => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                
                switch (msg.type) {
                    case 'log': div.style.color = '#fff'; break;
                    case 'warn': div.style.color = '#FFC107'; break;
                    case 'error': div.style.color = '#F44336'; break;
                    case 'info': div.style.color = '#2196F3'; break;
                    case 'debug': div.style.color = '#9C27B0'; break;
                    case 'command': div.style.color = '#4CAF50'; break;
                    case 'result': div.style.color = '#8BC34A'; break;
                    default: div.style.color = '#fff';
                }
                
                let feedbackButton = '';
                if (msg.type === 'error') {
                    // ‰ΩøÁî®ÁºñÁ†ÅÂêéÁöÑÊ∂àÊÅØÂÜÖÂÆπÈÅøÂÖçÂºïÂè∑ÂíåÁâπÊÆäÂ≠óÁ¨¶ÈóÆÈ¢ò
                    const encodedMessage = encodeURIComponent(msg.message);
                    feedbackButton = `<button style="margin-left: 10px; padding: 2px 8px; background-color: #F44336; color: white; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;" onclick="window.sendErrorFeedback('${encodedMessage}')">ÂèçÈ¶à</button>`;
                }
                div.innerHTML = `<span style="color: #9E9E9E; font-size: 12px;">[${msg.timestamp}]</span> <span style="font-weight: bold;">${msg.type.toUpperCase()}:</span> ${msg.message}${feedbackButton}`;
                consoleContent.appendChild(div);
            });
            
            consoleContent.scrollTop = consoleContent.scrollHeight;
        } else {
            console.error('Êú™ÊâæÂà∞ consoleContent ÂÖÉÁ¥†');
            alert('Êú™ÊâæÂà∞ÊéßÂà∂Âè∞ÂÜÖÂÆπÂÖÉÁ¥†');
        }
    } catch (e) {
        console.error('Âà∑Êñ∞ÊéßÂà∂Âè∞Êó∂Âá∫Èîô:', e);
        alert('Âà∑Êñ∞ÊéßÂà∂Âè∞Êó∂Âá∫Èîô: ' + e.message);
    }
};

// ÈîôËØØÂèçÈ¶àÂäüËÉΩ
window.sendErrorFeedback = function(encodedErrorMessage) {
    try {
        // Ëß£Á†ÅÈîôËØØÊ∂àÊÅØ
        const errorMessage = decodeURIComponent(encodedErrorMessage);
        
        // Êü•ÊâæÊúÄËøëÊâßË°åÁöÑÂëΩ‰ª§
        let recentCommand = "Êó†ÊúÄËøëÂëΩ‰ª§";
        for (let i = consoleMessages.length - 1; i >= 0; i--) {
            if (consoleMessages[i].type === 'command') {
                recentCommand = consoleMessages[i].message;
                break;
            }
        }
        
        // Ëé∑ÂèñÈîôËØØÂèëÁîü‰ΩçÁΩÆÁöÑÊ∏∏ÊàèÁä∂ÊÄÅ‰ø°ÊÅØ
        let gameStatus = "ÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅÔºö\n";
        try {
            // Â∞ùËØï‰ΩøÁî®gameStateÂØπË±°Ëé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅ
            if (typeof gameState !== 'undefined') {
                if (gameState.currentScreen) gameStatus += `- ÂΩìÂâçÂ±èÂπïÔºö${gameState.currentScreen}\n`;
                if (gameState.currentLevel) gameStatus += `- ÂΩìÂâçÂÖ≥Âç°Ôºö${gameState.currentLevel}\n`;
                if (gameState.playerName) gameStatus += `- Áé©ÂÆ∂ÂêçÁß∞Ôºö${gameState.playerName}\n`;
                if (gameState.coins !== undefined) gameStatus += `- ÈáëÂ∏ÅÊï∞ÈáèÔºö${gameState.coins}\n`;
                if (gameState.unlockedLevel) gameStatus += `- Â∑≤Ëß£ÈîÅÂÖ≥Âç°Ôºö${gameState.unlockedLevel}\n`;
                if (gameState.devMode) gameStatus += `- ÂºÄÂèëÊ®°ÂºèÔºö${gameState.devMode ? 'Â∑≤ÂêØÁî®' : 'Êú™ÂêØÁî®'}\n`;
                if (gameState.uiSettings) gameStatus += `- UIËÆæÁΩÆÔºö${gameState.uiSettings}\n`;
                if (gameState.gameStats) gameStatus += `- Ê∏∏ÊàèÁªüËÆ°Ôºö${gameState.gameStats ? 'Â∑≤ÂêØÁî®' : 'Êú™ÂêØÁî®'}\n`;
                if (gameState.controlsReversed) gameStatus += `- ÊéßÂà∂ÂèçËΩ¨Ôºö${gameState.controlsReversed ? 'Â∑≤ÂêØÁî®' : 'Êú™ÂêØÁî®'}\n`;
                if (gameState.currentLevel) gameStatus += `- ÂΩìÂâçÂÖ≥Âç°Ôºö${gameState.currentLevel}\n\n\n`;
                
                if (gameState.multiplayer) {
                    gameStatus += `- Â§ö‰∫∫Ê∏∏ÊàèÊ®°ÂºèÔºö${gameState.multiplayer.connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•'}\n`;
                    if (gameState.multiplayer.roomCode) gameStatus += `- ÊàøÈó¥‰ª£Á†ÅÔºö${gameState.multiplayer.roomCode}\n`;
                }
                
                // Â∞ùËØïËé∑ÂèñÁé©ÂÆ∂‰ΩçÁΩÆ‰ø°ÊÅØ
                if (typeof player !== 'undefined' && player.x !== undefined && player.y !== undefined) {
                    gameStatus += `- Áé©ÂÆ∂‰ΩçÁΩÆÔºö(${player.x}, ${player.y})\n`;
                }
            } else {
                // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáè
                if (typeof currentGameMode !== 'undefined') gameStatus += `- Ê∏∏ÊàèÊ®°ÂºèÔºö${currentGameMode}\n`;
                if (typeof currentLevel !== 'undefined') gameStatus += `- ÂΩìÂâçÂÖ≥Âç°Ôºö${currentLevel}\n`;
                if (typeof player !== 'undefined' && player.x !== undefined && player.y !== undefined) gameStatus += `- Áé©ÂÆ∂‰ΩçÁΩÆÔºö(${player.x}, ${player.y})\n`;
                if (typeof currentScreen !== 'undefined') gameStatus += `- ÂΩìÂâçÂ±èÂπïÔºö${currentScreen}\n`;
                
            }
        } catch (e) {
            gameStatus += `- Êó†Ê≥ïËé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅ‰ø°ÊÅØÔºö${e.message}\n`;
        }
        
        // Ëé∑ÂèñÊµèËßàÂô®‰ø°ÊÅØ
        const browserInfo = "ÊµèËßàÂô®‰ø°ÊÅØÔºö\n" +
                          `- Áî®Êà∑‰ª£ÁêÜÔºö${navigator.userAgent}\n` +
                          `- ËØ≠Ë®ÄÔºö${navigator.language}\n` +
                          `- Âπ≥Âè∞Ôºö${navigator.platform}\n`;
        
        // Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØ
        const systemInfo = "Á≥ªÁªü‰ø°ÊÅØÔºö\n" +
                          `- Â±èÂπïÂàÜËæ®ÁéáÔºö${window.screen.width}x${window.screen.height}\n` +
                          `- Á™óÂè£Â§ßÂ∞èÔºö${window.innerWidth}x${window.innerHeight}\n`;
        
        // ÊûÑÂª∫ÈÇÆ‰ª∂ÂÜÖÂÆπ
        const currentTime = new Date().toLocaleString();
        const subject = encodeURIComponent("Ëø∑ÂÆ´Êé¢Èô©Ê∏∏ÊàèÈîôËØØÂèçÈ¶à");
        const body = encodeURIComponent(`Ëø∑ÂÆ´Êé¢Èô©Ê∏∏ÊàèÈîôËØØÂèçÈ¶à\nÊä•ÂëäÊó∂Èó¥Ôºö${currentTime}\n\nÈîôËØØÂÜÖÂÆπÔºö\n${errorMessage}\n\nÊúÄËøëÊâßË°åÁöÑÂëΩ‰ª§Ôºö\n${recentCommand}\n\n${gameStatus}${browserInfo}${systemInfo}\n\nÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅ`);
        
        // ÊûÑÂª∫mailtoÈìæÊé•
        const mailtoLink = `mailto:YXF52013141@outlook.com?subject=${subject}&body=${body}`;
        
        // ÊâìÂºÄÈÇÆ‰ª∂ÂÆ¢Êà∑Á´Ø
        window.open(mailtoLink);
        
        console.log('ÈîôËØØÂèçÈ¶àÂ∑≤ÂèëÈÄÅ');
        alert('ÈîôËØØÂèçÈ¶àÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåËØ∑Âú®ÈÇÆ‰ª∂ÂÆ¢Êà∑Á´Ø‰∏≠ÁÇπÂáªÂèëÈÄÅÔºÅ');
        
    } catch (e) {
        console.error('ÂèëÈÄÅÈîôËØØÂèçÈ¶àÊó∂Âá∫Èîô:', e);
        alert('ÂèëÈÄÅÈîôËØØÂèçÈ¶àÊó∂Âá∫Èîô: ' + e.message);
    }
};
// JavaScriptÂëΩ‰ª§ÊâßË°åÂäüËÉΩ
window.executeConsoleCommand = function() {
    
    try {
        const input = document.getElementById('consoleCommandInput');
        if (!input) {
            console.error('Êú™ÊâæÂà∞ consoleCommandInput ÂÖÉÁ¥†');
            alert('Êú™ÊâæÂà∞ÂëΩ‰ª§ËæìÂÖ•Ê°Ü');
            return;
        }
        
        const command = input.value.trim();
        if (!command) {
            console.log('ÂëΩ‰ª§‰∏∫Á©∫Ôºå‰∏çÊâßË°å');
            return;
        }
        
        console.log('ÊâßË°åÂëΩ‰ª§:', command);
        
        // Ê∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•
        const dangerousKeywords = ['document.write', 'location.href', 'eval', 'window.open', 'setTimeout.*eval'];
        for (const keyword of dangerousKeywords) {
            const regex = new RegExp(keyword, 'i');
            if (regex.test(command)) {
                console.warn('Ê£ÄÊµãÂà∞Âç±Èô©ÂëΩ‰ª§ÔºåÁ¶ÅÊ≠¢ÊâßË°å:', command);
                alert('ËØ•ÂëΩ‰ª§ÂåÖÂê´Âç±Èô©Êìç‰ΩúÔºåÁ¶ÅÊ≠¢ÊâßË°åÔºÅ');
                input.value = '';
                return;
            }
        }
        
        // ËÆ∞ÂΩïÂëΩ‰ª§
        const timestamp = new Date().toLocaleTimeString();
        consoleMessages.push({
            type: 'command',
            message: '> ' + command,
            timestamp: timestamp
        });
        
        // ÊâßË°åÂëΩ‰ª§
        let result;
        try {
            result = eval(command);
            
            
            // ËÆ∞ÂΩïÁªìÊûú
            let resultMsg = '';
            if (result === undefined) {
                resultMsg = 'undefined';
            } else if (typeof result === 'object') {
                try {
                    resultMsg = JSON.stringify(result, null, 2);
                } catch (e) {
                    resultMsg = result.toString();
                }
            } else {
                resultMsg = result.toString();
            }
        } catch (e) {
            console.error('ÂëΩ‰ª§ÊâßË°åÈîôËØØ:', e);
            
            // ËÆ∞ÂΩïÈîôËØØ
            consoleMessages.push({
                type: 'error',
                message: 'Error: ' + e.message,
                timestamp: timestamp
            });
        }
        
        // ÈôêÂà∂Ê∂àÊÅØÊï∞Èáè
        if (consoleMessages.length > 1000) {
            consoleMessages.shift();
        }
        
        // Âà∑Êñ∞ÊéßÂà∂Âè∞ÊòæÁ§∫
        window.refreshConsole();
        
        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        input.value = '';
        
    } catch (e) {
        console.error('ÊâßË°åÂëΩ‰ª§Êó∂ÂèëÁîü‰∏•ÈáçÈîôËØØ:', e);
        alert('ÊâßË°åÂëΩ‰ª§Êó∂ÂèëÁîüÈîôËØØ: ' + e.message);
    }
};

// ÁöÆËÇ§Á≥ªÁªüÂáΩÊï∞
function updateCoinsDisplay() {
    const coinsElement = document.getElementById('currentCoins');
    if (coinsElement) {
        coinsElement.textContent = gameState.playerData.coins;
    }
}

function updateSkinShop() {
    gameState.playerData.skins.available.forEach(skin => {
        const skinElement = document.getElementById(`skin-${skin.id}`);
        if (skinElement) {
            const statusElement = skinElement.querySelector('.achievement-status');
            const isUnlocked = gameState.playerData.skins.unlocked.includes(skin.id);
            const isCurrent = gameState.playerData.skins.current === skin.id;
            
            if (statusElement) {
                if (isUnlocked) {
                    if (isCurrent) {
                        statusElement.innerHTML = '<button disabled>ÂΩìÂâç‰ΩøÁî®</button>';
                    } else {
                        statusElement.innerHTML = `<button onclick="selectSkin('${skin.id}')">‰ΩøÁî®</button>`;
                    }
                } else {
                    statusElement.innerHTML = `<button onclick="buySkin('${skin.id}')">Ë¥≠‰π∞ (${skin.price}ÈáëÂ∏Å)</button>`;
                }
            }
        }
    });
}

function buySkin(skinId) {
    const skin = gameState.playerData.skins.available.find(s => s.id === skinId);
    if (!skin) return;
    
    if (gameState.playerData.coins >= skin.price) {
        gameState.playerData.coins -= skin.price;
        if (!gameState.playerData.skins.unlocked.includes(skinId)) {
            gameState.playerData.skins.unlocked.push(skinId);
        }
        selectSkin(skinId);
        updateCoinsDisplay();
        updateSkinShop();
        saveGame();
        showNotification(`ÊàêÂäüË¥≠‰π∞ÁöÆËÇ§Ôºö${skin.name}ÔºÅ`, 3000);
    } else {
        showNotification('ÈáëÂ∏Å‰∏çË∂≥ÔºÅ', 3000);
    }
}

function selectSkin(skinId) {
    gameState.playerData.skins.current = skinId;
    updateSkinShop();
    saveGame();
    showNotification('Â∑≤ÂàáÊç¢ÁöÆËÇ§ÔºÅ', 3000);
}

function getCurrentSkin() {
    const currentSkinId = gameState.playerData.skins.current;
    return gameState.playerData.skins.available.find(skin => skin.id === currentSkinId) || { id: 'default', icon: 'üë§' };
}

function drawPlayerWithSkin(ctx, x, y, size) {
    const skin = getCurrentSkin();
    
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.font = `${size}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(skin.icon, x + size/2, y + size/2);
}

    </script>
<!-- ÁöÆËÇ§ÂïÜÂ∫óÁïåÈù¢ -->
    <div id="skinShopScreen" class="hidden">
        <button class="back-button" onclick="showScreen('mainMenu')">ËøîÂõû</button>
        <h2 class="level-select-title">ÁöÆËÇ§ÂïÜÂ∫ó</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <p>ÂΩìÂâçÈáëÂ∏ÅÔºö<span id="currentCoins">0</span></p>
        </div>
        <div class="achievements-container">
            <div class="achievement-item" id="skin-default">
                <div class="achievement-icon">üë§</div>
                <div class="achievement-info">
                    <h3>ÈªòËÆ§ËßíËâ≤</h3>
                    <p>ÂàùÂßãËßíËâ≤</p>
                    <p>‰ª∑Ê†ºÔºöÂÖçË¥π</p>
                </div>
                <div class="achievement-status"><button onclick="selectSkin('default')">‰ΩøÁî®</button></div>
            </div>
            <div class="achievement-item" id="skin-warrior">
                <div class="achievement-icon">‚öîÔ∏è</div>
                <div class="achievement-info">
                    <h3>ÂãáÂ£´</h3>
                    <p>ÂãáÊï¢ÁöÑÊàòÂ£´</p>
                    <p>‰ª∑Ê†ºÔºö100ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('warrior')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-mage">
                <div class="achievement-icon">üßô</div>
                <div class="achievement-info">
                    <h3>Ê≥ïÂ∏à</h3>
                    <p>Á•ûÁßòÁöÑÈ≠îÊ≥ïÂ∏à</p>
                    <p>‰ª∑Ê†ºÔºö200ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('mage')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-ninja">
                <div class="achievement-icon">ü•∑</div>
                <div class="achievement-info">
                    <h3>ÂøçËÄÖ</h3>
                    <p>ÈöêÁßòÁöÑÂà∫ÂÆ¢</p>
                    <p>‰ª∑Ê†ºÔºö300ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('ninja')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-robot">
                <div class="achievement-icon">ü§ñ</div>
                <div class="achievement-info">
                    <h3>Êú∫Âô®‰∫∫</h3>
                    <p>Êú™Êù•ÁßëÊäÄ‰∫ßÁâ©</p>
                    <p>‰ª∑Ê†ºÔºö500ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('robot')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-alien">
                <div class="achievement-icon">üëΩ</div>
                <div class="achievement-info">
                    <h3>Â§ñÊòü‰∫∫</h3>
                    <p>Êù•Ëá™Â§ñÂ§™Á©∫ÁöÑËÆøÂÆ¢</p>
                    <p>‰ª∑Ê†ºÔºö800ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('alien')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-knight">
                <div class="achievement-icon">üõ°Ô∏è</div>
                <div class="achievement-info">
                    <h3>È™ëÂ£´</h3>
                    <p>È´òË¥µÁöÑÂÆàÊä§ËÄÖ</p>
                    <p>‰ª∑Ê†ºÔºö1200ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('knight')">Ë¥≠‰π∞</button></div>
            </div>
            <div class="achievement-item" id="skin-dragon">
                <div class="achievement-icon">üêâ</div>
                <div class="achievement-info">
                    <h3>Èæô</h3>
                    <p>‰º†ËØ¥‰∏≠ÁöÑÁîüÁâ©</p>
                    <p>‰ª∑Ê†ºÔºö2000ÈáëÂ∏Å</p>
                </div>
                <div class="achievement-status"><button onclick="buySkin('dragon')">Ë¥≠‰π∞</button></div>
            </div>
        </div>
    </div>
    
    <script>
    // Èü≥‰πêÊñá‰ª∂ÈÄâÊã©Â§ÑÁêÜÂáΩÊï∞
    function handleMusicFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const audio = document.getElementById('gameAudio');
            const fileURL = URL.createObjectURL(file);
            
            // Êõ¥Êñ∞Èü≥È¢ëÂÖÉÁ¥†ÁöÑsrc
            audio.src = fileURL;
            
            // Â∞ùËØïÊí≠ÊîæÈü≥‰πê
            audio.play()
                .then(() => {
                    // Êí≠ÊîæÊàêÂäü
                    try {
                        addChatMessage('Á≥ªÁªü', `ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ: ${file.name}`, '#4CAF50');
                    } catch (e) {
                        console.error('Ë∞ÉÁî®addChatMessageÂ§±Ë¥•:', e);
                        alert(`ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ: ${file.name}`);
                    }
                    
                    // ÂπøÊí≠ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                    try {
                        if (gameState.multiplayer && gameState.multiplayer.connections) {
                            // Ê≥®ÊÑèÔºöÁî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÊàë‰ª¨‰∏çËÉΩÁõ¥Êé•ÂèëÈÄÅÊñá‰ª∂ÁªôÂÖ∂‰ªñÁé©ÂÆ∂
                            // ÂèëÈÄÅÈü≥‰πêÊí≠ÊîæÈÄöÁü•ÔºåËÆ©ÂÖ∂‰ªñÁé©ÂÆ∂Áü•ÈÅìÊúâÈü≥‰πêÂú®Êí≠Êîæ
                            const playerName = gameState.multiplayer.players[gameState.multiplayer.currentPlayerId]?.name || 'Áé©ÂÆ∂';
                            const musicNotification = {
                                type: 'chat-message',
                                from: gameState.multiplayer.currentPlayerId,
                                message: `[Èü≥‰πê] ${playerName} Ê≠£Âú®Êí≠ÊîæÈü≥‰πê: ${file.name}`,
                                color: '#FFD700',
                                isSystem: true
                            };
                            Object.values(gameState.multiplayer.connections).forEach(conn => {
                                if (conn.send) {
                                    conn.send(musicNotification);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('ÂπøÊí≠Èü≥‰πêÈÄöÁü•Â§±Ë¥•:', e);
                    }
                })
                .catch(error => {
                    console.error('Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:', error);
                    // Êí≠ÊîæÂ§±Ë¥•ÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                    showMusicPlayConfirmModal(fileURL);
                });
        }
    }
    
    // ÂõæÁâáÈ¢ÑËßàÂäüËÉΩ - ÂÖ®Â±ÄÂáΩÊï∞
    function openImagePreview(imageData) {
        const modal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');
        if (modal && previewImage) {
            previewImage.src = imageData;
            modal.style.display = 'flex';
        }
    }
    
    // ÂÖ≥Èó≠ÂõæÁâáÈ¢ÑËßà - ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('closePreview')?.addEventListener('click', function() {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.style.display = 'none';
        }
    });
    
    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠È¢ÑËßà - ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('imagePreviewModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
    
    // ÂõæÁâá‰∏ãËΩΩÂäüËÉΩ - ÂÖ®Â±ÄÂáΩÊï∞
    function downloadImage() {
        const previewImage = document.getElementById('previewImage');
        if (previewImage && previewImage.src) {
            const a = document.createElement('a');
            a.href = previewImage.src;
            a.download = `maze-adventure-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }
    
    // ÁªëÂÆö‰∏ãËΩΩÊåâÈíÆ‰∫ã‰ª∂
    document.getElementById('downloadImage')?.addEventListener('click', downloadImage);
    </script>
</body>
</html>
